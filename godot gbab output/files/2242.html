<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="gbab-1"></a><span class="cm">/********************************************************************</span>
<a name="gbab-2"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-3"></a><span class="cm"> * THIS FILE IS PART OF THE OggTheora SOFTWARE CODEC SOURCE CODE.   *</span>
<a name="gbab-4"></a><span class="cm"> * USE, DISTRIBUTION AND REPRODUCTION OF THIS LIBRARY SOURCE IS     *</span>
<a name="gbab-5"></a><span class="cm"> * GOVERNED BY A BSD-STYLE SOURCE LICENSE INCLUDED WITH THIS SOURCE *</span>
<a name="gbab-6"></a><span class="cm"> * IN &#39;COPYING&#39;. PLEASE READ THESE TERMS BEFORE DISTRIBUTING.       *</span>
<a name="gbab-7"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-8"></a><span class="cm"> * THE Theora SOURCE CODE IS COPYRIGHT (C) 2002-2009                *</span>
<a name="gbab-9"></a><span class="cm"> * by the Xiph.Org Foundation http://www.xiph.org/                  *</span>
<a name="gbab-10"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-11"></a><span class="cm"> ********************************************************************</span>
<a name="gbab-12"></a>
<a name="gbab-13"></a><span class="cm">  function:</span>
<a name="gbab-14"></a><span class="cm">  last mod: $Id: enquant.c 16503 2009-08-22 18:14:02Z giles $</span>
<a name="gbab-15"></a>
<a name="gbab-16"></a><span class="cm"> ********************************************************************/</span>
<a name="gbab-17"></a><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<a name="gbab-18"></a><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<a name="gbab-19"></a><span class="cp">#include</span> <span class="cpf">&quot;encint.h&quot;</span><span class="cp"></span>
<a name="gbab-20"></a>
<a name="gbab-21"></a>
<a name="gbab-22"></a>
<a name="gbab-23"></a><span class="kt">void</span> <span class="nf">oc_quant_params_pack</span><span class="p">(</span><span class="n">oggpack_buffer</span> <span class="o">*</span><span class="n">_opb</span><span class="p">,</span><span class="k">const</span> <span class="n">th_quant_info</span> <span class="o">*</span><span class="n">_qinfo</span><span class="p">){</span>
<a name="gbab-24"></a>  <span class="k">const</span> <span class="n">th_quant_ranges</span> <span class="o">*</span><span class="n">qranges</span><span class="p">;</span>
<a name="gbab-25"></a>  <span class="k">const</span> <span class="n">th_quant_base</span>   <span class="o">*</span><span class="n">base_mats</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mi">64</span><span class="p">];</span>
<a name="gbab-26"></a>  <span class="kt">int</span>                    <span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">64</span><span class="p">];</span>
<a name="gbab-27"></a>  <span class="kt">int</span>                    <span class="n">nbase_mats</span><span class="p">;</span>
<a name="gbab-28"></a>  <span class="kt">int</span>                    <span class="n">nbits</span><span class="p">;</span>
<a name="gbab-29"></a>  <span class="kt">int</span>                    <span class="n">ci</span><span class="p">;</span>
<a name="gbab-30"></a>  <span class="kt">int</span>                    <span class="n">qi</span><span class="p">;</span>
<a name="gbab-31"></a>  <span class="kt">int</span>                    <span class="n">qri</span><span class="p">;</span>
<a name="gbab-32"></a>  <span class="kt">int</span>                    <span class="n">qti</span><span class="p">;</span>
<a name="gbab-33"></a>  <span class="kt">int</span>                    <span class="n">pli</span><span class="p">;</span>
<a name="gbab-34"></a>  <span class="kt">int</span>                    <span class="n">qtj</span><span class="p">;</span>
<a name="gbab-35"></a>  <span class="kt">int</span>                    <span class="n">plj</span><span class="p">;</span>
<a name="gbab-36"></a>  <span class="kt">int</span>                    <span class="n">bmi</span><span class="p">;</span>
<a name="gbab-37"></a>  <span class="kt">int</span>                    <span class="n">i</span><span class="p">;</span>
<a name="gbab-38"></a>  <span class="n">i</span><span class="o">=</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">loop_filter_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="gbab-39"></a>  <span class="k">for</span><span class="p">(</span><span class="n">qi</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">qi</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">qi</span><span class="o">++</span><span class="p">)</span><span class="n">i</span><span class="o">=</span><span class="n">OC_MAXI</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">loop_filter_limits</span><span class="p">[</span><span class="n">qi</span><span class="p">]);</span>
<a name="gbab-40"></a>  <span class="n">nbits</span><span class="o">=</span><span class="n">OC_ILOG_32</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a name="gbab-41"></a>  <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">nbits</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<a name="gbab-42"></a>  <span class="k">for</span><span class="p">(</span><span class="n">qi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qi</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">qi</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-43"></a>    <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">loop_filter_limits</span><span class="p">[</span><span class="n">qi</span><span class="p">],</span><span class="n">nbits</span><span class="p">);</span>
<a name="gbab-44"></a>  <span class="p">}</span>
<a name="gbab-45"></a>  <span class="cm">/*580 bits for VP3.*/</span>
<a name="gbab-46"></a>  <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-47"></a>  <span class="k">for</span><span class="p">(</span><span class="n">qi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qi</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">qi</span><span class="o">++</span><span class="p">)</span><span class="n">i</span><span class="o">=</span><span class="n">OC_MAXI</span><span class="p">(</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">ac_scale</span><span class="p">[</span><span class="n">qi</span><span class="p">],</span><span class="n">i</span><span class="p">);</span>
<a name="gbab-48"></a>  <span class="n">nbits</span><span class="o">=</span><span class="n">OC_ILOGNZ_32</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a name="gbab-49"></a>  <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">nbits</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<a name="gbab-50"></a>  <span class="k">for</span><span class="p">(</span><span class="n">qi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qi</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">qi</span><span class="o">++</span><span class="p">)</span><span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">ac_scale</span><span class="p">[</span><span class="n">qi</span><span class="p">],</span><span class="n">nbits</span><span class="p">);</span>
<a name="gbab-51"></a>  <span class="cm">/*516 bits for VP3.*/</span>
<a name="gbab-52"></a>  <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-53"></a>  <span class="k">for</span><span class="p">(</span><span class="n">qi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qi</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">qi</span><span class="o">++</span><span class="p">)</span><span class="n">i</span><span class="o">=</span><span class="n">OC_MAXI</span><span class="p">(</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">dc_scale</span><span class="p">[</span><span class="n">qi</span><span class="p">],</span><span class="n">i</span><span class="p">);</span>
<a name="gbab-54"></a>  <span class="n">nbits</span><span class="o">=</span><span class="n">OC_ILOGNZ_32</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a name="gbab-55"></a>  <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">nbits</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<a name="gbab-56"></a>  <span class="k">for</span><span class="p">(</span><span class="n">qi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qi</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">qi</span><span class="o">++</span><span class="p">)</span><span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">dc_scale</span><span class="p">[</span><span class="n">qi</span><span class="p">],</span><span class="n">nbits</span><span class="p">);</span>
<a name="gbab-57"></a>  <span class="cm">/*Consolidate any duplicate base matrices.*/</span>
<a name="gbab-58"></a>  <span class="n">nbase_mats</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-59"></a>  <span class="k">for</span><span class="p">(</span><span class="n">qti</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qti</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="n">qti</span><span class="o">++</span><span class="p">)</span><span class="k">for</span><span class="p">(</span><span class="n">pli</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">pli</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">pli</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-60"></a>    <span class="n">qranges</span><span class="o">=</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">qi_ranges</span><span class="p">[</span><span class="n">qti</span><span class="p">]</span><span class="o">+</span><span class="n">pli</span><span class="p">;</span>
<a name="gbab-61"></a>    <span class="k">for</span><span class="p">(</span><span class="n">qri</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qri</span><span class="o">&lt;=</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">nranges</span><span class="p">;</span><span class="n">qri</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-62"></a>      <span class="k">for</span><span class="p">(</span><span class="n">bmi</span><span class="o">=</span><span class="mi">0</span><span class="p">;;</span><span class="n">bmi</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-63"></a>        <span class="k">if</span><span class="p">(</span><span class="n">bmi</span><span class="o">&gt;=</span><span class="n">nbase_mats</span><span class="p">){</span>
<a name="gbab-64"></a>          <span class="n">base_mats</span><span class="p">[</span><span class="n">bmi</span><span class="p">]</span><span class="o">=</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">base_matrices</span><span class="o">+</span><span class="n">qri</span><span class="p">;</span>
<a name="gbab-65"></a>          <span class="n">indices</span><span class="p">[</span><span class="n">qti</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="n">qri</span><span class="p">]</span><span class="o">=</span><span class="n">nbase_mats</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-66"></a>          <span class="k">break</span><span class="p">;</span>
<a name="gbab-67"></a>        <span class="p">}</span>
<a name="gbab-68"></a>        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">base_mats</span><span class="p">[</span><span class="n">bmi</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">base_matrices</span><span class="p">[</span><span class="n">qri</span><span class="p">],</span>
<a name="gbab-69"></a>         <span class="k">sizeof</span><span class="p">(</span><span class="n">base_mats</span><span class="p">[</span><span class="n">bmi</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-70"></a>          <span class="n">indices</span><span class="p">[</span><span class="n">qti</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="n">qri</span><span class="p">]</span><span class="o">=</span><span class="n">bmi</span><span class="p">;</span>
<a name="gbab-71"></a>          <span class="k">break</span><span class="p">;</span>
<a name="gbab-72"></a>        <span class="p">}</span>
<a name="gbab-73"></a>      <span class="p">}</span>
<a name="gbab-74"></a>    <span class="p">}</span>
<a name="gbab-75"></a>  <span class="p">}</span>
<a name="gbab-76"></a>  <span class="cm">/*Write out the list of unique base matrices.</span>
<a name="gbab-77"></a><span class="cm">    1545 bits for VP3 matrices.*/</span>
<a name="gbab-78"></a>  <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">nbase_mats</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">);</span>
<a name="gbab-79"></a>  <span class="k">for</span><span class="p">(</span><span class="n">bmi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">bmi</span><span class="o">&lt;</span><span class="n">nbase_mats</span><span class="p">;</span><span class="n">bmi</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-80"></a>    <span class="k">for</span><span class="p">(</span><span class="n">ci</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ci</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">ci</span><span class="o">++</span><span class="p">)</span><span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">base_mats</span><span class="p">[</span><span class="n">bmi</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">ci</span><span class="p">],</span><span class="mi">8</span><span class="p">);</span>
<a name="gbab-81"></a>  <span class="p">}</span>
<a name="gbab-82"></a>  <span class="cm">/*Now store quant ranges and their associated indices into the base matrix</span>
<a name="gbab-83"></a><span class="cm">     list.</span>
<a name="gbab-84"></a><span class="cm">    46 bits for VP3 matrices.*/</span>
<a name="gbab-85"></a>  <span class="n">nbits</span><span class="o">=</span><span class="n">OC_ILOG_32</span><span class="p">(</span><span class="n">nbase_mats</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-86"></a>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-87"></a>    <span class="n">qti</span><span class="o">=</span><span class="n">i</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
<a name="gbab-88"></a>    <span class="n">pli</span><span class="o">=</span><span class="n">i</span><span class="o">%</span><span class="mi">3</span><span class="p">;</span>
<a name="gbab-89"></a>    <span class="n">qranges</span><span class="o">=</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">qi_ranges</span><span class="p">[</span><span class="n">qti</span><span class="p">]</span><span class="o">+</span><span class="n">pli</span><span class="p">;</span>
<a name="gbab-90"></a>    <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-91"></a>      <span class="k">if</span><span class="p">(</span><span class="n">qti</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-92"></a>        <span class="k">if</span><span class="p">(</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">nranges</span><span class="o">==</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">qi_ranges</span><span class="p">[</span><span class="n">qti</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">pli</span><span class="p">].</span><span class="n">nranges</span><span class="o">&amp;&amp;</span>
<a name="gbab-93"></a>         <span class="n">memcmp</span><span class="p">(</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">sizes</span><span class="p">,</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">qi_ranges</span><span class="p">[</span><span class="n">qti</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">pli</span><span class="p">].</span><span class="n">sizes</span><span class="p">,</span>
<a name="gbab-94"></a>         <span class="n">qranges</span><span class="o">-&gt;</span><span class="n">nranges</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">==</span><span class="mi">0</span><span class="o">&amp;&amp;</span>
<a name="gbab-95"></a>         <span class="n">memcmp</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">qti</span><span class="p">][</span><span class="n">pli</span><span class="p">],</span><span class="n">indices</span><span class="p">[</span><span class="n">qti</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">pli</span><span class="p">],</span>
<a name="gbab-96"></a>         <span class="p">(</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">nranges</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">qti</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-97"></a>          <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a name="gbab-98"></a>          <span class="k">continue</span><span class="p">;</span>
<a name="gbab-99"></a>        <span class="p">}</span>
<a name="gbab-100"></a>      <span class="p">}</span>
<a name="gbab-101"></a>      <span class="n">qtj</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
<a name="gbab-102"></a>      <span class="n">plj</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span><span class="p">;</span>
<a name="gbab-103"></a>      <span class="k">if</span><span class="p">(</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">nranges</span><span class="o">==</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">qi_ranges</span><span class="p">[</span><span class="n">qtj</span><span class="p">][</span><span class="n">plj</span><span class="p">].</span><span class="n">nranges</span><span class="o">&amp;&amp;</span>
<a name="gbab-104"></a>       <span class="n">memcmp</span><span class="p">(</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">sizes</span><span class="p">,</span><span class="n">_qinfo</span><span class="o">-&gt;</span><span class="n">qi_ranges</span><span class="p">[</span><span class="n">qtj</span><span class="p">][</span><span class="n">plj</span><span class="p">].</span><span class="n">sizes</span><span class="p">,</span>
<a name="gbab-105"></a>       <span class="n">qranges</span><span class="o">-&gt;</span><span class="n">nranges</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">==</span><span class="mi">0</span><span class="o">&amp;&amp;</span>
<a name="gbab-106"></a>       <span class="n">memcmp</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">qti</span><span class="p">][</span><span class="n">pli</span><span class="p">],</span><span class="n">indices</span><span class="p">[</span><span class="n">qtj</span><span class="p">][</span><span class="n">plj</span><span class="p">],</span>
<a name="gbab-107"></a>       <span class="p">(</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">nranges</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">qti</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-108"></a>        <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">qti</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">));</span>
<a name="gbab-109"></a>        <span class="k">continue</span><span class="p">;</span>
<a name="gbab-110"></a>      <span class="p">}</span>
<a name="gbab-111"></a>      <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-112"></a>    <span class="p">}</span>
<a name="gbab-113"></a>    <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="n">qti</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">nbits</span><span class="p">);</span>
<a name="gbab-114"></a>    <span class="k">for</span><span class="p">(</span><span class="n">qi</span><span class="o">=</span><span class="n">qri</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qi</span><span class="o">&lt;</span><span class="mi">63</span><span class="p">;</span><span class="n">qri</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-115"></a>      <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">sizes</span><span class="p">[</span><span class="n">qri</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">OC_ILOG_32</span><span class="p">(</span><span class="mi">62</span><span class="o">-</span><span class="n">qi</span><span class="p">));</span>
<a name="gbab-116"></a>      <span class="n">qi</span><span class="o">+=</span><span class="n">qranges</span><span class="o">-&gt;</span><span class="n">sizes</span><span class="p">[</span><span class="n">qri</span><span class="p">];</span>
<a name="gbab-117"></a>      <span class="n">oggpackB_write</span><span class="p">(</span><span class="n">_opb</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="n">qti</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="n">qri</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">nbits</span><span class="p">);</span>
<a name="gbab-118"></a>    <span class="p">}</span>
<a name="gbab-119"></a>  <span class="p">}</span>
<a name="gbab-120"></a><span class="p">}</span>
<a name="gbab-121"></a>
<a name="gbab-122"></a><span class="k">static</span> <span class="kt">void</span> <span class="nf">oc_iquant_init</span><span class="p">(</span><span class="n">oc_iquant</span> <span class="o">*</span><span class="n">_this</span><span class="p">,</span><span class="n">ogg_uint16_t</span> <span class="n">_d</span><span class="p">){</span>
<a name="gbab-123"></a>  <span class="n">ogg_uint32_t</span> <span class="n">t</span><span class="p">;</span>
<a name="gbab-124"></a>  <span class="kt">int</span>          <span class="n">l</span><span class="p">;</span>
<a name="gbab-125"></a>  <span class="n">_d</span><span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-126"></a>  <span class="n">l</span><span class="o">=</span><span class="n">OC_ILOGNZ_32</span><span class="p">(</span><span class="n">_d</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-127"></a>  <span class="n">t</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="p">((</span><span class="n">ogg_uint32_t</span><span class="p">)</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="o">+</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">_d</span><span class="p">;</span>
<a name="gbab-128"></a>  <span class="n">_this</span><span class="o">-&gt;</span><span class="n">m</span><span class="o">=</span><span class="p">(</span><span class="n">ogg_int16_t</span><span class="p">)(</span><span class="n">t</span><span class="o">-</span><span class="mh">0x10000</span><span class="p">);</span>
<a name="gbab-129"></a>  <span class="n">_this</span><span class="o">-&gt;</span><span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">;</span>
<a name="gbab-130"></a><span class="p">}</span>
<a name="gbab-131"></a>
<a name="gbab-132"></a><span class="cm">/*See comments at oc_dequant_tables_init() for how the quantization tables&#39;</span>
<a name="gbab-133"></a><span class="cm">   storage should be initialized.*/</span>
<a name="gbab-134"></a><span class="kt">void</span> <span class="nf">oc_enquant_tables_init</span><span class="p">(</span><span class="n">ogg_uint16_t</span> <span class="o">*</span><span class="n">_dequant</span><span class="p">[</span><span class="mi">64</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
<a name="gbab-135"></a> <span class="n">oc_iquant</span> <span class="o">*</span><span class="n">_enquant</span><span class="p">[</span><span class="mi">64</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="k">const</span> <span class="n">th_quant_info</span> <span class="o">*</span><span class="n">_qinfo</span><span class="p">){</span>
<a name="gbab-136"></a>  <span class="kt">int</span> <span class="n">qi</span><span class="p">;</span>
<a name="gbab-137"></a>  <span class="kt">int</span> <span class="n">pli</span><span class="p">;</span>
<a name="gbab-138"></a>  <span class="kt">int</span> <span class="n">qti</span><span class="p">;</span>
<a name="gbab-139"></a>  <span class="cm">/*Initialize the dequantization tables first.*/</span>
<a name="gbab-140"></a>  <span class="n">oc_dequant_tables_init</span><span class="p">(</span><span class="n">_dequant</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">_qinfo</span><span class="p">);</span>
<a name="gbab-141"></a>  <span class="cm">/*Derive the quantization tables directly from the dequantization tables.*/</span>
<a name="gbab-142"></a>  <span class="k">for</span><span class="p">(</span><span class="n">qi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qi</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">qi</span><span class="o">++</span><span class="p">)</span><span class="k">for</span><span class="p">(</span><span class="n">qti</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qti</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="n">qti</span><span class="o">++</span><span class="p">)</span><span class="k">for</span><span class="p">(</span><span class="n">pli</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">pli</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">pli</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-143"></a>    <span class="kt">int</span> <span class="n">zzi</span><span class="p">;</span>
<a name="gbab-144"></a>    <span class="kt">int</span> <span class="n">plj</span><span class="p">;</span>
<a name="gbab-145"></a>    <span class="kt">int</span> <span class="n">qtj</span><span class="p">;</span>
<a name="gbab-146"></a>    <span class="kt">int</span> <span class="n">dupe</span><span class="p">;</span>
<a name="gbab-147"></a>    <span class="n">dupe</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-148"></a>    <span class="k">for</span><span class="p">(</span><span class="n">qtj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qtj</span><span class="o">&lt;=</span><span class="n">qti</span><span class="p">;</span><span class="n">qtj</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-149"></a>      <span class="k">for</span><span class="p">(</span><span class="n">plj</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">plj</span><span class="o">&lt;</span><span class="p">(</span><span class="n">qtj</span><span class="o">&lt;</span><span class="n">qti</span><span class="o">?</span><span class="mi">3</span><span class="o">:</span><span class="n">pli</span><span class="p">);</span><span class="n">plj</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-150"></a>        <span class="k">if</span><span class="p">(</span><span class="n">_dequant</span><span class="p">[</span><span class="n">qi</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="n">qti</span><span class="p">]</span><span class="o">==</span><span class="n">_dequant</span><span class="p">[</span><span class="n">qi</span><span class="p">][</span><span class="n">plj</span><span class="p">][</span><span class="n">qtj</span><span class="p">]){</span>
<a name="gbab-151"></a>          <span class="n">dupe</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-152"></a>          <span class="k">break</span><span class="p">;</span>
<a name="gbab-153"></a>        <span class="p">}</span>
<a name="gbab-154"></a>      <span class="p">}</span>
<a name="gbab-155"></a>      <span class="k">if</span><span class="p">(</span><span class="n">dupe</span><span class="p">)</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-156"></a>    <span class="p">}</span>
<a name="gbab-157"></a>    <span class="k">if</span><span class="p">(</span><span class="n">dupe</span><span class="p">){</span>
<a name="gbab-158"></a>      <span class="n">_enquant</span><span class="p">[</span><span class="n">qi</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="n">qti</span><span class="p">]</span><span class="o">=</span><span class="n">_enquant</span><span class="p">[</span><span class="n">qi</span><span class="p">][</span><span class="n">plj</span><span class="p">][</span><span class="n">qtj</span><span class="p">];</span>
<a name="gbab-159"></a>      <span class="k">continue</span><span class="p">;</span>
<a name="gbab-160"></a>    <span class="p">}</span>
<a name="gbab-161"></a>    <span class="cm">/*In the original VP3.2 code, the rounding offset and the size of the</span>
<a name="gbab-162"></a><span class="cm">       dead zone around 0 were controlled by a &quot;sharpness&quot; parameter.</span>
<a name="gbab-163"></a><span class="cm">      We now R-D optimize the tokens for each block after quantization,</span>
<a name="gbab-164"></a><span class="cm">       so the rounding offset should always be 1/2, and an explicit dead</span>
<a name="gbab-165"></a><span class="cm">       zone is unnecessary.</span>
<a name="gbab-166"></a><span class="cm">      Hence, all of that VP3.2 code is gone from here, and the remaining</span>
<a name="gbab-167"></a><span class="cm">       floating point code has been implemented as equivalent integer</span>
<a name="gbab-168"></a><span class="cm">       code with exact precision.*/</span>
<a name="gbab-169"></a>    <span class="k">for</span><span class="p">(</span><span class="n">zzi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">zzi</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">zzi</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-170"></a>      <span class="n">oc_iquant_init</span><span class="p">(</span><span class="n">_enquant</span><span class="p">[</span><span class="n">qi</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="n">qti</span><span class="p">]</span><span class="o">+</span><span class="n">zzi</span><span class="p">,</span>
<a name="gbab-171"></a>       <span class="n">_dequant</span><span class="p">[</span><span class="n">qi</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="n">qti</span><span class="p">][</span><span class="n">zzi</span><span class="p">]);</span>
<a name="gbab-172"></a>    <span class="p">}</span>
<a name="gbab-173"></a>  <span class="p">}</span>
<a name="gbab-174"></a><span class="p">}</span>
<a name="gbab-175"></a>
<a name="gbab-176"></a>
<a name="gbab-177"></a>
<a name="gbab-178"></a><span class="cm">/*This table gives the square root of the fraction of the squared magnitude of</span>
<a name="gbab-179"></a><span class="cm">   each DCT coefficient relative to the total, scaled by 2**16, for both INTRA</span>
<a name="gbab-180"></a><span class="cm">   and INTER modes.</span>
<a name="gbab-181"></a><span class="cm">  These values were measured after motion-compensated prediction, before</span>
<a name="gbab-182"></a><span class="cm">   quantization, over a large set of test video (from QCIF to 1080p) encoded at</span>
<a name="gbab-183"></a><span class="cm">   all possible rates.</span>
<a name="gbab-184"></a><span class="cm">  The DC coefficient takes into account the DPCM prediction (using the</span>
<a name="gbab-185"></a><span class="cm">   quantized values from neighboring blocks, as the encoder does, but still</span>
<a name="gbab-186"></a><span class="cm">   before quantization of the coefficient in the current block).</span>
<a name="gbab-187"></a><span class="cm">  The results differ significantly from the expected variance (e.g., using an</span>
<a name="gbab-188"></a><span class="cm">   AR(1) model of the signal with rho=0.95, as is frequently done to compute</span>
<a name="gbab-189"></a><span class="cm">   the coding gain of the DCT).</span>
<a name="gbab-190"></a><span class="cm">  We use them to estimate an &quot;average&quot; quantizer for a given quantizer matrix,</span>
<a name="gbab-191"></a><span class="cm">   as this is used to parameterize a number of the rate control decisions.</span>
<a name="gbab-192"></a><span class="cm">  These values are themselves probably quantizer-matrix dependent, since the</span>
<a name="gbab-193"></a><span class="cm">   shape of the matrix affects the noise distribution in the reference frames,</span>
<a name="gbab-194"></a><span class="cm">   but they should at least give us _some_ amount of adaptivity to different</span>
<a name="gbab-195"></a><span class="cm">   matrices, as opposed to hard-coding a table of average Q values for the</span>
<a name="gbab-196"></a><span class="cm">   current set.</span>
<a name="gbab-197"></a><span class="cm">  The main features they capture are that a) only a few of the quantizers in</span>
<a name="gbab-198"></a><span class="cm">   the upper-left corner contribute anything significant at all (though INTER</span>
<a name="gbab-199"></a><span class="cm">   mode is significantly flatter) and b) the DPCM prediction of the DC</span>
<a name="gbab-200"></a><span class="cm">   coefficient gives a very minor improvement in the INTRA case and a quite</span>
<a name="gbab-201"></a><span class="cm">   significant one in the INTER case (over the expected variance).*/</span>
<a name="gbab-202"></a><span class="k">static</span> <span class="k">const</span> <span class="n">ogg_uint16_t</span> <span class="n">OC_RPSD</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">64</span><span class="p">]</span><span class="o">=</span><span class="p">{</span>
<a name="gbab-203"></a>  <span class="p">{</span>
<a name="gbab-204"></a>    <span class="mi">52725</span><span class="p">,</span><span class="mi">17370</span><span class="p">,</span><span class="mi">10399</span><span class="p">,</span> <span class="mi">6867</span><span class="p">,</span> <span class="mi">5115</span><span class="p">,</span> <span class="mi">3798</span><span class="p">,</span> <span class="mi">2942</span><span class="p">,</span> <span class="mi">2076</span><span class="p">,</span>
<a name="gbab-205"></a>    <span class="mi">17370</span><span class="p">,</span> <span class="mi">9900</span><span class="p">,</span> <span class="mi">6948</span><span class="p">,</span> <span class="mi">4994</span><span class="p">,</span> <span class="mi">3836</span><span class="p">,</span> <span class="mi">2869</span><span class="p">,</span> <span class="mi">2229</span><span class="p">,</span> <span class="mi">1619</span><span class="p">,</span>
<a name="gbab-206"></a>    <span class="mi">10399</span><span class="p">,</span> <span class="mi">6948</span><span class="p">,</span> <span class="mi">5516</span><span class="p">,</span> <span class="mi">4202</span><span class="p">,</span> <span class="mi">3376</span><span class="p">,</span> <span class="mi">2573</span><span class="p">,</span> <span class="mi">2015</span><span class="p">,</span> <span class="mi">1461</span><span class="p">,</span>
<a name="gbab-207"></a>     <span class="mi">6867</span><span class="p">,</span> <span class="mi">4994</span><span class="p">,</span> <span class="mi">4202</span><span class="p">,</span> <span class="mi">3377</span><span class="p">,</span> <span class="mi">2800</span><span class="p">,</span> <span class="mi">2164</span><span class="p">,</span> <span class="mi">1718</span><span class="p">,</span> <span class="mi">1243</span><span class="p">,</span>
<a name="gbab-208"></a>     <span class="mi">5115</span><span class="p">,</span> <span class="mi">3836</span><span class="p">,</span> <span class="mi">3376</span><span class="p">,</span> <span class="mi">2800</span><span class="p">,</span> <span class="mi">2391</span><span class="p">,</span> <span class="mi">1884</span><span class="p">,</span> <span class="mi">1530</span><span class="p">,</span> <span class="mi">1091</span><span class="p">,</span>
<a name="gbab-209"></a>     <span class="mi">3798</span><span class="p">,</span> <span class="mi">2869</span><span class="p">,</span> <span class="mi">2573</span><span class="p">,</span> <span class="mi">2164</span><span class="p">,</span> <span class="mi">1884</span><span class="p">,</span> <span class="mi">1495</span><span class="p">,</span> <span class="mi">1212</span><span class="p">,</span>  <span class="mi">873</span><span class="p">,</span>
<a name="gbab-210"></a>     <span class="mi">2942</span><span class="p">,</span> <span class="mi">2229</span><span class="p">,</span> <span class="mi">2015</span><span class="p">,</span> <span class="mi">1718</span><span class="p">,</span> <span class="mi">1530</span><span class="p">,</span> <span class="mi">1212</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span>  <span class="mi">704</span><span class="p">,</span>
<a name="gbab-211"></a>     <span class="mi">2076</span><span class="p">,</span> <span class="mi">1619</span><span class="p">,</span> <span class="mi">1461</span><span class="p">,</span> <span class="mi">1243</span><span class="p">,</span> <span class="mi">1091</span><span class="p">,</span>  <span class="mi">873</span><span class="p">,</span>  <span class="mi">704</span><span class="p">,</span>  <span class="mi">474</span>
<a name="gbab-212"></a>  <span class="p">},</span>
<a name="gbab-213"></a>  <span class="p">{</span>
<a name="gbab-214"></a>    <span class="mi">23411</span><span class="p">,</span><span class="mi">15604</span><span class="p">,</span><span class="mi">13529</span><span class="p">,</span><span class="mi">11601</span><span class="p">,</span><span class="mi">10683</span><span class="p">,</span> <span class="mi">8958</span><span class="p">,</span> <span class="mi">7840</span><span class="p">,</span> <span class="mi">6142</span><span class="p">,</span>
<a name="gbab-215"></a>    <span class="mi">15604</span><span class="p">,</span><span class="mi">11901</span><span class="p">,</span><span class="mi">10718</span><span class="p">,</span> <span class="mi">9108</span><span class="p">,</span> <span class="mi">8290</span><span class="p">,</span> <span class="mi">6961</span><span class="p">,</span> <span class="mi">6023</span><span class="p">,</span> <span class="mi">4487</span><span class="p">,</span>
<a name="gbab-216"></a>    <span class="mi">13529</span><span class="p">,</span><span class="mi">10718</span><span class="p">,</span> <span class="mi">9961</span><span class="p">,</span> <span class="mi">8527</span><span class="p">,</span> <span class="mi">7945</span><span class="p">,</span> <span class="mi">6689</span><span class="p">,</span> <span class="mi">5742</span><span class="p">,</span> <span class="mi">4333</span><span class="p">,</span>
<a name="gbab-217"></a>    <span class="mi">11601</span><span class="p">,</span> <span class="mi">9108</span><span class="p">,</span> <span class="mi">8527</span><span class="p">,</span> <span class="mi">7414</span><span class="p">,</span> <span class="mi">7084</span><span class="p">,</span> <span class="mi">5923</span><span class="p">,</span> <span class="mi">5175</span><span class="p">,</span> <span class="mi">3743</span><span class="p">,</span>
<a name="gbab-218"></a>    <span class="mi">10683</span><span class="p">,</span> <span class="mi">8290</span><span class="p">,</span> <span class="mi">7945</span><span class="p">,</span> <span class="mi">7084</span><span class="p">,</span> <span class="mi">6771</span><span class="p">,</span> <span class="mi">5754</span><span class="p">,</span> <span class="mi">4793</span><span class="p">,</span> <span class="mi">3504</span><span class="p">,</span>
<a name="gbab-219"></a>     <span class="mi">8958</span><span class="p">,</span> <span class="mi">6961</span><span class="p">,</span> <span class="mi">6689</span><span class="p">,</span> <span class="mi">5923</span><span class="p">,</span> <span class="mi">5754</span><span class="p">,</span> <span class="mi">4679</span><span class="p">,</span> <span class="mi">3936</span><span class="p">,</span> <span class="mi">2989</span><span class="p">,</span>
<a name="gbab-220"></a>     <span class="mi">7840</span><span class="p">,</span> <span class="mi">6023</span><span class="p">,</span> <span class="mi">5742</span><span class="p">,</span> <span class="mi">5175</span><span class="p">,</span> <span class="mi">4793</span><span class="p">,</span> <span class="mi">3936</span><span class="p">,</span> <span class="mi">3522</span><span class="p">,</span> <span class="mi">2558</span><span class="p">,</span>
<a name="gbab-221"></a>     <span class="mi">6142</span><span class="p">,</span> <span class="mi">4487</span><span class="p">,</span> <span class="mi">4333</span><span class="p">,</span> <span class="mi">3743</span><span class="p">,</span> <span class="mi">3504</span><span class="p">,</span> <span class="mi">2989</span><span class="p">,</span> <span class="mi">2558</span><span class="p">,</span> <span class="mi">1829</span>
<a name="gbab-222"></a>  <span class="p">}</span>
<a name="gbab-223"></a><span class="p">};</span>
<a name="gbab-224"></a>
<a name="gbab-225"></a><span class="cm">/*The fraction of the squared magnitude of the residuals in each color channel</span>
<a name="gbab-226"></a><span class="cm">   relative to the total, scaled by 2**16, for each pixel format.</span>
<a name="gbab-227"></a><span class="cm">  These values were measured after motion-compensated prediction, before</span>
<a name="gbab-228"></a><span class="cm">   quantization, over a large set of test video encoded at all possible rates.</span>
<a name="gbab-229"></a><span class="cm">  TODO: These values are only from INTER frames; it should be re-measured for</span>
<a name="gbab-230"></a><span class="cm">   INTRA frames.*/</span>
<a name="gbab-231"></a><span class="k">static</span> <span class="k">const</span> <span class="n">ogg_uint16_t</span> <span class="n">OC_PCD</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="p">{</span>
<a name="gbab-232"></a>  <span class="p">{</span><span class="mi">59926</span><span class="p">,</span> <span class="mi">3038</span><span class="p">,</span> <span class="mi">2572</span><span class="p">},</span>
<a name="gbab-233"></a>  <span class="p">{</span><span class="mi">55201</span><span class="p">,</span> <span class="mi">5597</span><span class="p">,</span> <span class="mi">4738</span><span class="p">},</span>
<a name="gbab-234"></a>  <span class="p">{</span><span class="mi">55201</span><span class="p">,</span> <span class="mi">5597</span><span class="p">,</span> <span class="mi">4738</span><span class="p">},</span>
<a name="gbab-235"></a>  <span class="p">{</span><span class="mi">47682</span><span class="p">,</span> <span class="mi">9669</span><span class="p">,</span> <span class="mi">8185</span><span class="p">}</span>
<a name="gbab-236"></a><span class="p">};</span>
<a name="gbab-237"></a>
<a name="gbab-238"></a>
<a name="gbab-239"></a><span class="cm">/*Compute an &quot;average&quot; quantizer for each qi level.</span>
<a name="gbab-240"></a><span class="cm">  We do one for INTER and one for INTRA, since their behavior is very</span>
<a name="gbab-241"></a><span class="cm">   different, but average across chroma channels.</span>
<a name="gbab-242"></a><span class="cm">  The basic approach is to compute a harmonic average of the squared quantizer,</span>
<a name="gbab-243"></a><span class="cm">   weighted by the expected squared magnitude of the DCT coefficients.</span>
<a name="gbab-244"></a><span class="cm">  Under the (not quite true) assumption that DCT coefficients are</span>
<a name="gbab-245"></a><span class="cm">   Laplacian-distributed, this preserves the product Q*lambda, where</span>
<a name="gbab-246"></a><span class="cm">   lambda=sqrt(2/sigma**2) is the Laplacian distribution parameter (not to be</span>
<a name="gbab-247"></a><span class="cm">   confused with the lambda used in R-D optimization throughout most of the</span>
<a name="gbab-248"></a><span class="cm">   rest of the code).</span>
<a name="gbab-249"></a><span class="cm">  The value Q*lambda completely determines the entropy of the coefficients.*/</span>
<a name="gbab-250"></a><span class="kt">void</span> <span class="nf">oc_enquant_qavg_init</span><span class="p">(</span><span class="n">ogg_int64_t</span> <span class="n">_log_qavg</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">64</span><span class="p">],</span>
<a name="gbab-251"></a> <span class="n">ogg_uint16_t</span> <span class="o">*</span><span class="n">_dequant</span><span class="p">[</span><span class="mi">64</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="kt">int</span> <span class="n">_pixel_fmt</span><span class="p">){</span>
<a name="gbab-252"></a>  <span class="kt">int</span> <span class="n">qi</span><span class="p">;</span>
<a name="gbab-253"></a>  <span class="kt">int</span> <span class="n">pli</span><span class="p">;</span>
<a name="gbab-254"></a>  <span class="kt">int</span> <span class="n">qti</span><span class="p">;</span>
<a name="gbab-255"></a>  <span class="kt">int</span> <span class="n">ci</span><span class="p">;</span>
<a name="gbab-256"></a>  <span class="k">for</span><span class="p">(</span><span class="n">qti</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qti</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="n">qti</span><span class="o">++</span><span class="p">)</span><span class="k">for</span><span class="p">(</span><span class="n">qi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">qi</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">qi</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-257"></a>    <span class="n">ogg_int64_t</span> <span class="n">q2</span><span class="p">;</span>
<a name="gbab-258"></a>    <span class="n">q2</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-259"></a>    <span class="k">for</span><span class="p">(</span><span class="n">pli</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">pli</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">pli</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-260"></a>      <span class="n">ogg_uint32_t</span> <span class="n">qp</span><span class="p">;</span>
<a name="gbab-261"></a>      <span class="n">qp</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-262"></a>      <span class="k">for</span><span class="p">(</span><span class="n">ci</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ci</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">ci</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-263"></a>        <span class="kt">unsigned</span> <span class="n">rq</span><span class="p">;</span>
<a name="gbab-264"></a>        <span class="kt">unsigned</span> <span class="n">qd</span><span class="p">;</span>
<a name="gbab-265"></a>        <span class="n">qd</span><span class="o">=</span><span class="n">_dequant</span><span class="p">[</span><span class="n">qi</span><span class="p">][</span><span class="n">pli</span><span class="p">][</span><span class="n">qti</span><span class="p">][</span><span class="n">OC_IZIG_ZAG</span><span class="p">[</span><span class="n">ci</span><span class="p">]];</span>
<a name="gbab-266"></a>        <span class="n">rq</span><span class="o">=</span><span class="p">(</span><span class="n">OC_RPSD</span><span class="p">[</span><span class="n">qti</span><span class="p">][</span><span class="n">ci</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">qd</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">qd</span><span class="p">;</span>
<a name="gbab-267"></a>        <span class="n">qp</span><span class="o">+=</span><span class="n">rq</span><span class="o">*</span><span class="p">(</span><span class="n">ogg_uint32_t</span><span class="p">)</span><span class="n">rq</span><span class="p">;</span>
<a name="gbab-268"></a>      <span class="p">}</span>
<a name="gbab-269"></a>      <span class="n">q2</span><span class="o">+=</span><span class="n">OC_PCD</span><span class="p">[</span><span class="n">_pixel_fmt</span><span class="p">][</span><span class="n">pli</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ogg_int64_t</span><span class="p">)</span><span class="n">qp</span><span class="p">;</span>
<a name="gbab-270"></a>    <span class="p">}</span>
<a name="gbab-271"></a>    <span class="cm">/*qavg=1.0/sqrt(q2).*/</span>
<a name="gbab-272"></a>    <span class="n">_log_qavg</span><span class="p">[</span><span class="n">qti</span><span class="p">][</span><span class="n">qi</span><span class="p">]</span><span class="o">=</span><span class="n">OC_Q57</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span><span class="o">-</span><span class="n">oc_blog64</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-273"></a>  <span class="p">}</span>
<a name="gbab-274"></a><span class="p">}</span>
</pre></div>
</td></tr></table>