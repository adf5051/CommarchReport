<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="gbab-1"></a><span class="cm">/********************************************************************</span>
<a name="gbab-2"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-3"></a><span class="cm"> * THIS FILE IS PART OF THE OggTheora SOFTWARE CODEC SOURCE CODE.   *</span>
<a name="gbab-4"></a><span class="cm"> * USE, DISTRIBUTION AND REPRODUCTION OF THIS LIBRARY SOURCE IS     *</span>
<a name="gbab-5"></a><span class="cm"> * GOVERNED BY A BSD-STYLE SOURCE LICENSE INCLUDED WITH THIS SOURCE *</span>
<a name="gbab-6"></a><span class="cm"> * IN &#39;COPYING&#39;. PLEASE READ THESE TERMS BEFORE DISTRIBUTING.       *</span>
<a name="gbab-7"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-8"></a><span class="cm"> * THE Theora SOURCE CODE IS COPYRIGHT (C) 2002-2009                *</span>
<a name="gbab-9"></a><span class="cm"> * by the Xiph.Org Foundation and contributors http://www.xiph.org/ *</span>
<a name="gbab-10"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-11"></a><span class="cm"> ********************************************************************</span>
<a name="gbab-12"></a>
<a name="gbab-13"></a><span class="cm">  function:</span>
<a name="gbab-14"></a><span class="cm">    last mod: $Id: internal.h 16503 2009-08-22 18:14:02Z giles $</span>
<a name="gbab-15"></a>
<a name="gbab-16"></a><span class="cm"> ********************************************************************/</span>
<a name="gbab-17"></a><span class="cp">#if !defined(_internal_H)</span>
<a name="gbab-18"></a><span class="cp"># define _internal_H (1)</span>
<a name="gbab-19"></a><span class="cp"># include &lt;stdlib.h&gt;</span>
<a name="gbab-20"></a><span class="cp"># include &lt;limits.h&gt;</span>
<a name="gbab-21"></a><span class="cp"># if defined(HAVE_CONFIG_H)</span>
<a name="gbab-22"></a><span class="cp">#  include &lt;config.h&gt;</span>
<a name="gbab-23"></a><span class="cp"># endif</span>
<a name="gbab-24"></a><span class="cp"># include &quot;theora/codec.h&quot;</span>
<a name="gbab-25"></a><span class="cp"># include &quot;theora/theora.h&quot;</span>
<a name="gbab-26"></a>
<a name="gbab-27"></a><span class="cp"># if defined(_MSC_VER)</span>
<a name="gbab-28"></a><span class="cm">/*Disable missing EMMS warnings.*/</span>
<a name="gbab-29"></a><span class="cp">#  pragma warning(disable:4799)</span>
<a name="gbab-30"></a><span class="cm">/*Thank you Microsoft, I know the order of operations.*/</span>
<a name="gbab-31"></a><span class="cp">#  pragma warning(disable:4554)</span>
<a name="gbab-32"></a><span class="cp"># endif</span>
<a name="gbab-33"></a><span class="cm">/*You, too, gcc.*/</span>
<a name="gbab-34"></a><span class="cp"># if defined(__GNUC_PREREQ)</span>
<a name="gbab-35"></a><span class="cp">#  if __GNUC_PREREQ(4,2)</span>
<a name="gbab-36"></a><span class="cp">#   pragma GCC diagnostic ignored &quot;-Wparentheses&quot;</span>
<a name="gbab-37"></a><span class="cp">#  endif</span>
<a name="gbab-38"></a><span class="cp"># endif</span>
<a name="gbab-39"></a>
<a name="gbab-40"></a><span class="cp"># include &quot;ocintrin.h&quot;</span>
<a name="gbab-41"></a><span class="cp"># include &quot;huffman.h&quot;</span>
<a name="gbab-42"></a><span class="cp"># include &quot;quant.h&quot;</span>
<a name="gbab-43"></a>
<a name="gbab-44"></a><span class="cm">/*Some assembly constructs require aligned operands.*/</span>
<a name="gbab-45"></a><span class="cp"># if defined(OC_X86_ASM)</span>
<a name="gbab-46"></a><span class="cp">#  if defined(__GNUC__)</span>
<a name="gbab-47"></a><span class="cp">#   define OC_ALIGN8(expr) expr __attribute__((aligned(8)))</span>
<a name="gbab-48"></a><span class="cp">#   define OC_ALIGN16(expr) expr __attribute__((aligned(16)))</span>
<a name="gbab-49"></a><span class="cp">#  elif defined(_MSC_VER)</span>
<a name="gbab-50"></a><span class="cp">#   define OC_ALIGN8(expr) __declspec (align(8)) expr</span>
<a name="gbab-51"></a><span class="cp">#   define OC_ALIGN16(expr) __declspec (align(16)) expr</span>
<a name="gbab-52"></a><span class="cp">#  endif</span>
<a name="gbab-53"></a><span class="cp"># endif</span>
<a name="gbab-54"></a><span class="cp"># if !defined(OC_ALIGN8)</span>
<a name="gbab-55"></a><span class="cp">#  define OC_ALIGN8(expr) expr</span>
<a name="gbab-56"></a><span class="cp"># endif</span>
<a name="gbab-57"></a><span class="cp"># if !defined(OC_ALIGN16)</span>
<a name="gbab-58"></a><span class="cp">#  define OC_ALIGN16(expr) expr</span>
<a name="gbab-59"></a><span class="cp"># endif</span>
<a name="gbab-60"></a>
<a name="gbab-61"></a>
<a name="gbab-62"></a>
<a name="gbab-63"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="n">oc_sb_flags</span>              <span class="n">oc_sb_flags</span><span class="p">;</span>
<a name="gbab-64"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="n">oc_border_info</span>           <span class="n">oc_border_info</span><span class="p">;</span>
<a name="gbab-65"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="n">oc_fragment</span>              <span class="n">oc_fragment</span><span class="p">;</span>
<a name="gbab-66"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="n">oc_fragment_plane</span>        <span class="n">oc_fragment_plane</span><span class="p">;</span>
<a name="gbab-67"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="n">oc_base_opt_vtable</span>       <span class="n">oc_base_opt_vtable</span><span class="p">;</span>
<a name="gbab-68"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="n">oc_base_opt_data</span>         <span class="n">oc_base_opt_data</span><span class="p">;</span>
<a name="gbab-69"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="n">oc_state_dispatch_vtable</span> <span class="n">oc_state_dispatch_vtable</span><span class="p">;</span>
<a name="gbab-70"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="n">oc_theora_state</span>          <span class="n">oc_theora_state</span><span class="p">;</span>
<a name="gbab-71"></a>
<a name="gbab-72"></a>
<a name="gbab-73"></a>
<a name="gbab-74"></a><span class="cm">/*This library&#39;s version.*/</span>
<a name="gbab-75"></a><span class="cp"># define OC_VENDOR_STRING &quot;Xiph.Org libtheora 1.1 20090822 (Thusnelda)&quot;</span>
<a name="gbab-76"></a>
<a name="gbab-77"></a><span class="cm">/*Theora bitstream version.*/</span>
<a name="gbab-78"></a><span class="cp"># define TH_VERSION_MAJOR (3)</span>
<a name="gbab-79"></a><span class="cp"># define TH_VERSION_MINOR (2)</span>
<a name="gbab-80"></a><span class="cp"># define TH_VERSION_SUB   (1)</span>
<a name="gbab-81"></a><span class="cp"># define TH_VERSION_CHECK(_info,_maj,_min,_sub) \</span>
<a name="gbab-82"></a><span class="cp"> ((_info)-&gt;version_major&gt;(_maj)||(_info)-&gt;version_major==(_maj)&amp;&amp; \</span>
<a name="gbab-83"></a><span class="cp"> ((_info)-&gt;version_minor&gt;(_min)||(_info)-&gt;version_minor==(_min)&amp;&amp; \</span>
<a name="gbab-84"></a><span class="cp"> (_info)-&gt;version_subminor&gt;=(_sub)))</span>
<a name="gbab-85"></a>
<a name="gbab-86"></a><span class="cm">/*A keyframe.*/</span>
<a name="gbab-87"></a><span class="cp">#define OC_INTRA_FRAME (0)</span>
<a name="gbab-88"></a><span class="cm">/*A predicted frame.*/</span>
<a name="gbab-89"></a><span class="cp">#define OC_INTER_FRAME (1)</span>
<a name="gbab-90"></a><span class="cm">/*A frame of unknown type (frame type decision has not yet been made).*/</span>
<a name="gbab-91"></a><span class="cp">#define OC_UNKWN_FRAME (-1)</span>
<a name="gbab-92"></a>
<a name="gbab-93"></a><span class="cm">/*The amount of padding to add to the reconstructed frame buffers on all</span>
<a name="gbab-94"></a><span class="cm">   sides.</span>
<a name="gbab-95"></a><span class="cm">  This is used to allow unrestricted motion vectors without special casing.</span>
<a name="gbab-96"></a><span class="cm">  This must be a multiple of 2.*/</span>
<a name="gbab-97"></a><span class="cp">#define OC_UMV_PADDING (16)</span>
<a name="gbab-98"></a>
<a name="gbab-99"></a><span class="cm">/*Frame classification indices.*/</span>
<a name="gbab-100"></a><span class="cm">/*The previous golden frame.*/</span>
<a name="gbab-101"></a><span class="cp">#define OC_FRAME_GOLD (0)</span>
<a name="gbab-102"></a><span class="cm">/*The previous frame.*/</span>
<a name="gbab-103"></a><span class="cp">#define OC_FRAME_PREV (1)</span>
<a name="gbab-104"></a><span class="cm">/*The current frame.*/</span>
<a name="gbab-105"></a><span class="cp">#define OC_FRAME_SELF (2)</span>
<a name="gbab-106"></a>
<a name="gbab-107"></a><span class="cm">/*The input or output buffer.*/</span>
<a name="gbab-108"></a><span class="cp">#define OC_FRAME_IO   (3)</span>
<a name="gbab-109"></a>
<a name="gbab-110"></a><span class="cm">/*Macroblock modes.*/</span>
<a name="gbab-111"></a><span class="cm">/*Macro block is invalid: It is never coded.*/</span>
<a name="gbab-112"></a><span class="cp">#define OC_MODE_INVALID        (-1)</span>
<a name="gbab-113"></a><span class="cm">/*Encoded difference from the same macro block in the previous frame.*/</span>
<a name="gbab-114"></a><span class="cp">#define OC_MODE_INTER_NOMV     (0)</span>
<a name="gbab-115"></a><span class="cm">/*Encoded with no motion compensated prediction.*/</span>
<a name="gbab-116"></a><span class="cp">#define OC_MODE_INTRA          (1)</span>
<a name="gbab-117"></a><span class="cm">/*Encoded difference from the previous frame offset by the given motion </span>
<a name="gbab-118"></a><span class="cm">  vector.*/</span>
<a name="gbab-119"></a><span class="cp">#define OC_MODE_INTER_MV       (2)</span>
<a name="gbab-120"></a><span class="cm">/*Encoded difference from the previous frame offset by the last coded motion </span>
<a name="gbab-121"></a><span class="cm">  vector.*/</span>
<a name="gbab-122"></a><span class="cp">#define OC_MODE_INTER_MV_LAST  (3)</span>
<a name="gbab-123"></a><span class="cm">/*Encoded difference from the previous frame offset by the second to last </span>
<a name="gbab-124"></a><span class="cm">  coded motion vector.*/</span>
<a name="gbab-125"></a><span class="cp">#define OC_MODE_INTER_MV_LAST2 (4)</span>
<a name="gbab-126"></a><span class="cm">/*Encoded difference from the same macro block in the previous golden </span>
<a name="gbab-127"></a><span class="cm">  frame.*/</span>
<a name="gbab-128"></a><span class="cp">#define OC_MODE_GOLDEN_NOMV    (5)</span>
<a name="gbab-129"></a><span class="cm">/*Encoded difference from the previous golden frame offset by the given motion </span>
<a name="gbab-130"></a><span class="cm">  vector.*/</span>
<a name="gbab-131"></a><span class="cp">#define OC_MODE_GOLDEN_MV      (6)</span>
<a name="gbab-132"></a><span class="cm">/*Encoded difference from the previous frame offset by the individual motion </span>
<a name="gbab-133"></a><span class="cm">  vectors given for each block.*/</span>
<a name="gbab-134"></a><span class="cp">#define OC_MODE_INTER_MV_FOUR  (7)</span>
<a name="gbab-135"></a><span class="cm">/*The number of (coded) modes.*/</span>
<a name="gbab-136"></a><span class="cp">#define OC_NMODES              (8)</span>
<a name="gbab-137"></a>
<a name="gbab-138"></a><span class="cm">/*Determines the reference frame used for a given MB mode.*/</span>
<a name="gbab-139"></a><span class="cp">#define OC_FRAME_FOR_MODE(_x) \</span>
<a name="gbab-140"></a><span class="cp"> OC_UNIBBLE_TABLE32(OC_FRAME_PREV,OC_FRAME_SELF,OC_FRAME_PREV,OC_FRAME_PREV, \</span>
<a name="gbab-141"></a><span class="cp">  OC_FRAME_PREV,OC_FRAME_GOLD,OC_FRAME_GOLD,OC_FRAME_PREV,(_x))</span>
<a name="gbab-142"></a>
<a name="gbab-143"></a><span class="cm">/*Constants for the packet state machine common between encoder and decoder.*/</span>
<a name="gbab-144"></a>
<a name="gbab-145"></a><span class="cm">/*Next packet to emit/read: Codec info header.*/</span>
<a name="gbab-146"></a><span class="cp">#define OC_PACKET_INFO_HDR    (-3)</span>
<a name="gbab-147"></a><span class="cm">/*Next packet to emit/read: Comment header.*/</span>
<a name="gbab-148"></a><span class="cp">#define OC_PACKET_COMMENT_HDR (-2)</span>
<a name="gbab-149"></a><span class="cm">/*Next packet to emit/read: Codec setup header.*/</span>
<a name="gbab-150"></a><span class="cp">#define OC_PACKET_SETUP_HDR   (-1)</span>
<a name="gbab-151"></a><span class="cm">/*No more packets to emit/read.*/</span>
<a name="gbab-152"></a><span class="cp">#define OC_PACKET_DONE        (INT_MAX)</span>
<a name="gbab-153"></a>
<a name="gbab-154"></a>
<a name="gbab-155"></a>
<a name="gbab-156"></a><span class="cm">/*Super blocks are 32x32 segments of pixels in a single color plane indexed</span>
<a name="gbab-157"></a><span class="cm">   in image order.</span>
<a name="gbab-158"></a><span class="cm">  Internally, super blocks are broken up into four quadrants, each of which</span>
<a name="gbab-159"></a><span class="cm">   contains a 2x2 pattern of blocks, each of which is an 8x8 block of pixels.</span>
<a name="gbab-160"></a><span class="cm">  Quadrants, and the blocks within them, are indexed in a special order called</span>
<a name="gbab-161"></a><span class="cm">   a &quot;Hilbert curve&quot; within the super block.</span>
<a name="gbab-162"></a>
<a name="gbab-163"></a><span class="cm">  In order to differentiate between the Hilbert-curve indexing strategy and</span>
<a name="gbab-164"></a><span class="cm">   the regular image order indexing strategy, blocks indexed in image order</span>
<a name="gbab-165"></a><span class="cm">   are called &quot;fragments&quot;.</span>
<a name="gbab-166"></a><span class="cm">  Fragments are indexed in image order, left to right, then bottom to top,</span>
<a name="gbab-167"></a><span class="cm">   from Y&#39; plane to Cb plane to Cr plane.</span>
<a name="gbab-168"></a>
<a name="gbab-169"></a><span class="cm">  The co-located fragments in all image planes corresponding to the location</span>
<a name="gbab-170"></a><span class="cm">   of a single quadrant of a luma plane super block form a macro block.</span>
<a name="gbab-171"></a><span class="cm">  Thus there is only a single set of macro blocks for all planes, each of which</span>
<a name="gbab-172"></a><span class="cm">   contains between 6 and 12 fragments, depending on the pixel format.</span>
<a name="gbab-173"></a><span class="cm">  Therefore macro block information is kept in a separate set of arrays from</span>
<a name="gbab-174"></a><span class="cm">   super blocks to avoid unused space in the other planes.</span>
<a name="gbab-175"></a><span class="cm">  The lists are indexed in super block order.</span>
<a name="gbab-176"></a><span class="cm">  That is, the macro block corresponding to the macro block mbi in (luma plane)</span>
<a name="gbab-177"></a><span class="cm">   super block sbi is at index (sbi&lt;&lt;2|mbi).</span>
<a name="gbab-178"></a><span class="cm">  Thus the number of macro blocks in each dimension is always twice the number</span>
<a name="gbab-179"></a><span class="cm">   of super blocks, even when only an odd number fall inside the coded frame.</span>
<a name="gbab-180"></a><span class="cm">  These &quot;extra&quot; macro blocks are just an artifact of our internal data layout,</span>
<a name="gbab-181"></a><span class="cm">   and not part of the coded stream; they are flagged with a negative MB mode.*/</span>
<a name="gbab-182"></a>
<a name="gbab-183"></a>
<a name="gbab-184"></a>
<a name="gbab-185"></a><span class="cm">/*A single quadrant of the map from a super block to fragment numbers.*/</span>
<a name="gbab-186"></a><span class="k">typedef</span> <span class="kt">ptrdiff_t</span>       <span class="n">oc_sb_map_quad</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<a name="gbab-187"></a><span class="cm">/*A map from a super block to fragment numbers.*/</span>
<a name="gbab-188"></a><span class="k">typedef</span> <span class="n">oc_sb_map_quad</span>  <span class="n">oc_sb_map</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<a name="gbab-189"></a><span class="cm">/*A single plane of the map from a macro block to fragment numbers.*/</span>
<a name="gbab-190"></a><span class="k">typedef</span> <span class="kt">ptrdiff_t</span>       <span class="n">oc_mb_map_plane</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<a name="gbab-191"></a><span class="cm">/*A map from a macro block to fragment numbers.*/</span>
<a name="gbab-192"></a><span class="k">typedef</span> <span class="n">oc_mb_map_plane</span> <span class="n">oc_mb_map</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-193"></a><span class="cm">/*A motion vector.*/</span>
<a name="gbab-194"></a><span class="k">typedef</span> <span class="kt">signed</span> <span class="kt">char</span>     <span class="n">oc_mv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a name="gbab-195"></a>
<a name="gbab-196"></a>
<a name="gbab-197"></a>
<a name="gbab-198"></a><span class="cm">/*Super block information.*/</span>
<a name="gbab-199"></a><span class="k">struct</span> <span class="n">oc_sb_flags</span><span class="p">{</span>
<a name="gbab-200"></a>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nl">coded_fully</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-201"></a>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nl">coded_partially</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-202"></a>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nl">quad_valid</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span>
<a name="gbab-203"></a><span class="p">};</span>
<a name="gbab-204"></a>
<a name="gbab-205"></a>
<a name="gbab-206"></a>
<a name="gbab-207"></a><span class="cm">/*Information about a fragment which intersects the border of the displayable</span>
<a name="gbab-208"></a><span class="cm">   region.</span>
<a name="gbab-209"></a><span class="cm">  This marks which pixels belong to the displayable region.*/</span>
<a name="gbab-210"></a><span class="k">struct</span> <span class="n">oc_border_info</span><span class="p">{</span>
<a name="gbab-211"></a>  <span class="cm">/*A bit mask marking which pixels are in the displayable region.</span>
<a name="gbab-212"></a><span class="cm">    Pixel (x,y) corresponds to bit (y&lt;&lt;3|x).*/</span>
<a name="gbab-213"></a>  <span class="n">ogg_int64_t</span> <span class="n">mask</span><span class="p">;</span>
<a name="gbab-214"></a>  <span class="cm">/*The number of pixels in the displayable region.</span>
<a name="gbab-215"></a><span class="cm">    This is always positive, and always less than 64.*/</span>
<a name="gbab-216"></a>  <span class="kt">int</span>         <span class="n">npixels</span><span class="p">;</span>
<a name="gbab-217"></a><span class="p">};</span>
<a name="gbab-218"></a>
<a name="gbab-219"></a>
<a name="gbab-220"></a>
<a name="gbab-221"></a><span class="cm">/*Fragment information.*/</span>
<a name="gbab-222"></a><span class="k">struct</span> <span class="n">oc_fragment</span><span class="p">{</span>
<a name="gbab-223"></a>  <span class="cm">/*A flag indicating whether or not this fragment is coded.*/</span>
<a name="gbab-224"></a>  <span class="kt">unsigned</span>   <span class="nl">coded</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-225"></a>  <span class="cm">/*A flag indicating that this entire fragment lies outside the displayable</span>
<a name="gbab-226"></a><span class="cm">     region of the frame.</span>
<a name="gbab-227"></a><span class="cm">    Note the contrast with an invalid macro block, which is outside the coded</span>
<a name="gbab-228"></a><span class="cm">     frame, not just the displayable one.</span>
<a name="gbab-229"></a><span class="cm">    There are no fragments outside the coded frame by construction.*/</span>
<a name="gbab-230"></a>  <span class="kt">unsigned</span>   <span class="nl">invalid</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-231"></a>  <span class="cm">/*The index of the quality index used for this fragment&#39;s AC coefficients.*/</span>
<a name="gbab-232"></a>  <span class="kt">unsigned</span>   <span class="nl">qii</span><span class="p">:</span><span class="mi">6</span><span class="p">;</span>
<a name="gbab-233"></a>  <span class="cm">/*The mode of the macroblock this fragment belongs to.*/</span>
<a name="gbab-234"></a>  <span class="kt">unsigned</span>   <span class="nl">mb_mode</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span>
<a name="gbab-235"></a>  <span class="cm">/*The index of the associated border information for fragments which lie</span>
<a name="gbab-236"></a><span class="cm">     partially outside the displayable region.</span>
<a name="gbab-237"></a><span class="cm">    For fragments completely inside or outside this region, this is -1.</span>
<a name="gbab-238"></a><span class="cm">    Note that the C standard requires an explicit signed keyword for bitfield</span>
<a name="gbab-239"></a><span class="cm">     types, since some compilers may treat them as unsigned without it.*/</span>
<a name="gbab-240"></a>  <span class="kt">signed</span> <span class="kt">int</span> <span class="nl">borderi</span><span class="p">:</span><span class="mi">5</span><span class="p">;</span>
<a name="gbab-241"></a>  <span class="cm">/*The prediction-corrected DC component.</span>
<a name="gbab-242"></a><span class="cm">    Note that the C standard requires an explicit signed keyword for bitfield</span>
<a name="gbab-243"></a><span class="cm">     types, since some compilers may treat them as unsigned without it.*/</span>
<a name="gbab-244"></a>  <span class="kt">signed</span> <span class="kt">int</span> <span class="nl">dc</span><span class="p">:</span><span class="mi">16</span><span class="p">;</span>
<a name="gbab-245"></a><span class="p">};</span>
<a name="gbab-246"></a>
<a name="gbab-247"></a>
<a name="gbab-248"></a>
<a name="gbab-249"></a><span class="cm">/*A description of each fragment plane.*/</span>
<a name="gbab-250"></a><span class="k">struct</span> <span class="n">oc_fragment_plane</span><span class="p">{</span>
<a name="gbab-251"></a>  <span class="cm">/*The number of fragments in the horizontal direction.*/</span>
<a name="gbab-252"></a>  <span class="kt">int</span>       <span class="n">nhfrags</span><span class="p">;</span>
<a name="gbab-253"></a>  <span class="cm">/*The number of fragments in the vertical direction.*/</span>
<a name="gbab-254"></a>  <span class="kt">int</span>       <span class="n">nvfrags</span><span class="p">;</span>
<a name="gbab-255"></a>  <span class="cm">/*The offset of the first fragment in the plane.*/</span>
<a name="gbab-256"></a>  <span class="kt">ptrdiff_t</span> <span class="n">froffset</span><span class="p">;</span>
<a name="gbab-257"></a>  <span class="cm">/*The total number of fragments in the plane.*/</span>
<a name="gbab-258"></a>  <span class="kt">ptrdiff_t</span> <span class="n">nfrags</span><span class="p">;</span>
<a name="gbab-259"></a>  <span class="cm">/*The number of super blocks in the horizontal direction.*/</span>
<a name="gbab-260"></a>  <span class="kt">unsigned</span>  <span class="n">nhsbs</span><span class="p">;</span>
<a name="gbab-261"></a>  <span class="cm">/*The number of super blocks in the vertical direction.*/</span>
<a name="gbab-262"></a>  <span class="kt">unsigned</span>  <span class="n">nvsbs</span><span class="p">;</span>
<a name="gbab-263"></a>  <span class="cm">/*The offset of the first super block in the plane.*/</span>
<a name="gbab-264"></a>  <span class="kt">unsigned</span>  <span class="n">sboffset</span><span class="p">;</span>
<a name="gbab-265"></a>  <span class="cm">/*The total number of super blocks in the plane.*/</span>
<a name="gbab-266"></a>  <span class="kt">unsigned</span>  <span class="n">nsbs</span><span class="p">;</span>
<a name="gbab-267"></a><span class="p">};</span>
<a name="gbab-268"></a>
<a name="gbab-269"></a>
<a name="gbab-270"></a>
<a name="gbab-271"></a><span class="cm">/*The shared (encoder and decoder) functions that have accelerated variants.*/</span>
<a name="gbab-272"></a><span class="k">struct</span> <span class="n">oc_base_opt_vtable</span><span class="p">{</span>
<a name="gbab-273"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">frag_copy</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span>
<a name="gbab-274"></a>   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_ystride</span><span class="p">);</span>
<a name="gbab-275"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">frag_recon_intra</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_ystride</span><span class="p">,</span>
<a name="gbab-276"></a>   <span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_residue</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
<a name="gbab-277"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">frag_recon_inter</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span>
<a name="gbab-278"></a>   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_ystride</span><span class="p">,</span><span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_residue</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
<a name="gbab-279"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">frag_recon_inter2</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src1</span><span class="p">,</span>
<a name="gbab-280"></a>   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src2</span><span class="p">,</span><span class="kt">int</span> <span class="n">_ystride</span><span class="p">,</span><span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_residue</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
<a name="gbab-281"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">idct8x8</span><span class="p">)(</span><span class="n">ogg_int16_t</span> <span class="n">_y</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span><span class="kt">int</span> <span class="n">_last_zzi</span><span class="p">);</span>
<a name="gbab-282"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">state_frag_recon</span><span class="p">)(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">ptrdiff_t</span> <span class="n">_fragi</span><span class="p">,</span>
<a name="gbab-283"></a>   <span class="kt">int</span> <span class="n">_pli</span><span class="p">,</span><span class="n">ogg_int16_t</span> <span class="n">_dct_coeffs</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span><span class="kt">int</span> <span class="n">_last_zzi</span><span class="p">,</span><span class="n">ogg_uint16_t</span> <span class="n">_dc_quant</span><span class="p">);</span>
<a name="gbab-284"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">state_frag_copy_list</span><span class="p">)(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span>
<a name="gbab-285"></a>   <span class="k">const</span> <span class="kt">ptrdiff_t</span> <span class="o">*</span><span class="n">_fragis</span><span class="p">,</span><span class="kt">ptrdiff_t</span> <span class="n">_nfragis</span><span class="p">,</span>
<a name="gbab-286"></a>   <span class="kt">int</span> <span class="n">_dst_frame</span><span class="p">,</span><span class="kt">int</span> <span class="n">_src_frame</span><span class="p">,</span><span class="kt">int</span> <span class="n">_pli</span><span class="p">);</span>
<a name="gbab-287"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">state_loop_filter_frag_rows</span><span class="p">)(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span>
<a name="gbab-288"></a>   <span class="kt">int</span> <span class="n">_bv</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span><span class="kt">int</span> <span class="n">_refi</span><span class="p">,</span><span class="kt">int</span> <span class="n">_pli</span><span class="p">,</span><span class="kt">int</span> <span class="n">_fragy0</span><span class="p">,</span><span class="kt">int</span> <span class="n">_fragy_end</span><span class="p">);</span>  
<a name="gbab-289"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">restore_fpu</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<a name="gbab-290"></a><span class="p">};</span>
<a name="gbab-291"></a>
<a name="gbab-292"></a><span class="cm">/*The shared (encoder and decoder) tables that vary according to which variants</span>
<a name="gbab-293"></a><span class="cm">   of the above functions are used.*/</span>
<a name="gbab-294"></a><span class="k">struct</span> <span class="n">oc_base_opt_data</span><span class="p">{</span>
<a name="gbab-295"></a>  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dct_fzig_zag</span><span class="p">;</span>
<a name="gbab-296"></a><span class="p">};</span>
<a name="gbab-297"></a>
<a name="gbab-298"></a>
<a name="gbab-299"></a><span class="cm">/*State information common to both the encoder and decoder.*/</span>
<a name="gbab-300"></a><span class="k">struct</span> <span class="n">oc_theora_state</span><span class="p">{</span>
<a name="gbab-301"></a>  <span class="cm">/*The stream information.*/</span>
<a name="gbab-302"></a>  <span class="n">th_info</span>             <span class="n">info</span><span class="p">;</span>
<a name="gbab-303"></a>  <span class="cm">/*Table for shared accelerated functions.*/</span>
<a name="gbab-304"></a>  <span class="n">oc_base_opt_vtable</span>  <span class="n">opt_vtable</span><span class="p">;</span>
<a name="gbab-305"></a>  <span class="cm">/*Table for shared data used by accelerated functions.*/</span>
<a name="gbab-306"></a>  <span class="n">oc_base_opt_data</span>    <span class="n">opt_data</span><span class="p">;</span>
<a name="gbab-307"></a>  <span class="cm">/*CPU flags to detect the presence of extended instruction sets.*/</span>
<a name="gbab-308"></a>  <span class="n">ogg_uint32_t</span>        <span class="n">cpu_flags</span><span class="p">;</span>
<a name="gbab-309"></a>  <span class="cm">/*The fragment plane descriptions.*/</span>
<a name="gbab-310"></a>  <span class="n">oc_fragment_plane</span>   <span class="n">fplanes</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-311"></a>  <span class="cm">/*The list of fragments, indexed in image order.*/</span>
<a name="gbab-312"></a>  <span class="n">oc_fragment</span>        <span class="o">*</span><span class="n">frags</span><span class="p">;</span>
<a name="gbab-313"></a>  <span class="cm">/*The the offset into the reference frame buffer to the upper-left pixel of</span>
<a name="gbab-314"></a><span class="cm">     each fragment.*/</span>
<a name="gbab-315"></a>  <span class="kt">ptrdiff_t</span>          <span class="o">*</span><span class="n">frag_buf_offs</span><span class="p">;</span>
<a name="gbab-316"></a>  <span class="cm">/*The motion vector for each fragment.*/</span>
<a name="gbab-317"></a>  <span class="n">oc_mv</span>              <span class="o">*</span><span class="n">frag_mvs</span><span class="p">;</span>
<a name="gbab-318"></a>  <span class="cm">/*The total number of fragments in a single frame.*/</span>
<a name="gbab-319"></a>  <span class="kt">ptrdiff_t</span>           <span class="n">nfrags</span><span class="p">;</span>
<a name="gbab-320"></a>  <span class="cm">/*The list of super block maps, indexed in image order.*/</span>
<a name="gbab-321"></a>  <span class="n">oc_sb_map</span>          <span class="o">*</span><span class="n">sb_maps</span><span class="p">;</span>
<a name="gbab-322"></a>  <span class="cm">/*The list of super block flags, indexed in image order.*/</span>
<a name="gbab-323"></a>  <span class="n">oc_sb_flags</span>        <span class="o">*</span><span class="n">sb_flags</span><span class="p">;</span>
<a name="gbab-324"></a>  <span class="cm">/*The total number of super blocks in a single frame.*/</span>
<a name="gbab-325"></a>  <span class="kt">unsigned</span>            <span class="n">nsbs</span><span class="p">;</span>
<a name="gbab-326"></a>  <span class="cm">/*The fragments from each color plane that belong to each macro block.</span>
<a name="gbab-327"></a><span class="cm">    Fragments are stored in image order (left to right then top to bottom).</span>
<a name="gbab-328"></a><span class="cm">    When chroma components are decimated, the extra fragments have an index of</span>
<a name="gbab-329"></a><span class="cm">     -1.*/</span>
<a name="gbab-330"></a>  <span class="n">oc_mb_map</span>          <span class="o">*</span><span class="n">mb_maps</span><span class="p">;</span>
<a name="gbab-331"></a>  <span class="cm">/*The list of macro block modes.</span>
<a name="gbab-332"></a><span class="cm">    A negative number indicates the macro block lies entirely outside the</span>
<a name="gbab-333"></a><span class="cm">     coded frame.*/</span>
<a name="gbab-334"></a>  <span class="kt">signed</span> <span class="kt">char</span>        <span class="o">*</span><span class="n">mb_modes</span><span class="p">;</span>
<a name="gbab-335"></a>  <span class="cm">/*The number of macro blocks in the X direction.*/</span>
<a name="gbab-336"></a>  <span class="kt">unsigned</span>            <span class="n">nhmbs</span><span class="p">;</span>
<a name="gbab-337"></a>  <span class="cm">/*The number of macro blocks in the Y direction.*/</span>
<a name="gbab-338"></a>  <span class="kt">unsigned</span>            <span class="n">nvmbs</span><span class="p">;</span>
<a name="gbab-339"></a>  <span class="cm">/*The total number of macro blocks.*/</span>
<a name="gbab-340"></a>  <span class="kt">size_t</span>              <span class="n">nmbs</span><span class="p">;</span>
<a name="gbab-341"></a>  <span class="cm">/*The list of coded fragments, in coded order.</span>
<a name="gbab-342"></a><span class="cm">    Uncoded fragments are stored in reverse order from the end of the list.*/</span>
<a name="gbab-343"></a>  <span class="kt">ptrdiff_t</span>          <span class="o">*</span><span class="n">coded_fragis</span><span class="p">;</span>
<a name="gbab-344"></a>  <span class="cm">/*The number of coded fragments in each plane.*/</span>
<a name="gbab-345"></a>  <span class="kt">ptrdiff_t</span>           <span class="n">ncoded_fragis</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-346"></a>  <span class="cm">/*The total number of coded fragments.*/</span>
<a name="gbab-347"></a>  <span class="kt">ptrdiff_t</span>           <span class="n">ntotal_coded_fragis</span><span class="p">;</span>
<a name="gbab-348"></a>  <span class="cm">/*The index of the buffers being used for each OC_FRAME_* reference frame.*/</span>
<a name="gbab-349"></a>  <span class="kt">int</span>                 <span class="n">ref_frame_idx</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<a name="gbab-350"></a>  <span class="cm">/*The actual buffers used for the previously decoded frames.*/</span>
<a name="gbab-351"></a>  <span class="n">th_ycbcr_buffer</span>     <span class="n">ref_frame_bufs</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<a name="gbab-352"></a>  <span class="cm">/*The storage for the reference frame buffers.*/</span>
<a name="gbab-353"></a>  <span class="kt">unsigned</span> <span class="kt">char</span>      <span class="o">*</span><span class="n">ref_frame_data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<a name="gbab-354"></a>  <span class="cm">/*The strides for each plane in the reference frames.*/</span>
<a name="gbab-355"></a>  <span class="kt">int</span>                 <span class="n">ref_ystride</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-356"></a>  <span class="cm">/*The number of unique border patterns.*/</span>
<a name="gbab-357"></a>  <span class="kt">int</span>                 <span class="n">nborders</span><span class="p">;</span>
<a name="gbab-358"></a>  <span class="cm">/*The unique border patterns for all border fragments.</span>
<a name="gbab-359"></a><span class="cm">    The borderi field of fragments which straddle the border indexes this</span>
<a name="gbab-360"></a><span class="cm">     list.*/</span>
<a name="gbab-361"></a>  <span class="n">oc_border_info</span>      <span class="n">borders</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<a name="gbab-362"></a>  <span class="cm">/*The frame number of the last keyframe.*/</span>
<a name="gbab-363"></a>  <span class="n">ogg_int64_t</span>         <span class="n">keyframe_num</span><span class="p">;</span>
<a name="gbab-364"></a>  <span class="cm">/*The frame number of the current frame.*/</span>
<a name="gbab-365"></a>  <span class="n">ogg_int64_t</span>         <span class="n">curframe_num</span><span class="p">;</span>
<a name="gbab-366"></a>  <span class="cm">/*The granpos of the current frame.*/</span>
<a name="gbab-367"></a>  <span class="n">ogg_int64_t</span>         <span class="n">granpos</span><span class="p">;</span>
<a name="gbab-368"></a>  <span class="cm">/*The type of the current frame.*/</span>
<a name="gbab-369"></a>  <span class="kt">unsigned</span> <span class="kt">char</span>       <span class="n">frame_type</span><span class="p">;</span>
<a name="gbab-370"></a>  <span class="cm">/*The bias to add to the frame count when computing granule positions.*/</span>
<a name="gbab-371"></a>  <span class="kt">unsigned</span> <span class="kt">char</span>       <span class="n">granpos_bias</span><span class="p">;</span>
<a name="gbab-372"></a>  <span class="cm">/*The number of quality indices used in the current frame.*/</span>
<a name="gbab-373"></a>  <span class="kt">unsigned</span> <span class="kt">char</span>       <span class="n">nqis</span><span class="p">;</span>
<a name="gbab-374"></a>  <span class="cm">/*The quality indices of the current frame.*/</span>
<a name="gbab-375"></a>  <span class="kt">unsigned</span> <span class="kt">char</span>       <span class="n">qis</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-376"></a>  <span class="cm">/*The dequantization tables, stored in zig-zag order, and indexed by</span>
<a name="gbab-377"></a><span class="cm">     qi, pli, qti, and zzi.*/</span>
<a name="gbab-378"></a>  <span class="n">ogg_uint16_t</span>       <span class="o">*</span><span class="n">dequant_tables</span><span class="p">[</span><span class="mi">64</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
<a name="gbab-379"></a>  <span class="n">OC_ALIGN16</span><span class="p">(</span><span class="n">oc_quant_table</span>      <span class="n">dequant_table_data</span><span class="p">[</span><span class="mi">64</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<a name="gbab-380"></a>  <span class="cm">/*Loop filter strength parameters.*/</span>
<a name="gbab-381"></a>  <span class="kt">unsigned</span> <span class="kt">char</span>       <span class="n">loop_filter_limits</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<a name="gbab-382"></a><span class="p">};</span>
<a name="gbab-383"></a>
<a name="gbab-384"></a>
<a name="gbab-385"></a>
<a name="gbab-386"></a><span class="cm">/*The function type used to fill in the chroma plane motion vectors for a</span>
<a name="gbab-387"></a><span class="cm">   macro block when 4 different motion vectors are specified in the luma</span>
<a name="gbab-388"></a><span class="cm">   plane.</span>
<a name="gbab-389"></a><span class="cm">  _cbmvs: The chroma block-level motion vectors to fill in.</span>
<a name="gbab-390"></a><span class="cm">  _lmbmv: The luma macro-block level motion vector to fill in for use in</span>
<a name="gbab-391"></a><span class="cm">           prediction.</span>
<a name="gbab-392"></a><span class="cm">  _lbmvs: The luma block-level motion vectors.*/</span>
<a name="gbab-393"></a><span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">oc_set_chroma_mvs_func</span><span class="p">)(</span><span class="n">oc_mv</span> <span class="n">_cbmvs</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="k">const</span> <span class="n">oc_mv</span> <span class="n">_lbmvs</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<a name="gbab-394"></a>
<a name="gbab-395"></a>
<a name="gbab-396"></a>
<a name="gbab-397"></a><span class="cm">/*A map from the index in the zig zag scan to the coefficient number in a</span>
<a name="gbab-398"></a><span class="cm">   block.*/</span>
<a name="gbab-399"></a><span class="k">extern</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">OC_FZIG_ZAG</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<a name="gbab-400"></a><span class="cm">/*A map from the coefficient number in a block to its index in the zig zag</span>
<a name="gbab-401"></a><span class="cm">   scan.*/</span>
<a name="gbab-402"></a><span class="k">extern</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">OC_IZIG_ZAG</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<a name="gbab-403"></a><span class="cm">/*A map from physical macro block ordering to bitstream macro block</span>
<a name="gbab-404"></a><span class="cm">   ordering within a super block.*/</span>
<a name="gbab-405"></a><span class="k">extern</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">OC_MB_MAP</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
<a name="gbab-406"></a><span class="cm">/*A list of the indices in the oc_mb_map array that can be valid for each of</span>
<a name="gbab-407"></a><span class="cm">   the various chroma decimation types.*/</span>
<a name="gbab-408"></a><span class="k">extern</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">OC_MB_MAP_IDXS</span><span class="p">[</span><span class="n">TH_PF_NFORMATS</span><span class="p">][</span><span class="mi">12</span><span class="p">];</span>
<a name="gbab-409"></a><span class="cm">/*The number of indices in the oc_mb_map array that can be valid for each of</span>
<a name="gbab-410"></a><span class="cm">   the various chroma decimation types.*/</span>
<a name="gbab-411"></a><span class="k">extern</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">OC_MB_MAP_NIDXS</span><span class="p">[</span><span class="n">TH_PF_NFORMATS</span><span class="p">];</span>
<a name="gbab-412"></a><span class="cm">/*A table of functions used to fill in the Cb,Cr plane motion vectors for a</span>
<a name="gbab-413"></a><span class="cm">   macro block when 4 different motion vectors are specified in the luma</span>
<a name="gbab-414"></a><span class="cm">   plane.*/</span>
<a name="gbab-415"></a><span class="k">extern</span> <span class="k">const</span> <span class="n">oc_set_chroma_mvs_func</span> <span class="n">OC_SET_CHROMA_MVS_TABLE</span><span class="p">[</span><span class="n">TH_PF_NFORMATS</span><span class="p">];</span>
<a name="gbab-416"></a>
<a name="gbab-417"></a>
<a name="gbab-418"></a>
<a name="gbab-419"></a><span class="kt">int</span> <span class="nf">oc_ilog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">_v</span><span class="p">);</span>
<a name="gbab-420"></a><span class="kt">void</span> <span class="o">**</span><span class="nf">oc_malloc_2d</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">_height</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_width</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_sz</span><span class="p">);</span>
<a name="gbab-421"></a><span class="kt">void</span> <span class="o">**</span><span class="nf">oc_calloc_2d</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">_height</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_width</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_sz</span><span class="p">);</span>
<a name="gbab-422"></a><span class="kt">void</span> <span class="nf">oc_free_2d</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_ptr</span><span class="p">);</span>
<a name="gbab-423"></a>
<a name="gbab-424"></a><span class="kt">void</span> <span class="nf">oc_ycbcr_buffer_flip</span><span class="p">(</span><span class="n">th_ycbcr_buffer</span> <span class="n">_dst</span><span class="p">,</span>
<a name="gbab-425"></a> <span class="k">const</span> <span class="n">th_ycbcr_buffer</span> <span class="n">_src</span><span class="p">);</span>
<a name="gbab-426"></a>
<a name="gbab-427"></a><span class="kt">int</span> <span class="nf">oc_state_init</span><span class="p">(</span><span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="k">const</span> <span class="n">th_info</span> <span class="o">*</span><span class="n">_info</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nrefs</span><span class="p">);</span>
<a name="gbab-428"></a><span class="kt">void</span> <span class="nf">oc_state_clear</span><span class="p">(</span><span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">);</span>
<a name="gbab-429"></a><span class="kt">void</span> <span class="nf">oc_state_vtable_init_c</span><span class="p">(</span><span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">);</span>
<a name="gbab-430"></a><span class="kt">void</span> <span class="nf">oc_state_borders_fill_rows</span><span class="p">(</span><span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">int</span> <span class="n">_refi</span><span class="p">,</span><span class="kt">int</span> <span class="n">_pli</span><span class="p">,</span>
<a name="gbab-431"></a> <span class="kt">int</span> <span class="n">_y0</span><span class="p">,</span><span class="kt">int</span> <span class="n">_yend</span><span class="p">);</span>
<a name="gbab-432"></a><span class="kt">void</span> <span class="nf">oc_state_borders_fill_caps</span><span class="p">(</span><span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">int</span> <span class="n">_refi</span><span class="p">,</span><span class="kt">int</span> <span class="n">_pli</span><span class="p">);</span>
<a name="gbab-433"></a><span class="kt">void</span> <span class="nf">oc_state_borders_fill</span><span class="p">(</span><span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">int</span> <span class="n">_refi</span><span class="p">);</span>
<a name="gbab-434"></a><span class="kt">void</span> <span class="nf">oc_state_fill_buffer_ptrs</span><span class="p">(</span><span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">int</span> <span class="n">_buf_idx</span><span class="p">,</span>
<a name="gbab-435"></a> <span class="n">th_ycbcr_buffer</span> <span class="n">_img</span><span class="p">);</span>
<a name="gbab-436"></a><span class="kt">int</span> <span class="nf">oc_state_mbi_for_pos</span><span class="p">(</span><span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">int</span> <span class="n">_mbx</span><span class="p">,</span><span class="kt">int</span> <span class="n">_mby</span><span class="p">);</span>
<a name="gbab-437"></a><span class="kt">int</span> <span class="nf">oc_state_get_mv_offsets</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">int</span> <span class="n">_offsets</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<a name="gbab-438"></a> <span class="kt">int</span> <span class="n">_pli</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dx</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dy</span><span class="p">);</span>
<a name="gbab-439"></a>
<a name="gbab-440"></a><span class="kt">int</span> <span class="nf">oc_state_loop_filter_init</span><span class="p">(</span><span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_bv</span><span class="p">);</span>
<a name="gbab-441"></a><span class="kt">void</span> <span class="nf">oc_state_loop_filter</span><span class="p">(</span><span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">int</span> <span class="n">_frame</span><span class="p">);</span>
<a name="gbab-442"></a><span class="cp">#if defined(OC_DUMP_IMAGES)</span>
<a name="gbab-443"></a><span class="kt">int</span> <span class="nf">oc_state_dump_frame</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">int</span> <span class="n">_frame</span><span class="p">,</span>
<a name="gbab-444"></a> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_suf</span><span class="p">);</span>
<a name="gbab-445"></a><span class="cp">#endif</span>
<a name="gbab-446"></a>
<a name="gbab-447"></a><span class="cm">/*Shared accelerated functions.*/</span>
<a name="gbab-448"></a><span class="kt">void</span> <span class="nf">oc_frag_copy</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span>
<a name="gbab-449"></a> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_ystride</span><span class="p">);</span>
<a name="gbab-450"></a><span class="kt">void</span> <span class="nf">oc_frag_recon_intra</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span>
<a name="gbab-451"></a> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dst_ystride</span><span class="p">,</span><span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_residue</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
<a name="gbab-452"></a><span class="kt">void</span> <span class="nf">oc_frag_recon_inter</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span>
<a name="gbab-453"></a> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_ystride</span><span class="p">,</span><span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_residue</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
<a name="gbab-454"></a><span class="kt">void</span> <span class="nf">oc_frag_recon_inter2</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span>
<a name="gbab-455"></a> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src1</span><span class="p">,</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src2</span><span class="p">,</span>
<a name="gbab-456"></a> <span class="kt">int</span> <span class="n">_ystride</span><span class="p">,</span><span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_residue</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
<a name="gbab-457"></a><span class="kt">void</span> <span class="nf">oc_idct8x8</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="n">ogg_int16_t</span> <span class="n">_y</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span><span class="kt">int</span> <span class="n">_last_zzi</span><span class="p">);</span>
<a name="gbab-458"></a><span class="kt">void</span> <span class="nf">oc_state_frag_recon</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">ptrdiff_t</span> <span class="n">_fragi</span><span class="p">,</span>
<a name="gbab-459"></a> <span class="kt">int</span> <span class="n">_pli</span><span class="p">,</span><span class="n">ogg_int16_t</span> <span class="n">_dct_coeffs</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span><span class="kt">int</span> <span class="n">_last_zzi</span><span class="p">,</span><span class="n">ogg_uint16_t</span> <span class="n">_dc_quant</span><span class="p">);</span>
<a name="gbab-460"></a><span class="kt">void</span> <span class="nf">oc_state_frag_copy_list</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span>
<a name="gbab-461"></a> <span class="k">const</span> <span class="kt">ptrdiff_t</span> <span class="o">*</span><span class="n">_fragis</span><span class="p">,</span><span class="kt">ptrdiff_t</span> <span class="n">_nfragis</span><span class="p">,</span>
<a name="gbab-462"></a> <span class="kt">int</span> <span class="n">_dst_frame</span><span class="p">,</span><span class="kt">int</span> <span class="n">_src_frame</span><span class="p">,</span><span class="kt">int</span> <span class="n">_pli</span><span class="p">);</span>
<a name="gbab-463"></a><span class="kt">void</span> <span class="nf">oc_state_loop_filter_frag_rows</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span>
<a name="gbab-464"></a> <span class="kt">int</span> <span class="n">_bv</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span><span class="kt">int</span> <span class="n">_refi</span><span class="p">,</span><span class="kt">int</span> <span class="n">_pli</span><span class="p">,</span><span class="kt">int</span> <span class="n">_fragy0</span><span class="p">,</span><span class="kt">int</span> <span class="n">_fragy_end</span><span class="p">);</span>
<a name="gbab-465"></a><span class="kt">void</span> <span class="nf">oc_restore_fpu</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">);</span>
<a name="gbab-466"></a>
<a name="gbab-467"></a><span class="cm">/*Default pure-C implementations.*/</span>
<a name="gbab-468"></a><span class="kt">void</span> <span class="nf">oc_frag_copy_c</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span>
<a name="gbab-469"></a> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_src_ystride</span><span class="p">);</span>
<a name="gbab-470"></a><span class="kt">void</span> <span class="nf">oc_frag_recon_intra_c</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dst_ystride</span><span class="p">,</span>
<a name="gbab-471"></a> <span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_residue</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
<a name="gbab-472"></a><span class="kt">void</span> <span class="nf">oc_frag_recon_inter_c</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span>
<a name="gbab-473"></a> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_ystride</span><span class="p">,</span><span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_residue</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
<a name="gbab-474"></a><span class="kt">void</span> <span class="nf">oc_frag_recon_inter2_c</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src1</span><span class="p">,</span>
<a name="gbab-475"></a> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_src2</span><span class="p">,</span><span class="kt">int</span> <span class="n">_ystride</span><span class="p">,</span><span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_residue</span><span class="p">[</span><span class="mi">64</span><span class="p">]);</span>
<a name="gbab-476"></a><span class="kt">void</span> <span class="nf">oc_idct8x8_c</span><span class="p">(</span><span class="n">ogg_int16_t</span> <span class="n">_y</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span><span class="kt">int</span> <span class="n">_last_zzi</span><span class="p">);</span>
<a name="gbab-477"></a><span class="kt">void</span> <span class="nf">oc_state_frag_recon_c</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span><span class="kt">ptrdiff_t</span> <span class="n">_fragi</span><span class="p">,</span>
<a name="gbab-478"></a> <span class="kt">int</span> <span class="n">_pli</span><span class="p">,</span><span class="n">ogg_int16_t</span> <span class="n">_dct_coeffs</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span><span class="kt">int</span> <span class="n">_last_zzi</span><span class="p">,</span><span class="n">ogg_uint16_t</span> <span class="n">_dc_quant</span><span class="p">);</span>
<a name="gbab-479"></a><span class="kt">void</span> <span class="nf">oc_state_frag_copy_list_c</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span>
<a name="gbab-480"></a> <span class="k">const</span> <span class="kt">ptrdiff_t</span> <span class="o">*</span><span class="n">_fragis</span><span class="p">,</span><span class="kt">ptrdiff_t</span> <span class="n">_nfragis</span><span class="p">,</span>
<a name="gbab-481"></a> <span class="kt">int</span> <span class="n">_dst_frame</span><span class="p">,</span><span class="kt">int</span> <span class="n">_src_frame</span><span class="p">,</span><span class="kt">int</span> <span class="n">_pli</span><span class="p">);</span>
<a name="gbab-482"></a><span class="kt">void</span> <span class="nf">oc_state_loop_filter_frag_rows_c</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_theora_state</span> <span class="o">*</span><span class="n">_state</span><span class="p">,</span>
<a name="gbab-483"></a> <span class="kt">int</span> <span class="n">_bv</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span><span class="kt">int</span> <span class="n">_refi</span><span class="p">,</span><span class="kt">int</span> <span class="n">_pli</span><span class="p">,</span><span class="kt">int</span> <span class="n">_fragy0</span><span class="p">,</span><span class="kt">int</span> <span class="n">_fragy_end</span><span class="p">);</span>
<a name="gbab-484"></a><span class="kt">void</span> <span class="nf">oc_restore_fpu_c</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a name="gbab-485"></a>
<a name="gbab-486"></a><span class="cm">/*We need a way to call a few encoder functions without introducing a link-time</span>
<a name="gbab-487"></a><span class="cm">   dependency into the decoder, while still allowing the old alpha API which</span>
<a name="gbab-488"></a><span class="cm">   does not distinguish between encoder and decoder objects to be used.</span>
<a name="gbab-489"></a><span class="cm">  We do this by placing a function table at the start of the encoder object</span>
<a name="gbab-490"></a><span class="cm">   which can dispatch into the encoder library.</span>
<a name="gbab-491"></a><span class="cm">  We do a similar thing for the decoder in case we ever decide to split off a</span>
<a name="gbab-492"></a><span class="cm">   common base library.*/</span>
<a name="gbab-493"></a><span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">oc_state_clear_func</span><span class="p">)(</span><span class="n">theora_state</span> <span class="o">*</span><span class="n">_th</span><span class="p">);</span>
<a name="gbab-494"></a><span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">oc_state_control_func</span><span class="p">)(</span><span class="n">theora_state</span> <span class="o">*</span><span class="n">th</span><span class="p">,</span><span class="kt">int</span> <span class="n">_req</span><span class="p">,</span>
<a name="gbab-495"></a> <span class="kt">void</span> <span class="o">*</span><span class="n">_buf</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_buf_sz</span><span class="p">);</span>
<a name="gbab-496"></a><span class="k">typedef</span> <span class="nf">ogg_int64_t</span> <span class="p">(</span><span class="o">*</span><span class="n">oc_state_granule_frame_func</span><span class="p">)(</span><span class="n">theora_state</span> <span class="o">*</span><span class="n">_th</span><span class="p">,</span>
<a name="gbab-497"></a> <span class="n">ogg_int64_t</span> <span class="n">_granulepos</span><span class="p">);</span>
<a name="gbab-498"></a><span class="k">typedef</span> <span class="nf">double</span> <span class="p">(</span><span class="o">*</span><span class="n">oc_state_granule_time_func</span><span class="p">)(</span><span class="n">theora_state</span> <span class="o">*</span><span class="n">_th</span><span class="p">,</span>
<a name="gbab-499"></a> <span class="n">ogg_int64_t</span> <span class="n">_granulepos</span><span class="p">);</span>
<a name="gbab-500"></a>
<a name="gbab-501"></a>
<a name="gbab-502"></a><span class="k">struct</span> <span class="n">oc_state_dispatch_vtable</span><span class="p">{</span>
<a name="gbab-503"></a>  <span class="n">oc_state_clear_func</span>         <span class="n">clear</span><span class="p">;</span>
<a name="gbab-504"></a>  <span class="n">oc_state_control_func</span>       <span class="n">control</span><span class="p">;</span>
<a name="gbab-505"></a>  <span class="n">oc_state_granule_frame_func</span> <span class="n">granule_frame</span><span class="p">;</span>
<a name="gbab-506"></a>  <span class="n">oc_state_granule_time_func</span>  <span class="n">granule_time</span><span class="p">;</span>
<a name="gbab-507"></a><span class="p">};</span>
<a name="gbab-508"></a>
<a name="gbab-509"></a><span class="cp">#endif</span>
</pre></div>
</td></tr></table>