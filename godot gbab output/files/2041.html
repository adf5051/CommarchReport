<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742
743
744
745
746
747
748
749
750
751
752
753
754
755
756
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779
780
781
782
783
784
785
786
787
788
789
790
791
792
793
794
795
796
797
798
799
800
801
802
803
804
805
806
807
808
809
810
811
812
813
814
815
816
817
818
819
820
821
822
823
824
825
826
827
828
829
830
831
832
833
834
835
836
837
838
839
840
841
842
843
844
845
846
847
848
849
850
851
852
853
854
855
856
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874
875
876
877
878
879
880
881
882
883
884
885
886
887
888
889
890
891
892
893
894
895
896
897
898
899
900
901
902
903
904
905
906
907
908
909
910
911
912
913
914
915
916
917
918
919
920
921
922
923
924
925
926
927
928
929
930
931
932
933
934
935
936
937
938
939
940
941
942
943
944
945
946
947
948
949
950
951
952
953
954
955
956
957
958
959
960
961
962</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="gbab-1"></a><span class="cm">/* pngerror.c - stub functions for i/o and memory allocation</span>
<a name="gbab-2"></a><span class="cm"> *</span>
<a name="gbab-3"></a><span class="cm"> * Last changed in libpng 1.6.15 [November 20, 2014]</span>
<a name="gbab-4"></a><span class="cm"> * Copyright (c) 1998-2002,2004,2006-2014 Glenn Randers-Pehrson</span>
<a name="gbab-5"></a><span class="cm"> * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)</span>
<a name="gbab-6"></a><span class="cm"> * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)</span>
<a name="gbab-7"></a><span class="cm"> *</span>
<a name="gbab-8"></a><span class="cm"> * This code is released under the libpng license.</span>
<a name="gbab-9"></a><span class="cm"> * For conditions of distribution and use, see the disclaimer</span>
<a name="gbab-10"></a><span class="cm"> * and license in png.h</span>
<a name="gbab-11"></a><span class="cm"> *</span>
<a name="gbab-12"></a><span class="cm"> * This file provides a location for all error handling.  Users who</span>
<a name="gbab-13"></a><span class="cm"> * need special error handling are expected to write replacement functions</span>
<a name="gbab-14"></a><span class="cm"> * and use png_set_error_fn() to use those functions.  See the instructions</span>
<a name="gbab-15"></a><span class="cm"> * at each function.</span>
<a name="gbab-16"></a><span class="cm"> */</span>
<a name="gbab-17"></a>
<a name="gbab-18"></a><span class="cp">#include</span> <span class="cpf">&quot;pngpriv.h&quot;</span><span class="cp"></span>
<a name="gbab-19"></a>
<a name="gbab-20"></a><span class="cp">#if defined(PNG_READ_SUPPORTED) || defined(PNG_WRITE_SUPPORTED)</span>
<a name="gbab-21"></a>
<a name="gbab-22"></a><span class="k">static</span> <span class="nf">PNG_FUNCTION</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">png_default_error</span><span class="p">,</span><span class="n">PNGARG</span><span class="p">((</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span>
<a name="gbab-23"></a>    <span class="n">png_const_charp</span> <span class="n">error_message</span><span class="p">)),</span><span class="n">PNG_NORETURN</span><span class="p">);</span>
<a name="gbab-24"></a>
<a name="gbab-25"></a><span class="cp">#ifdef PNG_WARNINGS_SUPPORTED</span>
<a name="gbab-26"></a><span class="k">static</span> <span class="kt">void</span> <span class="cm">/* PRIVATE */</span>
<a name="gbab-27"></a><span class="n">png_default_warning</span> <span class="n">PNGARG</span><span class="p">((</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span>
<a name="gbab-28"></a>   <span class="n">png_const_charp</span> <span class="n">warning_message</span><span class="p">));</span>
<a name="gbab-29"></a><span class="cp">#endif </span><span class="cm">/* WARNINGS */</span><span class="cp"></span>
<a name="gbab-30"></a>
<a name="gbab-31"></a><span class="cm">/* This function is called whenever there is a fatal error.  This function</span>
<a name="gbab-32"></a><span class="cm"> * should not be changed.  If there is a need to handle errors differently,</span>
<a name="gbab-33"></a><span class="cm"> * you should supply a replacement error function and use png_set_error_fn()</span>
<a name="gbab-34"></a><span class="cm"> * to replace the error function at run-time.</span>
<a name="gbab-35"></a><span class="cm"> */</span>
<a name="gbab-36"></a><span class="cp">#ifdef PNG_ERROR_TEXT_SUPPORTED</span>
<a name="gbab-37"></a><span class="n">PNG_FUNCTION</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span><span class="n">PNGAPI</span>
<a name="gbab-38"></a><span class="n">png_error</span><span class="p">,(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">error_message</span><span class="p">),</span>
<a name="gbab-39"></a>   <span class="n">PNG_NORETURN</span><span class="p">)</span>
<a name="gbab-40"></a><span class="p">{</span>
<a name="gbab-41"></a><span class="cp">#ifdef PNG_ERROR_NUMBERS_SUPPORTED</span>
<a name="gbab-42"></a>   <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<a name="gbab-43"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-44"></a>   <span class="p">{</span>
<a name="gbab-45"></a>      <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
<a name="gbab-46"></a>         <span class="p">(</span><span class="n">PNG_FLAG_STRIP_ERROR_NUMBERS</span><span class="o">|</span><span class="n">PNG_FLAG_STRIP_ERROR_TEXT</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-47"></a>      <span class="p">{</span>
<a name="gbab-48"></a>         <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">error_message</span> <span class="o">==</span> <span class="n">PNG_LITERAL_SHARP</span><span class="p">)</span>
<a name="gbab-49"></a>         <span class="p">{</span>
<a name="gbab-50"></a>            <span class="cm">/* Strip &quot;#nnnn &quot; from beginning of error message. */</span>
<a name="gbab-51"></a>            <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<a name="gbab-52"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">offset</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span>
<a name="gbab-53"></a>               <span class="k">if</span> <span class="p">(</span><span class="n">error_message</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
<a name="gbab-54"></a>                  <span class="k">break</span><span class="p">;</span>
<a name="gbab-55"></a>
<a name="gbab-56"></a>            <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PNG_FLAG_STRIP_ERROR_TEXT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-57"></a>            <span class="p">{</span>
<a name="gbab-58"></a>               <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="gbab-59"></a>               <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="gbab-60"></a>                  <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_message</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<a name="gbab-61"></a>               <span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="gbab-62"></a>               <span class="n">error_message</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
<a name="gbab-63"></a>            <span class="p">}</span>
<a name="gbab-64"></a>
<a name="gbab-65"></a>            <span class="k">else</span>
<a name="gbab-66"></a>               <span class="n">error_message</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
<a name="gbab-67"></a>      <span class="p">}</span>
<a name="gbab-68"></a>
<a name="gbab-69"></a>      <span class="k">else</span>
<a name="gbab-70"></a>      <span class="p">{</span>
<a name="gbab-71"></a>         <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PNG_FLAG_STRIP_ERROR_TEXT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-72"></a>         <span class="p">{</span>
<a name="gbab-73"></a>            <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
<a name="gbab-74"></a>            <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="gbab-75"></a>            <span class="n">error_message</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
<a name="gbab-76"></a>         <span class="p">}</span>
<a name="gbab-77"></a>       <span class="p">}</span>
<a name="gbab-78"></a>     <span class="p">}</span>
<a name="gbab-79"></a>   <span class="p">}</span>
<a name="gbab-80"></a><span class="cp">#endif</span>
<a name="gbab-81"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">error_fn</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-82"></a>      <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">error_fn</span><span class="p">))(</span><span class="n">png_constcast</span><span class="p">(</span><span class="n">png_structrp</span><span class="p">,</span><span class="n">png_ptr</span><span class="p">),</span>
<a name="gbab-83"></a>          <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-84"></a>
<a name="gbab-85"></a>   <span class="cm">/* If the custom handler doesn&#39;t exist, or if it returns,</span>
<a name="gbab-86"></a><span class="cm">      use the default handler, which will not return. */</span>
<a name="gbab-87"></a>   <span class="n">png_default_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-88"></a><span class="p">}</span>
<a name="gbab-89"></a><span class="cp">#else</span>
<a name="gbab-90"></a><span class="n">PNG_FUNCTION</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span><span class="n">PNGAPI</span>
<a name="gbab-91"></a><span class="n">png_err</span><span class="p">,(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">),</span><span class="n">PNG_NORETURN</span><span class="p">)</span>
<a name="gbab-92"></a><span class="p">{</span>
<a name="gbab-93"></a>   <span class="cm">/* Prior to 1.5.2 the error_fn received a NULL pointer, expressed</span>
<a name="gbab-94"></a><span class="cm">    * erroneously as &#39;\0&#39;, instead of the empty string &quot;&quot;.  This was</span>
<a name="gbab-95"></a><span class="cm">    * apparently an error, introduced in libpng-1.2.20, and png_default_error</span>
<a name="gbab-96"></a><span class="cm">    * will crash in this case.</span>
<a name="gbab-97"></a><span class="cm">    */</span>
<a name="gbab-98"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">error_fn</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-99"></a>      <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">error_fn</span><span class="p">))(</span><span class="n">png_constcast</span><span class="p">(</span><span class="n">png_structrp</span><span class="p">,</span><span class="n">png_ptr</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<a name="gbab-100"></a>
<a name="gbab-101"></a>   <span class="cm">/* If the custom handler doesn&#39;t exist, or if it returns,</span>
<a name="gbab-102"></a><span class="cm">      use the default handler, which will not return. */</span>
<a name="gbab-103"></a>   <span class="n">png_default_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<a name="gbab-104"></a><span class="p">}</span>
<a name="gbab-105"></a><span class="cp">#endif </span><span class="cm">/* ERROR_TEXT */</span><span class="cp"></span>
<a name="gbab-106"></a>
<a name="gbab-107"></a><span class="cm">/* Utility to safely appends strings to a buffer.  This never errors out so</span>
<a name="gbab-108"></a><span class="cm"> * error checking is not required in the caller.</span>
<a name="gbab-109"></a><span class="cm"> */</span>
<a name="gbab-110"></a><span class="kt">size_t</span>
<a name="gbab-111"></a><span class="n">png_safecat</span><span class="p">(</span><span class="n">png_charp</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bufsize</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">pos</span><span class="p">,</span>
<a name="gbab-112"></a>   <span class="n">png_const_charp</span> <span class="n">string</span><span class="p">)</span>
<a name="gbab-113"></a><span class="p">{</span>
<a name="gbab-114"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">bufsize</span><span class="p">)</span>
<a name="gbab-115"></a>   <span class="p">{</span>
<a name="gbab-116"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-117"></a>         <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">string</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">bufsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="gbab-118"></a>           <span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">string</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-119"></a>
<a name="gbab-120"></a>      <span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="gbab-121"></a>   <span class="p">}</span>
<a name="gbab-122"></a>
<a name="gbab-123"></a>   <span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<a name="gbab-124"></a><span class="p">}</span>
<a name="gbab-125"></a>
<a name="gbab-126"></a><span class="cp">#if defined(PNG_WARNINGS_SUPPORTED) || defined(PNG_TIME_RFC1123_SUPPORTED)</span>
<a name="gbab-127"></a><span class="cm">/* Utility to dump an unsigned value into a buffer, given a start pointer and</span>
<a name="gbab-128"></a><span class="cm"> * and end pointer (which should point just *beyond* the end of the buffer!)</span>
<a name="gbab-129"></a><span class="cm"> * Returns the pointer to the start of the formatted string.</span>
<a name="gbab-130"></a><span class="cm"> */</span>
<a name="gbab-131"></a><span class="n">png_charp</span>
<a name="gbab-132"></a><span class="n">png_format_number</span><span class="p">(</span><span class="n">png_const_charp</span> <span class="n">start</span><span class="p">,</span> <span class="n">png_charp</span> <span class="n">end</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
<a name="gbab-133"></a>   <span class="n">png_alloc_size_t</span> <span class="n">number</span><span class="p">)</span>
<a name="gbab-134"></a><span class="p">{</span>
<a name="gbab-135"></a>   <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* number of digits output */</span>
<a name="gbab-136"></a>   <span class="kt">int</span> <span class="n">mincount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* minimum number required */</span>
<a name="gbab-137"></a>   <span class="kt">int</span> <span class="n">output</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* digit output (for the fixed point format) */</span>
<a name="gbab-138"></a>
<a name="gbab-139"></a>   <span class="o">*--</span><span class="n">end</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="gbab-140"></a>
<a name="gbab-141"></a>   <span class="cm">/* This is written so that the loop always runs at least once, even with</span>
<a name="gbab-142"></a><span class="cm">    * number zero.</span>
<a name="gbab-143"></a><span class="cm">    */</span>
<a name="gbab-144"></a>   <span class="k">while</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">number</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">mincount</span><span class="p">))</span>
<a name="gbab-145"></a>   <span class="p">{</span>
<a name="gbab-146"></a>
<a name="gbab-147"></a>      <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">digits</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;0123456789ABCDEF&quot;</span><span class="p">;</span>
<a name="gbab-148"></a>
<a name="gbab-149"></a>      <span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span>
<a name="gbab-150"></a>      <span class="p">{</span>
<a name="gbab-151"></a>         <span class="k">case</span> <span class="nl">PNG_NUMBER_FORMAT_fixed</span><span class="p">:</span>
<a name="gbab-152"></a>            <span class="cm">/* Needs five digits (the fraction) */</span>
<a name="gbab-153"></a>            <span class="n">mincount</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<a name="gbab-154"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">output</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">number</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-155"></a>            <span class="p">{</span>
<a name="gbab-156"></a>               <span class="o">*--</span><span class="n">end</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">number</span> <span class="o">%</span> <span class="mi">10</span><span class="p">];</span>
<a name="gbab-157"></a>               <span class="n">output</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-158"></a>            <span class="p">}</span>
<a name="gbab-159"></a>            <span class="n">number</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
<a name="gbab-160"></a>            <span class="k">break</span><span class="p">;</span>
<a name="gbab-161"></a>
<a name="gbab-162"></a>         <span class="k">case</span> <span class="nl">PNG_NUMBER_FORMAT_02u</span><span class="p">:</span>
<a name="gbab-163"></a>            <span class="cm">/* Expects at least 2 digits. */</span>
<a name="gbab-164"></a>            <span class="n">mincount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="gbab-165"></a>            <span class="cm">/* FALL THROUGH */</span>
<a name="gbab-166"></a>
<a name="gbab-167"></a>         <span class="k">case</span> <span class="nl">PNG_NUMBER_FORMAT_u</span><span class="p">:</span>
<a name="gbab-168"></a>            <span class="o">*--</span><span class="n">end</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">number</span> <span class="o">%</span> <span class="mi">10</span><span class="p">];</span>
<a name="gbab-169"></a>            <span class="n">number</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
<a name="gbab-170"></a>            <span class="k">break</span><span class="p">;</span>
<a name="gbab-171"></a>
<a name="gbab-172"></a>         <span class="k">case</span> <span class="nl">PNG_NUMBER_FORMAT_02x</span><span class="p">:</span>
<a name="gbab-173"></a>            <span class="cm">/* This format expects at least two digits */</span>
<a name="gbab-174"></a>            <span class="n">mincount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="gbab-175"></a>            <span class="cm">/* FALL THROUGH */</span>
<a name="gbab-176"></a>
<a name="gbab-177"></a>         <span class="k">case</span> <span class="nl">PNG_NUMBER_FORMAT_x</span><span class="p">:</span>
<a name="gbab-178"></a>            <span class="o">*--</span><span class="n">end</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
<a name="gbab-179"></a>            <span class="n">number</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
<a name="gbab-180"></a>            <span class="k">break</span><span class="p">;</span>
<a name="gbab-181"></a>
<a name="gbab-182"></a>         <span class="k">default</span><span class="o">:</span> <span class="cm">/* an error */</span>
<a name="gbab-183"></a>            <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-184"></a>            <span class="k">break</span><span class="p">;</span>
<a name="gbab-185"></a>      <span class="p">}</span>
<a name="gbab-186"></a>
<a name="gbab-187"></a>      <span class="cm">/* Keep track of the number of digits added */</span>
<a name="gbab-188"></a>      <span class="o">++</span><span class="n">count</span><span class="p">;</span>
<a name="gbab-189"></a>
<a name="gbab-190"></a>      <span class="cm">/* Float a fixed number here: */</span>
<a name="gbab-191"></a>      <span class="k">if</span> <span class="p">((</span><span class="n">format</span> <span class="o">==</span> <span class="n">PNG_NUMBER_FORMAT_fixed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">))</span>
<a name="gbab-192"></a>      <span class="p">{</span>
<a name="gbab-193"></a>         <span class="cm">/* End of the fraction, but maybe nothing was output?  In that case</span>
<a name="gbab-194"></a><span class="cm">          * drop the decimal point.  If the number is a true zero handle that</span>
<a name="gbab-195"></a><span class="cm">          * here.</span>
<a name="gbab-196"></a><span class="cm">          */</span>
<a name="gbab-197"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">output</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-198"></a>            <span class="o">*--</span><span class="n">end</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
<a name="gbab-199"></a>         <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* and !output */</span>
<a name="gbab-200"></a>            <span class="o">*--</span><span class="n">end</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
<a name="gbab-201"></a>      <span class="p">}</span>
<a name="gbab-202"></a>   <span class="p">}</span>
<a name="gbab-203"></a>
<a name="gbab-204"></a>   <span class="k">return</span> <span class="n">end</span><span class="p">;</span>
<a name="gbab-205"></a><span class="p">}</span>
<a name="gbab-206"></a><span class="cp">#endif</span>
<a name="gbab-207"></a>
<a name="gbab-208"></a><span class="cp">#ifdef PNG_WARNINGS_SUPPORTED</span>
<a name="gbab-209"></a><span class="cm">/* This function is called whenever there is a non-fatal error.  This function</span>
<a name="gbab-210"></a><span class="cm"> * should not be changed.  If there is a need to handle warnings differently,</span>
<a name="gbab-211"></a><span class="cm"> * you should supply a replacement warning function and use</span>
<a name="gbab-212"></a><span class="cm"> * png_set_error_fn() to replace the warning function at run-time.</span>
<a name="gbab-213"></a><span class="cm"> */</span>
<a name="gbab-214"></a><span class="kt">void</span> <span class="n">PNGAPI</span>
<a name="gbab-215"></a><span class="n">png_warning</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">warning_message</span><span class="p">)</span>
<a name="gbab-216"></a><span class="p">{</span>
<a name="gbab-217"></a>   <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-218"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-219"></a>   <span class="p">{</span>
<a name="gbab-220"></a><span class="cp">#ifdef PNG_ERROR_NUMBERS_SUPPORTED</span>
<a name="gbab-221"></a>   <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
<a name="gbab-222"></a>       <span class="p">(</span><span class="n">PNG_FLAG_STRIP_ERROR_NUMBERS</span><span class="o">|</span><span class="n">PNG_FLAG_STRIP_ERROR_TEXT</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-223"></a><span class="cp">#endif</span>
<a name="gbab-224"></a>      <span class="p">{</span>
<a name="gbab-225"></a>         <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">warning_message</span> <span class="o">==</span> <span class="n">PNG_LITERAL_SHARP</span><span class="p">)</span>
<a name="gbab-226"></a>         <span class="p">{</span>
<a name="gbab-227"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span>
<a name="gbab-228"></a>               <span class="k">if</span> <span class="p">(</span><span class="n">warning_message</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
<a name="gbab-229"></a>                  <span class="k">break</span><span class="p">;</span>
<a name="gbab-230"></a>         <span class="p">}</span>
<a name="gbab-231"></a>      <span class="p">}</span>
<a name="gbab-232"></a>   <span class="p">}</span>
<a name="gbab-233"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">warning_fn</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-234"></a>      <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">warning_fn</span><span class="p">))(</span><span class="n">png_constcast</span><span class="p">(</span><span class="n">png_structrp</span><span class="p">,</span><span class="n">png_ptr</span><span class="p">),</span>
<a name="gbab-235"></a>         <span class="n">warning_message</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<a name="gbab-236"></a>   <span class="k">else</span>
<a name="gbab-237"></a>      <span class="nf">png_default_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">warning_message</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<a name="gbab-238"></a><span class="p">}</span>
<a name="gbab-239"></a>
<a name="gbab-240"></a><span class="cm">/* These functions support &#39;formatted&#39; warning messages with up to</span>
<a name="gbab-241"></a><span class="cm"> * PNG_WARNING_PARAMETER_COUNT parameters.  In the format string the parameter</span>
<a name="gbab-242"></a><span class="cm"> * is introduced by @&lt;number&gt;, where &#39;number&#39; starts at 1.  This follows the</span>
<a name="gbab-243"></a><span class="cm"> * standard established by X/Open for internationalizable error messages.</span>
<a name="gbab-244"></a><span class="cm"> */</span>
<a name="gbab-245"></a><span class="kt">void</span>
<a name="gbab-246"></a><span class="n">png_warning_parameter</span><span class="p">(</span><span class="n">png_warning_parameters</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number</span><span class="p">,</span>
<a name="gbab-247"></a>   <span class="n">png_const_charp</span> <span class="n">string</span><span class="p">)</span>
<a name="gbab-248"></a><span class="p">{</span>
<a name="gbab-249"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">number</span> <span class="o">&lt;=</span> <span class="n">PNG_WARNING_PARAMETER_COUNT</span><span class="p">)</span>
<a name="gbab-250"></a>      <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">png_safecat</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">number</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">p</span><span class="p">[</span><span class="n">number</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
<a name="gbab-251"></a><span class="p">}</span>
<a name="gbab-252"></a>
<a name="gbab-253"></a><span class="kt">void</span>
<a name="gbab-254"></a><span class="n">png_warning_parameter_unsigned</span><span class="p">(</span><span class="n">png_warning_parameters</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
<a name="gbab-255"></a>   <span class="n">png_alloc_size_t</span> <span class="n">value</span><span class="p">)</span>
<a name="gbab-256"></a><span class="p">{</span>
<a name="gbab-257"></a>   <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">PNG_NUMBER_BUFFER_SIZE</span><span class="p">];</span>
<a name="gbab-258"></a>   <span class="n">png_warning_parameter</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">PNG_FORMAT_NUMBER</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>
<a name="gbab-259"></a><span class="p">}</span>
<a name="gbab-260"></a>
<a name="gbab-261"></a><span class="kt">void</span>
<a name="gbab-262"></a><span class="n">png_warning_parameter_signed</span><span class="p">(</span><span class="n">png_warning_parameters</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
<a name="gbab-263"></a>   <span class="n">png_int_32</span> <span class="n">value</span><span class="p">)</span>
<a name="gbab-264"></a><span class="p">{</span>
<a name="gbab-265"></a>   <span class="n">png_alloc_size_t</span> <span class="n">u</span><span class="p">;</span>
<a name="gbab-266"></a>   <span class="n">png_charp</span> <span class="n">str</span><span class="p">;</span>
<a name="gbab-267"></a>   <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">PNG_NUMBER_BUFFER_SIZE</span><span class="p">];</span>
<a name="gbab-268"></a>
<a name="gbab-269"></a>   <span class="cm">/* Avoid overflow by doing the negate in a png_alloc_size_t: */</span>
<a name="gbab-270"></a>   <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">png_alloc_size_t</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
<a name="gbab-271"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-272"></a>      <span class="n">u</span> <span class="o">=</span> <span class="o">~</span><span class="n">u</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-273"></a>
<a name="gbab-274"></a>   <span class="n">str</span> <span class="o">=</span> <span class="n">PNG_FORMAT_NUMBER</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>
<a name="gbab-275"></a>
<a name="gbab-276"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">str</span> <span class="o">&gt;</span> <span class="n">buffer</span><span class="p">)</span>
<a name="gbab-277"></a>      <span class="o">*--</span><span class="n">str</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
<a name="gbab-278"></a>
<a name="gbab-279"></a>   <span class="n">png_warning_parameter</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
<a name="gbab-280"></a><span class="p">}</span>
<a name="gbab-281"></a>
<a name="gbab-282"></a><span class="kt">void</span>
<a name="gbab-283"></a><span class="n">png_formatted_warning</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_warning_parameters</span> <span class="n">p</span><span class="p">,</span>
<a name="gbab-284"></a>   <span class="n">png_const_charp</span> <span class="n">message</span><span class="p">)</span>
<a name="gbab-285"></a><span class="p">{</span>
<a name="gbab-286"></a>   <span class="cm">/* The internal buffer is just 192 bytes - enough for all our messages,</span>
<a name="gbab-287"></a><span class="cm">    * overflow doesn&#39;t happen because this code checks!  If someone figures</span>
<a name="gbab-288"></a><span class="cm">    * out how to send us a message longer than 192 bytes, all that will</span>
<a name="gbab-289"></a><span class="cm">    * happen is that the message will be truncated appropriately.</span>
<a name="gbab-290"></a><span class="cm">    */</span>
<a name="gbab-291"></a>   <span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Index in the msg[] buffer: */</span>
<a name="gbab-292"></a>   <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">192</span><span class="p">];</span>
<a name="gbab-293"></a>
<a name="gbab-294"></a>   <span class="cm">/* Each iteration through the following loop writes at most one character</span>
<a name="gbab-295"></a><span class="cm">    * to msg[i++] then returns here to validate that there is still space for</span>
<a name="gbab-296"></a><span class="cm">    * the trailing &#39;\0&#39;.  It may (in the case of a parameter) read more than</span>
<a name="gbab-297"></a><span class="cm">    * one character from message[]; it must check for &#39;\0&#39; and continue to the</span>
<a name="gbab-298"></a><span class="cm">    * test if it finds the end of string.</span>
<a name="gbab-299"></a><span class="cm">    */</span>
<a name="gbab-300"></a>   <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">msg</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">message</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
<a name="gbab-301"></a>      <span class="p">{</span>
<a name="gbab-302"></a>      <span class="cm">/* &#39;@&#39; at end of string is now just printed (previously it was skipped);</span>
<a name="gbab-303"></a><span class="cm">       * it is an error in the calling code to terminate the string with @.</span>
<a name="gbab-304"></a><span class="cm">       */</span>
<a name="gbab-305"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">message</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
<a name="gbab-306"></a>         <span class="p">{</span>
<a name="gbab-307"></a>         <span class="kt">int</span> <span class="n">parameter_char</span> <span class="o">=</span> <span class="o">*++</span><span class="n">message</span><span class="p">;</span> <span class="cm">/* Consume the &#39;@&#39; */</span>
<a name="gbab-308"></a>         <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">valid_parameters</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;123456789&quot;</span><span class="p">;</span>
<a name="gbab-309"></a>         <span class="kt">int</span> <span class="n">parameter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-310"></a>
<a name="gbab-311"></a>         <span class="cm">/* Search for the parameter digit, the index in the string is the</span>
<a name="gbab-312"></a><span class="cm">          * parameter to use.</span>
<a name="gbab-313"></a><span class="cm">          */</span>
<a name="gbab-314"></a>         <span class="k">while</span> <span class="p">(</span><span class="n">valid_parameters</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">!=</span> <span class="n">parameter_char</span> <span class="o">&amp;&amp;</span>
<a name="gbab-315"></a>            <span class="n">valid_parameters</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
<a name="gbab-316"></a>            <span class="o">++</span><span class="n">parameter</span><span class="p">;</span>
<a name="gbab-317"></a>
<a name="gbab-318"></a>         <span class="cm">/* If the parameter digit is out of range it will just get printed. */</span>
<a name="gbab-319"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">parameter</span> <span class="o">&lt;</span> <span class="n">PNG_WARNING_PARAMETER_COUNT</span><span class="p">)</span>
<a name="gbab-320"></a>         <span class="p">{</span>
<a name="gbab-321"></a>            <span class="cm">/* Append this parameter */</span>
<a name="gbab-322"></a>            <span class="n">png_const_charp</span> <span class="n">parm</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">parameter</span><span class="p">];</span>
<a name="gbab-323"></a>            <span class="n">png_const_charp</span> <span class="n">pend</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">p</span><span class="p">[</span><span class="n">parameter</span><span class="p">]);</span>
<a name="gbab-324"></a>
<a name="gbab-325"></a>            <span class="cm">/* No need to copy the trailing &#39;\0&#39; here, but there is no guarantee</span>
<a name="gbab-326"></a><span class="cm">             * that parm[] has been initialized, so there is no guarantee of a</span>
<a name="gbab-327"></a><span class="cm">             * trailing &#39;\0&#39;:</span>
<a name="gbab-328"></a><span class="cm">             */</span>
<a name="gbab-329"></a>            <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">msg</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">parm</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">parm</span> <span class="o">&lt;</span> <span class="n">pend</span><span class="p">)</span>
<a name="gbab-330"></a>               <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">parm</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-331"></a>
<a name="gbab-332"></a>            <span class="cm">/* Consume the parameter digit too: */</span>
<a name="gbab-333"></a>            <span class="o">++</span><span class="n">message</span><span class="p">;</span>
<a name="gbab-334"></a>            <span class="k">continue</span><span class="p">;</span>
<a name="gbab-335"></a>         <span class="p">}</span>
<a name="gbab-336"></a>
<a name="gbab-337"></a>         <span class="cm">/* else not a parameter and there is a character after the @ sign; just</span>
<a name="gbab-338"></a><span class="cm">          * copy that.  This is known not to be &#39;\0&#39; because of the test above.</span>
<a name="gbab-339"></a><span class="cm">          */</span>
<a name="gbab-340"></a>      <span class="p">}</span>
<a name="gbab-341"></a>
<a name="gbab-342"></a>      <span class="cm">/* At this point *message can&#39;t be &#39;\0&#39;, even in the bad parameter case</span>
<a name="gbab-343"></a><span class="cm">       * above where there is a lone &#39;@&#39; at the end of the message string.</span>
<a name="gbab-344"></a><span class="cm">       */</span>
<a name="gbab-345"></a>      <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">message</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-346"></a>   <span class="p">}</span>
<a name="gbab-347"></a>
<a name="gbab-348"></a>   <span class="cm">/* i is always less than (sizeof msg), so: */</span>
<a name="gbab-349"></a>   <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="gbab-350"></a>
<a name="gbab-351"></a>   <span class="cm">/* And this is the formatted message. It may be larger than</span>
<a name="gbab-352"></a><span class="cm">    * PNG_MAX_ERROR_TEXT, but that is only used for &#39;chunk&#39; errors and these</span>
<a name="gbab-353"></a><span class="cm">    * are not (currently) formatted.</span>
<a name="gbab-354"></a><span class="cm">    */</span>
<a name="gbab-355"></a>   <span class="n">png_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<a name="gbab-356"></a><span class="p">}</span>
<a name="gbab-357"></a><span class="cp">#endif </span><span class="cm">/* WARNINGS */</span><span class="cp"></span>
<a name="gbab-358"></a>
<a name="gbab-359"></a><span class="cp">#ifdef PNG_BENIGN_ERRORS_SUPPORTED</span>
<a name="gbab-360"></a><span class="kt">void</span> <span class="n">PNGAPI</span>
<a name="gbab-361"></a><span class="n">png_benign_error</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">error_message</span><span class="p">)</span>
<a name="gbab-362"></a><span class="p">{</span>
<a name="gbab-363"></a>   <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PNG_FLAG_BENIGN_ERRORS_WARN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-364"></a>   <span class="p">{</span>
<a name="gbab-365"></a><span class="cp">#     ifdef PNG_READ_SUPPORTED</span>
<a name="gbab-366"></a>         <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">PNG_IS_READ_STRUCT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="gbab-367"></a>            <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">chunk_name</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-368"></a>            <span class="n">png_chunk_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-369"></a>         <span class="k">else</span>
<a name="gbab-370"></a><span class="cp">#     endif</span>
<a name="gbab-371"></a>      <span class="n">png_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-372"></a>   <span class="p">}</span>
<a name="gbab-373"></a>
<a name="gbab-374"></a>   <span class="k">else</span>
<a name="gbab-375"></a>   <span class="p">{</span>
<a name="gbab-376"></a><span class="cp">#     ifdef PNG_READ_SUPPORTED</span>
<a name="gbab-377"></a>         <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">PNG_IS_READ_STRUCT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="gbab-378"></a>            <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">chunk_name</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-379"></a>            <span class="n">png_chunk_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-380"></a>         <span class="k">else</span>
<a name="gbab-381"></a><span class="cp">#     endif</span>
<a name="gbab-382"></a>      <span class="n">png_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-383"></a>   <span class="p">}</span>
<a name="gbab-384"></a>
<a name="gbab-385"></a><span class="cp">#  ifndef PNG_ERROR_TEXT_SUPPORTED</span>
<a name="gbab-386"></a>      <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
<a name="gbab-387"></a><span class="cp">#  endif</span>
<a name="gbab-388"></a><span class="p">}</span>
<a name="gbab-389"></a>
<a name="gbab-390"></a><span class="kt">void</span> <span class="cm">/* PRIVATE */</span>
<a name="gbab-391"></a><span class="n">png_app_warning</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">error_message</span><span class="p">)</span>
<a name="gbab-392"></a><span class="p">{</span>
<a name="gbab-393"></a>  <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PNG_FLAG_APP_WARNINGS_WARN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-394"></a>     <span class="n">png_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-395"></a>  <span class="k">else</span>
<a name="gbab-396"></a>     <span class="nf">png_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-397"></a>
<a name="gbab-398"></a><span class="cp">#  ifndef PNG_ERROR_TEXT_SUPPORTED</span>
<a name="gbab-399"></a>      <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
<a name="gbab-400"></a><span class="cp">#  endif</span>
<a name="gbab-401"></a><span class="p">}</span>
<a name="gbab-402"></a>
<a name="gbab-403"></a><span class="kt">void</span> <span class="cm">/* PRIVATE */</span>
<a name="gbab-404"></a><span class="n">png_app_error</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">error_message</span><span class="p">)</span>
<a name="gbab-405"></a><span class="p">{</span>
<a name="gbab-406"></a>  <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PNG_FLAG_APP_ERRORS_WARN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-407"></a>     <span class="n">png_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-408"></a>  <span class="k">else</span>
<a name="gbab-409"></a>     <span class="nf">png_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-410"></a>
<a name="gbab-411"></a><span class="cp">#  ifndef PNG_ERROR_TEXT_SUPPORTED</span>
<a name="gbab-412"></a>      <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
<a name="gbab-413"></a><span class="cp">#endif</span>
<a name="gbab-414"></a><span class="p">}</span>
<a name="gbab-415"></a><span class="cp">#endif </span><span class="cm">/* BENIGN_ERRORS */</span><span class="cp"></span>
<a name="gbab-416"></a>
<a name="gbab-417"></a><span class="cp">#define PNG_MAX_ERROR_TEXT 196 </span><span class="cm">/* Currently limited by profile_error in png.c */</span><span class="cp"></span>
<a name="gbab-418"></a><span class="cp">#if defined(PNG_WARNINGS_SUPPORTED) || \</span>
<a name="gbab-419"></a><span class="cp">   (defined(PNG_READ_SUPPORTED) &amp;&amp; defined(PNG_ERROR_TEXT_SUPPORTED))</span>
<a name="gbab-420"></a><span class="cm">/* These utilities are used internally to build an error message that relates</span>
<a name="gbab-421"></a><span class="cm"> * to the current chunk.  The chunk name comes from png_ptr-&gt;chunk_name,</span>
<a name="gbab-422"></a><span class="cm"> * which is used to prefix the message.  The message is limited in length</span>
<a name="gbab-423"></a><span class="cm"> * to 63 bytes. The name characters are output as hex digits wrapped in []</span>
<a name="gbab-424"></a><span class="cm"> * if the character is invalid.</span>
<a name="gbab-425"></a><span class="cm"> */</span>
<a name="gbab-426"></a><span class="cp">#define isnonalpha(c) ((c) &lt; 65 || (c) &gt; 122 || ((c) &gt; 90 &amp;&amp; (c) &lt; 97))</span>
<a name="gbab-427"></a><span class="k">static</span> <span class="n">PNG_CONST</span> <span class="kt">char</span> <span class="n">png_digit</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a name="gbab-428"></a>   <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span>
<a name="gbab-429"></a>   <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span>
<a name="gbab-430"></a><span class="p">};</span>
<a name="gbab-431"></a>
<a name="gbab-432"></a><span class="k">static</span> <span class="kt">void</span> <span class="cm">/* PRIVATE */</span>
<a name="gbab-433"></a><span class="n">png_format_buffer</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_charp</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">png_const_charp</span>
<a name="gbab-434"></a>    <span class="n">error_message</span><span class="p">)</span>
<a name="gbab-435"></a><span class="p">{</span>
<a name="gbab-436"></a>   <span class="n">png_uint_32</span> <span class="n">chunk_name</span> <span class="o">=</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">chunk_name</span><span class="p">;</span>
<a name="gbab-437"></a>   <span class="kt">int</span> <span class="n">iout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ishift</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
<a name="gbab-438"></a>
<a name="gbab-439"></a>   <span class="k">while</span> <span class="p">(</span><span class="n">ishift</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-440"></a>   <span class="p">{</span>
<a name="gbab-441"></a>      <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">chunk_name</span> <span class="o">&gt;&gt;</span> <span class="n">ishift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<a name="gbab-442"></a>
<a name="gbab-443"></a>      <span class="n">ishift</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
<a name="gbab-444"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">isnonalpha</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-445"></a>      <span class="p">{</span>
<a name="gbab-446"></a>         <span class="n">buffer</span><span class="p">[</span><span class="n">iout</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">PNG_LITERAL_LEFT_SQUARE_BRACKET</span><span class="p">;</span>
<a name="gbab-447"></a>         <span class="n">buffer</span><span class="p">[</span><span class="n">iout</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">png_digit</span><span class="p">[(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
<a name="gbab-448"></a>         <span class="n">buffer</span><span class="p">[</span><span class="n">iout</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">png_digit</span><span class="p">[</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">];</span>
<a name="gbab-449"></a>         <span class="n">buffer</span><span class="p">[</span><span class="n">iout</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">PNG_LITERAL_RIGHT_SQUARE_BRACKET</span><span class="p">;</span>
<a name="gbab-450"></a>      <span class="p">}</span>
<a name="gbab-451"></a>
<a name="gbab-452"></a>      <span class="k">else</span>
<a name="gbab-453"></a>      <span class="p">{</span>
<a name="gbab-454"></a>         <span class="n">buffer</span><span class="p">[</span><span class="n">iout</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
<a name="gbab-455"></a>      <span class="p">}</span>
<a name="gbab-456"></a>   <span class="p">}</span>
<a name="gbab-457"></a>
<a name="gbab-458"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">error_message</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-459"></a>      <span class="n">buffer</span><span class="p">[</span><span class="n">iout</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="gbab-460"></a>
<a name="gbab-461"></a>   <span class="k">else</span>
<a name="gbab-462"></a>   <span class="p">{</span>
<a name="gbab-463"></a>      <span class="kt">int</span> <span class="n">iin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-464"></a>
<a name="gbab-465"></a>      <span class="n">buffer</span><span class="p">[</span><span class="n">iout</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
<a name="gbab-466"></a>      <span class="n">buffer</span><span class="p">[</span><span class="n">iout</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
<a name="gbab-467"></a>
<a name="gbab-468"></a>      <span class="k">while</span> <span class="p">(</span><span class="n">iin</span> <span class="o">&lt;</span> <span class="n">PNG_MAX_ERROR_TEXT</span><span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">error_message</span><span class="p">[</span><span class="n">iin</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
<a name="gbab-469"></a>         <span class="n">buffer</span><span class="p">[</span><span class="n">iout</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_message</span><span class="p">[</span><span class="n">iin</span><span class="o">++</span><span class="p">];</span>
<a name="gbab-470"></a>
<a name="gbab-471"></a>      <span class="cm">/* iin &lt; PNG_MAX_ERROR_TEXT, so the following is safe: */</span>
<a name="gbab-472"></a>      <span class="n">buffer</span><span class="p">[</span><span class="n">iout</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="gbab-473"></a>   <span class="p">}</span>
<a name="gbab-474"></a><span class="p">}</span>
<a name="gbab-475"></a><span class="cp">#endif </span><span class="cm">/* WARNINGS || ERROR_TEXT */</span><span class="cp"></span>
<a name="gbab-476"></a>
<a name="gbab-477"></a><span class="cp">#if defined(PNG_READ_SUPPORTED) &amp;&amp; defined(PNG_ERROR_TEXT_SUPPORTED)</span>
<a name="gbab-478"></a><span class="n">PNG_FUNCTION</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span><span class="n">PNGAPI</span>
<a name="gbab-479"></a><span class="n">png_chunk_error</span><span class="p">,(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">error_message</span><span class="p">),</span>
<a name="gbab-480"></a>   <span class="n">PNG_NORETURN</span><span class="p">)</span>
<a name="gbab-481"></a><span class="p">{</span>
<a name="gbab-482"></a>   <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">18</span><span class="o">+</span><span class="n">PNG_MAX_ERROR_TEXT</span><span class="p">];</span>
<a name="gbab-483"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-484"></a>      <span class="n">png_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-485"></a>
<a name="gbab-486"></a>   <span class="k">else</span>
<a name="gbab-487"></a>   <span class="p">{</span>
<a name="gbab-488"></a>      <span class="n">png_format_buffer</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-489"></a>      <span class="n">png_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<a name="gbab-490"></a>   <span class="p">}</span>
<a name="gbab-491"></a><span class="p">}</span>
<a name="gbab-492"></a><span class="cp">#endif </span><span class="cm">/* READ &amp;&amp; ERROR_TEXT */</span><span class="cp"></span>
<a name="gbab-493"></a>
<a name="gbab-494"></a><span class="cp">#ifdef PNG_WARNINGS_SUPPORTED</span>
<a name="gbab-495"></a><span class="kt">void</span> <span class="n">PNGAPI</span>
<a name="gbab-496"></a><span class="n">png_chunk_warning</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">warning_message</span><span class="p">)</span>
<a name="gbab-497"></a><span class="p">{</span>
<a name="gbab-498"></a>   <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">18</span><span class="o">+</span><span class="n">PNG_MAX_ERROR_TEXT</span><span class="p">];</span>
<a name="gbab-499"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-500"></a>      <span class="n">png_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">);</span>
<a name="gbab-501"></a>
<a name="gbab-502"></a>   <span class="k">else</span>
<a name="gbab-503"></a>   <span class="p">{</span>
<a name="gbab-504"></a>      <span class="n">png_format_buffer</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">);</span>
<a name="gbab-505"></a>      <span class="n">png_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<a name="gbab-506"></a>   <span class="p">}</span>
<a name="gbab-507"></a><span class="p">}</span>
<a name="gbab-508"></a><span class="cp">#endif </span><span class="cm">/* WARNINGS */</span><span class="cp"></span>
<a name="gbab-509"></a>
<a name="gbab-510"></a><span class="cp">#ifdef PNG_READ_SUPPORTED</span>
<a name="gbab-511"></a><span class="cp">#ifdef PNG_BENIGN_ERRORS_SUPPORTED</span>
<a name="gbab-512"></a><span class="kt">void</span> <span class="n">PNGAPI</span>
<a name="gbab-513"></a><span class="n">png_chunk_benign_error</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span>
<a name="gbab-514"></a>    <span class="n">error_message</span><span class="p">)</span>
<a name="gbab-515"></a><span class="p">{</span>
<a name="gbab-516"></a>   <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PNG_FLAG_BENIGN_ERRORS_WARN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-517"></a>      <span class="n">png_chunk_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-518"></a>
<a name="gbab-519"></a>   <span class="k">else</span>
<a name="gbab-520"></a>      <span class="nf">png_chunk_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-521"></a>
<a name="gbab-522"></a><span class="cp">#  ifndef PNG_ERROR_TEXT_SUPPORTED</span>
<a name="gbab-523"></a>      <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
<a name="gbab-524"></a><span class="cp">#  endif</span>
<a name="gbab-525"></a><span class="p">}</span>
<a name="gbab-526"></a><span class="cp">#endif</span>
<a name="gbab-527"></a><span class="cp">#endif </span><span class="cm">/* READ */</span><span class="cp"></span>
<a name="gbab-528"></a>
<a name="gbab-529"></a><span class="kt">void</span> <span class="cm">/* PRIVATE */</span>
<a name="gbab-530"></a><span class="n">png_chunk_report</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">message</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<a name="gbab-531"></a><span class="p">{</span>
<a name="gbab-532"></a><span class="cp">#  ifndef PNG_WARNINGS_SUPPORTED</span>
<a name="gbab-533"></a>      <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a name="gbab-534"></a><span class="cp">#  endif</span>
<a name="gbab-535"></a>
<a name="gbab-536"></a>   <span class="cm">/* This is always supported, but for just read or just write it</span>
<a name="gbab-537"></a><span class="cm">    * unconditionally does the right thing.</span>
<a name="gbab-538"></a><span class="cm">    */</span>
<a name="gbab-539"></a><span class="cp">#  if defined(PNG_READ_SUPPORTED) &amp;&amp; defined(PNG_WRITE_SUPPORTED)</span>
<a name="gbab-540"></a>      <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">PNG_IS_READ_STRUCT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-541"></a><span class="cp">#  endif</span>
<a name="gbab-542"></a>
<a name="gbab-543"></a><span class="cp">#  ifdef PNG_READ_SUPPORTED</span>
<a name="gbab-544"></a>      <span class="p">{</span>
<a name="gbab-545"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="n">PNG_CHUNK_ERROR</span><span class="p">)</span>
<a name="gbab-546"></a>            <span class="n">png_chunk_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
<a name="gbab-547"></a>
<a name="gbab-548"></a>         <span class="k">else</span>
<a name="gbab-549"></a>            <span class="nf">png_chunk_benign_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
<a name="gbab-550"></a><span class="p">}</span>
<a name="gbab-551"></a><span class="cp">#endif</span>
<a name="gbab-552"></a>
<a name="gbab-553"></a><span class="cp">#  if defined(PNG_READ_SUPPORTED) &amp;&amp; defined(PNG_WRITE_SUPPORTED)</span>
<a name="gbab-554"></a>      <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">PNG_IS_READ_STRUCT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-555"></a><span class="cp">#  endif</span>
<a name="gbab-556"></a>
<a name="gbab-557"></a><span class="cp">#  ifdef PNG_WRITE_SUPPORTED</span>
<a name="gbab-558"></a>      <span class="p">{</span>
<a name="gbab-559"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="n">PNG_CHUNK_WRITE_ERROR</span><span class="p">)</span>
<a name="gbab-560"></a>            <span class="n">png_app_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
<a name="gbab-561"></a>
<a name="gbab-562"></a>         <span class="k">else</span>
<a name="gbab-563"></a>            <span class="nf">png_app_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
<a name="gbab-564"></a>      <span class="p">}</span>
<a name="gbab-565"></a><span class="cp">#  endif</span>
<a name="gbab-566"></a><span class="p">}</span>
<a name="gbab-567"></a>
<a name="gbab-568"></a><span class="cp">#ifdef PNG_ERROR_TEXT_SUPPORTED</span>
<a name="gbab-569"></a><span class="cp">#ifdef PNG_FLOATING_POINT_SUPPORTED</span>
<a name="gbab-570"></a><span class="n">PNG_FUNCTION</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span>
<a name="gbab-571"></a><span class="n">png_fixed_error</span><span class="p">,(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">name</span><span class="p">),</span><span class="n">PNG_NORETURN</span><span class="p">)</span>
<a name="gbab-572"></a><span class="p">{</span>
<a name="gbab-573"></a><span class="cp">#  define fixed_message &quot;fixed point overflow in &quot;</span>
<a name="gbab-574"></a><span class="cp">#  define fixed_message_ln ((sizeof fixed_message)-1)</span>
<a name="gbab-575"></a>   <span class="kt">int</span>  <span class="n">iin</span><span class="p">;</span>
<a name="gbab-576"></a>   <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="n">fixed_message_ln</span><span class="o">+</span><span class="n">PNG_MAX_ERROR_TEXT</span><span class="p">];</span>
<a name="gbab-577"></a>   <span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">fixed_message</span><span class="p">,</span> <span class="n">fixed_message_ln</span><span class="p">);</span>
<a name="gbab-578"></a>   <span class="n">iin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-579"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-580"></a>      <span class="k">while</span> <span class="p">(</span><span class="n">iin</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">PNG_MAX_ERROR_TEXT</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">[</span><span class="n">iin</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-581"></a>   <span class="p">{</span>
<a name="gbab-582"></a>      <span class="n">msg</span><span class="p">[</span><span class="n">fixed_message_ln</span> <span class="o">+</span> <span class="n">iin</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">iin</span><span class="p">];</span>
<a name="gbab-583"></a>      <span class="o">++</span><span class="n">iin</span><span class="p">;</span>
<a name="gbab-584"></a>   <span class="p">}</span>
<a name="gbab-585"></a>   <span class="n">msg</span><span class="p">[</span><span class="n">fixed_message_ln</span> <span class="o">+</span> <span class="n">iin</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-586"></a>   <span class="n">png_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<a name="gbab-587"></a><span class="p">}</span>
<a name="gbab-588"></a><span class="cp">#endif</span>
<a name="gbab-589"></a><span class="cp">#endif</span>
<a name="gbab-590"></a>
<a name="gbab-591"></a><span class="cp">#ifdef PNG_SETJMP_SUPPORTED</span>
<a name="gbab-592"></a><span class="cm">/* This API only exists if ANSI-C style error handling is used,</span>
<a name="gbab-593"></a><span class="cm"> * otherwise it is necessary for png_default_error to be overridden.</span>
<a name="gbab-594"></a><span class="cm"> */</span>
<a name="gbab-595"></a><span class="kt">jmp_buf</span><span class="o">*</span> <span class="n">PNGAPI</span>
<a name="gbab-596"></a><span class="n">png_set_longjmp_fn</span><span class="p">(</span><span class="n">png_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_longjmp_ptr</span> <span class="n">longjmp_fn</span><span class="p">,</span>
<a name="gbab-597"></a>    <span class="kt">size_t</span> <span class="n">jmp_buf_size</span><span class="p">)</span>
<a name="gbab-598"></a><span class="p">{</span>
<a name="gbab-599"></a>   <span class="cm">/* From libpng 1.6.0 the app gets one chance to set a &#39;jmpbuf_size&#39; value</span>
<a name="gbab-600"></a><span class="cm">    * and it must not change after that.  Libpng doesn&#39;t care how big the</span>
<a name="gbab-601"></a><span class="cm">    * buffer is, just that it doesn&#39;t change.</span>
<a name="gbab-602"></a><span class="cm">    *</span>
<a name="gbab-603"></a><span class="cm">    * If the buffer size is no *larger* than the size of jmp_buf when libpng is</span>
<a name="gbab-604"></a><span class="cm">    * compiled a built in jmp_buf is returned; this preserves the pre-1.6.0</span>
<a name="gbab-605"></a><span class="cm">    * semantics that this call will not fail.  If the size is larger, however,</span>
<a name="gbab-606"></a><span class="cm">    * the buffer is allocated and this may fail, causing the function to return</span>
<a name="gbab-607"></a><span class="cm">    * NULL.</span>
<a name="gbab-608"></a><span class="cm">    */</span>
<a name="gbab-609"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-610"></a>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-611"></a>
<a name="gbab-612"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-613"></a>   <span class="p">{</span>
<a name="gbab-614"></a>      <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not allocated */</span>
<a name="gbab-615"></a>
<a name="gbab-616"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">jmp_buf_size</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_local</span><span class="p">))</span>
<a name="gbab-617"></a>         <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_local</span><span class="p">;</span>
<a name="gbab-618"></a>
<a name="gbab-619"></a>      <span class="k">else</span>
<a name="gbab-620"></a>      <span class="p">{</span>
<a name="gbab-621"></a>         <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span> <span class="o">=</span> <span class="n">png_voidcast</span><span class="p">(</span><span class="kt">jmp_buf</span> <span class="o">*</span><span class="p">,</span>
<a name="gbab-622"></a>            <span class="n">png_malloc_warn</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">jmp_buf_size</span><span class="p">));</span>
<a name="gbab-623"></a>
<a name="gbab-624"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-625"></a>            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* new NULL return on OOM */</span>
<a name="gbab-626"></a>
<a name="gbab-627"></a>         <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_size</span> <span class="o">=</span> <span class="n">jmp_buf_size</span><span class="p">;</span>
<a name="gbab-628"></a>      <span class="p">}</span>
<a name="gbab-629"></a>   <span class="p">}</span>
<a name="gbab-630"></a>
<a name="gbab-631"></a>   <span class="k">else</span> <span class="cm">/* Already allocated: check the size */</span>
<a name="gbab-632"></a>   <span class="p">{</span>
<a name="gbab-633"></a>      <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_size</span><span class="p">;</span>
<a name="gbab-634"></a>
<a name="gbab-635"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-636"></a>      <span class="p">{</span>
<a name="gbab-637"></a>         <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_local</span><span class="p">);</span>
<a name="gbab-638"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_local</span><span class="p">)</span>
<a name="gbab-639"></a>         <span class="p">{</span>
<a name="gbab-640"></a>            <span class="cm">/* This is an internal error in libpng: somehow we have been left</span>
<a name="gbab-641"></a><span class="cm">             * with a stack allocated jmp_buf when the application regained</span>
<a name="gbab-642"></a><span class="cm">             * control.  It&#39;s always possible to fix this up, but for the moment</span>
<a name="gbab-643"></a><span class="cm">             * this is a png_error because that makes it easy to detect.</span>
<a name="gbab-644"></a><span class="cm">             */</span>
<a name="gbab-645"></a>            <span class="n">png_error</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="s">&quot;Libpng jmp_buf still allocated&quot;</span><span class="p">);</span>
<a name="gbab-646"></a>            <span class="cm">/* png_ptr-&gt;jmp_buf_ptr = &amp;png_ptr-&gt;jmp_buf_local; */</span>
<a name="gbab-647"></a>         <span class="p">}</span>
<a name="gbab-648"></a>      <span class="p">}</span>
<a name="gbab-649"></a>
<a name="gbab-650"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">jmp_buf_size</span><span class="p">)</span>
<a name="gbab-651"></a>      <span class="p">{</span>
<a name="gbab-652"></a>         <span class="n">png_warning</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="s">&quot;Application jmp_buf size changed&quot;</span><span class="p">);</span>
<a name="gbab-653"></a>         <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* caller will probably crash: no choice here */</span>
<a name="gbab-654"></a>      <span class="p">}</span>
<a name="gbab-655"></a>   <span class="p">}</span>
<a name="gbab-656"></a>
<a name="gbab-657"></a>   <span class="cm">/* Finally fill in the function, now we have a satisfactory buffer. It is</span>
<a name="gbab-658"></a><span class="cm">    * valid to change the function on every call.</span>
<a name="gbab-659"></a><span class="cm">    */</span>
<a name="gbab-660"></a>   <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">longjmp_fn</span> <span class="o">=</span> <span class="n">longjmp_fn</span><span class="p">;</span>
<a name="gbab-661"></a>   <span class="k">return</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span><span class="p">;</span>
<a name="gbab-662"></a><span class="p">}</span>
<a name="gbab-663"></a>
<a name="gbab-664"></a><span class="kt">void</span> <span class="cm">/* PRIVATE */</span>
<a name="gbab-665"></a><span class="n">png_free_jmpbuf</span><span class="p">(</span><span class="n">png_structrp</span> <span class="n">png_ptr</span><span class="p">)</span>
<a name="gbab-666"></a><span class="p">{</span>
<a name="gbab-667"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-668"></a>   <span class="p">{</span>
<a name="gbab-669"></a>      <span class="kt">jmp_buf</span> <span class="o">*</span><span class="n">jb</span> <span class="o">=</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span><span class="p">;</span>
<a name="gbab-670"></a>
<a name="gbab-671"></a>      <span class="cm">/* A size of 0 is used to indicate a local, stack, allocation of the</span>
<a name="gbab-672"></a><span class="cm">       * pointer; used here and in png.c</span>
<a name="gbab-673"></a><span class="cm">       */</span>
<a name="gbab-674"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">jb</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-675"></a>      <span class="p">{</span>
<a name="gbab-676"></a>
<a name="gbab-677"></a>         <span class="cm">/* This stuff is so that a failure to free the error control structure</span>
<a name="gbab-678"></a><span class="cm">          * does not leave libpng in a state with no valid error handling: the</span>
<a name="gbab-679"></a><span class="cm">          * free always succeeds, if there is an error it gets ignored.</span>
<a name="gbab-680"></a><span class="cm">          */</span>
<a name="gbab-681"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">jb</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_local</span><span class="p">)</span>
<a name="gbab-682"></a>         <span class="p">{</span>
<a name="gbab-683"></a>            <span class="cm">/* Make an internal, libpng, jmp_buf to return here */</span>
<a name="gbab-684"></a>            <span class="kt">jmp_buf</span> <span class="n">free_jmp_buf</span><span class="p">;</span>
<a name="gbab-685"></a>
<a name="gbab-686"></a>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setjmp</span><span class="p">(</span><span class="n">free_jmp_buf</span><span class="p">))</span>
<a name="gbab-687"></a>            <span class="p">{</span>
<a name="gbab-688"></a>               <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">free_jmp_buf</span><span class="p">;</span> <span class="cm">/* come back here */</span>
<a name="gbab-689"></a>               <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* stack allocation */</span>
<a name="gbab-690"></a>               <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">longjmp_fn</span> <span class="o">=</span> <span class="n">longjmp</span><span class="p">;</span>
<a name="gbab-691"></a>               <span class="n">png_free</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="n">jb</span><span class="p">);</span> <span class="cm">/* Return to setjmp on error */</span>
<a name="gbab-692"></a>            <span class="p">}</span>
<a name="gbab-693"></a>         <span class="p">}</span>
<a name="gbab-694"></a>      <span class="p">}</span>
<a name="gbab-695"></a>
<a name="gbab-696"></a>      <span class="cm">/* *Always* cancel everything out: */</span>
<a name="gbab-697"></a>      <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-698"></a>      <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-699"></a>      <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">longjmp_fn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-700"></a>   <span class="p">}</span>
<a name="gbab-701"></a><span class="p">}</span>
<a name="gbab-702"></a><span class="cp">#endif</span>
<a name="gbab-703"></a>
<a name="gbab-704"></a><span class="cm">/* This is the default error handling function.  Note that replacements for</span>
<a name="gbab-705"></a><span class="cm"> * this function MUST NOT RETURN, or the program will likely crash.  This</span>
<a name="gbab-706"></a><span class="cm"> * function is used by default, or if the program supplies NULL for the</span>
<a name="gbab-707"></a><span class="cm"> * error function pointer in png_set_error_fn().</span>
<a name="gbab-708"></a><span class="cm"> */</span>
<a name="gbab-709"></a><span class="k">static</span> <span class="n">PNG_FUNCTION</span><span class="p">(</span><span class="kt">void</span> <span class="cm">/* PRIVATE */</span><span class="p">,</span>
<a name="gbab-710"></a><span class="n">png_default_error</span><span class="p">,(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">error_message</span><span class="p">),</span>
<a name="gbab-711"></a>   <span class="n">PNG_NORETURN</span><span class="p">)</span>
<a name="gbab-712"></a><span class="p">{</span>
<a name="gbab-713"></a><span class="cp">#ifdef PNG_CONSOLE_IO_SUPPORTED</span>
<a name="gbab-714"></a><span class="cp">#ifdef PNG_ERROR_NUMBERS_SUPPORTED</span>
<a name="gbab-715"></a>   <span class="cm">/* Check on NULL only added in 1.5.4 */</span>
<a name="gbab-716"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">error_message</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">error_message</span> <span class="o">==</span> <span class="n">PNG_LITERAL_SHARP</span><span class="p">)</span>
<a name="gbab-717"></a>   <span class="p">{</span>
<a name="gbab-718"></a>      <span class="cm">/* Strip &quot;#nnnn &quot; from beginning of error message. */</span>
<a name="gbab-719"></a>      <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<a name="gbab-720"></a>      <span class="kt">char</span> <span class="n">error_number</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<a name="gbab-721"></a>      <span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span>
<a name="gbab-722"></a>      <span class="p">{</span>
<a name="gbab-723"></a>         <span class="n">error_number</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_message</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<a name="gbab-724"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">error_message</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
<a name="gbab-725"></a>            <span class="k">break</span><span class="p">;</span>
<a name="gbab-726"></a>      <span class="p">}</span>
<a name="gbab-727"></a>
<a name="gbab-728"></a>      <span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">))</span>
<a name="gbab-729"></a>      <span class="p">{</span>
<a name="gbab-730"></a>         <span class="n">error_number</span><span class="p">[</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="gbab-731"></a>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;libpng error no. %s: %s&quot;</span><span class="p">,</span>
<a name="gbab-732"></a>             <span class="n">error_number</span><span class="p">,</span> <span class="n">error_message</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="gbab-733"></a>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">PNG_STRING_NEWLINE</span><span class="p">);</span>
<a name="gbab-734"></a>      <span class="p">}</span>
<a name="gbab-735"></a>
<a name="gbab-736"></a>      <span class="k">else</span>
<a name="gbab-737"></a>      <span class="p">{</span>
<a name="gbab-738"></a>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;libpng error: %s, offset=%d&quot;</span><span class="p">,</span>
<a name="gbab-739"></a>             <span class="n">error_message</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<a name="gbab-740"></a>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">PNG_STRING_NEWLINE</span><span class="p">);</span>
<a name="gbab-741"></a>      <span class="p">}</span>
<a name="gbab-742"></a>   <span class="p">}</span>
<a name="gbab-743"></a>   <span class="k">else</span>
<a name="gbab-744"></a><span class="cp">#endif</span>
<a name="gbab-745"></a>   <span class="p">{</span>
<a name="gbab-746"></a>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;libpng error: %s&quot;</span><span class="p">,</span> <span class="n">error_message</span> <span class="o">?</span> <span class="nl">error_message</span> <span class="p">:</span>
<a name="gbab-747"></a>         <span class="s">&quot;undefined&quot;</span><span class="p">);</span>
<a name="gbab-748"></a>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">PNG_STRING_NEWLINE</span><span class="p">);</span>
<a name="gbab-749"></a>   <span class="p">}</span>
<a name="gbab-750"></a><span class="cp">#else</span>
<a name="gbab-751"></a>   <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span> <span class="cm">/* Make compiler happy */</span>
<a name="gbab-752"></a><span class="cp">#endif</span>
<a name="gbab-753"></a>   <span class="n">png_longjmp</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="gbab-754"></a><span class="p">}</span>
<a name="gbab-755"></a>
<a name="gbab-756"></a><span class="n">PNG_FUNCTION</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span><span class="n">PNGAPI</span>
<a name="gbab-757"></a><span class="n">png_longjmp</span><span class="p">,(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">),</span><span class="n">PNG_NORETURN</span><span class="p">)</span>
<a name="gbab-758"></a><span class="p">{</span>
<a name="gbab-759"></a><span class="cp">#ifdef PNG_SETJMP_SUPPORTED</span>
<a name="gbab-760"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">longjmp_fn</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
<a name="gbab-761"></a>       <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-762"></a>      <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">longjmp_fn</span><span class="p">(</span><span class="o">*</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">jmp_buf_ptr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<a name="gbab-763"></a><span class="cp">#else</span>
<a name="gbab-764"></a>   <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">)</span>
<a name="gbab-765"></a>   <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<a name="gbab-766"></a><span class="cp">#endif</span>
<a name="gbab-767"></a>
<a name="gbab-768"></a>   <span class="cm">/* If control reaches this point, png_longjmp() must not return. The only</span>
<a name="gbab-769"></a><span class="cm">    * choice is to terminate the whole process (or maybe the thread); to do</span>
<a name="gbab-770"></a><span class="cm">    * this the ANSI-C abort() function is used unless a different method is</span>
<a name="gbab-771"></a><span class="cm">    * implemented by overriding the default configuration setting for</span>
<a name="gbab-772"></a><span class="cm">    * PNG_ABORT().</span>
<a name="gbab-773"></a><span class="cm">    */</span>
<a name="gbab-774"></a>   <span class="n">PNG_ABORT</span><span class="p">();</span>
<a name="gbab-775"></a><span class="p">}</span>
<a name="gbab-776"></a>
<a name="gbab-777"></a><span class="cp">#ifdef PNG_WARNINGS_SUPPORTED</span>
<a name="gbab-778"></a><span class="cm">/* This function is called when there is a warning, but the library thinks</span>
<a name="gbab-779"></a><span class="cm"> * it can continue anyway.  Replacement functions don&#39;t have to do anything</span>
<a name="gbab-780"></a><span class="cm"> * here if you don&#39;t want them to.  In the default configuration, png_ptr is</span>
<a name="gbab-781"></a><span class="cm"> * not used, but it is passed in case it may be useful.</span>
<a name="gbab-782"></a><span class="cm"> */</span>
<a name="gbab-783"></a><span class="k">static</span> <span class="kt">void</span> <span class="cm">/* PRIVATE */</span>
<a name="gbab-784"></a><span class="n">png_default_warning</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">warning_message</span><span class="p">)</span>
<a name="gbab-785"></a><span class="p">{</span>
<a name="gbab-786"></a><span class="cp">#ifdef PNG_CONSOLE_IO_SUPPORTED</span>
<a name="gbab-787"></a><span class="cp">#  ifdef PNG_ERROR_NUMBERS_SUPPORTED</span>
<a name="gbab-788"></a>   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">warning_message</span> <span class="o">==</span> <span class="n">PNG_LITERAL_SHARP</span><span class="p">)</span>
<a name="gbab-789"></a>   <span class="p">{</span>
<a name="gbab-790"></a>      <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<a name="gbab-791"></a>      <span class="kt">char</span> <span class="n">warning_number</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<a name="gbab-792"></a>      <span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span>
<a name="gbab-793"></a>      <span class="p">{</span>
<a name="gbab-794"></a>         <span class="n">warning_number</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">warning_message</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<a name="gbab-795"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">warning_message</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
<a name="gbab-796"></a>            <span class="k">break</span><span class="p">;</span>
<a name="gbab-797"></a>      <span class="p">}</span>
<a name="gbab-798"></a>
<a name="gbab-799"></a>      <span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">))</span>
<a name="gbab-800"></a>      <span class="p">{</span>
<a name="gbab-801"></a>         <span class="n">warning_number</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="gbab-802"></a>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;libpng warning no. %s: %s&quot;</span><span class="p">,</span>
<a name="gbab-803"></a>             <span class="n">warning_number</span><span class="p">,</span> <span class="n">warning_message</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<a name="gbab-804"></a>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">PNG_STRING_NEWLINE</span><span class="p">);</span>
<a name="gbab-805"></a>      <span class="p">}</span>
<a name="gbab-806"></a>
<a name="gbab-807"></a>      <span class="k">else</span>
<a name="gbab-808"></a>      <span class="p">{</span>
<a name="gbab-809"></a>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;libpng warning: %s&quot;</span><span class="p">,</span>
<a name="gbab-810"></a>             <span class="n">warning_message</span><span class="p">);</span>
<a name="gbab-811"></a>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">PNG_STRING_NEWLINE</span><span class="p">);</span>
<a name="gbab-812"></a>      <span class="p">}</span>
<a name="gbab-813"></a>   <span class="p">}</span>
<a name="gbab-814"></a>   <span class="k">else</span>
<a name="gbab-815"></a><span class="cp">#  endif</span>
<a name="gbab-816"></a>
<a name="gbab-817"></a>   <span class="p">{</span>
<a name="gbab-818"></a>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;libpng warning: %s&quot;</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">);</span>
<a name="gbab-819"></a>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">PNG_STRING_NEWLINE</span><span class="p">);</span>
<a name="gbab-820"></a>   <span class="p">}</span>
<a name="gbab-821"></a><span class="cp">#else</span>
<a name="gbab-822"></a>   <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">warning_message</span><span class="p">)</span> <span class="cm">/* Make compiler happy */</span>
<a name="gbab-823"></a><span class="cp">#endif</span>
<a name="gbab-824"></a>   <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">png_ptr</span><span class="p">)</span> <span class="cm">/* Make compiler happy */</span>
<a name="gbab-825"></a><span class="p">}</span>
<a name="gbab-826"></a><span class="cp">#endif </span><span class="cm">/* WARNINGS */</span><span class="cp"></span>
<a name="gbab-827"></a>
<a name="gbab-828"></a><span class="cm">/* This function is called when the application wants to use another method</span>
<a name="gbab-829"></a><span class="cm"> * of handling errors and warnings.  Note that the error function MUST NOT</span>
<a name="gbab-830"></a><span class="cm"> * return to the calling routine or serious problems will occur.  The return</span>
<a name="gbab-831"></a><span class="cm"> * method used in the default routine calls longjmp(png_ptr-&gt;jmp_buf_ptr, 1)</span>
<a name="gbab-832"></a><span class="cm"> */</span>
<a name="gbab-833"></a><span class="kt">void</span> <span class="n">PNGAPI</span>
<a name="gbab-834"></a><span class="n">png_set_error_fn</span><span class="p">(</span><span class="n">png_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_voidp</span> <span class="n">error_ptr</span><span class="p">,</span>
<a name="gbab-835"></a>    <span class="n">png_error_ptr</span> <span class="n">error_fn</span><span class="p">,</span> <span class="n">png_error_ptr</span> <span class="n">warning_fn</span><span class="p">)</span>
<a name="gbab-836"></a><span class="p">{</span>
<a name="gbab-837"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-838"></a>      <span class="k">return</span><span class="p">;</span>
<a name="gbab-839"></a>
<a name="gbab-840"></a>   <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">error_ptr</span> <span class="o">=</span> <span class="n">error_ptr</span><span class="p">;</span>
<a name="gbab-841"></a>   <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">error_fn</span> <span class="o">=</span> <span class="n">error_fn</span><span class="p">;</span>
<a name="gbab-842"></a><span class="cp">#ifdef PNG_WARNINGS_SUPPORTED</span>
<a name="gbab-843"></a>   <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">warning_fn</span> <span class="o">=</span> <span class="n">warning_fn</span><span class="p">;</span>
<a name="gbab-844"></a><span class="cp">#else</span>
<a name="gbab-845"></a>   <span class="n">PNG_UNUSED</span><span class="p">(</span><span class="n">warning_fn</span><span class="p">)</span>
<a name="gbab-846"></a><span class="cp">#endif</span>
<a name="gbab-847"></a><span class="p">}</span>
<a name="gbab-848"></a>
<a name="gbab-849"></a>
<a name="gbab-850"></a><span class="cm">/* This function returns a pointer to the error_ptr associated with the user</span>
<a name="gbab-851"></a><span class="cm"> * functions.  The application should free any memory associated with this</span>
<a name="gbab-852"></a><span class="cm"> * pointer before png_write_destroy and png_read_destroy are called.</span>
<a name="gbab-853"></a><span class="cm"> */</span>
<a name="gbab-854"></a><span class="n">png_voidp</span> <span class="n">PNGAPI</span>
<a name="gbab-855"></a><span class="n">png_get_error_ptr</span><span class="p">(</span><span class="n">png_const_structrp</span> <span class="n">png_ptr</span><span class="p">)</span>
<a name="gbab-856"></a><span class="p">{</span>
<a name="gbab-857"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-858"></a>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-859"></a>
<a name="gbab-860"></a>   <span class="k">return</span> <span class="p">((</span><span class="n">png_voidp</span><span class="p">)</span><span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">error_ptr</span><span class="p">);</span>
<a name="gbab-861"></a><span class="p">}</span>
<a name="gbab-862"></a>
<a name="gbab-863"></a>
<a name="gbab-864"></a><span class="cp">#ifdef PNG_ERROR_NUMBERS_SUPPORTED</span>
<a name="gbab-865"></a><span class="kt">void</span> <span class="n">PNGAPI</span>
<a name="gbab-866"></a><span class="n">png_set_strip_error_numbers</span><span class="p">(</span><span class="n">png_structrp</span> <span class="n">png_ptr</span><span class="p">,</span> <span class="n">png_uint_32</span> <span class="n">strip_mode</span><span class="p">)</span>
<a name="gbab-867"></a><span class="p">{</span>
<a name="gbab-868"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">png_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-869"></a>   <span class="p">{</span>
<a name="gbab-870"></a>      <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
<a name="gbab-871"></a>         <span class="p">((</span><span class="o">~</span><span class="p">(</span><span class="n">PNG_FLAG_STRIP_ERROR_NUMBERS</span> <span class="o">|</span>
<a name="gbab-872"></a>         <span class="n">PNG_FLAG_STRIP_ERROR_TEXT</span><span class="p">))</span><span class="o">&amp;</span><span class="n">strip_mode</span><span class="p">);</span>
<a name="gbab-873"></a>   <span class="p">}</span>
<a name="gbab-874"></a><span class="p">}</span>
<a name="gbab-875"></a><span class="cp">#endif</span>
<a name="gbab-876"></a>
<a name="gbab-877"></a><span class="cp">#if defined(PNG_SIMPLIFIED_READ_SUPPORTED) ||\</span>
<a name="gbab-878"></a><span class="cp">   defined(PNG_SIMPLIFIED_WRITE_SUPPORTED)</span>
<a name="gbab-879"></a>   <span class="cm">/* Currently the above both depend on SETJMP_SUPPORTED, however it would be</span>
<a name="gbab-880"></a><span class="cm">    * possible to implement without setjmp support just so long as there is some</span>
<a name="gbab-881"></a><span class="cm">    * way to handle the error return here:</span>
<a name="gbab-882"></a><span class="cm">    */</span>
<a name="gbab-883"></a><span class="n">PNG_FUNCTION</span><span class="p">(</span><span class="kt">void</span> <span class="cm">/* PRIVATE */</span><span class="p">,</span> <span class="p">(</span><span class="n">PNGCBAPI</span>
<a name="gbab-884"></a><span class="n">png_safe_error</span><span class="p">),(</span><span class="n">png_structp</span> <span class="n">png_nonconst_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">error_message</span><span class="p">),</span>
<a name="gbab-885"></a>   <span class="n">PNG_NORETURN</span><span class="p">)</span>
<a name="gbab-886"></a><span class="p">{</span>
<a name="gbab-887"></a>   <span class="k">const</span> <span class="n">png_const_structrp</span> <span class="n">png_ptr</span> <span class="o">=</span> <span class="n">png_nonconst_ptr</span><span class="p">;</span>
<a name="gbab-888"></a>   <span class="n">png_imagep</span> <span class="n">image</span> <span class="o">=</span> <span class="n">png_voidcast</span><span class="p">(</span><span class="n">png_imagep</span><span class="p">,</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">error_ptr</span><span class="p">);</span>
<a name="gbab-889"></a>
<a name="gbab-890"></a>   <span class="cm">/* An error is always logged here, overwriting anything (typically a warning)</span>
<a name="gbab-891"></a><span class="cm">    * that is already there:</span>
<a name="gbab-892"></a><span class="cm">    */</span>
<a name="gbab-893"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">image</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-894"></a>   <span class="p">{</span>
<a name="gbab-895"></a>      <span class="n">png_safecat</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-896"></a>      <span class="n">image</span><span class="o">-&gt;</span><span class="n">warning_or_error</span> <span class="o">|=</span> <span class="n">PNG_IMAGE_ERROR</span><span class="p">;</span>
<a name="gbab-897"></a>
<a name="gbab-898"></a>      <span class="cm">/* Retrieve the jmp_buf from within the png_control, making this work for</span>
<a name="gbab-899"></a><span class="cm">       * C++ compilation too is pretty tricky: C++ wants a pointer to the first</span>
<a name="gbab-900"></a><span class="cm">       * element of a jmp_buf, but C doesn&#39;t tell us the type of that.</span>
<a name="gbab-901"></a><span class="cm">       */</span>
<a name="gbab-902"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">opaque</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">opaque</span><span class="o">-&gt;</span><span class="n">error_buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="gbab-903"></a>         <span class="n">longjmp</span><span class="p">(</span><span class="n">png_control_jmp_buf</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">opaque</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<a name="gbab-904"></a>
<a name="gbab-905"></a>      <span class="cm">/* Missing longjmp buffer, the following is to help debugging: */</span>
<a name="gbab-906"></a>      <span class="p">{</span>
<a name="gbab-907"></a>         <span class="kt">size_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">png_safecat</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
<a name="gbab-908"></a>            <span class="s">&quot;bad longjmp: &quot;</span><span class="p">);</span>
<a name="gbab-909"></a>         <span class="n">png_safecat</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">),</span> <span class="n">pos</span><span class="p">,</span>
<a name="gbab-910"></a>             <span class="n">error_message</span><span class="p">);</span>
<a name="gbab-911"></a>      <span class="p">}</span>
<a name="gbab-912"></a>   <span class="p">}</span>
<a name="gbab-913"></a>
<a name="gbab-914"></a>   <span class="cm">/* Here on an internal programming error. */</span>
<a name="gbab-915"></a>   <span class="n">abort</span><span class="p">();</span>
<a name="gbab-916"></a><span class="p">}</span>
<a name="gbab-917"></a>
<a name="gbab-918"></a><span class="cp">#ifdef PNG_WARNINGS_SUPPORTED</span>
<a name="gbab-919"></a><span class="kt">void</span> <span class="cm">/* PRIVATE */</span> <span class="n">PNGCBAPI</span>
<a name="gbab-920"></a><span class="n">png_safe_warning</span><span class="p">(</span><span class="n">png_structp</span> <span class="n">png_nonconst_ptr</span><span class="p">,</span> <span class="n">png_const_charp</span> <span class="n">warning_message</span><span class="p">)</span>
<a name="gbab-921"></a><span class="p">{</span>
<a name="gbab-922"></a>   <span class="k">const</span> <span class="n">png_const_structrp</span> <span class="n">png_ptr</span> <span class="o">=</span> <span class="n">png_nonconst_ptr</span><span class="p">;</span>
<a name="gbab-923"></a>   <span class="n">png_imagep</span> <span class="n">image</span> <span class="o">=</span> <span class="n">png_voidcast</span><span class="p">(</span><span class="n">png_imagep</span><span class="p">,</span> <span class="n">png_ptr</span><span class="o">-&gt;</span><span class="n">error_ptr</span><span class="p">);</span>
<a name="gbab-924"></a>
<a name="gbab-925"></a>   <span class="cm">/* A warning is only logged if there is no prior warning or error. */</span>
<a name="gbab-926"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">warning_or_error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-927"></a>   <span class="p">{</span>
<a name="gbab-928"></a>      <span class="n">png_safecat</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">);</span>
<a name="gbab-929"></a>      <span class="n">image</span><span class="o">-&gt;</span><span class="n">warning_or_error</span> <span class="o">|=</span> <span class="n">PNG_IMAGE_WARNING</span><span class="p">;</span>
<a name="gbab-930"></a>   <span class="p">}</span>
<a name="gbab-931"></a><span class="p">}</span>
<a name="gbab-932"></a><span class="cp">#endif</span>
<a name="gbab-933"></a>
<a name="gbab-934"></a><span class="kt">int</span> <span class="cm">/* PRIVATE */</span>
<a name="gbab-935"></a><span class="n">png_safe_execute</span><span class="p">(</span><span class="n">png_imagep</span> <span class="n">image_in</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="n">png_voidp</span><span class="p">),</span> <span class="n">png_voidp</span> <span class="n">arg</span><span class="p">)</span>
<a name="gbab-936"></a><span class="p">{</span>
<a name="gbab-937"></a>   <span class="k">volatile</span> <span class="n">png_imagep</span> <span class="n">image</span> <span class="o">=</span> <span class="n">image_in</span><span class="p">;</span>
<a name="gbab-938"></a>   <span class="k">volatile</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
<a name="gbab-939"></a>   <span class="k">volatile</span> <span class="n">png_voidp</span> <span class="n">saved_error_buf</span><span class="p">;</span>
<a name="gbab-940"></a>   <span class="kt">jmp_buf</span> <span class="n">safe_jmpbuf</span><span class="p">;</span>
<a name="gbab-941"></a>
<a name="gbab-942"></a>   <span class="cm">/* Safely execute function(arg) with png_error returning to this function. */</span>
<a name="gbab-943"></a>   <span class="n">saved_error_buf</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">opaque</span><span class="o">-&gt;</span><span class="n">error_buf</span><span class="p">;</span>
<a name="gbab-944"></a>   <span class="n">result</span> <span class="o">=</span> <span class="n">setjmp</span><span class="p">(</span><span class="n">safe_jmpbuf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-945"></a>
<a name="gbab-946"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-947"></a>   <span class="p">{</span>
<a name="gbab-948"></a>
<a name="gbab-949"></a>      <span class="n">image</span><span class="o">-&gt;</span><span class="n">opaque</span><span class="o">-&gt;</span><span class="n">error_buf</span> <span class="o">=</span> <span class="n">safe_jmpbuf</span><span class="p">;</span>
<a name="gbab-950"></a>      <span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<a name="gbab-951"></a>   <span class="p">}</span>
<a name="gbab-952"></a>
<a name="gbab-953"></a>   <span class="n">image</span><span class="o">-&gt;</span><span class="n">opaque</span><span class="o">-&gt;</span><span class="n">error_buf</span> <span class="o">=</span> <span class="n">saved_error_buf</span><span class="p">;</span>
<a name="gbab-954"></a>
<a name="gbab-955"></a>   <span class="cm">/* And do the cleanup prior to any failure return. */</span>
<a name="gbab-956"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-957"></a>      <span class="n">png_image_free</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
<a name="gbab-958"></a>
<a name="gbab-959"></a>   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<a name="gbab-960"></a><span class="p">}</span>
<a name="gbab-961"></a><span class="cp">#endif </span><span class="cm">/* SIMPLIFIED READ || SIMPLIFIED_WRITE */</span><span class="cp"></span>
<a name="gbab-962"></a><span class="cp">#endif </span><span class="cm">/* READ || WRITE */</span><span class="cp"></span>
</pre></div>
</td></tr></table>