<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="gbab-1"></a><span class="cm">/********************************************************************</span>
<a name="gbab-2"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-3"></a><span class="cm"> * THIS FILE IS PART OF THE OggTheora SOFTWARE CODEC SOURCE CODE.   *</span>
<a name="gbab-4"></a><span class="cm"> * USE, DISTRIBUTION AND REPRODUCTION OF THIS LIBRARY SOURCE IS     *</span>
<a name="gbab-5"></a><span class="cm"> * GOVERNED BY A BSD-STYLE SOURCE LICENSE INCLUDED WITH THIS SOURCE *</span>
<a name="gbab-6"></a><span class="cm"> * IN &#39;COPYING&#39;. PLEASE READ THESE TERMS BEFORE DISTRIBUTING.       *</span>
<a name="gbab-7"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-8"></a><span class="cm"> * THE Theora SOURCE CODE IS COPYRIGHT (C) 2002-2009                *</span>
<a name="gbab-9"></a><span class="cm"> * by the Xiph.Org Foundation http://www.xiph.org/                  *</span>
<a name="gbab-10"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-11"></a><span class="cm"> ********************************************************************</span>
<a name="gbab-12"></a>
<a name="gbab-13"></a><span class="cm">  function:</span>
<a name="gbab-14"></a><span class="cm">  last mod: $Id: fdct.c 16503 2009-08-22 18:14:02Z giles $</span>
<a name="gbab-15"></a>
<a name="gbab-16"></a><span class="cm"> ********************************************************************/</span>
<a name="gbab-17"></a><span class="cp">#include</span> <span class="cpf">&quot;encint.h&quot;</span><span class="cp"></span>
<a name="gbab-18"></a><span class="cp">#include</span> <span class="cpf">&quot;dct.h&quot;</span><span class="cp"></span>
<a name="gbab-19"></a>
<a name="gbab-20"></a>
<a name="gbab-21"></a>
<a name="gbab-22"></a><span class="cm">/*Performs a forward 8 point Type-II DCT transform.</span>
<a name="gbab-23"></a><span class="cm">  The output is scaled by a factor of 2 from the orthonormal version of the</span>
<a name="gbab-24"></a><span class="cm">   transform.</span>
<a name="gbab-25"></a><span class="cm">  _y: The buffer to store the result in.</span>
<a name="gbab-26"></a><span class="cm">      Data will be placed the first 8 entries (e.g., in a row of an 8x8 block).</span>
<a name="gbab-27"></a><span class="cm">  _x: The input coefficients.</span>
<a name="gbab-28"></a><span class="cm">      Every 8th entry is used (e.g., from a column of an 8x8 block).*/</span>
<a name="gbab-29"></a><span class="k">static</span> <span class="kt">void</span> <span class="nf">oc_fdct8</span><span class="p">(</span><span class="n">ogg_int16_t</span> <span class="n">_y</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="o">*</span><span class="n">_x</span><span class="p">){</span>
<a name="gbab-30"></a>  <span class="kt">int</span> <span class="n">t0</span><span class="p">;</span>
<a name="gbab-31"></a>  <span class="kt">int</span> <span class="n">t1</span><span class="p">;</span>
<a name="gbab-32"></a>  <span class="kt">int</span> <span class="n">t2</span><span class="p">;</span>
<a name="gbab-33"></a>  <span class="kt">int</span> <span class="n">t3</span><span class="p">;</span>
<a name="gbab-34"></a>  <span class="kt">int</span> <span class="n">t4</span><span class="p">;</span>
<a name="gbab-35"></a>  <span class="kt">int</span> <span class="n">t5</span><span class="p">;</span>
<a name="gbab-36"></a>  <span class="kt">int</span> <span class="n">t6</span><span class="p">;</span>
<a name="gbab-37"></a>  <span class="kt">int</span> <span class="n">t7</span><span class="p">;</span>
<a name="gbab-38"></a>  <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
<a name="gbab-39"></a>  <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
<a name="gbab-40"></a>  <span class="kt">int</span> <span class="n">u</span><span class="p">;</span>
<a name="gbab-41"></a>  <span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
<a name="gbab-42"></a>  <span class="cm">/*Stage 1:*/</span>
<a name="gbab-43"></a>  <span class="cm">/*0-7 butterfly.*/</span>
<a name="gbab-44"></a>  <span class="n">t0</span><span class="o">=</span><span class="n">_x</span><span class="p">[</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">_x</span><span class="p">[</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-45"></a>  <span class="n">t7</span><span class="o">=</span><span class="n">_x</span><span class="p">[</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">_x</span><span class="p">[</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-46"></a>  <span class="cm">/*1-6 butterfly.*/</span>
<a name="gbab-47"></a>  <span class="n">t1</span><span class="o">=</span><span class="n">_x</span><span class="p">[</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">_x</span><span class="p">[</span><span class="mi">6</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-48"></a>  <span class="n">t6</span><span class="o">=</span><span class="n">_x</span><span class="p">[</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">_x</span><span class="p">[</span><span class="mi">6</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-49"></a>  <span class="cm">/*2-5 butterfly.*/</span>
<a name="gbab-50"></a>  <span class="n">t2</span><span class="o">=</span><span class="n">_x</span><span class="p">[</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">_x</span><span class="p">[</span><span class="mi">5</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-51"></a>  <span class="n">t5</span><span class="o">=</span><span class="n">_x</span><span class="p">[</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">_x</span><span class="p">[</span><span class="mi">5</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-52"></a>  <span class="cm">/*3-4 butterfly.*/</span>
<a name="gbab-53"></a>  <span class="n">t3</span><span class="o">=</span><span class="n">_x</span><span class="p">[</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">_x</span><span class="p">[</span><span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-54"></a>  <span class="n">t4</span><span class="o">=</span><span class="n">_x</span><span class="p">[</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">_x</span><span class="p">[</span><span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-55"></a>  <span class="cm">/*Stage 2:*/</span>
<a name="gbab-56"></a>  <span class="cm">/*0-3 butterfly.*/</span>
<a name="gbab-57"></a>  <span class="n">r</span><span class="o">=</span><span class="n">t0</span><span class="o">+</span><span class="n">t3</span><span class="p">;</span>
<a name="gbab-58"></a>  <span class="n">t3</span><span class="o">=</span><span class="n">t0</span><span class="o">-</span><span class="n">t3</span><span class="p">;</span>
<a name="gbab-59"></a>  <span class="n">t0</span><span class="o">=</span><span class="n">r</span><span class="p">;</span>
<a name="gbab-60"></a>  <span class="cm">/*1-2 butterfly.*/</span>
<a name="gbab-61"></a>  <span class="n">r</span><span class="o">=</span><span class="n">t1</span><span class="o">+</span><span class="n">t2</span><span class="p">;</span>
<a name="gbab-62"></a>  <span class="n">t2</span><span class="o">=</span><span class="n">t1</span><span class="o">-</span><span class="n">t2</span><span class="p">;</span>
<a name="gbab-63"></a>  <span class="n">t1</span><span class="o">=</span><span class="n">r</span><span class="p">;</span>
<a name="gbab-64"></a>  <span class="cm">/*6-5 butterfly.*/</span>
<a name="gbab-65"></a>  <span class="n">r</span><span class="o">=</span><span class="n">t6</span><span class="o">+</span><span class="n">t5</span><span class="p">;</span>
<a name="gbab-66"></a>  <span class="n">t5</span><span class="o">=</span><span class="n">t6</span><span class="o">-</span><span class="n">t5</span><span class="p">;</span>
<a name="gbab-67"></a>  <span class="n">t6</span><span class="o">=</span><span class="n">r</span><span class="p">;</span>
<a name="gbab-68"></a>  <span class="cm">/*Stages 3 and 4 are where all the approximation occurs.</span>
<a name="gbab-69"></a><span class="cm">    These are chosen to be as close to an exact inverse of the approximations</span>
<a name="gbab-70"></a><span class="cm">     made in the iDCT as possible, while still using mostly 16-bit arithmetic.</span>
<a name="gbab-71"></a><span class="cm">    We use some 16x16-&gt;32 signed MACs, but those still commonly execute in 1</span>
<a name="gbab-72"></a><span class="cm">     cycle on a 16-bit DSP.</span>
<a name="gbab-73"></a><span class="cm">    For example, s=(27146*t5+0x4000&gt;&gt;16)+t5+(t5!=0) is an exact inverse of</span>
<a name="gbab-74"></a><span class="cm">     t5=(OC_C4S4*s&gt;&gt;16).</span>
<a name="gbab-75"></a><span class="cm">    That is, applying the latter to the output of the former will recover t5</span>
<a name="gbab-76"></a><span class="cm">     exactly (over the valid input range of t5, -23171...23169).</span>
<a name="gbab-77"></a><span class="cm">    We increase the rounding bias to 0xB500 in this particular case so that</span>
<a name="gbab-78"></a><span class="cm">     errors inverting the subsequent butterfly are not one-sided (e.g., the</span>
<a name="gbab-79"></a><span class="cm">     mean error is very close to zero).</span>
<a name="gbab-80"></a><span class="cm">    The (t5!=0) term could be replaced simply by 1, but we want to send 0 to 0.</span>
<a name="gbab-81"></a><span class="cm">    The fDCT of an all-zeros block will still not be zero, because of the</span>
<a name="gbab-82"></a><span class="cm">     biases we added at the very beginning of the process, but it will be close</span>
<a name="gbab-83"></a><span class="cm">     enough that it is guaranteed to round to zero.*/</span>
<a name="gbab-84"></a>  <span class="cm">/*Stage 3:*/</span>
<a name="gbab-85"></a>  <span class="cm">/*4-5 butterfly.*/</span>
<a name="gbab-86"></a>  <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mi">27146</span><span class="o">*</span><span class="n">t5</span><span class="o">+</span><span class="mh">0xB500</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">t5</span><span class="o">+</span><span class="p">(</span><span class="n">t5</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-87"></a>  <span class="n">r</span><span class="o">=</span><span class="n">t4</span><span class="o">+</span><span class="n">s</span><span class="p">;</span>
<a name="gbab-88"></a>  <span class="n">t5</span><span class="o">=</span><span class="n">t4</span><span class="o">-</span><span class="n">s</span><span class="p">;</span>
<a name="gbab-89"></a>  <span class="n">t4</span><span class="o">=</span><span class="n">r</span><span class="p">;</span>
<a name="gbab-90"></a>  <span class="cm">/*7-6 butterfly.*/</span>
<a name="gbab-91"></a>  <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mi">27146</span><span class="o">*</span><span class="n">t6</span><span class="o">+</span><span class="mh">0xB500</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">t6</span><span class="o">+</span><span class="p">(</span><span class="n">t6</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-92"></a>  <span class="n">r</span><span class="o">=</span><span class="n">t7</span><span class="o">+</span><span class="n">s</span><span class="p">;</span>
<a name="gbab-93"></a>  <span class="n">t6</span><span class="o">=</span><span class="n">t7</span><span class="o">-</span><span class="n">s</span><span class="p">;</span>
<a name="gbab-94"></a>  <span class="n">t7</span><span class="o">=</span><span class="n">r</span><span class="p">;</span>
<a name="gbab-95"></a>  <span class="cm">/*Stage 4:*/</span>
<a name="gbab-96"></a>  <span class="cm">/*0-1 butterfly.*/</span>
<a name="gbab-97"></a>  <span class="n">r</span><span class="o">=</span><span class="p">(</span><span class="mi">27146</span><span class="o">*</span><span class="n">t0</span><span class="o">+</span><span class="mh">0x4000</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">t0</span><span class="o">+</span><span class="p">(</span><span class="n">t0</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-98"></a>  <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mi">27146</span><span class="o">*</span><span class="n">t1</span><span class="o">+</span><span class="mh">0xB500</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="n">t1</span><span class="o">+</span><span class="p">(</span><span class="n">t1</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-99"></a>  <span class="n">u</span><span class="o">=</span><span class="n">r</span><span class="o">+</span><span class="n">s</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-100"></a>  <span class="n">v</span><span class="o">=</span><span class="n">r</span><span class="o">-</span><span class="n">u</span><span class="p">;</span>
<a name="gbab-101"></a>  <span class="n">_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">u</span><span class="p">;</span>
<a name="gbab-102"></a>  <span class="n">_y</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="p">;</span>
<a name="gbab-103"></a>  <span class="cm">/*3-2 rotation by 6pi/16*/</span>
<a name="gbab-104"></a>  <span class="n">u</span><span class="o">=</span><span class="p">(</span><span class="n">OC_C6S2</span><span class="o">*</span><span class="n">t2</span><span class="o">+</span><span class="n">OC_C2S6</span><span class="o">*</span><span class="n">t3</span><span class="o">+</span><span class="mh">0x6CB7</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">t3</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-105"></a>  <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="n">OC_C6S2</span><span class="o">*</span><span class="n">u</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">-</span><span class="n">t2</span><span class="p">;</span>
<a name="gbab-106"></a>  <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="mi">21600</span><span class="o">+</span><span class="mh">0x2800</span><span class="o">&gt;&gt;</span><span class="mi">18</span><span class="p">)</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="p">(</span><span class="n">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-107"></a>  <span class="n">_y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">u</span><span class="p">;</span>
<a name="gbab-108"></a>  <span class="n">_y</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="p">;</span>
<a name="gbab-109"></a>  <span class="cm">/*6-5 rotation by 3pi/16*/</span>
<a name="gbab-110"></a>  <span class="n">u</span><span class="o">=</span><span class="p">(</span><span class="n">OC_C5S3</span><span class="o">*</span><span class="n">t6</span><span class="o">+</span><span class="n">OC_C3S5</span><span class="o">*</span><span class="n">t5</span><span class="o">+</span><span class="mh">0x0E3D</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">t5</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-111"></a>  <span class="n">s</span><span class="o">=</span><span class="n">t6</span><span class="o">-</span><span class="p">(</span><span class="n">OC_C5S3</span><span class="o">*</span><span class="n">u</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">);</span>
<a name="gbab-112"></a>  <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="mi">26568</span><span class="o">+</span><span class="mh">0x3400</span><span class="o">&gt;&gt;</span><span class="mi">17</span><span class="p">)</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="p">(</span><span class="n">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-113"></a>  <span class="n">_y</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="n">u</span><span class="p">;</span>
<a name="gbab-114"></a>  <span class="n">_y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="p">;</span>
<a name="gbab-115"></a>  <span class="cm">/*7-4 rotation by 7pi/16*/</span>
<a name="gbab-116"></a>  <span class="n">u</span><span class="o">=</span><span class="p">(</span><span class="n">OC_C7S1</span><span class="o">*</span><span class="n">t4</span><span class="o">+</span><span class="n">OC_C1S7</span><span class="o">*</span><span class="n">t7</span><span class="o">+</span><span class="mh">0x7B1B</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">t7</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-117"></a>  <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="n">OC_C7S1</span><span class="o">*</span><span class="n">u</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">-</span><span class="n">t4</span><span class="p">;</span>
<a name="gbab-118"></a>  <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="mi">20539</span><span class="o">+</span><span class="mh">0x3000</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">)</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="p">(</span><span class="n">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-119"></a>  <span class="n">_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">u</span><span class="p">;</span>
<a name="gbab-120"></a>  <span class="n">_y</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="p">;</span>
<a name="gbab-121"></a><span class="p">}</span>
<a name="gbab-122"></a>
<a name="gbab-123"></a><span class="kt">void</span> <span class="nf">oc_enc_fdct8x8</span><span class="p">(</span><span class="k">const</span> <span class="n">oc_enc_ctx</span> <span class="o">*</span><span class="n">_enc</span><span class="p">,</span><span class="n">ogg_int16_t</span> <span class="n">_y</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span>
<a name="gbab-124"></a> <span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_x</span><span class="p">[</span><span class="mi">64</span><span class="p">]){</span>
<a name="gbab-125"></a>  <span class="p">(</span><span class="o">*</span><span class="n">_enc</span><span class="o">-&gt;</span><span class="n">opt_vtable</span><span class="p">.</span><span class="n">fdct8x8</span><span class="p">)(</span><span class="n">_y</span><span class="p">,</span><span class="n">_x</span><span class="p">);</span>
<a name="gbab-126"></a><span class="p">}</span>
<a name="gbab-127"></a>
<a name="gbab-128"></a><span class="cm">/*Performs a forward 8x8 Type-II DCT transform.</span>
<a name="gbab-129"></a><span class="cm">  The output is scaled by a factor of 4 relative to the orthonormal version</span>
<a name="gbab-130"></a><span class="cm">   of the transform.</span>
<a name="gbab-131"></a><span class="cm">  _y: The buffer to store the result in.</span>
<a name="gbab-132"></a><span class="cm">      This may be the same as _x.</span>
<a name="gbab-133"></a><span class="cm">  _x: The input coefficients. */</span>
<a name="gbab-134"></a><span class="kt">void</span> <span class="nf">oc_enc_fdct8x8_c</span><span class="p">(</span><span class="n">ogg_int16_t</span> <span class="n">_y</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span><span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="n">_x</span><span class="p">[</span><span class="mi">64</span><span class="p">]){</span>
<a name="gbab-135"></a>  <span class="k">const</span> <span class="n">ogg_int16_t</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>
<a name="gbab-136"></a>  <span class="n">ogg_int16_t</span>       <span class="o">*</span><span class="n">end</span><span class="p">;</span>
<a name="gbab-137"></a>  <span class="n">ogg_int16_t</span>       <span class="o">*</span><span class="n">out</span><span class="p">;</span>
<a name="gbab-138"></a>  <span class="n">ogg_int16_t</span>        <span class="n">w</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<a name="gbab-139"></a>  <span class="kt">int</span>                <span class="n">i</span><span class="p">;</span>
<a name="gbab-140"></a>  <span class="cm">/*Add two extra bits of working precision to improve accuracy; any more and</span>
<a name="gbab-141"></a><span class="cm">     we could overflow.*/</span>
<a name="gbab-142"></a>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">;</span>
<a name="gbab-143"></a>  <span class="cm">/*These biases correct for some systematic error that remains in the full</span>
<a name="gbab-144"></a><span class="cm">     fDCT-&gt;iDCT round trip.*/</span>
<a name="gbab-145"></a>  <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-146"></a>  <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-147"></a>  <span class="n">w</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
<a name="gbab-148"></a>  <span class="cm">/*Transform columns of w into rows of _y.*/</span>
<a name="gbab-149"></a>  <span class="k">for</span><span class="p">(</span><span class="n">in</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">_y</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="n">out</span><span class="o">+</span><span class="mi">64</span><span class="p">;</span><span class="n">out</span><span class="o">&lt;</span><span class="n">end</span><span class="p">;</span><span class="n">in</span><span class="o">++</span><span class="p">,</span><span class="n">out</span><span class="o">+=</span><span class="mi">8</span><span class="p">)</span><span class="n">oc_fdct8</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">in</span><span class="p">);</span>
<a name="gbab-150"></a>  <span class="cm">/*Transform columns of _y into rows of w.*/</span>
<a name="gbab-151"></a>  <span class="k">for</span><span class="p">(</span><span class="n">in</span><span class="o">=</span><span class="n">_y</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="n">out</span><span class="o">+</span><span class="mi">64</span><span class="p">;</span><span class="n">out</span><span class="o">&lt;</span><span class="n">end</span><span class="p">;</span><span class="n">in</span><span class="o">++</span><span class="p">,</span><span class="n">out</span><span class="o">+=</span><span class="mi">8</span><span class="p">)</span><span class="n">oc_fdct8</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">in</span><span class="p">);</span>
<a name="gbab-152"></a>  <span class="cm">/*Round the result back to the external working precision (which is still</span>
<a name="gbab-153"></a><span class="cm">     scaled by four relative to the orthogonal result).</span>
<a name="gbab-154"></a><span class="cm">    TODO: We should just update the external working precision.*/</span>
<a name="gbab-155"></a>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="n">_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">;</span>
<a name="gbab-156"></a><span class="p">}</span>
<a name="gbab-157"></a>
<a name="gbab-158"></a>
<a name="gbab-159"></a>
<a name="gbab-160"></a><span class="cm">/*This does not seem to outperform simple LFE border padding before MC.</span>
<a name="gbab-161"></a><span class="cm">  It yields higher PSNR, but much higher bitrate usage.*/</span>
<a name="gbab-162"></a><span class="cp">#if 0</span><span class="c"></span>
<a name="gbab-163"></a><span class="c">typedef struct oc_extension_info oc_extension_info;</span>
<a name="gbab-164"></a>
<a name="gbab-165"></a>
<a name="gbab-166"></a>
<a name="gbab-167"></a><span class="c">/*Information needed to pad boundary blocks.</span>
<a name="gbab-168"></a><span class="c">  We multiply each row/column by an extension matrix that fills in the padding</span>
<a name="gbab-169"></a><span class="c">   values as a linear combination of the active values, so that an equivalent</span>
<a name="gbab-170"></a><span class="c">   number of coefficients are forced to zero.</span>
<a name="gbab-171"></a><span class="c">  This costs at most 16 multiplies, the same as a 1-D fDCT itself, and as</span>
<a name="gbab-172"></a><span class="c">   little as 7 multiplies.</span>
<a name="gbab-173"></a><span class="c">  We compute the extension matrices for every possible shape in advance, as</span>
<a name="gbab-174"></a><span class="c">   there are only 35.</span>
<a name="gbab-175"></a><span class="c">  The coefficients for all matrices are stored in a single array to take</span>
<a name="gbab-176"></a><span class="c">   advantage of the overlap and repetitiveness of many of the shapes.</span>
<a name="gbab-177"></a><span class="c">  A similar technique is applied to the offsets into this array.</span>
<a name="gbab-178"></a><span class="c">  This reduces the required table storage by about 48%.</span>
<a name="gbab-179"></a><span class="c">  See tools/extgen.c for details.</span>
<a name="gbab-180"></a><span class="c">  We could conceivably do the same for all 256 possible shapes.*/</span>
<a name="gbab-181"></a><span class="c">struct oc_extension_info{</span>
<a name="gbab-182"></a><span class="c">  /*The mask of the active pixels in the shape.*/</span>
<a name="gbab-183"></a><span class="c">  short                     mask;</span>
<a name="gbab-184"></a><span class="c">  /*The number of active pixels in the shape.*/</span>
<a name="gbab-185"></a><span class="c">  short                     na;</span>
<a name="gbab-186"></a><span class="c">  /*The extension matrix.</span>
<a name="gbab-187"></a><span class="c">    This is (8-na)xna*/</span>
<a name="gbab-188"></a><span class="c">  const ogg_int16_t *const *ext;</span>
<a name="gbab-189"></a><span class="c">  /*The pixel indices: na active pixels followed by 8-na padding pixels.*/</span>
<a name="gbab-190"></a><span class="c">  unsigned char             pi[8];</span>
<a name="gbab-191"></a><span class="c">  /*The coefficient indices: na unconstrained coefficients followed by 8-na</span>
<a name="gbab-192"></a><span class="c">     coefficients to be forced to zero.*/</span>
<a name="gbab-193"></a><span class="c">  unsigned char             ci[8];</span>
<a name="gbab-194"></a><span class="c">};</span>
<a name="gbab-195"></a>
<a name="gbab-196"></a>
<a name="gbab-197"></a><span class="c">/*The number of shapes we need.*/</span>
<a name="gbab-198"></a><span class="c">#define OC_NSHAPES   (35)</span>
<a name="gbab-199"></a>
<a name="gbab-200"></a><span class="c">static const ogg_int16_t OC_EXT_COEFFS[229]={</span>
<a name="gbab-201"></a><span class="c">  0x7FFF,0xE1F8,0x6903,0xAA79,0x5587,0x7FFF,0x1E08,0x7FFF,</span>
<a name="gbab-202"></a><span class="c">  0x5587,0xAA79,0x6903,0xE1F8,0x7FFF,0x0000,0x0000,0x0000,</span>
<a name="gbab-203"></a><span class="c">  0x7FFF,0x0000,0x0000,0x7FFF,0x8000,0x7FFF,0x0000,0x0000,</span>
<a name="gbab-204"></a><span class="c">  0x7FFF,0xE1F8,0x1E08,0xB0A7,0xAA1D,0x337C,0x7FFF,0x4345,</span>
<a name="gbab-205"></a><span class="c">  0x2267,0x4345,0x7FFF,0x337C,0xAA1D,0xB0A7,0x8A8C,0x4F59,</span>
<a name="gbab-206"></a><span class="c">  0x03B4,0xE2D6,0x7FFF,0x2CF3,0x7FFF,0xE2D6,0x03B4,0x4F59,</span>
<a name="gbab-207"></a><span class="c">  0x8A8C,0x1103,0x7AEF,0x5225,0xDF60,0xC288,0xDF60,0x5225,</span>
<a name="gbab-208"></a><span class="c">  0x7AEF,0x1103,0x668A,0xD6EE,0x3A16,0x0E6C,0xFA07,0x0E6C,</span>
<a name="gbab-209"></a><span class="c">  0x3A16,0xD6EE,0x668A,0x2A79,0x2402,0x980F,0x50F5,0x4882,</span>
<a name="gbab-210"></a><span class="c">  0x50F5,0x980F,0x2402,0x2A79,0xF976,0x2768,0x5F22,0x2768,</span>
<a name="gbab-211"></a><span class="c">  0xF976,0x1F91,0x76C1,0xE9AE,0x76C1,0x1F91,0x7FFF,0xD185,</span>
<a name="gbab-212"></a><span class="c">  0x0FC8,0xD185,0x7FFF,0x4F59,0x4345,0xED62,0x4345,0x4F59,</span>
<a name="gbab-213"></a><span class="c">  0xF574,0x5D99,0x2CF3,0x5D99,0xF574,0x5587,0x3505,0x30FC,</span>
<a name="gbab-214"></a><span class="c">  0xF482,0x953C,0xEAC4,0x7FFF,0x4F04,0x7FFF,0xEAC4,0x953C,</span>
<a name="gbab-215"></a><span class="c">  0xF482,0x30FC,0x4F04,0x273D,0xD8C3,0x273D,0x1E09,0x61F7,</span>
<a name="gbab-216"></a><span class="c">  0x1E09,0x273D,0xD8C3,0x273D,0x4F04,0x30FC,0xA57E,0x153C,</span>
<a name="gbab-217"></a><span class="c">  0x6AC4,0x3C7A,0x1E08,0x3C7A,0x6AC4,0x153C,0xA57E,0x7FFF,</span>
<a name="gbab-218"></a><span class="c">  0xA57E,0x5A82,0x6AC4,0x153C,0xC386,0xE1F8,0xC386,0x153C,</span>
<a name="gbab-219"></a><span class="c">  0x6AC4,0x5A82,0xD8C3,0x273D,0x7FFF,0xE1F7,0x7FFF,0x273D,</span>
<a name="gbab-220"></a><span class="c">  0xD8C3,0x4F04,0x30FC,0xD8C3,0x273D,0xD8C3,0x30FC,0x4F04,</span>
<a name="gbab-221"></a><span class="c">  0x1FC8,0x67AD,0x1853,0xE038,0x1853,0x67AD,0x1FC8,0x4546,</span>
<a name="gbab-222"></a><span class="c">  0xE038,0x1FC8,0x3ABA,0x1FC8,0xE038,0x4546,0x3505,0x5587,</span>
<a name="gbab-223"></a><span class="c">  0xF574,0xBC11,0x78F4,0x4AFB,0xE6F3,0x4E12,0x3C11,0xF8F4,</span>
<a name="gbab-224"></a><span class="c">  0x4AFB,0x3C7A,0xF88B,0x3C11,0x78F4,0xCAFB,0x7FFF,0x08CC,</span>
<a name="gbab-225"></a><span class="c">  0x070C,0x236D,0x5587,0x236D,0x070C,0xF88B,0x3C7A,0x4AFB,</span>
<a name="gbab-226"></a><span class="c">  0xF8F4,0x3C11,0x7FFF,0x153C,0xCAFB,0x153C,0x7FFF,0x1E08,</span>
<a name="gbab-227"></a><span class="c">  0xE1F8,0x7FFF,0x08CC,0x7FFF,0xCAFB,0x78F4,0x3C11,0x4E12,</span>
<a name="gbab-228"></a><span class="c">  0xE6F3,0x4AFB,0x78F4,0xBC11,0xFE3D,0x7FFF,0xFE3D,0x2F3A,</span>
<a name="gbab-229"></a><span class="c">  0x7FFF,0x2F3A,0x89BC,0x7FFF,0x89BC</span>
<a name="gbab-230"></a><span class="c">};</span>
<a name="gbab-231"></a>
<a name="gbab-232"></a><span class="c">static const ogg_int16_t *const OC_EXT_ROWS[96]={</span>
<a name="gbab-233"></a><span class="c">  OC_EXT_COEFFS+   0,OC_EXT_COEFFS+   0,OC_EXT_COEFFS+   0,OC_EXT_COEFFS+   0,</span>
<a name="gbab-234"></a><span class="c">  OC_EXT_COEFFS+   0,OC_EXT_COEFFS+   0,OC_EXT_COEFFS+   0,OC_EXT_COEFFS+   6,</span>
<a name="gbab-235"></a><span class="c">  OC_EXT_COEFFS+  27,OC_EXT_COEFFS+  38,OC_EXT_COEFFS+  43,OC_EXT_COEFFS+  32,</span>
<a name="gbab-236"></a><span class="c">  OC_EXT_COEFFS+  49,OC_EXT_COEFFS+  58,OC_EXT_COEFFS+  67,OC_EXT_COEFFS+  71,</span>
<a name="gbab-237"></a><span class="c">  OC_EXT_COEFFS+  62,OC_EXT_COEFFS+  53,OC_EXT_COEFFS+  12,OC_EXT_COEFFS+  15,</span>
<a name="gbab-238"></a><span class="c">  OC_EXT_COEFFS+  14,OC_EXT_COEFFS+  13,OC_EXT_COEFFS+  76,OC_EXT_COEFFS+  81,</span>
<a name="gbab-239"></a><span class="c">  OC_EXT_COEFFS+  86,OC_EXT_COEFFS+  91,OC_EXT_COEFFS+  96,OC_EXT_COEFFS+  98,</span>
<a name="gbab-240"></a><span class="c">  OC_EXT_COEFFS+  93,OC_EXT_COEFFS+  88,OC_EXT_COEFFS+  83,OC_EXT_COEFFS+  78,</span>
<a name="gbab-241"></a><span class="c">  OC_EXT_COEFFS+  12,OC_EXT_COEFFS+  15,OC_EXT_COEFFS+  15,OC_EXT_COEFFS+  12,</span>
<a name="gbab-242"></a><span class="c">  OC_EXT_COEFFS+  12,OC_EXT_COEFFS+  15,OC_EXT_COEFFS+  12,OC_EXT_COEFFS+  15,</span>
<a name="gbab-243"></a><span class="c">  OC_EXT_COEFFS+  15,OC_EXT_COEFFS+  12,OC_EXT_COEFFS+ 103,OC_EXT_COEFFS+ 108,</span>
<a name="gbab-244"></a><span class="c">  OC_EXT_COEFFS+ 126,OC_EXT_COEFFS+  16,OC_EXT_COEFFS+ 137,OC_EXT_COEFFS+ 141,</span>
<a name="gbab-245"></a><span class="c">  OC_EXT_COEFFS+  20,OC_EXT_COEFFS+ 130,OC_EXT_COEFFS+ 113,OC_EXT_COEFFS+ 116,</span>
<a name="gbab-246"></a><span class="c">  OC_EXT_COEFFS+ 146,OC_EXT_COEFFS+ 153,OC_EXT_COEFFS+ 160,OC_EXT_COEFFS+ 167,</span>
<a name="gbab-247"></a><span class="c">  OC_EXT_COEFFS+ 170,OC_EXT_COEFFS+ 163,OC_EXT_COEFFS+ 156,OC_EXT_COEFFS+ 149,</span>
<a name="gbab-248"></a><span class="c">  OC_EXT_COEFFS+ 119,OC_EXT_COEFFS+ 122,OC_EXT_COEFFS+ 174,OC_EXT_COEFFS+ 177,</span>
<a name="gbab-249"></a><span class="c">  OC_EXT_COEFFS+ 182,OC_EXT_COEFFS+ 187,OC_EXT_COEFFS+ 192,OC_EXT_COEFFS+ 197,</span>
<a name="gbab-250"></a><span class="c">  OC_EXT_COEFFS+ 202,OC_EXT_COEFFS+ 207,OC_EXT_COEFFS+ 210,OC_EXT_COEFFS+ 215,</span>
<a name="gbab-251"></a><span class="c">  OC_EXT_COEFFS+ 179,OC_EXT_COEFFS+ 189,OC_EXT_COEFFS+  24,OC_EXT_COEFFS+ 204,</span>
<a name="gbab-252"></a><span class="c">  OC_EXT_COEFFS+ 184,OC_EXT_COEFFS+ 194,OC_EXT_COEFFS+ 212,OC_EXT_COEFFS+ 199,</span>
<a name="gbab-253"></a><span class="c">  OC_EXT_COEFFS+ 217,OC_EXT_COEFFS+ 100,OC_EXT_COEFFS+ 134,OC_EXT_COEFFS+ 135,</span>
<a name="gbab-254"></a><span class="c">  OC_EXT_COEFFS+ 135,OC_EXT_COEFFS+  12,OC_EXT_COEFFS+  15,OC_EXT_COEFFS+ 134,</span>
<a name="gbab-255"></a><span class="c">  OC_EXT_COEFFS+ 134,OC_EXT_COEFFS+ 135,OC_EXT_COEFFS+ 220,OC_EXT_COEFFS+ 223,</span>
<a name="gbab-256"></a><span class="c">  OC_EXT_COEFFS+ 226,OC_EXT_COEFFS+ 227,OC_EXT_COEFFS+ 224,OC_EXT_COEFFS+ 221</span>
<a name="gbab-257"></a><span class="c">};</span>
<a name="gbab-258"></a>
<a name="gbab-259"></a><span class="c">static const oc_extension_info OC_EXTENSION_INFO[OC_NSHAPES]={</span>
<a name="gbab-260"></a><span class="c">  {0x7F,7,OC_EXT_ROWS+  0,{0,1,2,3,4,5,6,7},{0,1,2,4,5,6,7,3}},</span>
<a name="gbab-261"></a><span class="c">  {0xFE,7,OC_EXT_ROWS+  7,{1,2,3,4,5,6,7,0},{0,1,2,4,5,6,7,3}},</span>
<a name="gbab-262"></a><span class="c">  {0x3F,6,OC_EXT_ROWS+  8,{0,1,2,3,4,5,7,6},{0,1,3,4,6,7,5,2}},</span>
<a name="gbab-263"></a><span class="c">  {0xFC,6,OC_EXT_ROWS+ 10,{2,3,4,5,6,7,1,0},{0,1,3,4,6,7,5,2}},</span>
<a name="gbab-264"></a><span class="c">  {0x1F,5,OC_EXT_ROWS+ 12,{0,1,2,3,4,7,6,5},{0,2,3,5,7,6,4,1}},</span>
<a name="gbab-265"></a><span class="c">  {0xF8,5,OC_EXT_ROWS+ 15,{3,4,5,6,7,2,1,0},{0,2,3,5,7,6,4,1}},</span>
<a name="gbab-266"></a><span class="c">  {0x0F,4,OC_EXT_ROWS+ 18,{0,1,2,3,7,6,5,4},{0,2,4,6,7,5,3,1}},</span>
<a name="gbab-267"></a><span class="c">  {0xF0,4,OC_EXT_ROWS+ 18,{4,5,6,7,3,2,1,0},{0,2,4,6,7,5,3,1}},</span>
<a name="gbab-268"></a><span class="c">  {0x07,3,OC_EXT_ROWS+ 22,{0,1,2,7,6,5,4,3},{0,3,6,7,5,4,2,1}},</span>
<a name="gbab-269"></a><span class="c">  {0xE0,3,OC_EXT_ROWS+ 27,{5,6,7,4,3,2,1,0},{0,3,6,7,5,4,2,1}},</span>
<a name="gbab-270"></a><span class="c">  {0x03,2,OC_EXT_ROWS+ 32,{0,1,7,6,5,4,3,2},{0,4,7,6,5,3,2,1}},</span>
<a name="gbab-271"></a><span class="c">  {0xC0,2,OC_EXT_ROWS+ 32,{6,7,5,4,3,2,1,0},{0,4,7,6,5,3,2,1}},</span>
<a name="gbab-272"></a><span class="c">  {0x01,1,OC_EXT_ROWS+  0,{0,7,6,5,4,3,2,1},{0,7,6,5,4,3,2,1}},</span>
<a name="gbab-273"></a><span class="c">  {0x80,1,OC_EXT_ROWS+  0,{7,6,5,4,3,2,1,0},{0,7,6,5,4,3,2,1}},</span>
<a name="gbab-274"></a><span class="c">  {0x7E,6,OC_EXT_ROWS+ 42,{1,2,3,4,5,6,7,0},{0,1,2,5,6,7,4,3}},</span>
<a name="gbab-275"></a><span class="c">  {0x7C,5,OC_EXT_ROWS+ 44,{2,3,4,5,6,7,1,0},{0,1,4,5,7,6,3,2}},</span>
<a name="gbab-276"></a><span class="c">  {0x3E,5,OC_EXT_ROWS+ 47,{1,2,3,4,5,7,6,0},{0,1,4,5,7,6,3,2}},</span>
<a name="gbab-277"></a><span class="c">  {0x78,4,OC_EXT_ROWS+ 50,{3,4,5,6,7,2,1,0},{0,4,5,7,6,3,2,1}},</span>
<a name="gbab-278"></a><span class="c">  {0x3C,4,OC_EXT_ROWS+ 54,{2,3,4,5,7,6,1,0},{0,3,4,7,6,5,2,1}},</span>
<a name="gbab-279"></a><span class="c">  {0x1E,4,OC_EXT_ROWS+ 58,{1,2,3,4,7,6,5,0},{0,4,5,7,6,3,2,1}},</span>
<a name="gbab-280"></a><span class="c">  {0x70,3,OC_EXT_ROWS+ 62,{4,5,6,7,3,2,1,0},{0,5,7,6,4,3,2,1}},</span>
<a name="gbab-281"></a><span class="c">  {0x38,3,OC_EXT_ROWS+ 67,{3,4,5,7,6,2,1,0},{0,5,6,7,4,3,2,1}},</span>
<a name="gbab-282"></a><span class="c">  {0x1C,3,OC_EXT_ROWS+ 72,{2,3,4,7,6,5,1,0},{0,5,6,7,4,3,2,1}},</span>
<a name="gbab-283"></a><span class="c">  {0x0E,3,OC_EXT_ROWS+ 77,{1,2,3,7,6,5,4,0},{0,5,7,6,4,3,2,1}},</span>
<a name="gbab-284"></a><span class="c">  {0x60,2,OC_EXT_ROWS+ 82,{5,6,7,4,3,2,1,0},{0,2,7,6,5,4,3,1}},</span>
<a name="gbab-285"></a><span class="c">  {0x30,2,OC_EXT_ROWS+ 36,{4,5,7,6,3,2,1,0},{0,4,7,6,5,3,2,1}},</span>
<a name="gbab-286"></a><span class="c">  {0x18,2,OC_EXT_ROWS+ 90,{3,4,7,6,5,2,1,0},{0,1,7,6,5,4,3,2}},</span>
<a name="gbab-287"></a><span class="c">  {0x0C,2,OC_EXT_ROWS+ 34,{2,3,7,6,5,4,1,0},{0,4,7,6,5,3,2,1}},</span>
<a name="gbab-288"></a><span class="c">  {0x06,2,OC_EXT_ROWS+ 84,{1,2,7,6,5,4,3,0},{0,2,7,6,5,4,3,1}},</span>
<a name="gbab-289"></a><span class="c">  {0x40,1,OC_EXT_ROWS+  0,{6,7,5,4,3,2,1,0},{0,7,6,5,4,3,2,1}},</span>
<a name="gbab-290"></a><span class="c">  {0x20,1,OC_EXT_ROWS+  0,{5,7,6,4,3,2,1,0},{0,7,6,5,4,3,2,1}},</span>
<a name="gbab-291"></a><span class="c">  {0x10,1,OC_EXT_ROWS+  0,{4,7,6,5,3,2,1,0},{0,7,6,5,4,3,2,1}},</span>
<a name="gbab-292"></a><span class="c">  {0x08,1,OC_EXT_ROWS+  0,{3,7,6,5,4,2,1,0},{0,7,6,5,4,3,2,1}},</span>
<a name="gbab-293"></a><span class="c">  {0x04,1,OC_EXT_ROWS+  0,{2,7,6,5,4,3,1,0},{0,7,6,5,4,3,2,1}},</span>
<a name="gbab-294"></a><span class="c">  {0x02,1,OC_EXT_ROWS+  0,{1,7,6,5,4,3,2,0},{0,7,6,5,4,3,2,1}}</span>
<a name="gbab-295"></a><span class="c">};</span>
<a name="gbab-296"></a>
<a name="gbab-297"></a>
<a name="gbab-298"></a>
<a name="gbab-299"></a><span class="c">/*Pads a single column of a partial block and then performs a forward Type-II</span>
<a name="gbab-300"></a><span class="c">   DCT on the result.</span>
<a name="gbab-301"></a><span class="c">  The input is scaled by a factor of 4 and biased appropriately for the current</span>
<a name="gbab-302"></a><span class="c">   fDCT implementation.</span>
<a name="gbab-303"></a><span class="c">  The output is scaled by an additional factor of 2 from the orthonormal</span>
<a name="gbab-304"></a><span class="c">   version of the transform.</span>
<a name="gbab-305"></a><span class="c">  _y: The buffer to store the result in.</span>
<a name="gbab-306"></a><span class="c">      Data will be placed the first 8 entries (e.g., in a row of an 8x8 block).</span>
<a name="gbab-307"></a><span class="c">  _x: The input coefficients.</span>
<a name="gbab-308"></a><span class="c">      Every 8th entry is used (e.g., from a column of an 8x8 block).</span>
<a name="gbab-309"></a><span class="c">  _e: The extension information for the shape.*/</span>
<a name="gbab-310"></a><span class="c">static void oc_fdct8_ext(ogg_int16_t _y[8],ogg_int16_t *_x,</span>
<a name="gbab-311"></a><span class="c"> const oc_extension_info *_e){</span>
<a name="gbab-312"></a><span class="c">  const unsigned char *pi;</span>
<a name="gbab-313"></a><span class="c">  int                  na;</span>
<a name="gbab-314"></a><span class="c">  na=_e-&gt;na;</span>
<a name="gbab-315"></a><span class="c">  pi=_e-&gt;pi;</span>
<a name="gbab-316"></a><span class="c">  if(na==1){</span>
<a name="gbab-317"></a><span class="c">    int ci;</span>
<a name="gbab-318"></a><span class="c">    /*While the branch below is still correct for shapes with na==1, we can</span>
<a name="gbab-319"></a><span class="c">       perform the entire transform with just 1 multiply in this case instead</span>
<a name="gbab-320"></a><span class="c">       of 23.*/</span>
<a name="gbab-321"></a><span class="c">    _y[0]=(ogg_int16_t)(OC_DIV2_16(OC_C4S4*(_x[pi[0]])));</span>
<a name="gbab-322"></a><span class="c">    for(ci=1;ci&lt;8;ci++)_y[ci]=0;</span>
<a name="gbab-323"></a><span class="c">  }</span>
<a name="gbab-324"></a><span class="c">  else{</span>
<a name="gbab-325"></a><span class="c">    const ogg_int16_t *const *ext;</span>
<a name="gbab-326"></a><span class="c">    int                       zpi;</span>
<a name="gbab-327"></a><span class="c">    int                       api;</span>
<a name="gbab-328"></a><span class="c">    int                       nz;</span>
<a name="gbab-329"></a><span class="c">    /*First multiply by the extension matrix to compute the padding values.*/</span>
<a name="gbab-330"></a><span class="c">    nz=8-na;</span>
<a name="gbab-331"></a><span class="c">    ext=_e-&gt;ext;</span>
<a name="gbab-332"></a><span class="c">    for(zpi=0;zpi&lt;nz;zpi++){</span>
<a name="gbab-333"></a><span class="c">      ogg_int32_t v;</span>
<a name="gbab-334"></a><span class="c">      v=0;</span>
<a name="gbab-335"></a><span class="c">      for(api=0;api&lt;na;api++){</span>
<a name="gbab-336"></a><span class="c">        v+=ext[zpi][api]*(ogg_int32_t)(_x[pi[api]&lt;&lt;3]&lt;&lt;1);</span>
<a name="gbab-337"></a><span class="c">      }</span>
<a name="gbab-338"></a><span class="c">      _x[pi[na+zpi]&lt;&lt;3]=(ogg_int16_t)(v+0x8000&gt;&gt;16)+1&gt;&gt;1;</span>
<a name="gbab-339"></a><span class="c">    }</span>
<a name="gbab-340"></a><span class="c">    oc_fdct8(_y,_x);</span>
<a name="gbab-341"></a><span class="c">  }</span>
<a name="gbab-342"></a><span class="c">}</span>
<a name="gbab-343"></a>
<a name="gbab-344"></a><span class="c">/*Performs a forward 8x8 Type-II DCT transform on blocks which overlap the</span>
<a name="gbab-345"></a><span class="c">   border of the picture region.</span>
<a name="gbab-346"></a><span class="c">  This method ONLY works with rectangular regions.</span>
<a name="gbab-347"></a><span class="c">  _border: A description of which pixels are inside the border.</span>
<a name="gbab-348"></a><span class="c">  _y:      The buffer to store the result in.</span>
<a name="gbab-349"></a><span class="c">           This may be the same as _x.</span>
<a name="gbab-350"></a><span class="c">  _x:      The input pixel values.</span>
<a name="gbab-351"></a><span class="c">           Pixel values outside the border will be ignored.*/</span>
<a name="gbab-352"></a><span class="c">void oc_fdct8x8_border(const oc_border_info *_border,</span>
<a name="gbab-353"></a><span class="c"> ogg_int16_t _y[64],const ogg_int16_t _x[64]){</span>
<a name="gbab-354"></a><span class="c">  ogg_int16_t             *in;</span>
<a name="gbab-355"></a><span class="c">  ogg_int16_t             *out;</span>
<a name="gbab-356"></a><span class="c">  ogg_int16_t              w[64];</span>
<a name="gbab-357"></a><span class="c">  ogg_int64_t              mask;</span>
<a name="gbab-358"></a><span class="c">  const oc_extension_info *cext;</span>
<a name="gbab-359"></a><span class="c">  const oc_extension_info *rext;</span>
<a name="gbab-360"></a><span class="c">  int                      cmask;</span>
<a name="gbab-361"></a><span class="c">  int                      rmask;</span>
<a name="gbab-362"></a><span class="c">  int                      ri;</span>
<a name="gbab-363"></a><span class="c">  int                      ci;</span>
<a name="gbab-364"></a><span class="c">  /*Identify the shapes of the non-zero rows and columns.*/</span>
<a name="gbab-365"></a><span class="c">  rmask=cmask=0;</span>
<a name="gbab-366"></a><span class="c">  mask=_border-&gt;mask;</span>
<a name="gbab-367"></a><span class="c">  for(ri=0;ri&lt;8;ri++){</span>
<a name="gbab-368"></a><span class="c">    /*This aggregation is _only_ correct for rectangular masks.*/</span>
<a name="gbab-369"></a><span class="c">    cmask|=((mask&amp;0xFF)!=0)&lt;&lt;ri;</span>
<a name="gbab-370"></a><span class="c">    rmask|=mask&amp;0xFF;</span>
<a name="gbab-371"></a><span class="c">    mask&gt;&gt;=8;</span>
<a name="gbab-372"></a><span class="c">  }</span>
<a name="gbab-373"></a><span class="c">  /*Find the associated extension info for these shapes.*/</span>
<a name="gbab-374"></a><span class="c">  if(cmask==0xFF)cext=NULL;</span>
<a name="gbab-375"></a><span class="c">  else for(cext=OC_EXTENSION_INFO;cext-&gt;mask!=cmask;){</span>
<a name="gbab-376"></a><span class="c">    /*If we somehow can&#39;t find the shape, then just do an unpadded fDCT.</span>
<a name="gbab-377"></a><span class="c">      It won&#39;t be efficient, but it should still be correct.*/</span>
<a name="gbab-378"></a><span class="c">    if(++cext&gt;=OC_EXTENSION_INFO+OC_NSHAPES){</span>
<a name="gbab-379"></a><span class="c">      oc_enc_fdct8x8_c(_y,_x);</span>
<a name="gbab-380"></a><span class="c">      return;</span>
<a name="gbab-381"></a><span class="c">    }</span>
<a name="gbab-382"></a><span class="c">  }</span>
<a name="gbab-383"></a><span class="c">  if(rmask==0xFF)rext=NULL;</span>
<a name="gbab-384"></a><span class="c">  else for(rext=OC_EXTENSION_INFO;rext-&gt;mask!=rmask;){</span>
<a name="gbab-385"></a><span class="c">    /*If we somehow can&#39;t find the shape, then just do an unpadded fDCT.</span>
<a name="gbab-386"></a><span class="c">      It won&#39;t be efficient, but it should still be correct.*/</span>
<a name="gbab-387"></a><span class="c">    if(++rext&gt;=OC_EXTENSION_INFO+OC_NSHAPES){</span>
<a name="gbab-388"></a><span class="c">      oc_enc_fdct8x8_c(_y,_x);</span>
<a name="gbab-389"></a><span class="c">      return;</span>
<a name="gbab-390"></a><span class="c">    }</span>
<a name="gbab-391"></a><span class="c">  }</span>
<a name="gbab-392"></a><span class="c">  /*Add two extra bits of working precision to improve accuracy; any more and</span>
<a name="gbab-393"></a><span class="c">     we could overflow.*/</span>
<a name="gbab-394"></a><span class="c">  for(ci=0;ci&lt;64;ci++)w[ci]=_x[ci]&lt;&lt;2;</span>
<a name="gbab-395"></a><span class="c">  /*These biases correct for some systematic error that remains in the full</span>
<a name="gbab-396"></a><span class="c">     fDCT-&gt;iDCT round trip.</span>
<a name="gbab-397"></a><span class="c">    We can safely add them before padding, since if these pixel values are</span>
<a name="gbab-398"></a><span class="c">     overwritten, we didn&#39;t care what they were anyway (and the unbiased values</span>
<a name="gbab-399"></a><span class="c">     will usually yield smaller DCT coefficient magnitudes).*/</span>
<a name="gbab-400"></a><span class="c">  w[0]+=(w[0]!=0)+1;</span>
<a name="gbab-401"></a><span class="c">  w[1]++;</span>
<a name="gbab-402"></a><span class="c">  w[8]--;</span>
<a name="gbab-403"></a><span class="c">  /*Transform the columns.</span>
<a name="gbab-404"></a><span class="c">    We can ignore zero columns without a problem.*/</span>
<a name="gbab-405"></a><span class="c">  in=w;</span>
<a name="gbab-406"></a><span class="c">  out=_y;</span>
<a name="gbab-407"></a><span class="c">  if(cext==NULL)for(ci=0;ci&lt;8;ci++)oc_fdct8(out+(ci&lt;&lt;3),in+ci);</span>
<a name="gbab-408"></a><span class="c">  else for(ci=0;ci&lt;8;ci++)if(rmask&amp;(1&lt;&lt;ci))oc_fdct8_ext(out+(ci&lt;&lt;3),in+ci,cext);</span>
<a name="gbab-409"></a><span class="c">  /*Transform the rows.</span>
<a name="gbab-410"></a><span class="c">    We transform even rows that are supposedly zero, because rounding errors</span>
<a name="gbab-411"></a><span class="c">     may make them slightly non-zero, and this will give a more precise</span>
<a name="gbab-412"></a><span class="c">     reconstruction with very small quantizers.*/</span>
<a name="gbab-413"></a><span class="c">  in=_y;</span>
<a name="gbab-414"></a><span class="c">  out=w;</span>
<a name="gbab-415"></a><span class="c">  if(rext==NULL)for(ri=0;ri&lt;8;ri++)oc_fdct8(out+(ri&lt;&lt;3),in+ri);</span>
<a name="gbab-416"></a><span class="c">  else for(ri=0;ri&lt;8;ri++)oc_fdct8_ext(out+(ri&lt;&lt;3),in+ri,rext);</span>
<a name="gbab-417"></a><span class="c">  /*Round the result back to the external working precision (which is still</span>
<a name="gbab-418"></a><span class="c">     scaled by four relative to the orthogonal result).</span>
<a name="gbab-419"></a><span class="c">    TODO: We should just update the external working precision.*/</span>
<a name="gbab-420"></a><span class="c">  for(ci=0;ci&lt;64;ci++)_y[ci]=w[ci]+2&gt;&gt;2;</span>
<a name="gbab-421"></a><span class="c">}</span>
<a name="gbab-422"></a><span class="cp">#endif</span>
</pre></div>
</td></tr></table>