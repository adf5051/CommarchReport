<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>   1
   2
   3
   4
   5
   6
   7
   8
   9
  10
  11
  12
  13
  14
  15
  16
  17
  18
  19
  20
  21
  22
  23
  24
  25
  26
  27
  28
  29
  30
  31
  32
  33
  34
  35
  36
  37
  38
  39
  40
  41
  42
  43
  44
  45
  46
  47
  48
  49
  50
  51
  52
  53
  54
  55
  56
  57
  58
  59
  60
  61
  62
  63
  64
  65
  66
  67
  68
  69
  70
  71
  72
  73
  74
  75
  76
  77
  78
  79
  80
  81
  82
  83
  84
  85
  86
  87
  88
  89
  90
  91
  92
  93
  94
  95
  96
  97
  98
  99
 100
 101
 102
 103
 104
 105
 106
 107
 108
 109
 110
 111
 112
 113
 114
 115
 116
 117
 118
 119
 120
 121
 122
 123
 124
 125
 126
 127
 128
 129
 130
 131
 132
 133
 134
 135
 136
 137
 138
 139
 140
 141
 142
 143
 144
 145
 146
 147
 148
 149
 150
 151
 152
 153
 154
 155
 156
 157
 158
 159
 160
 161
 162
 163
 164
 165
 166
 167
 168
 169
 170
 171
 172
 173
 174
 175
 176
 177
 178
 179
 180
 181
 182
 183
 184
 185
 186
 187
 188
 189
 190
 191
 192
 193
 194
 195
 196
 197
 198
 199
 200
 201
 202
 203
 204
 205
 206
 207
 208
 209
 210
 211
 212
 213
 214
 215
 216
 217
 218
 219
 220
 221
 222
 223
 224
 225
 226
 227
 228
 229
 230
 231
 232
 233
 234
 235
 236
 237
 238
 239
 240
 241
 242
 243
 244
 245
 246
 247
 248
 249
 250
 251
 252
 253
 254
 255
 256
 257
 258
 259
 260
 261
 262
 263
 264
 265
 266
 267
 268
 269
 270
 271
 272
 273
 274
 275
 276
 277
 278
 279
 280
 281
 282
 283
 284
 285
 286
 287
 288
 289
 290
 291
 292
 293
 294
 295
 296
 297
 298
 299
 300
 301
 302
 303
 304
 305
 306
 307
 308
 309
 310
 311
 312
 313
 314
 315
 316
 317
 318
 319
 320
 321
 322
 323
 324
 325
 326
 327
 328
 329
 330
 331
 332
 333
 334
 335
 336
 337
 338
 339
 340
 341
 342
 343
 344
 345
 346
 347
 348
 349
 350
 351
 352
 353
 354
 355
 356
 357
 358
 359
 360
 361
 362
 363
 364
 365
 366
 367
 368
 369
 370
 371
 372
 373
 374
 375
 376
 377
 378
 379
 380
 381
 382
 383
 384
 385
 386
 387
 388
 389
 390
 391
 392
 393
 394
 395
 396
 397
 398
 399
 400
 401
 402
 403
 404
 405
 406
 407
 408
 409
 410
 411
 412
 413
 414
 415
 416
 417
 418
 419
 420
 421
 422
 423
 424
 425
 426
 427
 428
 429
 430
 431
 432
 433
 434
 435
 436
 437
 438
 439
 440
 441
 442
 443
 444
 445
 446
 447
 448
 449
 450
 451
 452
 453
 454
 455
 456
 457
 458
 459
 460
 461
 462
 463
 464
 465
 466
 467
 468
 469
 470
 471
 472
 473
 474
 475
 476
 477
 478
 479
 480
 481
 482
 483
 484
 485
 486
 487
 488
 489
 490
 491
 492
 493
 494
 495
 496
 497
 498
 499
 500
 501
 502
 503
 504
 505
 506
 507
 508
 509
 510
 511
 512
 513
 514
 515
 516
 517
 518
 519
 520
 521
 522
 523
 524
 525
 526
 527
 528
 529
 530
 531
 532
 533
 534
 535
 536
 537
 538
 539
 540
 541
 542
 543
 544
 545
 546
 547
 548
 549
 550
 551
 552
 553
 554
 555
 556
 557
 558
 559
 560
 561
 562
 563
 564
 565
 566
 567
 568
 569
 570
 571
 572
 573
 574
 575
 576
 577
 578
 579
 580
 581
 582
 583
 584
 585
 586
 587
 588
 589
 590
 591
 592
 593
 594
 595
 596
 597
 598
 599
 600
 601
 602
 603
 604
 605
 606
 607
 608
 609
 610
 611
 612
 613
 614
 615
 616
 617
 618
 619
 620
 621
 622
 623
 624
 625
 626
 627
 628
 629
 630
 631
 632
 633
 634
 635
 636
 637
 638
 639
 640
 641
 642
 643
 644
 645
 646
 647
 648
 649
 650
 651
 652
 653
 654
 655
 656
 657
 658
 659
 660
 661
 662
 663
 664
 665
 666
 667
 668
 669
 670
 671
 672
 673
 674
 675
 676
 677
 678
 679
 680
 681
 682
 683
 684
 685
 686
 687
 688
 689
 690
 691
 692
 693
 694
 695
 696
 697
 698
 699
 700
 701
 702
 703
 704
 705
 706
 707
 708
 709
 710
 711
 712
 713
 714
 715
 716
 717
 718
 719
 720
 721
 722
 723
 724
 725
 726
 727
 728
 729
 730
 731
 732
 733
 734
 735
 736
 737
 738
 739
 740
 741
 742
 743
 744
 745
 746
 747
 748
 749
 750
 751
 752
 753
 754
 755
 756
 757
 758
 759
 760
 761
 762
 763
 764
 765
 766
 767
 768
 769
 770
 771
 772
 773
 774
 775
 776
 777
 778
 779
 780
 781
 782
 783
 784
 785
 786
 787
 788
 789
 790
 791
 792
 793
 794
 795
 796
 797
 798
 799
 800
 801
 802
 803
 804
 805
 806
 807
 808
 809
 810
 811
 812
 813
 814
 815
 816
 817
 818
 819
 820
 821
 822
 823
 824
 825
 826
 827
 828
 829
 830
 831
 832
 833
 834
 835
 836
 837
 838
 839
 840
 841
 842
 843
 844
 845
 846
 847
 848
 849
 850
 851
 852
 853
 854
 855
 856
 857
 858
 859
 860
 861
 862
 863
 864
 865
 866
 867
 868
 869
 870
 871
 872
 873
 874
 875
 876
 877
 878
 879
 880
 881
 882
 883
 884
 885
 886
 887
 888
 889
 890
 891
 892
 893
 894
 895
 896
 897
 898
 899
 900
 901
 902
 903
 904
 905
 906
 907
 908
 909
 910
 911
 912
 913
 914
 915
 916
 917
 918
 919
 920
 921
 922
 923
 924
 925
 926
 927
 928
 929
 930
 931
 932
 933
 934
 935
 936
 937
 938
 939
 940
 941
 942
 943
 944
 945
 946
 947
 948
 949
 950
 951
 952
 953
 954
 955
 956
 957
 958
 959
 960
 961
 962
 963
 964
 965
 966
 967
 968
 969
 970
 971
 972
 973
 974
 975
 976
 977
 978
 979
 980
 981
 982
 983
 984
 985
 986
 987
 988
 989
 990
 991
 992
 993
 994
 995
 996
 997
 998
 999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036
1037
1038
1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049
1050
1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104
1105
1106
1107
1108
1109
1110
1111
1112
1113
1114
1115
1116
1117
1118
1119
1120
1121
1122
1123
1124
1125
1126
1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143
1144
1145
1146
1147
1148
1149
1150
1151
1152
1153
1154
1155
1156
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167
1168
1169
1170
1171
1172
1173
1174
1175
1176
1177
1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188
1189
1190
1191
1192
1193
1194
1195
1196
1197
1198
1199
1200
1201
1202
1203
1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214
1215
1216
1217
1218
1219
1220
1221
1222
1223
1224
1225
1226
1227
1228
1229
1230
1231
1232
1233
1234
1235
1236
1237
1238
1239
1240
1241
1242
1243
1244
1245
1246
1247
1248
1249
1250
1251
1252
1253
1254
1255
1256
1257
1258
1259
1260
1261
1262
1263
1264
1265
1266
1267
1268
1269
1270
1271
1272
1273
1274
1275
1276
1277
1278
1279
1280
1281
1282
1283
1284
1285
1286
1287
1288
1289
1290
1291
1292
1293
1294
1295
1296
1297
1298
1299
1300
1301
1302
1303
1304
1305
1306
1307
1308
1309
1310
1311
1312
1313
1314
1315
1316
1317
1318
1319
1320
1321
1322
1323
1324
1325
1326
1327
1328
1329
1330
1331
1332
1333
1334
1335
1336
1337
1338
1339
1340
1341
1342
1343
1344
1345
1346
1347
1348
1349
1350
1351
1352
1353
1354
1355
1356
1357
1358
1359
1360
1361
1362
1363
1364
1365
1366
1367
1368
1369
1370
1371
1372
1373
1374
1375
1376
1377
1378
1379
1380
1381
1382
1383
1384
1385
1386
1387
1388
1389
1390
1391
1392
1393
1394
1395
1396
1397
1398
1399
1400
1401
1402
1403
1404
1405
1406
1407
1408
1409
1410
1411
1412
1413
1414
1415
1416
1417
1418
1419
1420
1421
1422
1423
1424
1425
1426
1427
1428
1429
1430
1431
1432
1433
1434
1435
1436
1437
1438
1439
1440
1441
1442
1443
1444
1445
1446
1447
1448
1449
1450
1451
1452
1453
1454
1455
1456
1457
1458
1459
1460
1461
1462
1463
1464
1465
1466
1467
1468
1469
1470
1471
1472
1473
1474
1475
1476
1477
1478
1479
1480
1481
1482
1483
1484
1485
1486
1487
1488
1489
1490
1491
1492
1493
1494
1495
1496
1497
1498
1499
1500
1501
1502
1503
1504
1505
1506
1507
1508
1509
1510
1511
1512
1513
1514
1515
1516
1517
1518
1519
1520
1521
1522
1523
1524
1525
1526
1527
1528
1529
1530
1531
1532
1533
1534
1535
1536
1537
1538
1539
1540
1541
1542
1543
1544
1545
1546
1547
1548
1549
1550
1551
1552
1553
1554
1555
1556
1557
1558
1559
1560
1561
1562
1563
1564
1565
1566
1567
1568
1569
1570
1571
1572
1573
1574
1575
1576
1577
1578
1579
1580
1581
1582
1583
1584
1585
1586
1587
1588
1589
1590
1591
1592
1593
1594
1595
1596
1597
1598
1599
1600
1601
1602
1603
1604
1605
1606
1607
1608
1609
1610
1611
1612
1613
1614
1615
1616
1617
1618
1619
1620
1621
1622
1623
1624
1625
1626
1627
1628
1629
1630
1631
1632
1633
1634
1635
1636
1637
1638
1639
1640
1641
1642
1643
1644
1645
1646
1647
1648
1649
1650
1651
1652
1653
1654
1655
1656
1657
1658
1659
1660
1661
1662
1663
1664
1665
1666
1667
1668
1669
1670
1671
1672
1673
1674
1675
1676
1677
1678
1679
1680
1681
1682
1683
1684
1685
1686
1687
1688
1689
1690
1691
1692
1693
1694
1695
1696
1697
1698
1699
1700
1701
1702
1703
1704
1705
1706
1707
1708
1709
1710
1711
1712
1713
1714
1715
1716
1717
1718
1719
1720
1721
1722
1723
1724
1725
1726
1727
1728
1729
1730
1731
1732
1733
1734
1735
1736
1737
1738
1739
1740
1741
1742
1743
1744
1745
1746
1747
1748
1749
1750
1751
1752
1753
1754
1755
1756
1757
1758
1759
1760
1761
1762
1763
1764
1765
1766
1767
1768
1769
1770
1771
1772
1773
1774
1775
1776
1777
1778
1779
1780
1781
1782
1783
1784
1785
1786
1787
1788
1789
1790
1791
1792
1793
1794
1795
1796
1797
1798
1799
1800
1801
1802
1803
1804
1805
1806
1807
1808
1809
1810
1811
1812
1813
1814
1815
1816
1817
1818
1819
1820
1821
1822
1823
1824
1825
1826
1827
1828
1829
1830
1831
1832
1833
1834
1835
1836
1837
1838
1839
1840
1841
1842
1843
1844
1845
1846
1847
1848
1849
1850
1851
1852
1853
1854
1855
1856
1857
1858
1859
1860
1861
1862
1863
1864
1865
1866
1867
1868
1869
1870
1871
1872
1873
1874
1875
1876
1877
1878
1879
1880
1881
1882
1883
1884
1885
1886
1887
1888
1889
1890
1891
1892
1893
1894
1895
1896
1897
1898
1899
1900
1901
1902
1903
1904
1905
1906
1907
1908
1909
1910
1911
1912
1913
1914
1915
1916
1917
1918
1919
1920
1921
1922
1923
1924
1925
1926
1927
1928
1929
1930
1931
1932
1933
1934
1935
1936
1937
1938
1939
1940
1941
1942
1943
1944
1945
1946
1947
1948
1949
1950
1951
1952
1953
1954
1955
1956
1957
1958
1959
1960
1961
1962
1963
1964
1965
1966
1967
1968
1969
1970
1971
1972
1973
1974
1975
1976
1977
1978
1979
1980
1981
1982
1983
1984
1985
1986
1987
1988
1989
1990
1991
1992
1993
1994
1995
1996
1997
1998
1999
2000
2001
2002
2003
2004
2005
2006
2007
2008
2009
2010
2011
2012
2013
2014
2015
2016
2017
2018
2019
2020
2021
2022
2023
2024
2025
2026
2027
2028
2029
2030
2031
2032
2033
2034
2035
2036
2037
2038
2039
2040
2041
2042
2043
2044
2045
2046
2047
2048
2049
2050
2051
2052
2053
2054
2055
2056
2057
2058
2059
2060
2061
2062
2063
2064
2065
2066
2067
2068
2069
2070
2071
2072
2073
2074
2075
2076
2077
2078
2079
2080
2081
2082
2083
2084
2085
2086
2087
2088
2089
2090
2091
2092
2093
2094
2095
2096
2097
2098
2099
2100
2101
2102
2103
2104
2105
2106
2107
2108
2109
2110
2111
2112
2113
2114
2115
2116
2117
2118
2119
2120
2121
2122
2123
2124
2125
2126
2127
2128
2129
2130
2131
2132
2133
2134
2135
2136
2137
2138
2139
2140
2141
2142
2143
2144
2145
2146
2147
2148
2149
2150
2151
2152
2153
2154
2155
2156
2157
2158
2159
2160
2161
2162
2163
2164
2165
2166
2167
2168
2169
2170
2171
2172
2173
2174
2175
2176
2177
2178
2179
2180
2181
2182
2183
2184
2185
2186
2187
2188
2189
2190
2191
2192
2193
2194
2195
2196
2197
2198
2199
2200
2201
2202
2203
2204
2205
2206
2207
2208
2209
2210
2211
2212
2213
2214
2215
2216
2217
2218
2219
2220
2221
2222
2223
2224
2225
2226
2227
2228
2229
2230
2231
2232
2233
2234
2235
2236
2237
2238
2239
2240
2241
2242
2243
2244
2245
2246
2247
2248
2249
2250
2251
2252
2253
2254
2255
2256
2257
2258
2259
2260
2261
2262
2263
2264
2265
2266
2267
2268
2269
2270
2271
2272
2273
2274
2275
2276
2277
2278
2279
2280
2281
2282
2283
2284
2285
2286
2287
2288
2289
2290
2291
2292
2293
2294
2295
2296
2297
2298
2299
2300
2301
2302
2303
2304
2305
2306
2307
2308
2309
2310
2311
2312
2313
2314
2315
2316
2317
2318
2319
2320
2321
2322
2323
2324
2325
2326
2327
2328
2329
2330
2331
2332
2333
2334
2335
2336
2337
2338
2339
2340
2341
2342
2343
2344
2345
2346
2347
2348
2349
2350
2351
2352
2353
2354
2355
2356
2357
2358
2359
2360
2361
2362
2363
2364
2365
2366
2367
2368
2369
2370
2371
2372
2373
2374
2375
2376
2377
2378
2379
2380
2381
2382
2383
2384
2385
2386
2387
2388
2389
2390
2391
2392
2393
2394
2395
2396
2397
2398
2399
2400
2401
2402
2403
2404
2405
2406
2407
2408
2409
2410
2411
2412
2413
2414
2415
2416
2417
2418
2419
2420
2421
2422
2423
2424
2425
2426
2427
2428
2429
2430
2431
2432
2433
2434
2435
2436
2437
2438
2439
2440
2441
2442
2443
2444
2445
2446
2447
2448
2449
2450
2451
2452
2453
2454
2455
2456
2457
2458
2459
2460
2461
2462
2463
2464
2465
2466
2467
2468
2469
2470
2471
2472
2473
2474
2475
2476
2477
2478
2479
2480
2481
2482
2483
2484
2485
2486
2487
2488
2489
2490
2491
2492
2493
2494
2495
2496
2497
2498
2499
2500
2501
2502
2503
2504
2505
2506
2507
2508
2509
2510
2511
2512
2513
2514
2515
2516
2517
2518
2519
2520
2521
2522
2523
2524
2525
2526
2527
2528
2529
2530
2531
2532
2533
2534
2535
2536
2537
2538
2539
2540
2541
2542
2543
2544
2545
2546
2547
2548
2549
2550
2551
2552
2553
2554
2555
2556
2557
2558
2559
2560
2561
2562
2563
2564
2565
2566
2567
2568
2569
2570
2571
2572
2573
2574
2575
2576
2577
2578
2579
2580
2581
2582
2583
2584
2585
2586
2587
2588
2589
2590
2591
2592
2593
2594
2595
2596
2597
2598
2599
2600
2601
2602
2603
2604
2605
2606
2607
2608
2609
2610
2611
2612
2613
2614
2615
2616
2617
2618
2619
2620
2621
2622
2623
2624
2625
2626
2627
2628
2629
2630
2631
2632
2633
2634
2635
2636
2637
2638
2639
2640
2641
2642
2643
2644
2645
2646
2647
2648
2649
2650
2651
2652
2653
2654
2655
2656
2657
2658
2659
2660
2661
2662
2663
2664
2665
2666
2667
2668
2669
2670
2671
2672
2673
2674
2675
2676
2677
2678
2679
2680
2681
2682
2683
2684
2685
2686
2687
2688
2689
2690
2691
2692
2693
2694
2695
2696
2697
2698
2699
2700
2701
2702
2703
2704
2705
2706
2707
2708
2709
2710
2711
2712
2713
2714
2715
2716
2717
2718
2719
2720
2721
2722
2723
2724
2725
2726
2727
2728
2729
2730
2731
2732
2733
2734
2735
2736
2737
2738
2739
2740
2741
2742
2743
2744
2745
2746
2747
2748
2749
2750
2751
2752
2753
2754
2755
2756
2757
2758
2759
2760
2761
2762
2763
2764
2765
2766
2767
2768
2769
2770
2771
2772
2773
2774
2775
2776
2777
2778
2779
2780
2781
2782
2783
2784
2785
2786
2787
2788
2789
2790
2791
2792
2793
2794
2795
2796
2797
2798
2799
2800
2801
2802
2803
2804
2805
2806
2807
2808
2809
2810
2811
2812
2813
2814
2815
2816
2817
2818
2819
2820
2821
2822
2823
2824
2825
2826
2827
2828
2829
2830
2831
2832
2833
2834
2835
2836
2837
2838
2839
2840
2841
2842
2843
2844
2845
2846
2847
2848
2849
2850
2851
2852
2853
2854
2855
2856
2857
2858
2859
2860
2861
2862
2863
2864
2865
2866
2867
2868
2869
2870
2871
2872
2873
2874
2875
2876
2877
2878
2879
2880
2881
2882
2883
2884
2885
2886
2887
2888
2889
2890
2891
2892
2893
2894
2895
2896
2897
2898
2899
2900
2901
2902
2903
2904
2905
2906
2907
2908
2909
2910
2911
2912
2913
2914
2915
2916
2917
2918
2919
2920
2921
2922
2923
2924
2925
2926
2927
2928
2929
2930
2931
2932
2933
2934
2935
2936
2937
2938
2939
2940
2941
2942
2943
2944
2945
2946
2947
2948
2949
2950
2951
2952
2953
2954
2955
2956
2957
2958
2959
2960
2961
2962
2963
2964
2965
2966
2967
2968
2969
2970
2971
2972
2973
2974
2975
2976
2977
2978
2979
2980
2981
2982
2983
2984
2985
2986
2987
2988
2989
2990
2991
2992
2993
2994
2995
2996
2997
2998
2999
3000
3001
3002
3003
3004
3005
3006
3007
3008
3009
3010
3011
3012
3013
3014
3015
3016
3017
3018
3019
3020
3021
3022
3023
3024
3025
3026
3027
3028
3029
3030
3031
3032
3033
3034
3035
3036
3037
3038
3039
3040
3041
3042
3043
3044
3045
3046
3047
3048
3049
3050
3051
3052
3053
3054
3055
3056
3057
3058
3059
3060
3061
3062
3063
3064
3065
3066
3067
3068
3069
3070
3071
3072
3073
3074
3075
3076
3077
3078
3079
3080
3081
3082
3083
3084
3085
3086
3087
3088
3089
3090
3091
3092
3093
3094
3095
3096
3097
3098
3099
3100
3101
3102
3103
3104
3105
3106
3107
3108
3109
3110
3111
3112
3113
3114
3115
3116
3117
3118
3119
3120
3121
3122
3123
3124
3125
3126
3127
3128
3129
3130
3131
3132
3133
3134
3135
3136
3137
3138
3139
3140
3141
3142
3143
3144
3145
3146
3147
3148
3149
3150
3151
3152
3153
3154
3155
3156
3157
3158
3159
3160
3161
3162
3163
3164
3165
3166
3167
3168
3169
3170
3171
3172
3173
3174
3175
3176
3177
3178
3179
3180
3181
3182
3183
3184
3185
3186
3187
3188
3189
3190
3191
3192
3193
3194
3195
3196
3197
3198
3199
3200
3201
3202
3203
3204
3205
3206
3207
3208
3209
3210
3211
3212
3213
3214
3215
3216
3217
3218
3219
3220
3221
3222
3223
3224
3225
3226
3227
3228
3229
3230
3231
3232
3233
3234
3235
3236
3237
3238
3239
3240
3241
3242
3243
3244
3245
3246
3247
3248
3249
3250
3251
3252
3253
3254
3255
3256
3257
3258
3259
3260
3261
3262
3263
3264
3265
3266
3267
3268
3269
3270
3271
3272
3273
3274
3275</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="gbab-1"></a><span class="cm">/********************************************************************</span>
<a name="gbab-2"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-3"></a><span class="cm"> * THIS FILE IS PART OF THE libopusfile SOFTWARE CODEC SOURCE CODE. *</span>
<a name="gbab-4"></a><span class="cm"> * USE, DISTRIBUTION AND REPRODUCTION OF THIS LIBRARY SOURCE IS     *</span>
<a name="gbab-5"></a><span class="cm"> * GOVERNED BY A BSD-STYLE SOURCE LICENSE INCLUDED WITH THIS SOURCE *</span>
<a name="gbab-6"></a><span class="cm"> * IN &#39;COPYING&#39;. PLEASE READ THESE TERMS BEFORE DISTRIBUTING.       *</span>
<a name="gbab-7"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-8"></a><span class="cm"> * THE libopusfile SOURCE CODE IS (C) COPYRIGHT 1994-2012           *</span>
<a name="gbab-9"></a><span class="cm"> * by the Xiph.Org Foundation and contributors http://www.xiph.org/ *</span>
<a name="gbab-10"></a><span class="cm"> *                                                                  *</span>
<a name="gbab-11"></a><span class="cm"> ********************************************************************</span>
<a name="gbab-12"></a>
<a name="gbab-13"></a><span class="cm"> function: stdio-based convenience library for opening/seeking/decoding</span>
<a name="gbab-14"></a><span class="cm"> last mod: $Id: vorbisfile.c 17573 2010-10-27 14:53:59Z xiphmont $</span>
<a name="gbab-15"></a>
<a name="gbab-16"></a><span class="cm"> ********************************************************************/</span>
<a name="gbab-17"></a><span class="cp">#include</span> <span class="cpf">&quot;opus/opus_config.h&quot;</span><span class="cp"></span>
<a name="gbab-18"></a>
<a name="gbab-19"></a><span class="cp">#include</span> <span class="cpf">&quot;opus/internal.h&quot;</span><span class="cp"></span>
<a name="gbab-20"></a><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<a name="gbab-21"></a><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<a name="gbab-22"></a><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<a name="gbab-23"></a><span class="cp">#include</span> <span class="cpf">&lt;limits.h&gt;</span><span class="cp"></span>
<a name="gbab-24"></a><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<a name="gbab-25"></a><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<a name="gbab-26"></a>
<a name="gbab-27"></a><span class="cp">#include</span> <span class="cpf">&quot;opus/opusfile.h&quot;</span><span class="cp"></span>
<a name="gbab-28"></a>
<a name="gbab-29"></a><span class="cm">/*This implementation is largely based off of libvorbisfile.</span>
<a name="gbab-30"></a><span class="cm">  All of the Ogg bits work roughly the same, though I have made some</span>
<a name="gbab-31"></a><span class="cm">   &quot;improvements&quot; that have not been folded back there, yet.*/</span>
<a name="gbab-32"></a>
<a name="gbab-33"></a><span class="cm">/*A &#39;chained bitstream&#39; is an Ogg Opus bitstream that contains more than one</span>
<a name="gbab-34"></a><span class="cm">   logical bitstream arranged end to end (the only form of Ogg multiplexing</span>
<a name="gbab-35"></a><span class="cm">   supported by this library.</span>
<a name="gbab-36"></a><span class="cm">  Grouping (parallel multiplexing) is not supported, except to the extent that</span>
<a name="gbab-37"></a><span class="cm">   if there are multiple logical Ogg streams in a single link of the chain, we</span>
<a name="gbab-38"></a><span class="cm">   will ignore all but the first Opus stream we find.*/</span>
<a name="gbab-39"></a>
<a name="gbab-40"></a><span class="cm">/*An Ogg Opus file can be played beginning to end (streamed) without worrying</span>
<a name="gbab-41"></a><span class="cm">   ahead of time about chaining (see opusdec from the opus-tools package).</span>
<a name="gbab-42"></a><span class="cm">  If we have the whole file, however, and want random access</span>
<a name="gbab-43"></a><span class="cm">   (seeking/scrubbing) or desire to know the total length/time of a file, we</span>
<a name="gbab-44"></a><span class="cm">   need to account for the possibility of chaining.*/</span>
<a name="gbab-45"></a>
<a name="gbab-46"></a><span class="cm">/*We can handle things a number of ways.</span>
<a name="gbab-47"></a><span class="cm">  We can determine the entire bitstream structure right off the bat, or find</span>
<a name="gbab-48"></a><span class="cm">   pieces on demand.</span>
<a name="gbab-49"></a><span class="cm">  This library determines and caches structure for the entire bitstream, but</span>
<a name="gbab-50"></a><span class="cm">   builds a virtual decoder on the fly when moving between links in the chain.*/</span>
<a name="gbab-51"></a>
<a name="gbab-52"></a><span class="cm">/*There are also different ways to implement seeking.</span>
<a name="gbab-53"></a><span class="cm">  Enough information exists in an Ogg bitstream to seek to sample-granularity</span>
<a name="gbab-54"></a><span class="cm">   positions in the output.</span>
<a name="gbab-55"></a><span class="cm">  Or, one can seek by picking some portion of the stream roughly in the desired</span>
<a name="gbab-56"></a><span class="cm">   area if we only want coarse navigation through the stream.</span>
<a name="gbab-57"></a><span class="cm">  We implement and expose both strategies.*/</span>
<a name="gbab-58"></a>
<a name="gbab-59"></a><span class="cm">/*The maximum number of bytes in a page (including the page headers).*/</span>
<a name="gbab-60"></a><span class="cp">#define OP_PAGE_SIZE_MAX  (65307)</span>
<a name="gbab-61"></a><span class="cm">/*The default amount to seek backwards per step when trying to find the</span>
<a name="gbab-62"></a><span class="cm">   previous page.</span>
<a name="gbab-63"></a><span class="cm">  This must be at least as large as the maximum size of a page.*/</span>
<a name="gbab-64"></a><span class="cp">#define OP_CHUNK_SIZE     (65536)</span>
<a name="gbab-65"></a><span class="cm">/*The maximum amount to seek backwards per step when trying to find the</span>
<a name="gbab-66"></a><span class="cm">   previous page.*/</span>
<a name="gbab-67"></a><span class="cp">#define OP_CHUNK_SIZE_MAX (1024*(opus_int32)1024)</span>
<a name="gbab-68"></a><span class="cm">/*A smaller read size is needed for low-rate streaming.*/</span>
<a name="gbab-69"></a><span class="cp">#define OP_READ_SIZE      (2048)</span>
<a name="gbab-70"></a>
<a name="gbab-71"></a><span class="kt">int</span> <span class="nf">op_test</span><span class="p">(</span><span class="n">OpusHead</span> <span class="o">*</span><span class="n">_head</span><span class="p">,</span>
<a name="gbab-72"></a> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_initial_data</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_initial_bytes</span><span class="p">){</span>
<a name="gbab-73"></a>  <span class="n">ogg_sync_state</span>  <span class="n">oy</span><span class="p">;</span>
<a name="gbab-74"></a>  <span class="kt">char</span>           <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="gbab-75"></a>  <span class="kt">int</span>             <span class="n">err</span><span class="p">;</span>
<a name="gbab-76"></a>  <span class="cm">/*The first page of a normal Opus file will be at most 57 bytes (27 Ogg</span>
<a name="gbab-77"></a><span class="cm">     page header bytes + 1 lacing value + 21 Opus header bytes + 8 channel</span>
<a name="gbab-78"></a><span class="cm">     mapping bytes).</span>
<a name="gbab-79"></a><span class="cm">    It will be at least 47 bytes (27 Ogg page header bytes + 1 lacing value +</span>
<a name="gbab-80"></a><span class="cm">     19 Opus header bytes using channel mapping family 0).</span>
<a name="gbab-81"></a><span class="cm">    If we don&#39;t have at least that much data, give up now.*/</span>
<a name="gbab-82"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_initial_bytes</span><span class="o">&lt;</span><span class="mi">47</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_FALSE</span><span class="p">;</span>
<a name="gbab-83"></a>  <span class="cm">/*Only proceed if we start with the magic OggS string.</span>
<a name="gbab-84"></a><span class="cm">    This is to prevent us spending a lot of time allocating memory and looking</span>
<a name="gbab-85"></a><span class="cm">     for Ogg pages in non-Ogg files.*/</span>
<a name="gbab-86"></a>  <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">_initial_data</span><span class="p">,</span><span class="s">&quot;OggS&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_ENOTFORMAT</span><span class="p">;</span>
<a name="gbab-87"></a>  <span class="n">ogg_sync_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oy</span><span class="p">);</span>
<a name="gbab-88"></a>  <span class="n">data</span><span class="o">=</span><span class="n">ogg_sync_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oy</span><span class="p">,</span><span class="n">_initial_bytes</span><span class="p">);</span>
<a name="gbab-89"></a>  <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">){</span>
<a name="gbab-90"></a>    <span class="n">ogg_stream_state</span> <span class="n">os</span><span class="p">;</span>
<a name="gbab-91"></a>    <span class="n">ogg_page</span>         <span class="n">og</span><span class="p">;</span>
<a name="gbab-92"></a>    <span class="kt">int</span>              <span class="n">ret</span><span class="p">;</span>
<a name="gbab-93"></a>    <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">_initial_data</span><span class="p">,</span><span class="n">_initial_bytes</span><span class="p">);</span>
<a name="gbab-94"></a>    <span class="n">ogg_sync_wrote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oy</span><span class="p">,</span><span class="n">_initial_bytes</span><span class="p">);</span>
<a name="gbab-95"></a>    <span class="n">ogg_stream_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-96"></a>    <span class="n">err</span><span class="o">=</span><span class="n">OP_FALSE</span><span class="p">;</span>
<a name="gbab-97"></a>    <span class="k">do</span><span class="p">{</span>
<a name="gbab-98"></a>      <span class="n">ogg_packet</span> <span class="n">op</span><span class="p">;</span>
<a name="gbab-99"></a>      <span class="n">ret</span><span class="o">=</span><span class="n">ogg_sync_pageout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oy</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-100"></a>      <span class="cm">/*Ignore holes.*/</span>
<a name="gbab-101"></a>      <span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-102"></a>      <span class="cm">/*Stop if we run out of data.*/</span>
<a name="gbab-103"></a>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-104"></a>      <span class="n">ogg_stream_reset_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os</span><span class="p">,</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">));</span>
<a name="gbab-105"></a>      <span class="n">ogg_stream_pagein</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-106"></a>      <span class="cm">/*Only process the first packet on this page (if it&#39;s a BOS packet,</span>
<a name="gbab-107"></a><span class="cm">         it&#39;s required to be the only one).*/</span>
<a name="gbab-108"></a>      <span class="k">if</span><span class="p">(</span><span class="n">ogg_stream_packetout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os</span><span class="p">,</span><span class="o">&amp;</span><span class="n">op</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-109"></a>        <span class="k">if</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">b_o_s</span><span class="p">){</span>
<a name="gbab-110"></a>          <span class="n">ret</span><span class="o">=</span><span class="n">opus_head_parse</span><span class="p">(</span><span class="n">_head</span><span class="p">,</span><span class="n">op</span><span class="p">.</span><span class="n">packet</span><span class="p">,</span><span class="n">op</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>
<a name="gbab-111"></a>          <span class="cm">/*If this didn&#39;t look like Opus, keep going.*/</span>
<a name="gbab-112"></a>          <span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="o">==</span><span class="n">OP_ENOTFORMAT</span><span class="p">)</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-113"></a>          <span class="cm">/*Otherwise we&#39;re done, one way or another.*/</span>
<a name="gbab-114"></a>          <span class="n">err</span><span class="o">=</span><span class="n">ret</span><span class="p">;</span>
<a name="gbab-115"></a>        <span class="p">}</span>
<a name="gbab-116"></a>        <span class="cm">/*We finished parsing the headers.</span>
<a name="gbab-117"></a><span class="cm">          There is no Opus to be found.*/</span>
<a name="gbab-118"></a>        <span class="k">else</span> <span class="n">err</span><span class="o">=</span><span class="n">OP_ENOTFORMAT</span><span class="p">;</span>
<a name="gbab-119"></a>      <span class="p">}</span>
<a name="gbab-120"></a>    <span class="p">}</span>
<a name="gbab-121"></a>    <span class="k">while</span><span class="p">(</span><span class="n">err</span><span class="o">==</span><span class="n">OP_FALSE</span><span class="p">);</span>
<a name="gbab-122"></a>    <span class="n">ogg_stream_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os</span><span class="p">);</span>
<a name="gbab-123"></a>  <span class="p">}</span>
<a name="gbab-124"></a>  <span class="k">else</span> <span class="n">err</span><span class="o">=</span><span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-125"></a>  <span class="n">ogg_sync_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oy</span><span class="p">);</span>
<a name="gbab-126"></a>  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<a name="gbab-127"></a><span class="p">}</span>
<a name="gbab-128"></a>
<a name="gbab-129"></a><span class="cm">/*Many, many internal helpers.</span>
<a name="gbab-130"></a><span class="cm">  The intention is not to be confusing.</span>
<a name="gbab-131"></a><span class="cm">  Rampant duplication and monolithic function implementation (though we do have</span>
<a name="gbab-132"></a><span class="cm">   some large, omnibus functions still) would be harder to understand anyway.</span>
<a name="gbab-133"></a><span class="cm">  The high level functions are last.</span>
<a name="gbab-134"></a><span class="cm">  Begin grokking near the end of the file if you prefer to read things</span>
<a name="gbab-135"></a><span class="cm">   top-down.*/</span>
<a name="gbab-136"></a>
<a name="gbab-137"></a><span class="cm">/*The read/seek functions track absolute position within the stream.*/</span>
<a name="gbab-138"></a>
<a name="gbab-139"></a><span class="cm">/*Read a little more data from the file/pipe into the ogg_sync framer.</span>
<a name="gbab-140"></a><span class="cm">  _nbytes: The maximum number of bytes to read.</span>
<a name="gbab-141"></a><span class="cm">  Return: A positive number of bytes read on success, 0 on end-of-file, or a</span>
<a name="gbab-142"></a><span class="cm">           negative value on failure.*/</span>
<a name="gbab-143"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_get_data</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nbytes</span><span class="p">){</span>
<a name="gbab-144"></a>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
<a name="gbab-145"></a>  <span class="kt">int</span>            <span class="n">nbytes</span><span class="p">;</span>
<a name="gbab-146"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_nbytes</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-147"></a>  <span class="n">buffer</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ogg_sync_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">,</span><span class="n">_nbytes</span><span class="p">);</span>
<a name="gbab-148"></a>  <span class="n">nbytes</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">read</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">_nbytes</span><span class="p">);</span>
<a name="gbab-149"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">nbytes</span><span class="o">&lt;=</span><span class="n">_nbytes</span><span class="p">);</span>
<a name="gbab-150"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">nbytes</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="n">ogg_sync_wrote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">,</span><span class="n">nbytes</span><span class="p">);</span>
<a name="gbab-151"></a>  <span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>
<a name="gbab-152"></a><span class="p">}</span>
<a name="gbab-153"></a>
<a name="gbab-154"></a><span class="cm">/*Save a tiny smidge of verbosity to make the code more readable.*/</span>
<a name="gbab-155"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_seek_helper</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">opus_int64</span> <span class="n">_offset</span><span class="p">){</span>
<a name="gbab-156"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_offset</span><span class="o">==</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span><span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-157"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">seek</span><span class="o">==</span><span class="nb">NULL</span>
<a name="gbab-158"></a>   <span class="o">||</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">seek</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span><span class="n">_offset</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">)){</span>
<a name="gbab-159"></a>    <span class="k">return</span> <span class="n">OP_EREAD</span><span class="p">;</span>
<a name="gbab-160"></a>  <span class="p">}</span>
<a name="gbab-161"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">=</span><span class="n">_offset</span><span class="p">;</span>
<a name="gbab-162"></a>  <span class="n">ogg_sync_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">);</span>
<a name="gbab-163"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-164"></a><span class="p">}</span>
<a name="gbab-165"></a>
<a name="gbab-166"></a><span class="cm">/*Get the current position indicator of the underlying source.</span>
<a name="gbab-167"></a><span class="cm">  This should be the same as the value reported by tell().*/</span>
<a name="gbab-168"></a><span class="k">static</span> <span class="n">opus_int64</span> <span class="nf">op_position</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-169"></a>  <span class="cm">/*The current position indicator is _not_ simply offset.</span>
<a name="gbab-170"></a><span class="cm">    We may also have unprocessed, buffered data in the sync state.*/</span>
<a name="gbab-171"></a>  <span class="k">return</span> <span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">+</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">.</span><span class="n">fill</span><span class="o">-</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">.</span><span class="n">returned</span><span class="p">;</span>
<a name="gbab-172"></a><span class="p">}</span>
<a name="gbab-173"></a>
<a name="gbab-174"></a><span class="cm">/*From the head of the stream, get the next page.</span>
<a name="gbab-175"></a><span class="cm">  _boundary specifies if the function is allowed to fetch more data from the</span>
<a name="gbab-176"></a><span class="cm">   stream (and how much) or only use internally buffered data.</span>
<a name="gbab-177"></a><span class="cm">  _boundary: -1: Unbounded search.</span>
<a name="gbab-178"></a><span class="cm">              0: Read no additional data.</span>
<a name="gbab-179"></a><span class="cm">                 Use only cached data.</span>
<a name="gbab-180"></a><span class="cm">              n: Search for the start of a new page up to file position n.</span>
<a name="gbab-181"></a><span class="cm">  Return: n&gt;=0:       Found a page at absolute offset n.</span>
<a name="gbab-182"></a><span class="cm">          OP_FALSE:   Hit the _boundary limit.</span>
<a name="gbab-183"></a><span class="cm">          OP_EREAD:   An underlying read operation failed.</span>
<a name="gbab-184"></a><span class="cm">          OP_BADLINK: We hit end-of-file before reaching _boundary.*/</span>
<a name="gbab-185"></a><span class="k">static</span> <span class="n">opus_int64</span> <span class="nf">op_get_next_page</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">ogg_page</span> <span class="o">*</span><span class="n">_og</span><span class="p">,</span>
<a name="gbab-186"></a> <span class="n">opus_int64</span> <span class="n">_boundary</span><span class="p">){</span>
<a name="gbab-187"></a>  <span class="k">while</span><span class="p">(</span><span class="n">_boundary</span><span class="o">&lt;=</span><span class="mi">0</span><span class="o">||</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">&lt;</span><span class="n">_boundary</span><span class="p">){</span>
<a name="gbab-188"></a>    <span class="kt">int</span> <span class="n">more</span><span class="p">;</span>
<a name="gbab-189"></a>    <span class="n">more</span><span class="o">=</span><span class="n">ogg_sync_pageseek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">,</span><span class="n">_og</span><span class="p">);</span>
<a name="gbab-190"></a>    <span class="cm">/*Skipped (-more) bytes.*/</span>
<a name="gbab-191"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">more</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">-=</span><span class="n">more</span><span class="p">;</span>
<a name="gbab-192"></a>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">more</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-193"></a>      <span class="kt">int</span> <span class="n">read_nbytes</span><span class="p">;</span>
<a name="gbab-194"></a>      <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-195"></a>      <span class="cm">/*Send more paramedics.*/</span>
<a name="gbab-196"></a>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_boundary</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_FALSE</span><span class="p">;</span>
<a name="gbab-197"></a>      <span class="k">if</span><span class="p">(</span><span class="n">_boundary</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="n">read_nbytes</span><span class="o">=</span><span class="n">OP_READ_SIZE</span><span class="p">;</span>
<a name="gbab-198"></a>      <span class="k">else</span><span class="p">{</span>
<a name="gbab-199"></a>        <span class="n">opus_int64</span> <span class="n">position</span><span class="p">;</span>
<a name="gbab-200"></a>        <span class="n">position</span><span class="o">=</span><span class="n">op_position</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-201"></a>        <span class="k">if</span><span class="p">(</span><span class="n">position</span><span class="o">&gt;=</span><span class="n">_boundary</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_FALSE</span><span class="p">;</span>
<a name="gbab-202"></a>        <span class="n">read_nbytes</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">_boundary</span><span class="o">-</span><span class="n">position</span><span class="p">,</span><span class="n">OP_READ_SIZE</span><span class="p">);</span>
<a name="gbab-203"></a>      <span class="p">}</span>
<a name="gbab-204"></a>      <span class="n">ret</span><span class="o">=</span><span class="n">op_get_data</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">read_nbytes</span><span class="p">);</span>
<a name="gbab-205"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EREAD</span><span class="p">;</span>
<a name="gbab-206"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">==</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-207"></a>        <span class="cm">/*Only fail cleanly on EOF if we didn&#39;t have a known boundary.</span>
<a name="gbab-208"></a><span class="cm">          Otherwise, we should have been able to reach that boundary, and this</span>
<a name="gbab-209"></a><span class="cm">           is a fatal error.*/</span>
<a name="gbab-210"></a>        <span class="k">return</span> <span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_boundary</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="nl">OP_FALSE</span><span class="p">:</span><span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-211"></a>      <span class="p">}</span>
<a name="gbab-212"></a>    <span class="p">}</span>
<a name="gbab-213"></a>    <span class="k">else</span><span class="p">{</span>
<a name="gbab-214"></a>      <span class="cm">/*Got a page.</span>
<a name="gbab-215"></a><span class="cm">        Return the page start offset and advance the internal offset past the</span>
<a name="gbab-216"></a><span class="cm">         page end.*/</span>
<a name="gbab-217"></a>      <span class="n">opus_int64</span> <span class="n">page_offset</span><span class="p">;</span>
<a name="gbab-218"></a>      <span class="n">page_offset</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-219"></a>      <span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">+=</span><span class="n">more</span><span class="p">;</span>
<a name="gbab-220"></a>      <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">page_offset</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-221"></a>      <span class="k">return</span> <span class="n">page_offset</span><span class="p">;</span>
<a name="gbab-222"></a>    <span class="p">}</span>
<a name="gbab-223"></a>  <span class="p">}</span>
<a name="gbab-224"></a>  <span class="k">return</span> <span class="n">OP_FALSE</span><span class="p">;</span>
<a name="gbab-225"></a><span class="p">}</span>
<a name="gbab-226"></a>
<a name="gbab-227"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_add_serialno</span><span class="p">(</span><span class="k">const</span> <span class="n">ogg_page</span> <span class="o">*</span><span class="n">_og</span><span class="p">,</span>
<a name="gbab-228"></a> <span class="n">ogg_uint32_t</span> <span class="o">**</span><span class="n">_serialnos</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_nserialnos</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_cserialnos</span><span class="p">){</span>
<a name="gbab-229"></a>  <span class="n">ogg_uint32_t</span> <span class="o">*</span><span class="n">serialnos</span><span class="p">;</span>
<a name="gbab-230"></a>  <span class="kt">int</span>           <span class="n">nserialnos</span><span class="p">;</span>
<a name="gbab-231"></a>  <span class="kt">int</span>           <span class="n">cserialnos</span><span class="p">;</span>
<a name="gbab-232"></a>  <span class="n">ogg_uint32_t</span> <span class="n">s</span><span class="p">;</span>
<a name="gbab-233"></a>  <span class="n">s</span><span class="o">=</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="n">_og</span><span class="p">);</span>
<a name="gbab-234"></a>  <span class="n">serialnos</span><span class="o">=*</span><span class="n">_serialnos</span><span class="p">;</span>
<a name="gbab-235"></a>  <span class="n">nserialnos</span><span class="o">=*</span><span class="n">_nserialnos</span><span class="p">;</span>
<a name="gbab-236"></a>  <span class="n">cserialnos</span><span class="o">=*</span><span class="n">_cserialnos</span><span class="p">;</span>
<a name="gbab-237"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">nserialnos</span><span class="o">&gt;=</span><span class="n">cserialnos</span><span class="p">)){</span>
<a name="gbab-238"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">cserialnos</span><span class="o">&gt;</span><span class="n">INT_MAX</span><span class="o">/</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">serialnos</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)){</span>
<a name="gbab-239"></a>      <span class="k">return</span> <span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-240"></a>    <span class="p">}</span>
<a name="gbab-241"></a>    <span class="n">cserialnos</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">cserialnos</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-242"></a>    <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">nserialnos</span><span class="o">&lt;</span><span class="n">cserialnos</span><span class="p">);</span>
<a name="gbab-243"></a>    <span class="n">serialnos</span><span class="o">=</span><span class="p">(</span><span class="n">ogg_uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">_ogg_realloc</span><span class="p">(</span><span class="n">serialnos</span><span class="p">,</span>
<a name="gbab-244"></a>     <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">serialnos</span><span class="p">)</span><span class="o">*</span><span class="n">cserialnos</span><span class="p">);</span>
<a name="gbab-245"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">serialnos</span><span class="o">==</span><span class="nb">NULL</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-246"></a>  <span class="p">}</span>
<a name="gbab-247"></a>  <span class="n">serialnos</span><span class="p">[</span><span class="n">nserialnos</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="n">s</span><span class="p">;</span>
<a name="gbab-248"></a>  <span class="o">*</span><span class="n">_serialnos</span><span class="o">=</span><span class="n">serialnos</span><span class="p">;</span>
<a name="gbab-249"></a>  <span class="o">*</span><span class="n">_nserialnos</span><span class="o">=</span><span class="n">nserialnos</span><span class="p">;</span>
<a name="gbab-250"></a>  <span class="o">*</span><span class="n">_cserialnos</span><span class="o">=</span><span class="n">cserialnos</span><span class="p">;</span>
<a name="gbab-251"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-252"></a><span class="p">}</span>
<a name="gbab-253"></a>
<a name="gbab-254"></a><span class="cm">/*Returns nonzero if found.*/</span>
<a name="gbab-255"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_lookup_serialno</span><span class="p">(</span><span class="n">ogg_uint32_t</span> <span class="n">_s</span><span class="p">,</span>
<a name="gbab-256"></a> <span class="k">const</span> <span class="n">ogg_uint32_t</span> <span class="o">*</span><span class="n">_serialnos</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nserialnos</span><span class="p">){</span>
<a name="gbab-257"></a>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="gbab-258"></a>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_nserialnos</span><span class="o">&amp;&amp;</span><span class="n">_serialnos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="n">_s</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">);</span>
<a name="gbab-259"></a>  <span class="k">return</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_nserialnos</span><span class="p">;</span>
<a name="gbab-260"></a><span class="p">}</span>
<a name="gbab-261"></a>
<a name="gbab-262"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_lookup_page_serialno</span><span class="p">(</span><span class="k">const</span> <span class="n">ogg_page</span> <span class="o">*</span><span class="n">_og</span><span class="p">,</span>
<a name="gbab-263"></a> <span class="k">const</span> <span class="n">ogg_uint32_t</span> <span class="o">*</span><span class="n">_serialnos</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nserialnos</span><span class="p">){</span>
<a name="gbab-264"></a>  <span class="k">return</span> <span class="n">op_lookup_serialno</span><span class="p">(</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="n">_og</span><span class="p">),</span><span class="n">_serialnos</span><span class="p">,</span><span class="n">_nserialnos</span><span class="p">);</span>
<a name="gbab-265"></a><span class="p">}</span>
<a name="gbab-266"></a>
<a name="gbab-267"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="n">OpusSeekRecord</span> <span class="n">OpusSeekRecord</span><span class="p">;</span>
<a name="gbab-268"></a>
<a name="gbab-269"></a><span class="cm">/*We use this to remember the pages we found while enumerating the links of a</span>
<a name="gbab-270"></a><span class="cm">   chained stream.</span>
<a name="gbab-271"></a><span class="cm">  We keep track of the starting and ending offsets, as well as the point we</span>
<a name="gbab-272"></a><span class="cm">   started searching from, so we know where to bisect.</span>
<a name="gbab-273"></a><span class="cm">  We also keep the serial number, so we can tell if the page belonged to the</span>
<a name="gbab-274"></a><span class="cm">   current link or not, as well as the granule position, to aid in estimating</span>
<a name="gbab-275"></a><span class="cm">   the start of the link.*/</span>
<a name="gbab-276"></a><span class="k">struct</span> <span class="n">OpusSeekRecord</span><span class="p">{</span>
<a name="gbab-277"></a>  <span class="cm">/*The earliest byte we know of such that reading forward from it causes</span>
<a name="gbab-278"></a><span class="cm">     capture to be regained at this page.*/</span>
<a name="gbab-279"></a>  <span class="n">opus_int64</span>   <span class="n">search_start</span><span class="p">;</span>
<a name="gbab-280"></a>  <span class="cm">/*The offset of this page.*/</span>
<a name="gbab-281"></a>  <span class="n">opus_int64</span>   <span class="n">offset</span><span class="p">;</span>
<a name="gbab-282"></a>  <span class="cm">/*The size of this page.*/</span>
<a name="gbab-283"></a>  <span class="n">opus_int32</span>   <span class="n">size</span><span class="p">;</span>
<a name="gbab-284"></a>  <span class="cm">/*The serial number of this page.*/</span>
<a name="gbab-285"></a>  <span class="n">ogg_uint32_t</span> <span class="n">serialno</span><span class="p">;</span>
<a name="gbab-286"></a>  <span class="cm">/*The granule position of this page.*/</span>
<a name="gbab-287"></a>  <span class="n">ogg_int64_t</span>  <span class="n">gp</span><span class="p">;</span>
<a name="gbab-288"></a><span class="p">};</span>
<a name="gbab-289"></a>
<a name="gbab-290"></a><span class="cm">/*Find the last page beginning before _offset with a valid granule position.</span>
<a name="gbab-291"></a><span class="cm">  There is no &#39;_boundary&#39; parameter as it will always have to read more data.</span>
<a name="gbab-292"></a><span class="cm">  This is much dirtier than the above, as Ogg doesn&#39;t have any backward search</span>
<a name="gbab-293"></a><span class="cm">   linkage.</span>
<a name="gbab-294"></a><span class="cm">  This search prefers pages of the specified serial number.</span>
<a name="gbab-295"></a><span class="cm">  If a page of the specified serial number is spotted during the</span>
<a name="gbab-296"></a><span class="cm">   seek-back-and-read-forward, it will return the info of last page of the</span>
<a name="gbab-297"></a><span class="cm">   matching serial number, instead of the very last page, unless the very last</span>
<a name="gbab-298"></a><span class="cm">   page belongs to a different link than preferred serial number.</span>
<a name="gbab-299"></a><span class="cm">  If no page of the specified serial number is seen, it will return the info of</span>
<a name="gbab-300"></a><span class="cm">   the last page.</span>
<a name="gbab-301"></a><span class="cm">  [out] _sr:   Returns information about the page that was found on success.</span>
<a name="gbab-302"></a><span class="cm">  _offset:     The _offset before which to find a page.</span>
<a name="gbab-303"></a><span class="cm">               Any page returned will consist of data entirely before _offset.</span>
<a name="gbab-304"></a><span class="cm">  _serialno:   The preferred serial number.</span>
<a name="gbab-305"></a><span class="cm">               If a page with this serial number is found, it will be returned</span>
<a name="gbab-306"></a><span class="cm">                even if another page in the same link is found closer to</span>
<a name="gbab-307"></a><span class="cm">                _offset.</span>
<a name="gbab-308"></a><span class="cm">               This is purely opportunistic: there is no guarantee such a page</span>
<a name="gbab-309"></a><span class="cm">                will be found if it exists.</span>
<a name="gbab-310"></a><span class="cm">  _serialnos:  The list of serial numbers in the link that contains the</span>
<a name="gbab-311"></a><span class="cm">                preferred serial number.</span>
<a name="gbab-312"></a><span class="cm">  _nserialnos: The number of serial numbers in the current link.</span>
<a name="gbab-313"></a><span class="cm">  Return: 0 on success, or a negative value on failure.</span>
<a name="gbab-314"></a><span class="cm">          OP_EREAD:    Failed to read more data (error or EOF).</span>
<a name="gbab-315"></a><span class="cm">          OP_EBADLINK: We couldn&#39;t find a page even after seeking back to the</span>
<a name="gbab-316"></a><span class="cm">                        start of the stream.*/</span>
<a name="gbab-317"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_get_prev_page_serial</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">OpusSeekRecord</span> <span class="o">*</span><span class="n">_sr</span><span class="p">,</span>
<a name="gbab-318"></a> <span class="n">opus_int64</span> <span class="n">_offset</span><span class="p">,</span><span class="n">ogg_uint32_t</span> <span class="n">_serialno</span><span class="p">,</span>
<a name="gbab-319"></a> <span class="k">const</span> <span class="n">ogg_uint32_t</span> <span class="o">*</span><span class="n">_serialnos</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nserialnos</span><span class="p">){</span>
<a name="gbab-320"></a>  <span class="n">OpusSeekRecord</span> <span class="n">preferred_sr</span><span class="p">;</span>
<a name="gbab-321"></a>  <span class="n">ogg_page</span>       <span class="n">og</span><span class="p">;</span>
<a name="gbab-322"></a>  <span class="n">opus_int64</span>     <span class="n">begin</span><span class="p">;</span>
<a name="gbab-323"></a>  <span class="n">opus_int64</span>     <span class="n">end</span><span class="p">;</span>
<a name="gbab-324"></a>  <span class="n">opus_int64</span>     <span class="n">original_end</span><span class="p">;</span>
<a name="gbab-325"></a>  <span class="n">opus_int32</span>     <span class="n">chunk_size</span><span class="p">;</span>
<a name="gbab-326"></a>  <span class="kt">int</span>            <span class="n">preferred_found</span><span class="p">;</span>
<a name="gbab-327"></a>  <span class="n">original_end</span><span class="o">=</span><span class="n">end</span><span class="o">=</span><span class="n">begin</span><span class="o">=</span><span class="n">_offset</span><span class="p">;</span>
<a name="gbab-328"></a>  <span class="n">preferred_found</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-329"></a>  <span class="n">_offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-330"></a>  <span class="n">chunk_size</span><span class="o">=</span><span class="n">OP_CHUNK_SIZE</span><span class="p">;</span>
<a name="gbab-331"></a>  <span class="k">do</span><span class="p">{</span>
<a name="gbab-332"></a>    <span class="n">opus_int64</span> <span class="n">search_start</span><span class="p">;</span>
<a name="gbab-333"></a>    <span class="kt">int</span>        <span class="n">ret</span><span class="p">;</span>
<a name="gbab-334"></a>    <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">&gt;=</span><span class="n">OP_PAGE_SIZE_MAX</span><span class="p">);</span>
<a name="gbab-335"></a>    <span class="n">begin</span><span class="o">=</span><span class="n">OP_MAX</span><span class="p">(</span><span class="n">begin</span><span class="o">-</span><span class="n">chunk_size</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-336"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_seek_helper</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">begin</span><span class="p">);</span>
<a name="gbab-337"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-338"></a>    <span class="n">search_start</span><span class="o">=</span><span class="n">begin</span><span class="p">;</span>
<a name="gbab-339"></a>    <span class="k">while</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">&lt;</span><span class="n">end</span><span class="p">){</span>
<a name="gbab-340"></a>      <span class="n">opus_int64</span>   <span class="n">llret</span><span class="p">;</span>
<a name="gbab-341"></a>      <span class="n">ogg_uint32_t</span> <span class="n">serialno</span><span class="p">;</span>
<a name="gbab-342"></a>      <span class="n">llret</span><span class="o">=</span><span class="n">op_get_next_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">,</span><span class="n">end</span><span class="p">);</span>
<a name="gbab-343"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">llret</span><span class="o">&lt;</span><span class="n">OP_FALSE</span><span class="p">))</span><span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">llret</span><span class="p">;</span>
<a name="gbab-344"></a>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">llret</span><span class="o">==</span><span class="n">OP_FALSE</span><span class="p">)</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-345"></a>      <span class="n">serialno</span><span class="o">=</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-346"></a>      <span class="cm">/*Save the information for this page.</span>
<a name="gbab-347"></a><span class="cm">        We&#39;re not interested in the page itself... just the serial number, byte</span>
<a name="gbab-348"></a><span class="cm">         offset, page size, and granule position.*/</span>
<a name="gbab-349"></a>      <span class="n">_sr</span><span class="o">-&gt;</span><span class="n">search_start</span><span class="o">=</span><span class="n">search_start</span><span class="p">;</span>
<a name="gbab-350"></a>      <span class="n">_sr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">=</span><span class="n">_offset</span><span class="o">=</span><span class="n">llret</span><span class="p">;</span>
<a name="gbab-351"></a>      <span class="n">_sr</span><span class="o">-&gt;</span><span class="n">serialno</span><span class="o">=</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-352"></a>      <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">-</span><span class="n">_offset</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-353"></a>      <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">-</span><span class="n">_offset</span><span class="o">&lt;=</span><span class="n">OP_PAGE_SIZE_MAX</span><span class="p">);</span>
<a name="gbab-354"></a>      <span class="n">_sr</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">opus_int32</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">-</span><span class="n">_offset</span><span class="p">);</span>
<a name="gbab-355"></a>      <span class="n">_sr</span><span class="o">-&gt;</span><span class="n">gp</span><span class="o">=</span><span class="n">ogg_page_granulepos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-356"></a>      <span class="cm">/*If this page is from the stream we&#39;re looking for, remember it.*/</span>
<a name="gbab-357"></a>      <span class="k">if</span><span class="p">(</span><span class="n">serialno</span><span class="o">==</span><span class="n">_serialno</span><span class="p">){</span>
<a name="gbab-358"></a>        <span class="n">preferred_found</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-359"></a>        <span class="o">*&amp;</span><span class="n">preferred_sr</span><span class="o">=*</span><span class="n">_sr</span><span class="p">;</span>
<a name="gbab-360"></a>      <span class="p">}</span>
<a name="gbab-361"></a>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">op_lookup_serialno</span><span class="p">(</span><span class="n">serialno</span><span class="p">,</span><span class="n">_serialnos</span><span class="p">,</span><span class="n">_nserialnos</span><span class="p">)){</span>
<a name="gbab-362"></a>        <span class="cm">/*We fell off the end of the link, which means we seeked back too far</span>
<a name="gbab-363"></a><span class="cm">           and shouldn&#39;t have been looking in that link to begin with.</span>
<a name="gbab-364"></a><span class="cm">          If we found the preferred serial number, forget that we saw it.*/</span>
<a name="gbab-365"></a>        <span class="n">preferred_found</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-366"></a>      <span class="p">}</span>
<a name="gbab-367"></a>      <span class="n">search_start</span><span class="o">=</span><span class="n">llret</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-368"></a>    <span class="p">}</span>
<a name="gbab-369"></a>    <span class="cm">/*We started from the beginning of the stream and found nothing.</span>
<a name="gbab-370"></a><span class="cm">      This should be impossible unless the contents of the source changed out</span>
<a name="gbab-371"></a><span class="cm">       from under us after we read from it.*/</span>
<a name="gbab-372"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">begin</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-373"></a>    <span class="cm">/*Bump up the chunk size.</span>
<a name="gbab-374"></a><span class="cm">      This is mildly helpful when seeks are very expensive (http).*/</span>
<a name="gbab-375"></a>    <span class="n">chunk_size</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">,</span><span class="n">OP_CHUNK_SIZE_MAX</span><span class="p">);</span>
<a name="gbab-376"></a>    <span class="cm">/*Avoid quadratic complexity if we hit an invalid patch of the file.*/</span>
<a name="gbab-377"></a>    <span class="n">end</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">begin</span><span class="o">+</span><span class="n">OP_PAGE_SIZE_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">original_end</span><span class="p">);</span>
<a name="gbab-378"></a>  <span class="p">}</span>
<a name="gbab-379"></a>  <span class="k">while</span><span class="p">(</span><span class="n">_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-380"></a>  <span class="k">if</span><span class="p">(</span><span class="n">preferred_found</span><span class="p">)</span><span class="o">*</span><span class="n">_sr</span><span class="o">=*&amp;</span><span class="n">preferred_sr</span><span class="p">;</span>
<a name="gbab-381"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-382"></a><span class="p">}</span>
<a name="gbab-383"></a>
<a name="gbab-384"></a><span class="cm">/*Find the last page beginning before _offset with the given serial number and</span>
<a name="gbab-385"></a><span class="cm">   a valid granule position.</span>
<a name="gbab-386"></a><span class="cm">  Unlike the above search, this continues until it finds such a page, but does</span>
<a name="gbab-387"></a><span class="cm">   not stray outside the current link.</span>
<a name="gbab-388"></a><span class="cm">  We could implement it (inefficiently) by calling op_get_prev_page_serial()</span>
<a name="gbab-389"></a><span class="cm">   repeatedly until it returned a page that had both our preferred serial</span>
<a name="gbab-390"></a><span class="cm">   number and a valid granule position, but doing it with a separate function</span>
<a name="gbab-391"></a><span class="cm">   allows us to avoid repeatedly re-scanning valid pages from other streams as</span>
<a name="gbab-392"></a><span class="cm">   we seek-back-and-read-forward.</span>
<a name="gbab-393"></a><span class="cm">  [out] _gp:   Returns the granule position of the page that was found on</span>
<a name="gbab-394"></a><span class="cm">                success.</span>
<a name="gbab-395"></a><span class="cm">  _offset:     The _offset before which to find a page.</span>
<a name="gbab-396"></a><span class="cm">               Any page returned will consist of data entirely before _offset.</span>
<a name="gbab-397"></a><span class="cm">  _serialno:   The target serial number.</span>
<a name="gbab-398"></a><span class="cm">  _serialnos:  The list of serial numbers in the link that contains the</span>
<a name="gbab-399"></a><span class="cm">                preferred serial number.</span>
<a name="gbab-400"></a><span class="cm">  _nserialnos: The number of serial numbers in the current link.</span>
<a name="gbab-401"></a><span class="cm">  Return: The offset of the page on success, or a negative value on failure.</span>
<a name="gbab-402"></a><span class="cm">          OP_EREAD:    Failed to read more data (error or EOF).</span>
<a name="gbab-403"></a><span class="cm">          OP_EBADLINK: We couldn&#39;t find a page even after seeking back past the</span>
<a name="gbab-404"></a><span class="cm">                        beginning of the link.*/</span>
<a name="gbab-405"></a><span class="k">static</span> <span class="n">opus_int64</span> <span class="nf">op_get_last_page</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">ogg_int64_t</span> <span class="o">*</span><span class="n">_gp</span><span class="p">,</span>
<a name="gbab-406"></a> <span class="n">opus_int64</span> <span class="n">_offset</span><span class="p">,</span><span class="n">ogg_uint32_t</span> <span class="n">_serialno</span><span class="p">,</span>
<a name="gbab-407"></a> <span class="k">const</span> <span class="n">ogg_uint32_t</span> <span class="o">*</span><span class="n">_serialnos</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nserialnos</span><span class="p">){</span>
<a name="gbab-408"></a>  <span class="n">ogg_page</span>    <span class="n">og</span><span class="p">;</span>
<a name="gbab-409"></a>  <span class="n">ogg_int64_t</span> <span class="n">gp</span><span class="p">;</span>
<a name="gbab-410"></a>  <span class="n">opus_int64</span>  <span class="n">begin</span><span class="p">;</span>
<a name="gbab-411"></a>  <span class="n">opus_int64</span>  <span class="n">end</span><span class="p">;</span>
<a name="gbab-412"></a>  <span class="n">opus_int64</span>  <span class="n">original_end</span><span class="p">;</span>
<a name="gbab-413"></a>  <span class="n">opus_int32</span>  <span class="n">chunk_size</span><span class="p">;</span>
<a name="gbab-414"></a>  <span class="cm">/*The target serial number must belong to the current link.*/</span>
<a name="gbab-415"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">op_lookup_serialno</span><span class="p">(</span><span class="n">_serialno</span><span class="p">,</span><span class="n">_serialnos</span><span class="p">,</span><span class="n">_nserialnos</span><span class="p">));</span>
<a name="gbab-416"></a>  <span class="n">original_end</span><span class="o">=</span><span class="n">end</span><span class="o">=</span><span class="n">begin</span><span class="o">=</span><span class="n">_offset</span><span class="p">;</span>
<a name="gbab-417"></a>  <span class="n">_offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-418"></a>  <span class="cm">/*We shouldn&#39;t have to initialize gp, but gcc is too dumb to figure out that</span>
<a name="gbab-419"></a><span class="cm">     ret&gt;=0 implies we entered the if(page_gp!=-1) block at least once.*/</span>
<a name="gbab-420"></a>  <span class="n">gp</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-421"></a>  <span class="n">chunk_size</span><span class="o">=</span><span class="n">OP_CHUNK_SIZE</span><span class="p">;</span>
<a name="gbab-422"></a>  <span class="k">do</span><span class="p">{</span>
<a name="gbab-423"></a>    <span class="kt">int</span> <span class="n">left_link</span><span class="p">;</span>
<a name="gbab-424"></a>    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-425"></a>    <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">&gt;=</span><span class="n">OP_PAGE_SIZE_MAX</span><span class="p">);</span>
<a name="gbab-426"></a>    <span class="n">begin</span><span class="o">=</span><span class="n">OP_MAX</span><span class="p">(</span><span class="n">begin</span><span class="o">-</span><span class="n">chunk_size</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-427"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_seek_helper</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">begin</span><span class="p">);</span>
<a name="gbab-428"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-429"></a>    <span class="n">left_link</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-430"></a>    <span class="k">while</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">&lt;</span><span class="n">end</span><span class="p">){</span>
<a name="gbab-431"></a>      <span class="n">opus_int64</span>   <span class="n">llret</span><span class="p">;</span>
<a name="gbab-432"></a>      <span class="n">ogg_uint32_t</span> <span class="n">serialno</span><span class="p">;</span>
<a name="gbab-433"></a>      <span class="n">llret</span><span class="o">=</span><span class="n">op_get_next_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">,</span><span class="n">end</span><span class="p">);</span>
<a name="gbab-434"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">llret</span><span class="o">&lt;</span><span class="n">OP_FALSE</span><span class="p">))</span><span class="k">return</span> <span class="n">llret</span><span class="p">;</span>
<a name="gbab-435"></a>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">llret</span><span class="o">==</span><span class="n">OP_FALSE</span><span class="p">)</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-436"></a>      <span class="n">serialno</span><span class="o">=</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-437"></a>      <span class="k">if</span><span class="p">(</span><span class="n">serialno</span><span class="o">==</span><span class="n">_serialno</span><span class="p">){</span>
<a name="gbab-438"></a>        <span class="n">ogg_int64_t</span> <span class="n">page_gp</span><span class="p">;</span>
<a name="gbab-439"></a>        <span class="cm">/*The page is from the right stream...*/</span>
<a name="gbab-440"></a>        <span class="n">page_gp</span><span class="o">=</span><span class="n">ogg_page_granulepos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-441"></a>        <span class="k">if</span><span class="p">(</span><span class="n">page_gp</span><span class="o">!=-</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-442"></a>          <span class="cm">/*And has a valid granule position.</span>
<a name="gbab-443"></a><span class="cm">            Let&#39;s remember it.*/</span>
<a name="gbab-444"></a>          <span class="n">_offset</span><span class="o">=</span><span class="n">llret</span><span class="p">;</span>
<a name="gbab-445"></a>          <span class="n">gp</span><span class="o">=</span><span class="n">page_gp</span><span class="p">;</span>
<a name="gbab-446"></a>        <span class="p">}</span>
<a name="gbab-447"></a>      <span class="p">}</span>
<a name="gbab-448"></a>      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">op_lookup_serialno</span><span class="p">(</span><span class="n">serialno</span><span class="p">,</span>
<a name="gbab-449"></a>       <span class="n">_serialnos</span><span class="p">,</span><span class="n">_nserialnos</span><span class="p">))){</span>
<a name="gbab-450"></a>        <span class="cm">/*We fell off the start of the link, which means we don&#39;t need to keep</span>
<a name="gbab-451"></a><span class="cm">           seeking any farther back.*/</span>
<a name="gbab-452"></a>        <span class="n">left_link</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-453"></a>      <span class="p">}</span>
<a name="gbab-454"></a>    <span class="p">}</span>
<a name="gbab-455"></a>    <span class="cm">/*We started from at or before the beginning of the link and found nothing.</span>
<a name="gbab-456"></a><span class="cm">      This should be impossible unless the contents of the source changed out</span>
<a name="gbab-457"></a><span class="cm">       from under us after we read from it.*/</span>
<a name="gbab-458"></a>    <span class="k">if</span><span class="p">((</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">left_link</span><span class="p">)</span><span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">begin</span><span class="p">))</span><span class="o">&amp;&amp;</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-459"></a>      <span class="k">return</span> <span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-460"></a>    <span class="p">}</span>
<a name="gbab-461"></a>    <span class="cm">/*Bump up the chunk size.</span>
<a name="gbab-462"></a><span class="cm">      This is mildly helpful when seeks are very expensive (http).*/</span>
<a name="gbab-463"></a>    <span class="n">chunk_size</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">,</span><span class="n">OP_CHUNK_SIZE_MAX</span><span class="p">);</span>
<a name="gbab-464"></a>    <span class="cm">/*Avoid quadratic complexity if we hit an invalid patch of the file.*/</span>
<a name="gbab-465"></a>    <span class="n">end</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">begin</span><span class="o">+</span><span class="n">OP_PAGE_SIZE_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">original_end</span><span class="p">);</span>
<a name="gbab-466"></a>  <span class="p">}</span>
<a name="gbab-467"></a>  <span class="k">while</span><span class="p">(</span><span class="n">_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-468"></a>  <span class="o">*</span><span class="n">_gp</span><span class="o">=</span><span class="n">gp</span><span class="p">;</span>
<a name="gbab-469"></a>  <span class="k">return</span> <span class="n">_offset</span><span class="p">;</span>
<a name="gbab-470"></a><span class="p">}</span>
<a name="gbab-471"></a>
<a name="gbab-472"></a><span class="cm">/*Uses the local ogg_stream storage in _of.</span>
<a name="gbab-473"></a><span class="cm">  This is important for non-streaming input sources.*/</span>
<a name="gbab-474"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_fetch_headers_impl</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">OpusHead</span> <span class="o">*</span><span class="n">_head</span><span class="p">,</span>
<a name="gbab-475"></a> <span class="n">OpusTags</span> <span class="o">*</span><span class="n">_tags</span><span class="p">,</span><span class="n">ogg_uint32_t</span> <span class="o">**</span><span class="n">_serialnos</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_nserialnos</span><span class="p">,</span>
<a name="gbab-476"></a> <span class="kt">int</span> <span class="o">*</span><span class="n">_cserialnos</span><span class="p">,</span><span class="n">ogg_page</span> <span class="o">*</span><span class="n">_og</span><span class="p">){</span>
<a name="gbab-477"></a>  <span class="n">ogg_packet</span> <span class="n">op</span><span class="p">;</span>
<a name="gbab-478"></a>  <span class="kt">int</span>        <span class="n">ret</span><span class="p">;</span>
<a name="gbab-479"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_serialnos</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span><span class="o">*</span><span class="n">_nserialnos</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-480"></a>  <span class="cm">/*Extract the serialnos of all BOS pages plus the first set of Opus headers</span>
<a name="gbab-481"></a><span class="cm">     we see in the link.*/</span>
<a name="gbab-482"></a>  <span class="k">while</span><span class="p">(</span><span class="n">ogg_page_bos</span><span class="p">(</span><span class="n">_og</span><span class="p">)){</span>
<a name="gbab-483"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_serialnos</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">){</span>
<a name="gbab-484"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_lookup_page_serialno</span><span class="p">(</span><span class="n">_og</span><span class="p">,</span><span class="o">*</span><span class="n">_serialnos</span><span class="p">,</span><span class="o">*</span><span class="n">_nserialnos</span><span class="p">))){</span>
<a name="gbab-485"></a>        <span class="cm">/*A dupe serialnumber in an initial header packet set==invalid stream.*/</span>
<a name="gbab-486"></a>        <span class="k">return</span> <span class="n">OP_EBADHEADER</span><span class="p">;</span>
<a name="gbab-487"></a>      <span class="p">}</span>
<a name="gbab-488"></a>      <span class="n">ret</span><span class="o">=</span><span class="n">op_add_serialno</span><span class="p">(</span><span class="n">_og</span><span class="p">,</span><span class="n">_serialnos</span><span class="p">,</span><span class="n">_nserialnos</span><span class="p">,</span><span class="n">_cserialnos</span><span class="p">);</span>
<a name="gbab-489"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-490"></a>    <span class="p">}</span>
<a name="gbab-491"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_STREAMSET</span><span class="p">){</span>
<a name="gbab-492"></a>      <span class="cm">/*We don&#39;t have an Opus stream in this link yet, so begin prospective</span>
<a name="gbab-493"></a><span class="cm">         stream setup.</span>
<a name="gbab-494"></a><span class="cm">        We need a stream to get packets.*/</span>
<a name="gbab-495"></a>      <span class="n">ogg_stream_reset_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="n">_og</span><span class="p">));</span>
<a name="gbab-496"></a>      <span class="n">ogg_stream_pagein</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="n">_og</span><span class="p">);</span>
<a name="gbab-497"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">ogg_stream_packetout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="o">&amp;</span><span class="n">op</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-498"></a>        <span class="n">ret</span><span class="o">=</span><span class="n">opus_head_parse</span><span class="p">(</span><span class="n">_head</span><span class="p">,</span><span class="n">op</span><span class="p">.</span><span class="n">packet</span><span class="p">,</span><span class="n">op</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>
<a name="gbab-499"></a>        <span class="cm">/*Found a valid Opus header.</span>
<a name="gbab-500"></a><span class="cm">          Continue setup.*/</span>
<a name="gbab-501"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">))</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_STREAMSET</span><span class="p">;</span>
<a name="gbab-502"></a>        <span class="cm">/*If it&#39;s just a stream type we don&#39;t recognize, ignore it.</span>
<a name="gbab-503"></a><span class="cm">          Everything else is fatal.*/</span>
<a name="gbab-504"></a>        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="o">!=</span><span class="n">OP_ENOTFORMAT</span><span class="p">)</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-505"></a>      <span class="p">}</span>
<a name="gbab-506"></a>    <span class="p">}</span>
<a name="gbab-507"></a>    <span class="cm">/*Get the next page.</span>
<a name="gbab-508"></a><span class="cm">      No need to clamp the boundary offset against _of-&gt;end, as all errors</span>
<a name="gbab-509"></a><span class="cm">       become OP_ENOTFORMAT or OP_EBADHEADER.*/</span>
<a name="gbab-510"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_get_next_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_og</span><span class="p">,</span>
<a name="gbab-511"></a>     <span class="n">OP_ADV_OFFSET</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span><span class="n">OP_CHUNK_SIZE</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-512"></a>      <span class="k">return</span> <span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_STREAMSET</span><span class="o">?</span><span class="nl">OP_ENOTFORMAT</span><span class="p">:</span><span class="n">OP_EBADHEADER</span><span class="p">;</span>
<a name="gbab-513"></a>    <span class="p">}</span>
<a name="gbab-514"></a>  <span class="p">}</span>
<a name="gbab-515"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">!=</span><span class="n">OP_STREAMSET</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_ENOTFORMAT</span><span class="p">;</span>
<a name="gbab-516"></a>  <span class="cm">/*If the first non-header page belonged to our Opus stream, submit it.*/</span>
<a name="gbab-517"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">serialno</span><span class="o">==</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="n">_og</span><span class="p">))</span><span class="n">ogg_stream_pagein</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="n">_og</span><span class="p">);</span>
<a name="gbab-518"></a>  <span class="cm">/*Loop getting packets.*/</span>
<a name="gbab-519"></a>  <span class="k">for</span><span class="p">(;;){</span>
<a name="gbab-520"></a>    <span class="k">switch</span><span class="p">(</span><span class="n">ogg_stream_packetout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="o">&amp;</span><span class="n">op</span><span class="p">)){</span>
<a name="gbab-521"></a>      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span><span class="p">{</span>
<a name="gbab-522"></a>        <span class="cm">/*Loop getting pages.*/</span>
<a name="gbab-523"></a>        <span class="k">for</span><span class="p">(;;){</span>
<a name="gbab-524"></a>          <span class="cm">/*No need to clamp the boundary offset against _of-&gt;end, as all</span>
<a name="gbab-525"></a><span class="cm">             errors become OP_EBADHEADER.*/</span>
<a name="gbab-526"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_get_next_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_og</span><span class="p">,</span>
<a name="gbab-527"></a>           <span class="n">OP_ADV_OFFSET</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span><span class="n">OP_CHUNK_SIZE</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-528"></a>            <span class="k">return</span> <span class="n">OP_EBADHEADER</span><span class="p">;</span>
<a name="gbab-529"></a>          <span class="p">}</span>
<a name="gbab-530"></a>          <span class="cm">/*If this page belongs to the correct stream, go parse it.*/</span>
<a name="gbab-531"></a>          <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">serialno</span><span class="o">==</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="n">_og</span><span class="p">)){</span>
<a name="gbab-532"></a>            <span class="n">ogg_stream_pagein</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="n">_og</span><span class="p">);</span>
<a name="gbab-533"></a>            <span class="k">break</span><span class="p">;</span>
<a name="gbab-534"></a>          <span class="p">}</span>
<a name="gbab-535"></a>          <span class="cm">/*If the link ends before we see the Opus comment header, abort.*/</span>
<a name="gbab-536"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ogg_page_bos</span><span class="p">(</span><span class="n">_og</span><span class="p">)))</span><span class="k">return</span> <span class="n">OP_EBADHEADER</span><span class="p">;</span>
<a name="gbab-537"></a>          <span class="cm">/*Otherwise, keep looking.*/</span>
<a name="gbab-538"></a>        <span class="p">}</span>
<a name="gbab-539"></a>      <span class="p">}</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-540"></a>      <span class="cm">/*We shouldn&#39;t get a hole in the headers!*/</span>
<a name="gbab-541"></a>      <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="k">return</span> <span class="n">OP_EBADHEADER</span><span class="p">;</span>
<a name="gbab-542"></a>      <span class="k">default</span><span class="o">:</span><span class="p">{</span>
<a name="gbab-543"></a>        <span class="cm">/*Got a packet.</span>
<a name="gbab-544"></a><span class="cm">          It should be the comment header.*/</span>
<a name="gbab-545"></a>        <span class="n">ret</span><span class="o">=</span><span class="n">opus_tags_parse</span><span class="p">(</span><span class="n">_tags</span><span class="p">,</span><span class="n">op</span><span class="p">.</span><span class="n">packet</span><span class="p">,</span><span class="n">op</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>
<a name="gbab-546"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-547"></a>        <span class="cm">/*Make sure the page terminated at the end of the comment header.</span>
<a name="gbab-548"></a><span class="cm">          If there is another packet on the page, or part of a packet, then</span>
<a name="gbab-549"></a><span class="cm">           reject the stream.</span>
<a name="gbab-550"></a><span class="cm">          Otherwise seekable sources won&#39;t be able to seek back to the start</span>
<a name="gbab-551"></a><span class="cm">           properly.*/</span>
<a name="gbab-552"></a>        <span class="n">ret</span><span class="o">=</span><span class="n">ogg_stream_packetout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
<a name="gbab-553"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
<a name="gbab-554"></a>         <span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_og</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">[</span><span class="n">_og</span><span class="o">-&gt;</span><span class="n">header_len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">255</span><span class="p">)){</span>
<a name="gbab-555"></a>          <span class="cm">/*If we fail, the caller assumes our tags are uninitialized.*/</span>
<a name="gbab-556"></a>          <span class="n">opus_tags_clear</span><span class="p">(</span><span class="n">_tags</span><span class="p">);</span>
<a name="gbab-557"></a>          <span class="k">return</span> <span class="n">OP_EBADHEADER</span><span class="p">;</span>
<a name="gbab-558"></a>        <span class="p">}</span>
<a name="gbab-559"></a>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-560"></a>      <span class="p">}</span>
<a name="gbab-561"></a>    <span class="p">}</span>
<a name="gbab-562"></a>  <span class="p">}</span>
<a name="gbab-563"></a><span class="p">}</span>
<a name="gbab-564"></a>
<a name="gbab-565"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_fetch_headers</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">OpusHead</span> <span class="o">*</span><span class="n">_head</span><span class="p">,</span>
<a name="gbab-566"></a> <span class="n">OpusTags</span> <span class="o">*</span><span class="n">_tags</span><span class="p">,</span><span class="n">ogg_uint32_t</span> <span class="o">**</span><span class="n">_serialnos</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_nserialnos</span><span class="p">,</span>
<a name="gbab-567"></a> <span class="kt">int</span> <span class="o">*</span><span class="n">_cserialnos</span><span class="p">,</span><span class="n">ogg_page</span> <span class="o">*</span><span class="n">_og</span><span class="p">){</span>
<a name="gbab-568"></a>  <span class="n">ogg_page</span> <span class="n">og</span><span class="p">;</span>
<a name="gbab-569"></a>  <span class="kt">int</span>      <span class="n">ret</span><span class="p">;</span>
<a name="gbab-570"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_og</span><span class="p">){</span>
<a name="gbab-571"></a>    <span class="cm">/*No need to clamp the boundary offset against _of-&gt;end, as all errors</span>
<a name="gbab-572"></a><span class="cm">       become OP_ENOTFORMAT.*/</span>
<a name="gbab-573"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_get_next_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">,</span>
<a name="gbab-574"></a>     <span class="n">OP_ADV_OFFSET</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span><span class="n">OP_CHUNK_SIZE</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-575"></a>      <span class="k">return</span> <span class="n">OP_ENOTFORMAT</span><span class="p">;</span>
<a name="gbab-576"></a>    <span class="p">}</span>
<a name="gbab-577"></a>    <span class="n">_og</span><span class="o">=&amp;</span><span class="n">og</span><span class="p">;</span>
<a name="gbab-578"></a>  <span class="p">}</span>
<a name="gbab-579"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_OPENED</span><span class="p">;</span>
<a name="gbab-580"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">op_fetch_headers_impl</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_head</span><span class="p">,</span><span class="n">_tags</span><span class="p">,</span><span class="n">_serialnos</span><span class="p">,</span><span class="n">_nserialnos</span><span class="p">,</span>
<a name="gbab-581"></a>   <span class="n">_cserialnos</span><span class="p">,</span><span class="n">_og</span><span class="p">);</span>
<a name="gbab-582"></a>  <span class="cm">/*Revert back from OP_STREAMSET to OP_OPENED on failure, to prevent</span>
<a name="gbab-583"></a><span class="cm">     double-free of the tags in an unseekable stream.*/</span>
<a name="gbab-584"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_OPENED</span><span class="p">;</span>
<a name="gbab-585"></a>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-586"></a><span class="p">}</span>
<a name="gbab-587"></a>
<a name="gbab-588"></a><span class="cm">/*Granule position manipulation routines.</span>
<a name="gbab-589"></a><span class="cm">  A granule position is defined to be an unsigned 64-bit integer, with the</span>
<a name="gbab-590"></a><span class="cm">   special value -1 in two&#39;s complement indicating an unset or invalid granule</span>
<a name="gbab-591"></a><span class="cm">   position.</span>
<a name="gbab-592"></a><span class="cm">  We are not guaranteed to have an unsigned 64-bit type, so we construct the</span>
<a name="gbab-593"></a><span class="cm">   following routines that</span>
<a name="gbab-594"></a><span class="cm">   a) Properly order negative numbers as larger than positive numbers, and</span>
<a name="gbab-595"></a><span class="cm">   b) Check for underflow or overflow past the special -1 value.</span>
<a name="gbab-596"></a><span class="cm">  This lets us operate on the full, valid range of granule positions in a</span>
<a name="gbab-597"></a><span class="cm">   consistent and safe manner.</span>
<a name="gbab-598"></a><span class="cm">  This full range is organized into distinct regions:</span>
<a name="gbab-599"></a><span class="cm">   [ -1 (invalid) ][ 0 ... OP_INT64_MAX ][ OP_INT64_MIN ... -2 ][-1 (invalid) ]</span>
<a name="gbab-600"></a>
<a name="gbab-601"></a><span class="cm">  No one should actually use granule positions so large that they&#39;re negative,</span>
<a name="gbab-602"></a><span class="cm">   even if they are technically valid, as very little software handles them</span>
<a name="gbab-603"></a><span class="cm">   correctly (including most of Xiph.Org&#39;s).</span>
<a name="gbab-604"></a><span class="cm">  This library also refuses to support durations so large they won&#39;t fit in a</span>
<a name="gbab-605"></a><span class="cm">   signed 64-bit integer (to avoid exposing this mess to the application, and</span>
<a name="gbab-606"></a><span class="cm">   to simplify a good deal of internal arithmetic), so the only way to use them</span>
<a name="gbab-607"></a><span class="cm">   successfully is if pcm_start is very large.</span>
<a name="gbab-608"></a><span class="cm">  This means there isn&#39;t anything you can do with negative granule positions</span>
<a name="gbab-609"></a><span class="cm">   that you couldn&#39;t have done with purely non-negative ones.</span>
<a name="gbab-610"></a><span class="cm">  The main purpose of these routines is to allow us to think very explicitly</span>
<a name="gbab-611"></a><span class="cm">   about the possible failure cases of all granule position manipulations.*/</span>
<a name="gbab-612"></a>
<a name="gbab-613"></a><span class="cm">/*Safely adds a small signed integer to a valid (not -1) granule position.</span>
<a name="gbab-614"></a><span class="cm">  The result can use the full 64-bit range of values (both positive and</span>
<a name="gbab-615"></a><span class="cm">   negative), but will fail on overflow (wrapping past -1; wrapping past</span>
<a name="gbab-616"></a><span class="cm">   OP_INT64_MAX is explicitly okay).</span>
<a name="gbab-617"></a><span class="cm">  [out] _dst_gp: The resulting granule position.</span>
<a name="gbab-618"></a><span class="cm">                 Only modified on success.</span>
<a name="gbab-619"></a><span class="cm">  _src_gp:       The granule position to add to.</span>
<a name="gbab-620"></a><span class="cm">                 This must not be -1.</span>
<a name="gbab-621"></a><span class="cm">  _delta:        The amount to add.</span>
<a name="gbab-622"></a><span class="cm">                 This is allowed to be up to 32 bits to support the maximum</span>
<a name="gbab-623"></a><span class="cm">                  duration of a single Ogg page (255 packets * 120 ms per</span>
<a name="gbab-624"></a><span class="cm">                  packet == 1,468,800 samples at 48 kHz).</span>
<a name="gbab-625"></a><span class="cm">  Return: 0 on success, or OP_EINVAL if the result would wrap around past -1.*/</span>
<a name="gbab-626"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_granpos_add</span><span class="p">(</span><span class="n">ogg_int64_t</span> <span class="o">*</span><span class="n">_dst_gp</span><span class="p">,</span><span class="n">ogg_int64_t</span> <span class="n">_src_gp</span><span class="p">,</span>
<a name="gbab-627"></a> <span class="n">opus_int32</span> <span class="n">_delta</span><span class="p">){</span>
<a name="gbab-628"></a>  <span class="cm">/*The code below handles this case correctly, but there&#39;s no reason we</span>
<a name="gbab-629"></a><span class="cm">     should ever be called with these values, so make sure we aren&#39;t.*/</span>
<a name="gbab-630"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_src_gp</span><span class="o">!=-</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-631"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_delta</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-632"></a>    <span class="cm">/*Adding this amount to the granule position would overflow its 64-bit</span>
<a name="gbab-633"></a><span class="cm">       range.*/</span>
<a name="gbab-634"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_src_gp</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_src_gp</span><span class="o">&gt;=-</span><span class="mi">1</span><span class="o">-</span><span class="n">_delta</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-635"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_src_gp</span><span class="o">&gt;</span><span class="n">OP_INT64_MAX</span><span class="o">-</span><span class="n">_delta</span><span class="p">)){</span>
<a name="gbab-636"></a>      <span class="cm">/*Adding this amount to the granule position would overflow the positive</span>
<a name="gbab-637"></a><span class="cm">         half of its 64-bit range.</span>
<a name="gbab-638"></a><span class="cm">        Since signed overflow is undefined in C, do it in a way the compiler</span>
<a name="gbab-639"></a><span class="cm">         isn&#39;t allowed to screw up.*/</span>
<a name="gbab-640"></a>      <span class="n">_delta</span><span class="o">-=</span><span class="p">(</span><span class="n">opus_int32</span><span class="p">)(</span><span class="n">OP_INT64_MAX</span><span class="o">-</span><span class="n">_src_gp</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-641"></a>      <span class="n">_src_gp</span><span class="o">=</span><span class="n">OP_INT64_MIN</span><span class="p">;</span>
<a name="gbab-642"></a>    <span class="p">}</span>
<a name="gbab-643"></a>  <span class="p">}</span>
<a name="gbab-644"></a>  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">_delta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-645"></a>    <span class="cm">/*Subtracting this amount from the granule position would underflow its</span>
<a name="gbab-646"></a><span class="cm">       64-bit range.*/</span>
<a name="gbab-647"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_src_gp</span><span class="o">&gt;=</span><span class="mi">0</span><span class="o">&amp;&amp;</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_src_gp</span><span class="o">&lt;-</span><span class="n">_delta</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-648"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_src_gp</span><span class="o">&lt;</span><span class="n">OP_INT64_MIN</span><span class="o">-</span><span class="n">_delta</span><span class="p">)){</span>
<a name="gbab-649"></a>      <span class="cm">/*Subtracting this amount from the granule position would underflow the</span>
<a name="gbab-650"></a><span class="cm">         negative half of its 64-bit range.</span>
<a name="gbab-651"></a><span class="cm">        Since signed underflow is undefined in C, do it in a way the compiler</span>
<a name="gbab-652"></a><span class="cm">         isn&#39;t allowed to screw up.*/</span>
<a name="gbab-653"></a>      <span class="n">_delta</span><span class="o">+=</span><span class="p">(</span><span class="n">opus_int32</span><span class="p">)(</span><span class="n">_src_gp</span><span class="o">-</span><span class="n">OP_INT64_MIN</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-654"></a>      <span class="n">_src_gp</span><span class="o">=</span><span class="n">OP_INT64_MAX</span><span class="p">;</span>
<a name="gbab-655"></a>    <span class="p">}</span>
<a name="gbab-656"></a>  <span class="p">}</span>
<a name="gbab-657"></a>  <span class="o">*</span><span class="n">_dst_gp</span><span class="o">=</span><span class="n">_src_gp</span><span class="o">+</span><span class="n">_delta</span><span class="p">;</span>
<a name="gbab-658"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-659"></a><span class="p">}</span>
<a name="gbab-660"></a>
<a name="gbab-661"></a><span class="cm">/*Safely computes the difference between two granule positions.</span>
<a name="gbab-662"></a><span class="cm">  The difference must fit in a signed 64-bit integer, or the function fails.</span>
<a name="gbab-663"></a><span class="cm">  It correctly handles the case where the granule position has wrapped around</span>
<a name="gbab-664"></a><span class="cm">   from positive values to negative ones.</span>
<a name="gbab-665"></a><span class="cm">  [out] _delta: The difference between the granule positions.</span>
<a name="gbab-666"></a><span class="cm">                Only modified on success.</span>
<a name="gbab-667"></a><span class="cm">  _gp_a:        The granule position to subtract from.</span>
<a name="gbab-668"></a><span class="cm">                This must not be -1.</span>
<a name="gbab-669"></a><span class="cm">  _gp_b:        The granule position to subtract.</span>
<a name="gbab-670"></a><span class="cm">                This must not be -1.</span>
<a name="gbab-671"></a><span class="cm">  Return: 0 on success, or OP_EINVAL if the result would not fit in a signed</span>
<a name="gbab-672"></a><span class="cm">           64-bit integer.*/</span>
<a name="gbab-673"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_granpos_diff</span><span class="p">(</span><span class="n">ogg_int64_t</span> <span class="o">*</span><span class="n">_delta</span><span class="p">,</span>
<a name="gbab-674"></a> <span class="n">ogg_int64_t</span> <span class="n">_gp_a</span><span class="p">,</span><span class="n">ogg_int64_t</span> <span class="n">_gp_b</span><span class="p">){</span>
<a name="gbab-675"></a>  <span class="kt">int</span> <span class="n">gp_a_negative</span><span class="p">;</span>
<a name="gbab-676"></a>  <span class="kt">int</span> <span class="n">gp_b_negative</span><span class="p">;</span>
<a name="gbab-677"></a>  <span class="cm">/*The code below handles these cases correctly, but there&#39;s no reason we</span>
<a name="gbab-678"></a><span class="cm">     should ever be called with these values, so make sure we aren&#39;t.*/</span>
<a name="gbab-679"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_gp_a</span><span class="o">!=-</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-680"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_gp_b</span><span class="o">!=-</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-681"></a>  <span class="n">gp_a_negative</span><span class="o">=</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_gp_a</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-682"></a>  <span class="n">gp_b_negative</span><span class="o">=</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_gp_b</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-683"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">gp_a_negative</span><span class="o">^</span><span class="n">gp_b_negative</span><span class="p">)){</span>
<a name="gbab-684"></a>    <span class="n">ogg_int64_t</span> <span class="n">da</span><span class="p">;</span>
<a name="gbab-685"></a>    <span class="n">ogg_int64_t</span> <span class="n">db</span><span class="p">;</span>
<a name="gbab-686"></a>    <span class="k">if</span><span class="p">(</span><span class="n">gp_a_negative</span><span class="p">){</span>
<a name="gbab-687"></a>      <span class="cm">/*_gp_a has wrapped to a negative value but _gp_b hasn&#39;t: the difference</span>
<a name="gbab-688"></a><span class="cm">         should be positive.*/</span>
<a name="gbab-689"></a>      <span class="cm">/*Step 1: Handle wrapping.*/</span>
<a name="gbab-690"></a>      <span class="cm">/*_gp_a &lt; 0 =&gt; da &lt; 0.*/</span>
<a name="gbab-691"></a>      <span class="n">da</span><span class="o">=</span><span class="p">(</span><span class="n">OP_INT64_MIN</span><span class="o">-</span><span class="n">_gp_a</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-692"></a>      <span class="cm">/*_gp_b &gt;= 0  =&gt; db &gt;= 0.*/</span>
<a name="gbab-693"></a>      <span class="n">db</span><span class="o">=</span><span class="n">OP_INT64_MAX</span><span class="o">-</span><span class="n">_gp_b</span><span class="p">;</span>
<a name="gbab-694"></a>      <span class="cm">/*Step 2: Check for overflow.*/</span>
<a name="gbab-695"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">OP_INT64_MAX</span><span class="o">+</span><span class="n">da</span><span class="o">&lt;</span><span class="n">db</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-696"></a>      <span class="o">*</span><span class="n">_delta</span><span class="o">=</span><span class="n">db</span><span class="o">-</span><span class="n">da</span><span class="p">;</span>
<a name="gbab-697"></a>    <span class="p">}</span>
<a name="gbab-698"></a>    <span class="k">else</span><span class="p">{</span>
<a name="gbab-699"></a>      <span class="cm">/*_gp_b has wrapped to a negative value but _gp_a hasn&#39;t: the difference</span>
<a name="gbab-700"></a><span class="cm">         should be negative.*/</span>
<a name="gbab-701"></a>      <span class="cm">/*Step 1: Handle wrapping.*/</span>
<a name="gbab-702"></a>      <span class="cm">/*_gp_a &gt;= 0 =&gt; da &lt;= 0*/</span>
<a name="gbab-703"></a>      <span class="n">da</span><span class="o">=</span><span class="n">_gp_a</span><span class="o">+</span><span class="n">OP_INT64_MIN</span><span class="p">;</span>
<a name="gbab-704"></a>      <span class="cm">/*_gp_b &lt; 0 =&gt; db &lt;= 0*/</span>
<a name="gbab-705"></a>      <span class="n">db</span><span class="o">=</span><span class="n">OP_INT64_MIN</span><span class="o">-</span><span class="n">_gp_b</span><span class="p">;</span>
<a name="gbab-706"></a>      <span class="cm">/*Step 2: Check for overflow.*/</span>
<a name="gbab-707"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">da</span><span class="o">&lt;</span><span class="n">OP_INT64_MIN</span><span class="o">-</span><span class="n">db</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-708"></a>      <span class="o">*</span><span class="n">_delta</span><span class="o">=</span><span class="n">da</span><span class="o">+</span><span class="n">db</span><span class="p">;</span>
<a name="gbab-709"></a>    <span class="p">}</span>
<a name="gbab-710"></a>  <span class="p">}</span>
<a name="gbab-711"></a>  <span class="k">else</span> <span class="o">*</span><span class="n">_delta</span><span class="o">=</span><span class="n">_gp_a</span><span class="o">-</span><span class="n">_gp_b</span><span class="p">;</span>
<a name="gbab-712"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-713"></a><span class="p">}</span>
<a name="gbab-714"></a>
<a name="gbab-715"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_granpos_cmp</span><span class="p">(</span><span class="n">ogg_int64_t</span> <span class="n">_gp_a</span><span class="p">,</span><span class="n">ogg_int64_t</span> <span class="n">_gp_b</span><span class="p">){</span>
<a name="gbab-716"></a>  <span class="cm">/*The invalid granule position -1 should behave like NaN: neither greater</span>
<a name="gbab-717"></a><span class="cm">     than nor less than any other granule position, nor equal to any other</span>
<a name="gbab-718"></a><span class="cm">     granule position, including itself.</span>
<a name="gbab-719"></a><span class="cm">    However, that means there isn&#39;t anything we could sensibly return from this</span>
<a name="gbab-720"></a><span class="cm">     function for it.*/</span>
<a name="gbab-721"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_gp_a</span><span class="o">!=-</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-722"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_gp_b</span><span class="o">!=-</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-723"></a>  <span class="cm">/*Handle the wrapping cases.*/</span>
<a name="gbab-724"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_gp_a</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-725"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_gp_b</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span><span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-726"></a>    <span class="cm">/*Else fall through.*/</span>
<a name="gbab-727"></a>  <span class="p">}</span>
<a name="gbab-728"></a>  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_gp_b</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-729"></a>  <span class="cm">/*No wrapping case.*/</span>
<a name="gbab-730"></a>  <span class="k">return</span> <span class="p">(</span><span class="n">_gp_a</span><span class="o">&gt;</span><span class="n">_gp_b</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">_gp_b</span><span class="o">&gt;</span><span class="n">_gp_a</span><span class="p">);</span>
<a name="gbab-731"></a><span class="p">}</span>
<a name="gbab-732"></a>
<a name="gbab-733"></a><span class="cm">/*Returns the duration of the packet (in samples at 48 kHz), or a negative</span>
<a name="gbab-734"></a><span class="cm">   value on error.*/</span>
<a name="gbab-735"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_get_packet_duration</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_data</span><span class="p">,</span><span class="kt">int</span> <span class="n">_len</span><span class="p">){</span>
<a name="gbab-736"></a>  <span class="kt">int</span> <span class="n">nframes</span><span class="p">;</span>
<a name="gbab-737"></a>  <span class="kt">int</span> <span class="n">frame_size</span><span class="p">;</span>
<a name="gbab-738"></a>  <span class="kt">int</span> <span class="n">nsamples</span><span class="p">;</span>
<a name="gbab-739"></a>  <span class="n">nframes</span><span class="o">=</span><span class="n">opus_packet_get_nb_frames</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span><span class="n">_len</span><span class="p">);</span>
<a name="gbab-740"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">nframes</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADPACKET</span><span class="p">;</span>
<a name="gbab-741"></a>  <span class="n">frame_size</span><span class="o">=</span><span class="n">opus_packet_get_samples_per_frame</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span><span class="mi">48000</span><span class="p">);</span>
<a name="gbab-742"></a>  <span class="n">nsamples</span><span class="o">=</span><span class="n">nframes</span><span class="o">*</span><span class="n">frame_size</span><span class="p">;</span>
<a name="gbab-743"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">nsamples</span><span class="o">&gt;</span><span class="mi">120</span><span class="o">*</span><span class="mi">48</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADPACKET</span><span class="p">;</span>
<a name="gbab-744"></a>  <span class="k">return</span> <span class="n">nsamples</span><span class="p">;</span>
<a name="gbab-745"></a><span class="p">}</span>
<a name="gbab-746"></a>
<a name="gbab-747"></a><span class="cm">/*This function more properly belongs in info.c, but we define it here to allow</span>
<a name="gbab-748"></a><span class="cm">   the static granule position manipulation functions to remain static.*/</span>
<a name="gbab-749"></a><span class="n">ogg_int64_t</span> <span class="nf">opus_granule_sample</span><span class="p">(</span><span class="k">const</span> <span class="n">OpusHead</span> <span class="o">*</span><span class="n">_head</span><span class="p">,</span><span class="n">ogg_int64_t</span> <span class="n">_gp</span><span class="p">){</span>
<a name="gbab-750"></a>  <span class="n">opus_int32</span> <span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-751"></a>  <span class="n">pre_skip</span><span class="o">=</span><span class="n">_head</span><span class="o">-&gt;</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-752"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_gp</span><span class="o">!=-</span><span class="mi">1</span><span class="o">&amp;&amp;</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_gp</span><span class="p">,</span><span class="n">_gp</span><span class="p">,</span><span class="o">-</span><span class="n">pre_skip</span><span class="p">))</span><span class="n">_gp</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-753"></a>  <span class="k">return</span> <span class="n">_gp</span><span class="p">;</span>
<a name="gbab-754"></a><span class="p">}</span>
<a name="gbab-755"></a>
<a name="gbab-756"></a><span class="cm">/*Grab all the packets currently in the stream state, and compute their</span>
<a name="gbab-757"></a><span class="cm">   durations.</span>
<a name="gbab-758"></a><span class="cm">  _of-&gt;op_count is set to the number of packets collected.</span>
<a name="gbab-759"></a><span class="cm">  [out] _durations: Returns the durations of the individual packets.</span>
<a name="gbab-760"></a><span class="cm">  Return: The total duration of all packets, or OP_HOLE if there was a hole.*/</span>
<a name="gbab-761"></a><span class="k">static</span> <span class="n">opus_int32</span> <span class="nf">op_collect_audio_packets</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-762"></a> <span class="kt">int</span> <span class="n">_durations</span><span class="p">[</span><span class="mi">255</span><span class="p">]){</span>
<a name="gbab-763"></a>  <span class="n">opus_int32</span> <span class="n">total_duration</span><span class="p">;</span>
<a name="gbab-764"></a>  <span class="kt">int</span>        <span class="n">op_count</span><span class="p">;</span>
<a name="gbab-765"></a>  <span class="cm">/*Count the durations of all packets in the page.*/</span>
<a name="gbab-766"></a>  <span class="n">op_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-767"></a>  <span class="n">total_duration</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-768"></a>  <span class="k">for</span><span class="p">(;;){</span>
<a name="gbab-769"></a>    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-770"></a>    <span class="cm">/*This takes advantage of undocumented libogg behavior that returned</span>
<a name="gbab-771"></a><span class="cm">       ogg_packet buffers are valid at least until the next page is</span>
<a name="gbab-772"></a><span class="cm">       submitted.</span>
<a name="gbab-773"></a><span class="cm">      Relying on this is not too terrible, as _none_ of the Ogg memory</span>
<a name="gbab-774"></a><span class="cm">       ownership/lifetime rules are well-documented.</span>
<a name="gbab-775"></a><span class="cm">      But I can read its code and know this will work.*/</span>
<a name="gbab-776"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">ogg_stream_packetout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">+</span><span class="n">op_count</span><span class="p">);</span>
<a name="gbab-777"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-778"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-779"></a>      <span class="cm">/*We shouldn&#39;t get holes in the middle of pages.*/</span>
<a name="gbab-780"></a>      <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">op_count</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-781"></a>      <span class="cm">/*Set the return value and break out of the loop.</span>
<a name="gbab-782"></a><span class="cm">        We want to make sure op_count gets set to 0, because we&#39;ve ingested a</span>
<a name="gbab-783"></a><span class="cm">         page, so any previously loaded packets are now invalid.*/</span>
<a name="gbab-784"></a>      <span class="n">total_duration</span><span class="o">=</span><span class="n">OP_HOLE</span><span class="p">;</span>
<a name="gbab-785"></a>      <span class="k">break</span><span class="p">;</span>
<a name="gbab-786"></a>    <span class="p">}</span>
<a name="gbab-787"></a>    <span class="cm">/*Unless libogg is broken, we can&#39;t get more than 255 packets from a</span>
<a name="gbab-788"></a><span class="cm">       single page.*/</span>
<a name="gbab-789"></a>    <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">op_count</span><span class="o">&lt;</span><span class="mi">255</span><span class="p">);</span>
<a name="gbab-790"></a>    <span class="n">_durations</span><span class="p">[</span><span class="n">op_count</span><span class="p">]</span><span class="o">=</span><span class="n">op_get_packet_duration</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="p">].</span><span class="n">packet</span><span class="p">,</span>
<a name="gbab-791"></a>     <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="p">].</span><span class="n">bytes</span><span class="p">);</span>
<a name="gbab-792"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">_durations</span><span class="p">[</span><span class="n">op_count</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-793"></a>      <span class="cm">/*With at most 255 packets on a page, this can&#39;t overflow.*/</span>
<a name="gbab-794"></a>      <span class="n">total_duration</span><span class="o">+=</span><span class="n">_durations</span><span class="p">[</span><span class="n">op_count</span><span class="o">++</span><span class="p">];</span>
<a name="gbab-795"></a>    <span class="p">}</span>
<a name="gbab-796"></a>    <span class="cm">/*Ignore packets with an invalid TOC sequence.*/</span>
<a name="gbab-797"></a>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">op_count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-798"></a>      <span class="cm">/*But save the granule position, if there was one.*/</span>
<a name="gbab-799"></a>      <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">granulepos</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="p">].</span><span class="n">granulepos</span><span class="p">;</span>
<a name="gbab-800"></a>    <span class="p">}</span>
<a name="gbab-801"></a>  <span class="p">}</span>
<a name="gbab-802"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-803"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="o">=</span><span class="n">op_count</span><span class="p">;</span>
<a name="gbab-804"></a>  <span class="k">return</span> <span class="n">total_duration</span><span class="p">;</span>
<a name="gbab-805"></a><span class="p">}</span>
<a name="gbab-806"></a>
<a name="gbab-807"></a><span class="cm">/*Starting from current cursor position, get the initial PCM offset of the next</span>
<a name="gbab-808"></a><span class="cm">   page.</span>
<a name="gbab-809"></a><span class="cm">  This also validates the granule position on the first page with a completed</span>
<a name="gbab-810"></a><span class="cm">   audio data packet, as required by the spec.</span>
<a name="gbab-811"></a><span class="cm">  If this link is completely empty (no pages with completed packets), then this</span>
<a name="gbab-812"></a><span class="cm">   function sets pcm_start=pcm_end=0 and returns the BOS page of the next link</span>
<a name="gbab-813"></a><span class="cm">   (if any).</span>
<a name="gbab-814"></a><span class="cm">  In the seekable case, we initialize pcm_end=-1 before calling this function,</span>
<a name="gbab-815"></a><span class="cm">   so that later we can detect that the link was empty before calling</span>
<a name="gbab-816"></a><span class="cm">   op_find_final_pcm_offset().</span>
<a name="gbab-817"></a><span class="cm">  [inout] _link: The link for which to find pcm_start.</span>
<a name="gbab-818"></a><span class="cm">  [out] _og:     Returns the BOS page of the next link if this link was empty.</span>
<a name="gbab-819"></a><span class="cm">                 In the unseekable case, we can then feed this to</span>
<a name="gbab-820"></a><span class="cm">                  op_fetch_headers() to start the next link.</span>
<a name="gbab-821"></a><span class="cm">                 The caller may pass NULL (e.g., for seekable streams), in</span>
<a name="gbab-822"></a><span class="cm">                  which case this page will be discarded.</span>
<a name="gbab-823"></a><span class="cm">  Return: 0 on success, 1 if there is a buffered BOS page available, or a</span>
<a name="gbab-824"></a><span class="cm">           negative value on unrecoverable error.*/</span>
<a name="gbab-825"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_find_initial_pcm_offset</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-826"></a> <span class="n">OggOpusLink</span> <span class="o">*</span><span class="n">_link</span><span class="p">,</span><span class="n">ogg_page</span> <span class="o">*</span><span class="n">_og</span><span class="p">){</span>
<a name="gbab-827"></a>  <span class="n">ogg_page</span>     <span class="n">og</span><span class="p">;</span>
<a name="gbab-828"></a>  <span class="n">opus_int64</span>   <span class="n">page_offset</span><span class="p">;</span>
<a name="gbab-829"></a>  <span class="n">ogg_int64_t</span>  <span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-830"></a>  <span class="n">ogg_int64_t</span>  <span class="n">prev_packet_gp</span><span class="p">;</span>
<a name="gbab-831"></a>  <span class="n">ogg_int64_t</span>  <span class="n">cur_page_gp</span><span class="p">;</span>
<a name="gbab-832"></a>  <span class="n">ogg_uint32_t</span> <span class="n">serialno</span><span class="p">;</span>
<a name="gbab-833"></a>  <span class="n">opus_int32</span>   <span class="n">total_duration</span><span class="p">;</span>
<a name="gbab-834"></a>  <span class="kt">int</span>          <span class="n">durations</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
<a name="gbab-835"></a>  <span class="kt">int</span>          <span class="n">cur_page_eos</span><span class="p">;</span>
<a name="gbab-836"></a>  <span class="kt">int</span>          <span class="n">op_count</span><span class="p">;</span>
<a name="gbab-837"></a>  <span class="kt">int</span>          <span class="n">pi</span><span class="p">;</span>
<a name="gbab-838"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_og</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span><span class="n">_og</span><span class="o">=&amp;</span><span class="n">og</span><span class="p">;</span>
<a name="gbab-839"></a>  <span class="n">serialno</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-840"></a>  <span class="n">op_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-841"></a>  <span class="cm">/*We shouldn&#39;t have to initialize total_duration, but gcc is too dumb to</span>
<a name="gbab-842"></a><span class="cm">     figure out that op_count&gt;0 implies we&#39;ve been through the whole loop at</span>
<a name="gbab-843"></a><span class="cm">     least once.*/</span>
<a name="gbab-844"></a>  <span class="n">total_duration</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-845"></a>  <span class="k">do</span><span class="p">{</span>
<a name="gbab-846"></a>    <span class="n">page_offset</span><span class="o">=</span><span class="n">op_get_next_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_og</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
<a name="gbab-847"></a>    <span class="cm">/*We should get a page unless the file is truncated or mangled.</span>
<a name="gbab-848"></a><span class="cm">      Otherwise there are no audio data packets in the whole logical stream.*/</span>
<a name="gbab-849"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">page_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-850"></a>      <span class="cm">/*Fail if there was a read error.*/</span>
<a name="gbab-851"></a>      <span class="k">if</span><span class="p">(</span><span class="n">page_offset</span><span class="o">&lt;</span><span class="n">OP_FALSE</span><span class="p">)</span><span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">page_offset</span><span class="p">;</span>
<a name="gbab-852"></a>      <span class="cm">/*Fail if the pre-skip is non-zero, since it&#39;s asking us to skip more</span>
<a name="gbab-853"></a><span class="cm">         samples than exist.*/</span>
<a name="gbab-854"></a>      <span class="k">if</span><span class="p">(</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_EBADTIMESTAMP</span><span class="p">;</span>
<a name="gbab-855"></a>      <span class="cm">/*Set pcm_end and end_offset so we can skip the call to</span>
<a name="gbab-856"></a><span class="cm">         op_find_final_pcm_offset().*/</span>
<a name="gbab-857"></a>      <span class="n">_link</span><span class="o">-&gt;</span><span class="n">pcm_start</span><span class="o">=</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">pcm_end</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-858"></a>      <span class="n">_link</span><span class="o">-&gt;</span><span class="n">end_offset</span><span class="o">=</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
<a name="gbab-859"></a>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-860"></a>    <span class="p">}</span>
<a name="gbab-861"></a>    <span class="cm">/*Similarly, if we hit the next link in the chain, we&#39;ve gone too far.*/</span>
<a name="gbab-862"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ogg_page_bos</span><span class="p">(</span><span class="n">_og</span><span class="p">))){</span>
<a name="gbab-863"></a>      <span class="k">if</span><span class="p">(</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_EBADTIMESTAMP</span><span class="p">;</span>
<a name="gbab-864"></a>      <span class="cm">/*Set pcm_end and end_offset so we can skip the call to</span>
<a name="gbab-865"></a><span class="cm">         op_find_final_pcm_offset().*/</span>
<a name="gbab-866"></a>      <span class="n">_link</span><span class="o">-&gt;</span><span class="n">pcm_end</span><span class="o">=</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">pcm_start</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-867"></a>      <span class="n">_link</span><span class="o">-&gt;</span><span class="n">end_offset</span><span class="o">=</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
<a name="gbab-868"></a>      <span class="cm">/*Tell the caller we&#39;ve got a buffered page for them.*/</span>
<a name="gbab-869"></a>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-870"></a>    <span class="p">}</span>
<a name="gbab-871"></a>    <span class="cm">/*Ignore pages from other streams (not strictly necessary, because of the</span>
<a name="gbab-872"></a><span class="cm">       checks in ogg_stream_pagein(), but saves some work).*/</span>
<a name="gbab-873"></a>    <span class="k">if</span><span class="p">(</span><span class="n">serialno</span><span class="o">!=</span><span class="p">(</span><span class="n">ogg_uint32_t</span><span class="p">)</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="n">_og</span><span class="p">))</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-874"></a>    <span class="n">ogg_stream_pagein</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="n">_og</span><span class="p">);</span>
<a name="gbab-875"></a>    <span class="cm">/*Bitrate tracking: add the header&#39;s bytes here.</span>
<a name="gbab-876"></a><span class="cm">      The body bytes are counted when we consume the packets.*/</span>
<a name="gbab-877"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">bytes_tracked</span><span class="o">+=</span><span class="n">_og</span><span class="o">-&gt;</span><span class="n">header_len</span><span class="p">;</span>
<a name="gbab-878"></a>    <span class="cm">/*Count the durations of all packets in the page.*/</span>
<a name="gbab-879"></a>    <span class="k">do</span> <span class="n">total_duration</span><span class="o">=</span><span class="n">op_collect_audio_packets</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">durations</span><span class="p">);</span>
<a name="gbab-880"></a>    <span class="cm">/*Ignore holes.*/</span>
<a name="gbab-881"></a>    <span class="k">while</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">total_duration</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">));</span>
<a name="gbab-882"></a>    <span class="n">op_count</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
<a name="gbab-883"></a>  <span class="p">}</span>
<a name="gbab-884"></a>  <span class="k">while</span><span class="p">(</span><span class="n">op_count</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-885"></a>  <span class="cm">/*We found the first page with a completed audio data packet: actually look</span>
<a name="gbab-886"></a><span class="cm">     at the granule position.</span>
<a name="gbab-887"></a><span class="cm">    RFC 3533 says, &quot;A special value of -1 (in two&#39;s complement) indicates that</span>
<a name="gbab-888"></a><span class="cm">     no packets finish on this page,&quot; which does not say that a granule</span>
<a name="gbab-889"></a><span class="cm">     position that is NOT -1 indicates that some packets DO finish on that page</span>
<a name="gbab-890"></a><span class="cm">     (even though this was the intention, libogg itself violated this intention</span>
<a name="gbab-891"></a><span class="cm">     for years before we fixed it).</span>
<a name="gbab-892"></a><span class="cm">    The Ogg Opus specification only imposes its start-time requirements</span>
<a name="gbab-893"></a><span class="cm">     on the granule position of the first page with completed packets,</span>
<a name="gbab-894"></a><span class="cm">     so we ignore any set granule positions until then.*/</span>
<a name="gbab-895"></a>  <span class="n">cur_page_gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">granulepos</span><span class="p">;</span>
<a name="gbab-896"></a>  <span class="cm">/*But getting a packet without a valid granule position on the page is not</span>
<a name="gbab-897"></a><span class="cm">     okay.*/</span>
<a name="gbab-898"></a>  <span class="k">if</span><span class="p">(</span><span class="n">cur_page_gp</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_EBADTIMESTAMP</span><span class="p">;</span>
<a name="gbab-899"></a>  <span class="n">cur_page_eos</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">e_o_s</span><span class="p">;</span>
<a name="gbab-900"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">cur_page_eos</span><span class="p">)){</span>
<a name="gbab-901"></a>    <span class="cm">/*The EOS flag wasn&#39;t set.</span>
<a name="gbab-902"></a><span class="cm">      Work backwards from the provided granule position to get the starting PCM</span>
<a name="gbab-903"></a><span class="cm">       offset.*/</span>
<a name="gbab-904"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm_start</span><span class="p">,</span><span class="n">cur_page_gp</span><span class="p">,</span><span class="o">-</span><span class="n">total_duration</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-905"></a>      <span class="cm">/*The starting granule position MUST not be smaller than the amount of</span>
<a name="gbab-906"></a><span class="cm">         audio on the first page with completed packets.*/</span>
<a name="gbab-907"></a>      <span class="k">return</span> <span class="n">OP_EBADTIMESTAMP</span><span class="p">;</span>
<a name="gbab-908"></a>    <span class="p">}</span>
<a name="gbab-909"></a>  <span class="p">}</span>
<a name="gbab-910"></a>  <span class="k">else</span><span class="p">{</span>
<a name="gbab-911"></a>    <span class="cm">/*The first page with completed packets was also the last.*/</span>
<a name="gbab-912"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm_start</span><span class="p">,</span><span class="n">cur_page_gp</span><span class="p">,</span><span class="o">-</span><span class="n">total_duration</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-913"></a>      <span class="cm">/*If there&#39;s less audio on the page than indicated by the granule</span>
<a name="gbab-914"></a><span class="cm">         position, then we&#39;re doing end-trimming, and the starting PCM offset</span>
<a name="gbab-915"></a><span class="cm">         is zero by spec mandate.*/</span>
<a name="gbab-916"></a>      <span class="n">pcm_start</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-917"></a>      <span class="cm">/*However, the end-trimming MUST not ask us to trim more samples than</span>
<a name="gbab-918"></a><span class="cm">         exist after applying the pre-skip.*/</span>
<a name="gbab-919"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">cur_page_gp</span><span class="p">,</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-920"></a>        <span class="k">return</span> <span class="n">OP_EBADTIMESTAMP</span><span class="p">;</span>
<a name="gbab-921"></a>      <span class="p">}</span>
<a name="gbab-922"></a>    <span class="p">}</span>
<a name="gbab-923"></a>  <span class="p">}</span>
<a name="gbab-924"></a>  <span class="cm">/*Timestamp the individual packets.*/</span>
<a name="gbab-925"></a>  <span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-926"></a>  <span class="k">for</span><span class="p">(</span><span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">pi</span><span class="o">&lt;</span><span class="n">op_count</span><span class="p">;</span><span class="n">pi</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-927"></a>    <span class="k">if</span><span class="p">(</span><span class="n">cur_page_eos</span><span class="p">){</span>
<a name="gbab-928"></a>      <span class="n">ogg_int64_t</span> <span class="n">diff</span><span class="p">;</span>
<a name="gbab-929"></a>      <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span><span class="n">cur_page_gp</span><span class="p">,</span><span class="n">prev_packet_gp</span><span class="p">));</span>
<a name="gbab-930"></a>      <span class="n">diff</span><span class="o">=</span><span class="n">durations</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="o">-</span><span class="n">diff</span><span class="p">;</span>
<a name="gbab-931"></a>      <span class="cm">/*If we have samples to trim...*/</span>
<a name="gbab-932"></a>      <span class="k">if</span><span class="p">(</span><span class="n">diff</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-933"></a>        <span class="cm">/*If we trimmed the entire packet, stop (the spec says encoders</span>
<a name="gbab-934"></a><span class="cm">           shouldn&#39;t do this, but we support it anyway).*/</span>
<a name="gbab-935"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">diff</span><span class="o">&gt;</span><span class="n">durations</span><span class="p">[</span><span class="n">pi</span><span class="p">]))</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-936"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">pi</span><span class="p">].</span><span class="n">granulepos</span><span class="o">=</span><span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">cur_page_gp</span><span class="p">;</span>
<a name="gbab-937"></a>        <span class="cm">/*Move the EOS flag to this packet, if necessary, so we&#39;ll trim the</span>
<a name="gbab-938"></a><span class="cm">           samples.*/</span>
<a name="gbab-939"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">pi</span><span class="p">].</span><span class="n">e_o_s</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-940"></a>        <span class="k">continue</span><span class="p">;</span>
<a name="gbab-941"></a>      <span class="p">}</span>
<a name="gbab-942"></a>    <span class="p">}</span>
<a name="gbab-943"></a>    <span class="cm">/*Update the granule position as normal.*/</span>
<a name="gbab-944"></a>    <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">pi</span><span class="p">].</span><span class="n">granulepos</span><span class="p">,</span>
<a name="gbab-945"></a>     <span class="n">prev_packet_gp</span><span class="p">,</span><span class="n">durations</span><span class="p">[</span><span class="n">pi</span><span class="p">]));</span>
<a name="gbab-946"></a>    <span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">pi</span><span class="p">].</span><span class="n">granulepos</span><span class="p">;</span>
<a name="gbab-947"></a>  <span class="p">}</span>
<a name="gbab-948"></a>  <span class="cm">/*Update the packet count after end-trimming.*/</span>
<a name="gbab-949"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="o">=</span><span class="n">pi</span><span class="p">;</span>
<a name="gbab-950"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="o">=</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-951"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">pcm_start</span><span class="o">=</span><span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-952"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_page_offset</span><span class="o">=</span><span class="n">page_offset</span><span class="p">;</span>
<a name="gbab-953"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-954"></a><span class="p">}</span>
<a name="gbab-955"></a>
<a name="gbab-956"></a><span class="cm">/*Starting from current cursor position, get the final PCM offset of the</span>
<a name="gbab-957"></a><span class="cm">   previous page.</span>
<a name="gbab-958"></a><span class="cm">  This also validates the duration of the link, which, while not strictly</span>
<a name="gbab-959"></a><span class="cm">   required by the spec, we need to ensure duration calculations don&#39;t</span>
<a name="gbab-960"></a><span class="cm">   overflow.</span>
<a name="gbab-961"></a><span class="cm">  This is only done for seekable sources.</span>
<a name="gbab-962"></a><span class="cm">  We must validate that op_find_initial_pcm_offset() succeeded for this link</span>
<a name="gbab-963"></a><span class="cm">   before calling this function, otherwise it will scan the entire stream</span>
<a name="gbab-964"></a><span class="cm">   backwards until it reaches the start, and then fail.*/</span>
<a name="gbab-965"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_find_final_pcm_offset</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-966"></a> <span class="k">const</span> <span class="n">ogg_uint32_t</span> <span class="o">*</span><span class="n">_serialnos</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nserialnos</span><span class="p">,</span><span class="n">OggOpusLink</span> <span class="o">*</span><span class="n">_link</span><span class="p">,</span>
<a name="gbab-967"></a> <span class="n">opus_int64</span> <span class="n">_offset</span><span class="p">,</span><span class="n">ogg_uint32_t</span> <span class="n">_end_serialno</span><span class="p">,</span><span class="n">ogg_int64_t</span> <span class="n">_end_gp</span><span class="p">,</span>
<a name="gbab-968"></a> <span class="n">ogg_int64_t</span> <span class="o">*</span><span class="n">_total_duration</span><span class="p">){</span>
<a name="gbab-969"></a>  <span class="n">ogg_int64_t</span>  <span class="n">total_duration</span><span class="p">;</span>
<a name="gbab-970"></a>  <span class="n">ogg_int64_t</span>  <span class="n">duration</span><span class="p">;</span>
<a name="gbab-971"></a>  <span class="n">ogg_uint32_t</span> <span class="n">cur_serialno</span><span class="p">;</span>
<a name="gbab-972"></a>  <span class="cm">/*For the time being, fetch end PCM offset the simple way.*/</span>
<a name="gbab-973"></a>  <span class="n">cur_serialno</span><span class="o">=</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-974"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_end_serialno</span><span class="o">!=</span><span class="n">cur_serialno</span><span class="o">||</span><span class="n">_end_gp</span><span class="o">==-</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-975"></a>    <span class="n">_offset</span><span class="o">=</span><span class="n">op_get_last_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">_end_gp</span><span class="p">,</span><span class="n">_offset</span><span class="p">,</span>
<a name="gbab-976"></a>     <span class="n">cur_serialno</span><span class="p">,</span><span class="n">_serialnos</span><span class="p">,</span><span class="n">_nserialnos</span><span class="p">);</span>
<a name="gbab-977"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">_offset</span><span class="p">;</span>
<a name="gbab-978"></a>  <span class="p">}</span>
<a name="gbab-979"></a>  <span class="cm">/*At worst we should have found the first page with completed packets.*/</span>
<a name="gbab-980"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_offset</span><span class="o">&lt;</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-981"></a>  <span class="cm">/*This implementation requires that the difference between the first and last</span>
<a name="gbab-982"></a><span class="cm">     granule positions in each link be representable in a signed, 64-bit</span>
<a name="gbab-983"></a><span class="cm">     number, and that each link also have at least as many samples as the</span>
<a name="gbab-984"></a><span class="cm">     pre-skip requires.*/</span>
<a name="gbab-985"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">duration</span><span class="p">,</span><span class="n">_end_gp</span><span class="p">,</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">pcm_start</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
<a name="gbab-986"></a>   <span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">duration</span><span class="o">&lt;</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">)){</span>
<a name="gbab-987"></a>    <span class="k">return</span> <span class="n">OP_EBADTIMESTAMP</span><span class="p">;</span>
<a name="gbab-988"></a>  <span class="p">}</span>
<a name="gbab-989"></a>  <span class="cm">/*We also require that the total duration be representable in a signed,</span>
<a name="gbab-990"></a><span class="cm">     64-bit number.*/</span>
<a name="gbab-991"></a>  <span class="n">duration</span><span class="o">-=</span><span class="n">_link</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-992"></a>  <span class="n">total_duration</span><span class="o">=*</span><span class="n">_total_duration</span><span class="p">;</span>
<a name="gbab-993"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">OP_INT64_MAX</span><span class="o">-</span><span class="n">duration</span><span class="o">&lt;</span><span class="n">total_duration</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADTIMESTAMP</span><span class="p">;</span>
<a name="gbab-994"></a>  <span class="o">*</span><span class="n">_total_duration</span><span class="o">=</span><span class="n">total_duration</span><span class="o">+</span><span class="n">duration</span><span class="p">;</span>
<a name="gbab-995"></a>  <span class="n">_link</span><span class="o">-&gt;</span><span class="n">pcm_end</span><span class="o">=</span><span class="n">_end_gp</span><span class="p">;</span>
<a name="gbab-996"></a>  <span class="n">_link</span><span class="o">-&gt;</span><span class="n">end_offset</span><span class="o">=</span><span class="n">_offset</span><span class="p">;</span>
<a name="gbab-997"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-998"></a><span class="p">}</span>
<a name="gbab-999"></a>
<a name="gbab-1000"></a><span class="cm">/*Rescale the number _x from the range [0,_from] to [0,_to].</span>
<a name="gbab-1001"></a><span class="cm">  _from and _to must be positive.*/</span>
<a name="gbab-1002"></a><span class="k">static</span> <span class="n">opus_int64</span> <span class="nf">op_rescale64</span><span class="p">(</span><span class="n">opus_int64</span> <span class="n">_x</span><span class="p">,</span><span class="n">opus_int64</span> <span class="n">_from</span><span class="p">,</span><span class="n">opus_int64</span> <span class="n">_to</span><span class="p">){</span>
<a name="gbab-1003"></a>  <span class="n">opus_int64</span> <span class="n">frac</span><span class="p">;</span>
<a name="gbab-1004"></a>  <span class="n">opus_int64</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1005"></a>  <span class="kt">int</span>        <span class="n">i</span><span class="p">;</span>
<a name="gbab-1006"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_x</span><span class="o">&gt;=</span><span class="n">_from</span><span class="p">)</span><span class="k">return</span> <span class="n">_to</span><span class="p">;</span>
<a name="gbab-1007"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_x</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span><span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-1008"></a>  <span class="n">frac</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1009"></a>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">63</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-1010"></a>    <span class="n">frac</span><span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1011"></a>    <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_x</span><span class="o">&lt;=</span><span class="n">_from</span><span class="p">);</span>
<a name="gbab-1012"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_x</span><span class="o">&gt;=</span><span class="n">_from</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-1013"></a>      <span class="n">_x</span><span class="o">-=</span><span class="n">_from</span><span class="o">-</span><span class="n">_x</span><span class="p">;</span>
<a name="gbab-1014"></a>      <span class="n">frac</span><span class="o">|=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1015"></a>    <span class="p">}</span>
<a name="gbab-1016"></a>    <span class="k">else</span> <span class="n">_x</span><span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1017"></a>  <span class="p">}</span>
<a name="gbab-1018"></a>  <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1019"></a>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">63</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-1020"></a>    <span class="k">if</span><span class="p">(</span><span class="n">frac</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="n">ret</span><span class="o">=</span><span class="p">(</span><span class="n">ret</span><span class="o">&amp;</span><span class="n">_to</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">_to</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-1021"></a>    <span class="k">else</span> <span class="n">ret</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1022"></a>    <span class="n">frac</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1023"></a>  <span class="p">}</span>
<a name="gbab-1024"></a>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1025"></a><span class="p">}</span>
<a name="gbab-1026"></a>
<a name="gbab-1027"></a><span class="cm">/*The minimum granule position spacing allowed for making predictions.</span>
<a name="gbab-1028"></a><span class="cm">  This corresponds to about 1 second of audio at 48 kHz for both Opus and</span>
<a name="gbab-1029"></a><span class="cm">   Vorbis, or one keyframe interval in Theora with the default keyframe spacing</span>
<a name="gbab-1030"></a><span class="cm">   of 256.*/</span>
<a name="gbab-1031"></a><span class="cp">#define OP_GP_SPACING_MIN (48000)</span>
<a name="gbab-1032"></a>
<a name="gbab-1033"></a><span class="cm">/*Try to estimate the location of the next link using the current seek</span>
<a name="gbab-1034"></a><span class="cm">   records, assuming the initial granule position of any streams we&#39;ve found is</span>
<a name="gbab-1035"></a><span class="cm">   0.*/</span>
<a name="gbab-1036"></a><span class="k">static</span> <span class="n">opus_int64</span> <span class="nf">op_predict_link_start</span><span class="p">(</span><span class="k">const</span> <span class="n">OpusSeekRecord</span> <span class="o">*</span><span class="n">_sr</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nsr</span><span class="p">,</span>
<a name="gbab-1037"></a> <span class="n">opus_int64</span> <span class="n">_searched</span><span class="p">,</span><span class="n">opus_int64</span> <span class="n">_end_searched</span><span class="p">,</span><span class="n">opus_int32</span> <span class="n">_bias</span><span class="p">){</span>
<a name="gbab-1038"></a>  <span class="n">opus_int64</span> <span class="n">bisect</span><span class="p">;</span>
<a name="gbab-1039"></a>  <span class="kt">int</span>        <span class="n">sri</span><span class="p">;</span>
<a name="gbab-1040"></a>  <span class="kt">int</span>        <span class="n">srj</span><span class="p">;</span>
<a name="gbab-1041"></a>  <span class="cm">/*Require that we be at least OP_CHUNK_SIZE from the end.</span>
<a name="gbab-1042"></a><span class="cm">    We don&#39;t require that we be at least OP_CHUNK_SIZE from the beginning,</span>
<a name="gbab-1043"></a><span class="cm">     because if we are we&#39;ll just scan forward without seeking.*/</span>
<a name="gbab-1044"></a>  <span class="n">_end_searched</span><span class="o">-=</span><span class="n">OP_CHUNK_SIZE</span><span class="p">;</span>
<a name="gbab-1045"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_searched</span><span class="o">&gt;=</span><span class="n">_end_searched</span><span class="p">)</span><span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1046"></a>  <span class="n">bisect</span><span class="o">=</span><span class="n">_end_searched</span><span class="p">;</span>
<a name="gbab-1047"></a>  <span class="k">for</span><span class="p">(</span><span class="n">sri</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">sri</span><span class="o">&lt;</span><span class="n">_nsr</span><span class="p">;</span><span class="n">sri</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-1048"></a>    <span class="n">ogg_int64_t</span>  <span class="n">gp1</span><span class="p">;</span>
<a name="gbab-1049"></a>    <span class="n">ogg_int64_t</span>  <span class="n">gp2_min</span><span class="p">;</span>
<a name="gbab-1050"></a>    <span class="n">ogg_uint32_t</span> <span class="n">serialno1</span><span class="p">;</span>
<a name="gbab-1051"></a>    <span class="n">opus_int64</span>   <span class="n">offset1</span><span class="p">;</span>
<a name="gbab-1052"></a>    <span class="cm">/*If the granule position is negative, either it&#39;s invalid or we&#39;d cause</span>
<a name="gbab-1053"></a><span class="cm">       overflow.*/</span>
<a name="gbab-1054"></a>    <span class="n">gp1</span><span class="o">=</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="p">].</span><span class="n">gp</span><span class="p">;</span>
<a name="gbab-1055"></a>    <span class="k">if</span><span class="p">(</span><span class="n">gp1</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-1056"></a>    <span class="cm">/*We require some minimum distance between granule positions to make an</span>
<a name="gbab-1057"></a><span class="cm">       estimate.</span>
<a name="gbab-1058"></a><span class="cm">      We don&#39;t actually know what granule position scheme is being used,</span>
<a name="gbab-1059"></a><span class="cm">       because we have no idea what kind of stream these came from.</span>
<a name="gbab-1060"></a><span class="cm">      Therefore we require a minimum spacing between them, with the</span>
<a name="gbab-1061"></a><span class="cm">       expectation that while bitrates and granule position increments might</span>
<a name="gbab-1062"></a><span class="cm">       vary locally in quite complex ways, they are globally smooth.*/</span>
<a name="gbab-1063"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp2_min</span><span class="p">,</span><span class="n">gp1</span><span class="p">,</span><span class="n">OP_GP_SPACING_MIN</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-1064"></a>      <span class="cm">/*No granule position would satisfy us.*/</span>
<a name="gbab-1065"></a>      <span class="k">continue</span><span class="p">;</span>
<a name="gbab-1066"></a>    <span class="p">}</span>
<a name="gbab-1067"></a>    <span class="n">offset1</span><span class="o">=</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1068"></a>    <span class="n">serialno1</span><span class="o">=</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="p">].</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1069"></a>    <span class="k">for</span><span class="p">(</span><span class="n">srj</span><span class="o">=</span><span class="n">sri</span><span class="p">;</span><span class="n">srj</span><span class="o">--&gt;</span><span class="mi">0</span><span class="p">;){</span>
<a name="gbab-1070"></a>      <span class="n">ogg_int64_t</span> <span class="n">gp2</span><span class="p">;</span>
<a name="gbab-1071"></a>      <span class="n">opus_int64</span>  <span class="n">offset2</span><span class="p">;</span>
<a name="gbab-1072"></a>      <span class="n">opus_int64</span>  <span class="n">num</span><span class="p">;</span>
<a name="gbab-1073"></a>      <span class="n">ogg_int64_t</span> <span class="n">den</span><span class="p">;</span>
<a name="gbab-1074"></a>      <span class="n">ogg_int64_t</span> <span class="n">ipart</span><span class="p">;</span>
<a name="gbab-1075"></a>      <span class="n">gp2</span><span class="o">=</span><span class="n">_sr</span><span class="p">[</span><span class="n">srj</span><span class="p">].</span><span class="n">gp</span><span class="p">;</span>
<a name="gbab-1076"></a>      <span class="k">if</span><span class="p">(</span><span class="n">gp2</span><span class="o">&lt;</span><span class="n">gp2_min</span><span class="p">)</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-1077"></a>      <span class="cm">/*Oh, and also make sure these came from the same stream.*/</span>
<a name="gbab-1078"></a>      <span class="k">if</span><span class="p">(</span><span class="n">_sr</span><span class="p">[</span><span class="n">srj</span><span class="p">].</span><span class="n">serialno</span><span class="o">!=</span><span class="n">serialno1</span><span class="p">)</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-1079"></a>      <span class="n">offset2</span><span class="o">=</span><span class="n">_sr</span><span class="p">[</span><span class="n">srj</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1080"></a>      <span class="cm">/*For once, we can subtract with impunity.*/</span>
<a name="gbab-1081"></a>      <span class="n">den</span><span class="o">=</span><span class="n">gp2</span><span class="o">-</span><span class="n">gp1</span><span class="p">;</span>
<a name="gbab-1082"></a>      <span class="n">ipart</span><span class="o">=</span><span class="n">gp2</span><span class="o">/</span><span class="n">den</span><span class="p">;</span>
<a name="gbab-1083"></a>      <span class="n">num</span><span class="o">=</span><span class="n">offset2</span><span class="o">-</span><span class="n">offset1</span><span class="p">;</span>
<a name="gbab-1084"></a>      <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">num</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-1085"></a>      <span class="k">if</span><span class="p">(</span><span class="n">ipart</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">offset2</span><span class="o">-</span><span class="n">_searched</span><span class="p">)</span><span class="o">/</span><span class="n">ipart</span><span class="o">&lt;</span><span class="n">num</span><span class="p">)</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-1086"></a>      <span class="n">offset2</span><span class="o">-=</span><span class="n">ipart</span><span class="o">*</span><span class="n">num</span><span class="p">;</span>
<a name="gbab-1087"></a>      <span class="n">gp2</span><span class="o">-=</span><span class="n">ipart</span><span class="o">*</span><span class="n">den</span><span class="p">;</span>
<a name="gbab-1088"></a>      <span class="n">offset2</span><span class="o">-=</span><span class="n">op_rescale64</span><span class="p">(</span><span class="n">gp2</span><span class="p">,</span><span class="n">den</span><span class="p">,</span><span class="n">num</span><span class="p">)</span><span class="o">-</span><span class="n">_bias</span><span class="p">;</span>
<a name="gbab-1089"></a>      <span class="k">if</span><span class="p">(</span><span class="n">offset2</span><span class="o">&lt;</span><span class="n">_searched</span><span class="p">)</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-1090"></a>      <span class="n">bisect</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">bisect</span><span class="p">,</span><span class="n">offset2</span><span class="p">);</span>
<a name="gbab-1091"></a>      <span class="k">break</span><span class="p">;</span>
<a name="gbab-1092"></a>    <span class="p">}</span>
<a name="gbab-1093"></a>  <span class="p">}</span>
<a name="gbab-1094"></a>  <span class="k">return</span> <span class="n">bisect</span><span class="o">&gt;=</span><span class="n">_end_searched</span><span class="o">?-</span><span class="mi">1</span><span class="o">:</span><span class="n">bisect</span><span class="p">;</span>
<a name="gbab-1095"></a><span class="p">}</span>
<a name="gbab-1096"></a>
<a name="gbab-1097"></a><span class="cm">/*Finds each bitstream link, one at a time, using a bisection search.</span>
<a name="gbab-1098"></a><span class="cm">  This has to begin by knowing the offset of the first link&#39;s initial page.*/</span>
<a name="gbab-1099"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_bisect_forward_serialno</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-1100"></a> <span class="n">opus_int64</span> <span class="n">_searched</span><span class="p">,</span><span class="n">OpusSeekRecord</span> <span class="o">*</span><span class="n">_sr</span><span class="p">,</span><span class="kt">int</span> <span class="n">_csr</span><span class="p">,</span>
<a name="gbab-1101"></a> <span class="n">ogg_uint32_t</span> <span class="o">**</span><span class="n">_serialnos</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_nserialnos</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_cserialnos</span><span class="p">){</span>
<a name="gbab-1102"></a>  <span class="n">ogg_page</span>      <span class="n">og</span><span class="p">;</span>
<a name="gbab-1103"></a>  <span class="n">OggOpusLink</span>  <span class="o">*</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-1104"></a>  <span class="kt">int</span>           <span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-1105"></a>  <span class="kt">int</span>           <span class="n">clinks</span><span class="p">;</span>
<a name="gbab-1106"></a>  <span class="n">ogg_uint32_t</span> <span class="o">*</span><span class="n">serialnos</span><span class="p">;</span>
<a name="gbab-1107"></a>  <span class="kt">int</span>           <span class="n">nserialnos</span><span class="p">;</span>
<a name="gbab-1108"></a>  <span class="n">ogg_int64_t</span>   <span class="n">total_duration</span><span class="p">;</span>
<a name="gbab-1109"></a>  <span class="kt">int</span>           <span class="n">nsr</span><span class="p">;</span>
<a name="gbab-1110"></a>  <span class="kt">int</span>           <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1111"></a>  <span class="n">links</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-1112"></a>  <span class="n">nlinks</span><span class="o">=</span><span class="n">clinks</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-1113"></a>  <span class="n">total_duration</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1114"></a>  <span class="cm">/*We start with one seek record, for the last page in the file.</span>
<a name="gbab-1115"></a><span class="cm">    We build up a list of records for places we seek to during link</span>
<a name="gbab-1116"></a><span class="cm">     enumeration.</span>
<a name="gbab-1117"></a><span class="cm">    This list is kept sorted in reverse order.</span>
<a name="gbab-1118"></a><span class="cm">    We only care about seek locations that were _not_ in the current link,</span>
<a name="gbab-1119"></a><span class="cm">     therefore we can add them one at a time to the end of the list as we</span>
<a name="gbab-1120"></a><span class="cm">     improve the lower bound on the location where the next link starts.*/</span>
<a name="gbab-1121"></a>  <span class="n">nsr</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1122"></a>  <span class="k">for</span><span class="p">(;;){</span>
<a name="gbab-1123"></a>    <span class="n">opus_int64</span>  <span class="n">end_searched</span><span class="p">;</span>
<a name="gbab-1124"></a>    <span class="n">opus_int64</span>  <span class="n">bisect</span><span class="p">;</span>
<a name="gbab-1125"></a>    <span class="n">opus_int64</span>  <span class="n">next</span><span class="p">;</span>
<a name="gbab-1126"></a>    <span class="n">opus_int64</span>  <span class="n">last</span><span class="p">;</span>
<a name="gbab-1127"></a>    <span class="n">ogg_int64_t</span> <span class="n">end_offset</span><span class="p">;</span>
<a name="gbab-1128"></a>    <span class="n">ogg_int64_t</span> <span class="n">end_gp</span><span class="p">;</span>
<a name="gbab-1129"></a>    <span class="kt">int</span>         <span class="n">sri</span><span class="p">;</span>
<a name="gbab-1130"></a>    <span class="n">serialnos</span><span class="o">=*</span><span class="n">_serialnos</span><span class="p">;</span>
<a name="gbab-1131"></a>    <span class="n">nserialnos</span><span class="o">=*</span><span class="n">_nserialnos</span><span class="p">;</span>
<a name="gbab-1132"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">nlinks</span><span class="o">&gt;=</span><span class="n">clinks</span><span class="p">)){</span>
<a name="gbab-1133"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">clinks</span><span class="o">&gt;</span><span class="n">INT_MAX</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-1134"></a>      <span class="n">clinks</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">clinks</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1135"></a>      <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">nlinks</span><span class="o">&lt;</span><span class="n">clinks</span><span class="p">);</span>
<a name="gbab-1136"></a>      <span class="n">links</span><span class="o">=</span><span class="p">(</span><span class="n">OggOpusLink</span> <span class="o">*</span><span class="p">)</span><span class="n">_ogg_realloc</span><span class="p">(</span><span class="n">links</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">links</span><span class="p">)</span><span class="o">*</span><span class="n">clinks</span><span class="p">);</span>
<a name="gbab-1137"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">links</span><span class="o">==</span><span class="nb">NULL</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-1138"></a>      <span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="o">=</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-1139"></a>    <span class="p">}</span>
<a name="gbab-1140"></a>    <span class="cm">/*Invariants:</span>
<a name="gbab-1141"></a><span class="cm">      We have the headers and serial numbers for the link beginning at &#39;begin&#39;.</span>
<a name="gbab-1142"></a><span class="cm">      We have the offset and granule position of the last page in the file</span>
<a name="gbab-1143"></a><span class="cm">       (potentially not a page we care about).*/</span>
<a name="gbab-1144"></a>    <span class="cm">/*Scan the seek records we already have to save us some bisection.*/</span>
<a name="gbab-1145"></a>    <span class="k">for</span><span class="p">(</span><span class="n">sri</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">sri</span><span class="o">&lt;</span><span class="n">nsr</span><span class="p">;</span><span class="n">sri</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-1146"></a>      <span class="k">if</span><span class="p">(</span><span class="n">op_lookup_serialno</span><span class="p">(</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="p">].</span><span class="n">serialno</span><span class="p">,</span><span class="n">serialnos</span><span class="p">,</span><span class="n">nserialnos</span><span class="p">))</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-1147"></a>    <span class="p">}</span>
<a name="gbab-1148"></a>    <span class="cm">/*Is the last page in our current list of serial numbers?*/</span>
<a name="gbab-1149"></a>    <span class="k">if</span><span class="p">(</span><span class="n">sri</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-1150"></a>    <span class="cm">/*Last page wasn&#39;t found.</span>
<a name="gbab-1151"></a><span class="cm">      We have at least one more link.*/</span>
<a name="gbab-1152"></a>    <span class="n">last</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1153"></a>    <span class="n">end_searched</span><span class="o">=</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">search_start</span><span class="p">;</span>
<a name="gbab-1154"></a>    <span class="n">next</span><span class="o">=</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1155"></a>    <span class="n">end_gp</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1156"></a>    <span class="k">if</span><span class="p">(</span><span class="n">sri</span><span class="o">&lt;</span><span class="n">nsr</span><span class="p">){</span>
<a name="gbab-1157"></a>      <span class="n">_searched</span><span class="o">=</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="p">].</span><span class="n">offset</span><span class="o">+</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
<a name="gbab-1158"></a>      <span class="k">if</span><span class="p">(</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="p">].</span><span class="n">serialno</span><span class="o">==</span><span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">serialno</span><span class="p">){</span>
<a name="gbab-1159"></a>        <span class="n">end_gp</span><span class="o">=</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="p">].</span><span class="n">gp</span><span class="p">;</span>
<a name="gbab-1160"></a>        <span class="n">end_offset</span><span class="o">=</span><span class="n">_sr</span><span class="p">[</span><span class="n">sri</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1161"></a>      <span class="p">}</span>
<a name="gbab-1162"></a>    <span class="p">}</span>
<a name="gbab-1163"></a>    <span class="n">nsr</span><span class="o">=</span><span class="n">sri</span><span class="p">;</span>
<a name="gbab-1164"></a>    <span class="n">bisect</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1165"></a>    <span class="cm">/*If we&#39;ve already found the end of at least one link, try to pick the</span>
<a name="gbab-1166"></a><span class="cm">       first bisection point at twice the average link size.</span>
<a name="gbab-1167"></a><span class="cm">      This is a good choice for files with lots of links that are all about the</span>
<a name="gbab-1168"></a><span class="cm">       same size.*/</span>
<a name="gbab-1169"></a>    <span class="k">if</span><span class="p">(</span><span class="n">nlinks</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-1170"></a>      <span class="n">opus_int64</span> <span class="n">last_offset</span><span class="p">;</span>
<a name="gbab-1171"></a>      <span class="n">opus_int64</span> <span class="n">avg_link_size</span><span class="p">;</span>
<a name="gbab-1172"></a>      <span class="n">opus_int64</span> <span class="n">upper_limit</span><span class="p">;</span>
<a name="gbab-1173"></a>      <span class="n">last_offset</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1174"></a>      <span class="n">avg_link_size</span><span class="o">=</span><span class="n">last_offset</span><span class="o">/</span><span class="p">(</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-1175"></a>      <span class="n">upper_limit</span><span class="o">=</span><span class="n">end_searched</span><span class="o">-</span><span class="n">OP_CHUNK_SIZE</span><span class="o">-</span><span class="n">avg_link_size</span><span class="p">;</span>
<a name="gbab-1176"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">last_offset</span><span class="o">&gt;</span><span class="n">_searched</span><span class="o">-</span><span class="n">avg_link_size</span><span class="p">)</span>
<a name="gbab-1177"></a>       <span class="o">&amp;&amp;</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">last_offset</span><span class="o">&lt;</span><span class="n">upper_limit</span><span class="p">)){</span>
<a name="gbab-1178"></a>        <span class="n">bisect</span><span class="o">=</span><span class="n">last_offset</span><span class="o">+</span><span class="n">avg_link_size</span><span class="p">;</span>
<a name="gbab-1179"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">bisect</span><span class="o">&lt;</span><span class="n">upper_limit</span><span class="p">))</span><span class="n">bisect</span><span class="o">+=</span><span class="n">avg_link_size</span><span class="p">;</span>
<a name="gbab-1180"></a>      <span class="p">}</span>
<a name="gbab-1181"></a>    <span class="p">}</span>
<a name="gbab-1182"></a>    <span class="cm">/*We guard against garbage separating the last and first pages of two</span>
<a name="gbab-1183"></a><span class="cm">       links below.*/</span>
<a name="gbab-1184"></a>    <span class="k">while</span><span class="p">(</span><span class="n">_searched</span><span class="o">&lt;</span><span class="n">end_searched</span><span class="p">){</span>
<a name="gbab-1185"></a>      <span class="n">opus_int32</span> <span class="n">next_bias</span><span class="p">;</span>
<a name="gbab-1186"></a>      <span class="cm">/*If we don&#39;t have a better estimate, use simple bisection.*/</span>
<a name="gbab-1187"></a>      <span class="k">if</span><span class="p">(</span><span class="n">bisect</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span><span class="n">bisect</span><span class="o">=</span><span class="n">_searched</span><span class="o">+</span><span class="p">(</span><span class="n">end_searched</span><span class="o">-</span><span class="n">_searched</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-1188"></a>      <span class="cm">/*If we&#39;re within OP_CHUNK_SIZE of the start, scan forward.*/</span>
<a name="gbab-1189"></a>      <span class="k">if</span><span class="p">(</span><span class="n">bisect</span><span class="o">-</span><span class="n">_searched</span><span class="o">&lt;</span><span class="n">OP_CHUNK_SIZE</span><span class="p">)</span><span class="n">bisect</span><span class="o">=</span><span class="n">_searched</span><span class="p">;</span>
<a name="gbab-1190"></a>      <span class="cm">/*Otherwise we&#39;re skipping data.</span>
<a name="gbab-1191"></a><span class="cm">        Forget the end page, if we saw one, as we might miss a later one.*/</span>
<a name="gbab-1192"></a>      <span class="k">else</span> <span class="n">end_gp</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1193"></a>      <span class="n">ret</span><span class="o">=</span><span class="n">op_seek_helper</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">bisect</span><span class="p">);</span>
<a name="gbab-1194"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1195"></a>      <span class="n">last</span><span class="o">=</span><span class="n">op_get_next_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">,</span><span class="n">_sr</span><span class="p">[</span><span class="n">nsr</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
<a name="gbab-1196"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">last</span><span class="o">&lt;</span><span class="n">OP_FALSE</span><span class="p">))</span><span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">last</span><span class="p">;</span>
<a name="gbab-1197"></a>      <span class="n">next_bias</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1198"></a>      <span class="k">if</span><span class="p">(</span><span class="n">last</span><span class="o">==</span><span class="n">OP_FALSE</span><span class="p">)</span><span class="n">end_searched</span><span class="o">=</span><span class="n">bisect</span><span class="p">;</span>
<a name="gbab-1199"></a>      <span class="k">else</span><span class="p">{</span>
<a name="gbab-1200"></a>        <span class="n">ogg_uint32_t</span> <span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1201"></a>        <span class="n">ogg_int64_t</span>  <span class="n">gp</span><span class="p">;</span>
<a name="gbab-1202"></a>        <span class="n">serialno</span><span class="o">=</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-1203"></a>        <span class="n">gp</span><span class="o">=</span><span class="n">ogg_page_granulepos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-1204"></a>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">op_lookup_serialno</span><span class="p">(</span><span class="n">serialno</span><span class="p">,</span><span class="n">serialnos</span><span class="p">,</span><span class="n">nserialnos</span><span class="p">)){</span>
<a name="gbab-1205"></a>          <span class="n">end_searched</span><span class="o">=</span><span class="n">bisect</span><span class="p">;</span>
<a name="gbab-1206"></a>          <span class="n">next</span><span class="o">=</span><span class="n">last</span><span class="p">;</span>
<a name="gbab-1207"></a>          <span class="cm">/*In reality we should always have enough room, but be paranoid.*/</span>
<a name="gbab-1208"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">nsr</span><span class="o">&lt;</span><span class="n">_csr</span><span class="p">)){</span>
<a name="gbab-1209"></a>            <span class="n">_sr</span><span class="p">[</span><span class="n">nsr</span><span class="p">].</span><span class="n">search_start</span><span class="o">=</span><span class="n">bisect</span><span class="p">;</span>
<a name="gbab-1210"></a>            <span class="n">_sr</span><span class="p">[</span><span class="n">nsr</span><span class="p">].</span><span class="n">offset</span><span class="o">=</span><span class="n">last</span><span class="p">;</span>
<a name="gbab-1211"></a>            <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">-</span><span class="n">last</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-1212"></a>            <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">-</span><span class="n">last</span><span class="o">&lt;=</span><span class="n">OP_PAGE_SIZE_MAX</span><span class="p">);</span>
<a name="gbab-1213"></a>            <span class="n">_sr</span><span class="p">[</span><span class="n">nsr</span><span class="p">].</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">opus_int32</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">-</span><span class="n">last</span><span class="p">);</span>
<a name="gbab-1214"></a>            <span class="n">_sr</span><span class="p">[</span><span class="n">nsr</span><span class="p">].</span><span class="n">serialno</span><span class="o">=</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1215"></a>            <span class="n">_sr</span><span class="p">[</span><span class="n">nsr</span><span class="p">].</span><span class="n">gp</span><span class="o">=</span><span class="n">gp</span><span class="p">;</span>
<a name="gbab-1216"></a>            <span class="n">nsr</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-1217"></a>          <span class="p">}</span>
<a name="gbab-1218"></a>        <span class="p">}</span>
<a name="gbab-1219"></a>        <span class="k">else</span><span class="p">{</span>
<a name="gbab-1220"></a>          <span class="n">_searched</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1221"></a>          <span class="n">next_bias</span><span class="o">=</span><span class="n">OP_CHUNK_SIZE</span><span class="p">;</span>
<a name="gbab-1222"></a>          <span class="k">if</span><span class="p">(</span><span class="n">serialno</span><span class="o">==</span><span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">serialno</span><span class="p">){</span>
<a name="gbab-1223"></a>            <span class="cm">/*This page was from the stream we want, remember it.</span>
<a name="gbab-1224"></a><span class="cm">              If it&#39;s the last such page in the link, we won&#39;t have to go back</span>
<a name="gbab-1225"></a><span class="cm">               looking for it later.*/</span>
<a name="gbab-1226"></a>            <span class="n">end_gp</span><span class="o">=</span><span class="n">gp</span><span class="p">;</span>
<a name="gbab-1227"></a>            <span class="n">end_offset</span><span class="o">=</span><span class="n">last</span><span class="p">;</span>
<a name="gbab-1228"></a>          <span class="p">}</span>
<a name="gbab-1229"></a>        <span class="p">}</span>
<a name="gbab-1230"></a>      <span class="p">}</span>
<a name="gbab-1231"></a>      <span class="n">bisect</span><span class="o">=</span><span class="n">op_predict_link_start</span><span class="p">(</span><span class="n">_sr</span><span class="p">,</span><span class="n">nsr</span><span class="p">,</span><span class="n">_searched</span><span class="p">,</span><span class="n">end_searched</span><span class="p">,</span><span class="n">next_bias</span><span class="p">);</span>
<a name="gbab-1232"></a>    <span class="p">}</span>
<a name="gbab-1233"></a>    <span class="cm">/*Bisection point found.</span>
<a name="gbab-1234"></a><span class="cm">      Get the final granule position of the previous link, assuming</span>
<a name="gbab-1235"></a><span class="cm">       op_find_initial_pcm_offset() didn&#39;t already determine the link was</span>
<a name="gbab-1236"></a><span class="cm">       empty.*/</span>
<a name="gbab-1237"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">pcm_end</span><span class="o">==-</span><span class="mi">1</span><span class="p">)){</span>
<a name="gbab-1238"></a>      <span class="k">if</span><span class="p">(</span><span class="n">end_gp</span><span class="o">==-</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-1239"></a>        <span class="cm">/*If we don&#39;t know where the end page is, we&#39;ll have to seek back and</span>
<a name="gbab-1240"></a><span class="cm">           look for it, starting from the end of the link.*/</span>
<a name="gbab-1241"></a>        <span class="n">end_offset</span><span class="o">=</span><span class="n">next</span><span class="p">;</span>
<a name="gbab-1242"></a>        <span class="cm">/*Also forget the last page we read.</span>
<a name="gbab-1243"></a><span class="cm">          It won&#39;t be available after the seek.*/</span>
<a name="gbab-1244"></a>        <span class="n">last</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1245"></a>      <span class="p">}</span>
<a name="gbab-1246"></a>      <span class="n">ret</span><span class="o">=</span><span class="n">op_find_final_pcm_offset</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">serialnos</span><span class="p">,</span><span class="n">nserialnos</span><span class="p">,</span>
<a name="gbab-1247"></a>       <span class="n">links</span><span class="o">+</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">end_offset</span><span class="p">,</span><span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">serialno</span><span class="p">,</span><span class="n">end_gp</span><span class="p">,</span>
<a name="gbab-1248"></a>       <span class="o">&amp;</span><span class="n">total_duration</span><span class="p">);</span>
<a name="gbab-1249"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1250"></a>    <span class="p">}</span>
<a name="gbab-1251"></a>    <span class="k">if</span><span class="p">(</span><span class="n">last</span><span class="o">!=</span><span class="n">next</span><span class="p">){</span>
<a name="gbab-1252"></a>      <span class="cm">/*The last page we read was not the first page the next link.</span>
<a name="gbab-1253"></a><span class="cm">        Move the cursor position to the offset of that first page.</span>
<a name="gbab-1254"></a><span class="cm">        This only performs an actual seek if the first page of the next link</span>
<a name="gbab-1255"></a><span class="cm">         does not start at the end of the last page from the current Opus</span>
<a name="gbab-1256"></a><span class="cm">         stream with a valid granule position.*/</span>
<a name="gbab-1257"></a>      <span class="n">ret</span><span class="o">=</span><span class="n">op_seek_helper</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">next</span><span class="p">);</span>
<a name="gbab-1258"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1259"></a>    <span class="p">}</span>
<a name="gbab-1260"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_fetch_headers</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="p">].</span><span class="n">head</span><span class="p">,</span><span class="o">&amp;</span><span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="p">].</span><span class="n">tags</span><span class="p">,</span>
<a name="gbab-1261"></a>     <span class="n">_serialnos</span><span class="p">,</span><span class="n">_nserialnos</span><span class="p">,</span><span class="n">_cserialnos</span><span class="p">,</span><span class="n">last</span><span class="o">!=</span><span class="n">next</span><span class="o">?</span><span class="nb">NULL</span><span class="o">:&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-1262"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1263"></a>    <span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="p">].</span><span class="n">offset</span><span class="o">=</span><span class="n">next</span><span class="p">;</span>
<a name="gbab-1264"></a>    <span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="p">].</span><span class="n">data_offset</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1265"></a>    <span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="p">].</span><span class="n">serialno</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1266"></a>    <span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="p">].</span><span class="n">pcm_end</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1267"></a>    <span class="cm">/*This might consume a page from the next link, however the next bisection</span>
<a name="gbab-1268"></a><span class="cm">       always starts with a seek.*/</span>
<a name="gbab-1269"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_find_initial_pcm_offset</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">links</span><span class="o">+</span><span class="n">nlinks</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<a name="gbab-1270"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1271"></a>    <span class="n">_searched</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1272"></a>    <span class="cm">/*Mark the current link count so it can be cleaned up on error.*/</span>
<a name="gbab-1273"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="o">=++</span><span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-1274"></a>  <span class="p">}</span>
<a name="gbab-1275"></a>  <span class="cm">/*Last page is in the starting serialno list, so we&#39;ve reached the last link.</span>
<a name="gbab-1276"></a><span class="cm">    Now find the last granule position for it (if we didn&#39;t the first time we</span>
<a name="gbab-1277"></a><span class="cm">     looked at the end of the stream, and if op_find_initial_pcm_offset()</span>
<a name="gbab-1278"></a><span class="cm">     didn&#39;t already determine the link was empty).*/</span>
<a name="gbab-1279"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">pcm_end</span><span class="o">==-</span><span class="mi">1</span><span class="p">)){</span>
<a name="gbab-1280"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_find_final_pcm_offset</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">serialnos</span><span class="p">,</span><span class="n">nserialnos</span><span class="p">,</span>
<a name="gbab-1281"></a>     <span class="n">links</span><span class="o">+</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">_sr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span><span class="n">_sr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">serialno</span><span class="p">,</span><span class="n">_sr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gp</span><span class="p">,</span><span class="o">&amp;</span><span class="n">total_duration</span><span class="p">);</span>
<a name="gbab-1282"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1283"></a>  <span class="p">}</span>
<a name="gbab-1284"></a>  <span class="cm">/*Trim back the links array if necessary.*/</span>
<a name="gbab-1285"></a>  <span class="n">links</span><span class="o">=</span><span class="p">(</span><span class="n">OggOpusLink</span> <span class="o">*</span><span class="p">)</span><span class="n">_ogg_realloc</span><span class="p">(</span><span class="n">links</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">links</span><span class="p">)</span><span class="o">*</span><span class="n">nlinks</span><span class="p">);</span>
<a name="gbab-1286"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">links</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">))</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="o">=</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-1287"></a>  <span class="cm">/*We also don&#39;t need these anymore.*/</span>
<a name="gbab-1288"></a>  <span class="n">_ogg_free</span><span class="p">(</span><span class="o">*</span><span class="n">_serialnos</span><span class="p">);</span>
<a name="gbab-1289"></a>  <span class="o">*</span><span class="n">_serialnos</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-1290"></a>  <span class="o">*</span><span class="n">_cserialnos</span><span class="o">=*</span><span class="n">_nserialnos</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1291"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-1292"></a><span class="p">}</span>
<a name="gbab-1293"></a>
<a name="gbab-1294"></a><span class="k">static</span> <span class="kt">void</span> <span class="nf">op_update_gain</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1295"></a>  <span class="n">OpusHead</span>   <span class="o">*</span><span class="n">head</span><span class="p">;</span>
<a name="gbab-1296"></a>  <span class="n">opus_int32</span>  <span class="n">gain_q8</span><span class="p">;</span>
<a name="gbab-1297"></a>  <span class="kt">int</span>         <span class="n">li</span><span class="p">;</span>
<a name="gbab-1298"></a>  <span class="cm">/*If decode isn&#39;t ready, then we&#39;ll apply the gain when we initialize the</span>
<a name="gbab-1299"></a><span class="cm">     decoder.*/</span>
<a name="gbab-1300"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_INITSET</span><span class="p">)</span><span class="k">return</span><span class="p">;</span>
<a name="gbab-1301"></a>  <span class="n">gain_q8</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">gain_offset_q8</span><span class="p">;</span>
<a name="gbab-1302"></a>  <span class="n">li</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="o">?</span><span class="n">_of</span><span class="o">-&gt;</span><span class="nl">cur_link</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1303"></a>  <span class="n">head</span><span class="o">=&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">head</span><span class="p">;</span>
<a name="gbab-1304"></a>  <span class="cm">/*We don&#39;t have to worry about overflow here because the header gain and</span>
<a name="gbab-1305"></a><span class="cm">     track gain must lie in the range [-32768,32767], and the user-supplied</span>
<a name="gbab-1306"></a><span class="cm">     offset has been pre-clamped to [-98302,98303].*/</span>
<a name="gbab-1307"></a>  <span class="k">switch</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">gain_type</span><span class="p">){</span>
<a name="gbab-1308"></a>    <span class="k">case</span> <span class="nl">OP_ALBUM_GAIN</span><span class="p">:{</span>
<a name="gbab-1309"></a>      <span class="kt">int</span> <span class="n">album_gain_q8</span><span class="p">;</span>
<a name="gbab-1310"></a>      <span class="n">album_gain_q8</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1311"></a>      <span class="n">opus_tags_get_album_gain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">tags</span><span class="p">,</span><span class="o">&amp;</span><span class="n">album_gain_q8</span><span class="p">);</span>
<a name="gbab-1312"></a>      <span class="n">gain_q8</span><span class="o">+=</span><span class="n">album_gain_q8</span><span class="p">;</span>
<a name="gbab-1313"></a>      <span class="n">gain_q8</span><span class="o">+=</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">output_gain</span><span class="p">;</span>
<a name="gbab-1314"></a>    <span class="p">}</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-1315"></a>    <span class="k">case</span> <span class="nl">OP_TRACK_GAIN</span><span class="p">:{</span>
<a name="gbab-1316"></a>      <span class="kt">int</span> <span class="n">track_gain_q8</span><span class="p">;</span>
<a name="gbab-1317"></a>      <span class="n">track_gain_q8</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1318"></a>      <span class="n">opus_tags_get_track_gain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">tags</span><span class="p">,</span><span class="o">&amp;</span><span class="n">track_gain_q8</span><span class="p">);</span>
<a name="gbab-1319"></a>      <span class="n">gain_q8</span><span class="o">+=</span><span class="n">track_gain_q8</span><span class="p">;</span>
<a name="gbab-1320"></a>      <span class="n">gain_q8</span><span class="o">+=</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">output_gain</span><span class="p">;</span>
<a name="gbab-1321"></a>    <span class="p">}</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-1322"></a>    <span class="k">case</span> <span class="nl">OP_HEADER_GAIN</span><span class="p">:</span><span class="n">gain_q8</span><span class="o">+=</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">output_gain</span><span class="p">;</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-1323"></a>    <span class="k">case</span> <span class="nl">OP_ABSOLUTE_GAIN</span><span class="p">:</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-1324"></a>    <span class="k">default</span><span class="o">:</span><span class="n">OP_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-1325"></a>  <span class="p">}</span>
<a name="gbab-1326"></a>  <span class="n">gain_q8</span><span class="o">=</span><span class="n">OP_CLAMP</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="n">gain_q8</span><span class="p">,</span><span class="mi">32767</span><span class="p">);</span>
<a name="gbab-1327"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">);</span>
<a name="gbab-1328"></a><span class="cp">#if defined(OPUS_SET_GAIN)</span>
<a name="gbab-1329"></a>  <span class="n">opus_multistream_decoder_ctl</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">,</span><span class="n">OPUS_SET_GAIN</span><span class="p">(</span><span class="n">gain_q8</span><span class="p">));</span>
<a name="gbab-1330"></a><span class="cp">#else</span>
<a name="gbab-1331"></a><span class="cm">/*A fallback that works with both float and fixed-point is a bunch of work,</span>
<a name="gbab-1332"></a><span class="cm">   so just force people to use a sufficiently new version.</span>
<a name="gbab-1333"></a><span class="cm">  This is deployed well enough at this point that this shouldn&#39;t be a burden.*/</span>
<a name="gbab-1334"></a><span class="cp"># error &quot;libopus 1.0.1 or later required&quot;</span>
<a name="gbab-1335"></a><span class="cp">#endif</span>
<a name="gbab-1336"></a><span class="p">}</span>
<a name="gbab-1337"></a>
<a name="gbab-1338"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_make_decode_ready</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1339"></a>  <span class="k">const</span> <span class="n">OpusHead</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
<a name="gbab-1340"></a>  <span class="kt">int</span>             <span class="n">li</span><span class="p">;</span>
<a name="gbab-1341"></a>  <span class="kt">int</span>             <span class="n">stream_count</span><span class="p">;</span>
<a name="gbab-1342"></a>  <span class="kt">int</span>             <span class="n">coupled_count</span><span class="p">;</span>
<a name="gbab-1343"></a>  <span class="kt">int</span>             <span class="n">channel_count</span><span class="p">;</span>
<a name="gbab-1344"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;</span><span class="n">OP_STREAMSET</span><span class="p">)</span><span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-1345"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_STREAMSET</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-1346"></a>  <span class="n">li</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="o">?</span><span class="n">_of</span><span class="o">-&gt;</span><span class="nl">cur_link</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1347"></a>  <span class="n">head</span><span class="o">=&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">head</span><span class="p">;</span>
<a name="gbab-1348"></a>  <span class="n">stream_count</span><span class="o">=</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">stream_count</span><span class="p">;</span>
<a name="gbab-1349"></a>  <span class="n">coupled_count</span><span class="o">=</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">coupled_count</span><span class="p">;</span>
<a name="gbab-1350"></a>  <span class="n">channel_count</span><span class="o">=</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">channel_count</span><span class="p">;</span>
<a name="gbab-1351"></a>  <span class="cm">/*Check to see if the current decoder is compatible with the current link.*/</span>
<a name="gbab-1352"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="o">!=</span><span class="nb">NULL</span><span class="o">&amp;&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_stream_count</span><span class="o">==</span><span class="n">stream_count</span>
<a name="gbab-1353"></a>   <span class="o">&amp;&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_coupled_count</span><span class="o">==</span><span class="n">coupled_count</span><span class="o">&amp;&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_channel_count</span><span class="o">==</span><span class="n">channel_count</span>
<a name="gbab-1354"></a>   <span class="o">&amp;&amp;</span><span class="n">memcmp</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_mapping</span><span class="p">,</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span>
<a name="gbab-1355"></a>   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">)</span><span class="o">*</span><span class="n">channel_count</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-1356"></a>    <span class="n">opus_multistream_decoder_ctl</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">,</span><span class="n">OPUS_RESET_STATE</span><span class="p">);</span>
<a name="gbab-1357"></a>  <span class="p">}</span>
<a name="gbab-1358"></a>  <span class="k">else</span><span class="p">{</span>
<a name="gbab-1359"></a>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<a name="gbab-1360"></a>    <span class="n">opus_multistream_decoder_destroy</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">);</span>
<a name="gbab-1361"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="o">=</span><span class="n">opus_multistream_decoder_create</span><span class="p">(</span><span class="mi">48000</span><span class="p">,</span><span class="n">channel_count</span><span class="p">,</span>
<a name="gbab-1362"></a>     <span class="n">stream_count</span><span class="p">,</span><span class="n">coupled_count</span><span class="p">,</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<a name="gbab-1363"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-1364"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_stream_count</span><span class="o">=</span><span class="n">stream_count</span><span class="p">;</span>
<a name="gbab-1365"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_coupled_count</span><span class="o">=</span><span class="n">coupled_count</span><span class="p">;</span>
<a name="gbab-1366"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_channel_count</span><span class="o">=</span><span class="n">channel_count</span><span class="p">;</span>
<a name="gbab-1367"></a>    <span class="n">memcpy</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_mapping</span><span class="p">,</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">)</span><span class="o">*</span><span class="n">channel_count</span><span class="p">);</span>
<a name="gbab-1368"></a>  <span class="p">}</span>
<a name="gbab-1369"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_INITSET</span><span class="p">;</span>
<a name="gbab-1370"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">bytes_tracked</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1371"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">samples_tracked</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1372"></a><span class="cp">#if !defined(OP_FIXED_POINT)</span>
<a name="gbab-1373"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">state_channel_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1374"></a>  <span class="cm">/*Use the serial number for the PRNG seed to get repeatable output for</span>
<a name="gbab-1375"></a><span class="cm">     straight play-throughs.*/</span>
<a name="gbab-1376"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_seed</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1377"></a><span class="cp">#endif</span>
<a name="gbab-1378"></a>  <span class="n">op_update_gain</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1379"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-1380"></a><span class="p">}</span>
<a name="gbab-1381"></a>
<a name="gbab-1382"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_open_seekable2_impl</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1383"></a>  <span class="cm">/*64 seek records should be enough for anybody.</span>
<a name="gbab-1384"></a><span class="cm">    Actually, with a bisection search in a 63-bit range down to OP_CHUNK_SIZE</span>
<a name="gbab-1385"></a><span class="cm">     granularity, much more than enough.*/</span>
<a name="gbab-1386"></a>  <span class="n">OpusSeekRecord</span> <span class="n">sr</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<a name="gbab-1387"></a>  <span class="n">opus_int64</span>     <span class="n">data_offset</span><span class="p">;</span>
<a name="gbab-1388"></a>  <span class="kt">int</span>            <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1389"></a>  <span class="cm">/*We can seek, so set out learning all about this file.*/</span>
<a name="gbab-1390"></a>  <span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">seek</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SEEK_END</span><span class="p">);</span>
<a name="gbab-1391"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">tell</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>
<a name="gbab-1392"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EREAD</span><span class="p">;</span>
<a name="gbab-1393"></a>  <span class="n">data_offset</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data_offset</span><span class="p">;</span>
<a name="gbab-1394"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">&lt;</span><span class="n">data_offset</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-1395"></a>  <span class="cm">/*Get the offset of the last page of the physical bitstream, or, if we&#39;re</span>
<a name="gbab-1396"></a><span class="cm">     lucky, the last Opus page of the first link, as most Ogg Opus files will</span>
<a name="gbab-1397"></a><span class="cm">     contain a single logical bitstream.*/</span>
<a name="gbab-1398"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">op_get_prev_page_serial</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
<a name="gbab-1399"></a>   <span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">serialno</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">serialnos</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nserialnos</span><span class="p">);</span>
<a name="gbab-1400"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1401"></a>  <span class="cm">/*If there&#39;s any trailing junk, forget about it.*/</span>
<a name="gbab-1402"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">=</span><span class="n">sr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span><span class="o">+</span><span class="n">sr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
<a name="gbab-1403"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">&lt;</span><span class="n">data_offset</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-1404"></a>  <span class="cm">/*Now enumerate the bitstream structure.*/</span>
<a name="gbab-1405"></a>  <span class="k">return</span> <span class="n">op_bisect_forward_serialno</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">data_offset</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sr</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sr</span><span class="p">),</span>
<a name="gbab-1406"></a>   <span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">serialnos</span><span class="p">,</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nserialnos</span><span class="p">,</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cserialnos</span><span class="p">);</span>
<a name="gbab-1407"></a><span class="p">}</span>
<a name="gbab-1408"></a>
<a name="gbab-1409"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_open_seekable2</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1410"></a>  <span class="n">ogg_sync_state</span>    <span class="n">oy_start</span><span class="p">;</span>
<a name="gbab-1411"></a>  <span class="n">ogg_stream_state</span>  <span class="n">os_start</span><span class="p">;</span>
<a name="gbab-1412"></a>  <span class="n">ogg_packet</span>       <span class="o">*</span><span class="n">op_start</span><span class="p">;</span>
<a name="gbab-1413"></a>  <span class="n">opus_int64</span>        <span class="n">prev_page_offset</span><span class="p">;</span>
<a name="gbab-1414"></a>  <span class="n">opus_int64</span>        <span class="n">start_offset</span><span class="p">;</span>
<a name="gbab-1415"></a>  <span class="kt">int</span>               <span class="n">start_op_count</span><span class="p">;</span>
<a name="gbab-1416"></a>  <span class="kt">int</span>               <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1417"></a>  <span class="cm">/*We&#39;re partially open and have a first link header state in storage in _of.</span>
<a name="gbab-1418"></a><span class="cm">    Save off that stream state so we can come back to it.</span>
<a name="gbab-1419"></a><span class="cm">    It would be simpler to just dump all this state and seek back to</span>
<a name="gbab-1420"></a><span class="cm">     links[0].data_offset when we&#39;re done.</span>
<a name="gbab-1421"></a><span class="cm">    But we do the extra work to allow us to seek back to _exactly_ the same</span>
<a name="gbab-1422"></a><span class="cm">     stream position we&#39;re at now.</span>
<a name="gbab-1423"></a><span class="cm">    This allows, e.g., the HTTP backend to continue reading from the original</span>
<a name="gbab-1424"></a><span class="cm">     connection (if it&#39;s still available), instead of opening a new one.</span>
<a name="gbab-1425"></a><span class="cm">    This means we can open and start playing a normal Opus file with a single</span>
<a name="gbab-1426"></a><span class="cm">     link and reasonable packet sizes using only two HTTP requests.*/</span>
<a name="gbab-1427"></a>  <span class="n">start_op_count</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
<a name="gbab-1428"></a>  <span class="cm">/*This is a bit too large to put on the stack unconditionally.*/</span>
<a name="gbab-1429"></a>  <span class="n">op_start</span><span class="o">=</span><span class="p">(</span><span class="n">ogg_packet</span> <span class="o">*</span><span class="p">)</span><span class="n">_ogg_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">op_start</span><span class="p">)</span><span class="o">*</span><span class="n">start_op_count</span><span class="p">);</span>
<a name="gbab-1430"></a>  <span class="k">if</span><span class="p">(</span><span class="n">op_start</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-1431"></a>  <span class="o">*&amp;</span><span class="n">oy_start</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">;</span>
<a name="gbab-1432"></a>  <span class="o">*&amp;</span><span class="n">os_start</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">;</span>
<a name="gbab-1433"></a>  <span class="n">prev_page_offset</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_page_offset</span><span class="p">;</span>
<a name="gbab-1434"></a>  <span class="n">start_offset</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1435"></a>  <span class="n">memcpy</span><span class="p">(</span><span class="n">op_start</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">op_start</span><span class="p">)</span><span class="o">*</span><span class="n">start_op_count</span><span class="p">);</span>
<a name="gbab-1436"></a>  <span class="n">OP_ASSERT</span><span class="p">((</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">tell</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">)</span><span class="o">==</span><span class="n">op_position</span><span class="p">(</span><span class="n">_of</span><span class="p">));</span>
<a name="gbab-1437"></a>  <span class="n">ogg_sync_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">);</span>
<a name="gbab-1438"></a>  <span class="n">ogg_stream_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-1439"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">op_open_seekable2_impl</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1440"></a>  <span class="cm">/*Restore the old stream state.*/</span>
<a name="gbab-1441"></a>  <span class="n">ogg_stream_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">);</span>
<a name="gbab-1442"></a>  <span class="n">ogg_sync_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">);</span>
<a name="gbab-1443"></a>  <span class="o">*&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="o">=*&amp;</span><span class="n">oy_start</span><span class="p">;</span>
<a name="gbab-1444"></a>  <span class="o">*&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="o">=*&amp;</span><span class="n">os_start</span><span class="p">;</span>
<a name="gbab-1445"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">=</span><span class="n">start_offset</span><span class="p">;</span>
<a name="gbab-1446"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="o">=</span><span class="n">start_op_count</span><span class="p">;</span>
<a name="gbab-1447"></a>  <span class="n">memcpy</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span><span class="n">op_start</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span><span class="o">*</span><span class="n">start_op_count</span><span class="p">);</span>
<a name="gbab-1448"></a>  <span class="n">_ogg_free</span><span class="p">(</span><span class="n">op_start</span><span class="p">);</span>
<a name="gbab-1449"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-1450"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_page_offset</span><span class="o">=</span><span class="n">prev_page_offset</span><span class="p">;</span>
<a name="gbab-1451"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-1452"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1453"></a>  <span class="cm">/*And restore the position indicator.*/</span>
<a name="gbab-1454"></a>  <span class="n">ret</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">seek</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span><span class="n">op_position</span><span class="p">(</span><span class="n">_of</span><span class="p">),</span><span class="n">SEEK_SET</span><span class="p">);</span>
<a name="gbab-1455"></a>  <span class="k">return</span> <span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="nl">OP_EREAD</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1456"></a><span class="p">}</span>
<a name="gbab-1457"></a>
<a name="gbab-1458"></a><span class="cm">/*Clear out the current logical bitstream decoder.*/</span>
<a name="gbab-1459"></a><span class="k">static</span> <span class="kt">void</span> <span class="nf">op_decode_clear</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1460"></a>  <span class="cm">/*We don&#39;t actually free the decoder.</span>
<a name="gbab-1461"></a><span class="cm">    We might be able to re-use it for the next link.*/</span>
<a name="gbab-1462"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1463"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_size</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1464"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1465"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_page_offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1466"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">){</span>
<a name="gbab-1467"></a>    <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;=</span><span class="n">OP_INITSET</span><span class="p">);</span>
<a name="gbab-1468"></a>    <span class="n">opus_tags_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tags</span><span class="p">);</span>
<a name="gbab-1469"></a>  <span class="p">}</span>
<a name="gbab-1470"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_OPENED</span><span class="p">;</span>
<a name="gbab-1471"></a><span class="p">}</span>
<a name="gbab-1472"></a>
<a name="gbab-1473"></a><span class="k">static</span> <span class="kt">void</span> <span class="nf">op_clear</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1474"></a>  <span class="n">OggOpusLink</span> <span class="o">*</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-1475"></a>  <span class="n">_ogg_free</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer</span><span class="p">);</span>
<a name="gbab-1476"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span><span class="n">opus_multistream_decoder_destroy</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">);</span>
<a name="gbab-1477"></a>  <span class="n">links</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-1478"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">){</span>
<a name="gbab-1479"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;</span><span class="n">OP_OPENED</span><span class="o">||</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">==</span><span class="n">OP_PARTOPEN</span><span class="p">){</span>
<a name="gbab-1480"></a>      <span class="n">opus_tags_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tags</span><span class="p">);</span>
<a name="gbab-1481"></a>    <span class="p">}</span>
<a name="gbab-1482"></a>  <span class="p">}</span>
<a name="gbab-1483"></a>  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">links</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)){</span>
<a name="gbab-1484"></a>    <span class="kt">int</span> <span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-1485"></a>    <span class="kt">int</span> <span class="n">link</span><span class="p">;</span>
<a name="gbab-1486"></a>    <span class="n">nlinks</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-1487"></a>    <span class="k">for</span><span class="p">(</span><span class="n">link</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">link</span><span class="o">&lt;</span><span class="n">nlinks</span><span class="p">;</span><span class="n">link</span><span class="o">++</span><span class="p">)</span><span class="n">opus_tags_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">links</span><span class="p">[</span><span class="n">link</span><span class="p">].</span><span class="n">tags</span><span class="p">);</span>
<a name="gbab-1488"></a>  <span class="p">}</span>
<a name="gbab-1489"></a>  <span class="n">_ogg_free</span><span class="p">(</span><span class="n">links</span><span class="p">);</span>
<a name="gbab-1490"></a>  <span class="n">_ogg_free</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">serialnos</span><span class="p">);</span>
<a name="gbab-1491"></a>  <span class="n">ogg_stream_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">);</span>
<a name="gbab-1492"></a>  <span class="n">ogg_sync_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">);</span>
<a name="gbab-1493"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">close</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">close</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>
<a name="gbab-1494"></a><span class="p">}</span>
<a name="gbab-1495"></a>
<a name="gbab-1496"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_open1</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-1497"></a> <span class="kt">void</span> <span class="o">*</span><span class="n">_source</span><span class="p">,</span><span class="k">const</span> <span class="n">OpusFileCallbacks</span> <span class="o">*</span><span class="n">_cb</span><span class="p">,</span>
<a name="gbab-1498"></a> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_initial_data</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_initial_bytes</span><span class="p">){</span>
<a name="gbab-1499"></a>  <span class="n">ogg_page</span>  <span class="n">og</span><span class="p">;</span>
<a name="gbab-1500"></a>  <span class="n">ogg_page</span> <span class="o">*</span><span class="n">pog</span><span class="p">;</span>
<a name="gbab-1501"></a>  <span class="kt">int</span>       <span class="n">seekable</span><span class="p">;</span>
<a name="gbab-1502"></a>  <span class="kt">int</span>       <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1503"></a>  <span class="n">memset</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="p">));</span>
<a name="gbab-1504"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1505"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">=</span><span class="n">_source</span><span class="p">;</span>
<a name="gbab-1506"></a>  <span class="o">*&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="o">=*</span><span class="n">_cb</span><span class="p">;</span>
<a name="gbab-1507"></a>  <span class="cm">/*At a minimum, we need to be able to read data.*/</span>
<a name="gbab-1508"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">read</span><span class="o">==</span><span class="nb">NULL</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EREAD</span><span class="p">;</span>
<a name="gbab-1509"></a>  <span class="cm">/*Initialize the framing state.*/</span>
<a name="gbab-1510"></a>  <span class="n">ogg_sync_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">);</span>
<a name="gbab-1511"></a>  <span class="cm">/*Perhaps some data was previously read into a buffer for testing against</span>
<a name="gbab-1512"></a><span class="cm">     other stream types.</span>
<a name="gbab-1513"></a><span class="cm">    Allow initialization from this previously read data (especially as we may</span>
<a name="gbab-1514"></a><span class="cm">     be reading from a non-seekable stream).</span>
<a name="gbab-1515"></a><span class="cm">    This requires copying it into a buffer allocated by ogg_sync_buffer() and</span>
<a name="gbab-1516"></a><span class="cm">     doesn&#39;t support seeking, so this is not a good mechanism to use for</span>
<a name="gbab-1517"></a><span class="cm">     decoding entire files from RAM.*/</span>
<a name="gbab-1518"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_initial_bytes</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-1519"></a>    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
<a name="gbab-1520"></a>    <span class="n">buffer</span><span class="o">=</span><span class="n">ogg_sync_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">,</span><span class="n">_initial_bytes</span><span class="p">);</span>
<a name="gbab-1521"></a>    <span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">_initial_data</span><span class="p">,</span><span class="n">_initial_bytes</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">));</span>
<a name="gbab-1522"></a>    <span class="n">ogg_sync_wrote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">oy</span><span class="p">,</span><span class="n">_initial_bytes</span><span class="p">);</span>
<a name="gbab-1523"></a>  <span class="p">}</span>
<a name="gbab-1524"></a>  <span class="cm">/*Can we seek?</span>
<a name="gbab-1525"></a><span class="cm">    Stevens suggests the seek test is portable.*/</span>
<a name="gbab-1526"></a>  <span class="n">seekable</span><span class="o">=</span><span class="n">_cb</span><span class="o">-&gt;</span><span class="n">seek</span><span class="o">!=</span><span class="nb">NULL</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">_cb</span><span class="o">-&gt;</span><span class="n">seek</span><span class="p">)(</span><span class="n">_source</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SEEK_CUR</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1527"></a>  <span class="cm">/*If seek is implemented, tell must also be implemented.*/</span>
<a name="gbab-1528"></a>  <span class="k">if</span><span class="p">(</span><span class="n">seekable</span><span class="p">){</span>
<a name="gbab-1529"></a>    <span class="n">opus_int64</span> <span class="n">pos</span><span class="p">;</span>
<a name="gbab-1530"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">tell</span><span class="o">==</span><span class="nb">NULL</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-1531"></a>    <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">tell</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">);</span>
<a name="gbab-1532"></a>    <span class="cm">/*If the current position is not equal to the initial bytes consumed,</span>
<a name="gbab-1533"></a><span class="cm">       absolute seeking will not work.*/</span>
<a name="gbab-1534"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">pos</span><span class="o">!=</span><span class="p">(</span><span class="n">opus_int64</span><span class="p">)</span><span class="n">_initial_bytes</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-1535"></a>  <span class="p">}</span>
<a name="gbab-1536"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="o">=</span><span class="n">seekable</span><span class="p">;</span>
<a name="gbab-1537"></a>  <span class="cm">/*Don&#39;t seek yet.</span>
<a name="gbab-1538"></a><span class="cm">    Set up a &#39;single&#39; (current) logical bitstream entry for partial open.*/</span>
<a name="gbab-1539"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="o">=</span><span class="p">(</span><span class="n">OggOpusLink</span> <span class="o">*</span><span class="p">)</span><span class="n">_ogg_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">));</span>
<a name="gbab-1540"></a>  <span class="cm">/*The serialno gets filled in later by op_fetch_headers().*/</span>
<a name="gbab-1541"></a>  <span class="n">ogg_stream_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-1542"></a>  <span class="n">pog</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-1543"></a>  <span class="k">for</span><span class="p">(;;){</span>
<a name="gbab-1544"></a>    <span class="cm">/*Fetch all BOS pages, store the Opus header and all seen serial numbers,</span>
<a name="gbab-1545"></a><span class="cm">      and load subsequent Opus setup headers.*/</span>
<a name="gbab-1546"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_fetch_headers</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">head</span><span class="p">,</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tags</span><span class="p">,</span>
<a name="gbab-1547"></a>     <span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">serialnos</span><span class="p">,</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nserialnos</span><span class="p">,</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cserialnos</span><span class="p">,</span><span class="n">pog</span><span class="p">);</span>
<a name="gbab-1548"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-1549"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1550"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1551"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data_offset</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1552"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pcm_end</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1553"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">serialno</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1554"></a>    <span class="cm">/*Fetch the initial PCM offset.*/</span>
<a name="gbab-1555"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_find_initial_pcm_offset</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-1556"></a>    <span class="k">if</span><span class="p">(</span><span class="n">seekable</span><span class="o">||</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">))</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-1557"></a>    <span class="cm">/*This link was empty, but we already have the BOS page for the next one in</span>
<a name="gbab-1558"></a><span class="cm">       og.</span>
<a name="gbab-1559"></a><span class="cm">      We can&#39;t seek, so start processing the next link right now.*/</span>
<a name="gbab-1560"></a>    <span class="n">opus_tags_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tags</span><span class="p">);</span>
<a name="gbab-1561"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1562"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">seekable</span><span class="p">)</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-1563"></a>    <span class="n">pog</span><span class="o">=&amp;</span><span class="n">og</span><span class="p">;</span>
<a name="gbab-1564"></a>  <span class="p">}</span>
<a name="gbab-1565"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">))</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_PARTOPEN</span><span class="p">;</span>
<a name="gbab-1566"></a>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1567"></a><span class="p">}</span>
<a name="gbab-1568"></a>
<a name="gbab-1569"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_open2</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1570"></a>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1571"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">==</span><span class="n">OP_PARTOPEN</span><span class="p">);</span>
<a name="gbab-1572"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">){</span>
<a name="gbab-1573"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_OPENED</span><span class="p">;</span>
<a name="gbab-1574"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_open_seekable2</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1575"></a>  <span class="p">}</span>
<a name="gbab-1576"></a>  <span class="k">else</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1577"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-1578"></a>    <span class="cm">/*We have buffered packets from op_find_initial_pcm_offset().</span>
<a name="gbab-1579"></a><span class="cm">      Move to OP_INITSET so we can use them.*/</span>
<a name="gbab-1580"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_STREAMSET</span><span class="p">;</span>
<a name="gbab-1581"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_make_decode_ready</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1582"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-1583"></a>  <span class="p">}</span>
<a name="gbab-1584"></a>  <span class="cm">/*Don&#39;t auto-close the stream on failure.*/</span>
<a name="gbab-1585"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">close</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-1586"></a>  <span class="n">op_clear</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1587"></a>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1588"></a><span class="p">}</span>
<a name="gbab-1589"></a>
<a name="gbab-1590"></a><span class="n">OggOpusFile</span> <span class="o">*</span><span class="nf">op_test_callbacks</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_source</span><span class="p">,</span><span class="k">const</span> <span class="n">OpusFileCallbacks</span> <span class="o">*</span><span class="n">_cb</span><span class="p">,</span>
<a name="gbab-1591"></a> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_initial_data</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_initial_bytes</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_error</span><span class="p">){</span>
<a name="gbab-1592"></a>  <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">of</span><span class="p">;</span>
<a name="gbab-1593"></a>  <span class="kt">int</span>          <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1594"></a>  <span class="n">of</span><span class="o">=</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="p">)</span><span class="n">_ogg_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">of</span><span class="p">));</span>
<a name="gbab-1595"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-1596"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">of</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)){</span>
<a name="gbab-1597"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_open1</span><span class="p">(</span><span class="n">of</span><span class="p">,</span><span class="n">_source</span><span class="p">,</span><span class="n">_cb</span><span class="p">,</span><span class="n">_initial_data</span><span class="p">,</span><span class="n">_initial_bytes</span><span class="p">);</span>
<a name="gbab-1598"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-1599"></a>      <span class="k">if</span><span class="p">(</span><span class="n">_error</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span><span class="o">*</span><span class="n">_error</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1600"></a>      <span class="k">return</span> <span class="n">of</span><span class="p">;</span>
<a name="gbab-1601"></a>    <span class="p">}</span>
<a name="gbab-1602"></a>    <span class="cm">/*Don&#39;t auto-close the stream on failure.*/</span>
<a name="gbab-1603"></a>    <span class="n">of</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">close</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-1604"></a>    <span class="n">op_clear</span><span class="p">(</span><span class="n">of</span><span class="p">);</span>
<a name="gbab-1605"></a>    <span class="n">_ogg_free</span><span class="p">(</span><span class="n">of</span><span class="p">);</span>
<a name="gbab-1606"></a>  <span class="p">}</span>
<a name="gbab-1607"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_error</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span><span class="o">*</span><span class="n">_error</span><span class="o">=</span><span class="n">ret</span><span class="p">;</span>
<a name="gbab-1608"></a>  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-1609"></a><span class="p">}</span>
<a name="gbab-1610"></a>
<a name="gbab-1611"></a><span class="n">OggOpusFile</span> <span class="o">*</span><span class="nf">op_open_callbacks</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_source</span><span class="p">,</span><span class="k">const</span> <span class="n">OpusFileCallbacks</span> <span class="o">*</span><span class="n">_cb</span><span class="p">,</span>
<a name="gbab-1612"></a> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_initial_data</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_initial_bytes</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_error</span><span class="p">){</span>
<a name="gbab-1613"></a>  <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">of</span><span class="p">;</span>
<a name="gbab-1614"></a>  <span class="n">of</span><span class="o">=</span><span class="n">op_test_callbacks</span><span class="p">(</span><span class="n">_source</span><span class="p">,</span><span class="n">_cb</span><span class="p">,</span><span class="n">_initial_data</span><span class="p">,</span><span class="n">_initial_bytes</span><span class="p">,</span><span class="n">_error</span><span class="p">);</span>
<a name="gbab-1615"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">of</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)){</span>
<a name="gbab-1616"></a>    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1617"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_open2</span><span class="p">(</span><span class="n">of</span><span class="p">);</span>
<a name="gbab-1618"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">of</span><span class="p">;</span>
<a name="gbab-1619"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_error</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span><span class="o">*</span><span class="n">_error</span><span class="o">=</span><span class="n">ret</span><span class="p">;</span>
<a name="gbab-1620"></a>    <span class="n">_ogg_free</span><span class="p">(</span><span class="n">of</span><span class="p">);</span>
<a name="gbab-1621"></a>  <span class="p">}</span>
<a name="gbab-1622"></a>  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-1623"></a><span class="p">}</span>
<a name="gbab-1624"></a>
<a name="gbab-1625"></a><span class="cm">/*Convenience routine to clean up from failure for the open functions that</span>
<a name="gbab-1626"></a><span class="cm">   create their own streams.*/</span>
<a name="gbab-1627"></a><span class="k">static</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="nf">op_open_close_on_failure</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_source</span><span class="p">,</span>
<a name="gbab-1628"></a> <span class="k">const</span> <span class="n">OpusFileCallbacks</span> <span class="o">*</span><span class="n">_cb</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_error</span><span class="p">){</span>
<a name="gbab-1629"></a>  <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">of</span><span class="p">;</span>
<a name="gbab-1630"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_source</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)){</span>
<a name="gbab-1631"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_error</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span><span class="o">*</span><span class="n">_error</span><span class="o">=</span><span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-1632"></a>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-1633"></a>  <span class="p">}</span>
<a name="gbab-1634"></a>  <span class="n">of</span><span class="o">=</span><span class="n">op_open_callbacks</span><span class="p">(</span><span class="n">_source</span><span class="p">,</span><span class="n">_cb</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">_error</span><span class="p">);</span>
<a name="gbab-1635"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">of</span><span class="o">==</span><span class="nb">NULL</span><span class="p">))(</span><span class="o">*</span><span class="n">_cb</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">)(</span><span class="n">_source</span><span class="p">);</span>
<a name="gbab-1636"></a>  <span class="k">return</span> <span class="n">of</span><span class="p">;</span>
<a name="gbab-1637"></a><span class="p">}</span>
<a name="gbab-1638"></a>
<a name="gbab-1639"></a><span class="n">OggOpusFile</span> <span class="o">*</span><span class="nf">op_open_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_path</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_error</span><span class="p">){</span>
<a name="gbab-1640"></a>  <span class="n">OpusFileCallbacks</span> <span class="n">cb</span><span class="p">;</span>
<a name="gbab-1641"></a>  <span class="k">return</span> <span class="n">op_open_close_on_failure</span><span class="p">(</span><span class="n">op_fopen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span><span class="n">_path</span><span class="p">,</span><span class="s">&quot;rb&quot;</span><span class="p">),</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span><span class="n">_error</span><span class="p">);</span>
<a name="gbab-1642"></a><span class="p">}</span>
<a name="gbab-1643"></a>
<a name="gbab-1644"></a><span class="n">OggOpusFile</span> <span class="o">*</span><span class="nf">op_open_memory</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_data</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_size</span><span class="p">,</span>
<a name="gbab-1645"></a> <span class="kt">int</span> <span class="o">*</span><span class="n">_error</span><span class="p">){</span>
<a name="gbab-1646"></a>  <span class="n">OpusFileCallbacks</span> <span class="n">cb</span><span class="p">;</span>
<a name="gbab-1647"></a>  <span class="k">return</span> <span class="n">op_open_close_on_failure</span><span class="p">(</span><span class="n">op_mem_stream_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span><span class="n">_data</span><span class="p">,</span><span class="n">_size</span><span class="p">),</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span>
<a name="gbab-1648"></a>   <span class="n">_error</span><span class="p">);</span>
<a name="gbab-1649"></a><span class="p">}</span>
<a name="gbab-1650"></a>
<a name="gbab-1651"></a><span class="cm">/*Convenience routine to clean up from failure for the open functions that</span>
<a name="gbab-1652"></a><span class="cm">   create their own streams.*/</span>
<a name="gbab-1653"></a><span class="k">static</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="nf">op_test_close_on_failure</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_source</span><span class="p">,</span>
<a name="gbab-1654"></a> <span class="k">const</span> <span class="n">OpusFileCallbacks</span> <span class="o">*</span><span class="n">_cb</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_error</span><span class="p">){</span>
<a name="gbab-1655"></a>  <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">of</span><span class="p">;</span>
<a name="gbab-1656"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_source</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)){</span>
<a name="gbab-1657"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_error</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span><span class="o">*</span><span class="n">_error</span><span class="o">=</span><span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-1658"></a>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-1659"></a>  <span class="p">}</span>
<a name="gbab-1660"></a>  <span class="n">of</span><span class="o">=</span><span class="n">op_test_callbacks</span><span class="p">(</span><span class="n">_source</span><span class="p">,</span><span class="n">_cb</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">_error</span><span class="p">);</span>
<a name="gbab-1661"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">of</span><span class="o">==</span><span class="nb">NULL</span><span class="p">))(</span><span class="o">*</span><span class="n">_cb</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">)(</span><span class="n">_source</span><span class="p">);</span>
<a name="gbab-1662"></a>  <span class="k">return</span> <span class="n">of</span><span class="p">;</span>
<a name="gbab-1663"></a><span class="p">}</span>
<a name="gbab-1664"></a>
<a name="gbab-1665"></a><span class="n">OggOpusFile</span> <span class="o">*</span><span class="nf">op_test_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_path</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_error</span><span class="p">){</span>
<a name="gbab-1666"></a>  <span class="n">OpusFileCallbacks</span> <span class="n">cb</span><span class="p">;</span>
<a name="gbab-1667"></a>  <span class="k">return</span> <span class="n">op_test_close_on_failure</span><span class="p">(</span><span class="n">op_fopen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span><span class="n">_path</span><span class="p">,</span><span class="s">&quot;rb&quot;</span><span class="p">),</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span><span class="n">_error</span><span class="p">);</span>
<a name="gbab-1668"></a><span class="p">}</span>
<a name="gbab-1669"></a>
<a name="gbab-1670"></a><span class="n">OggOpusFile</span> <span class="o">*</span><span class="nf">op_test_memory</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_data</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">_size</span><span class="p">,</span>
<a name="gbab-1671"></a> <span class="kt">int</span> <span class="o">*</span><span class="n">_error</span><span class="p">){</span>
<a name="gbab-1672"></a>  <span class="n">OpusFileCallbacks</span> <span class="n">cb</span><span class="p">;</span>
<a name="gbab-1673"></a>  <span class="k">return</span> <span class="n">op_test_close_on_failure</span><span class="p">(</span><span class="n">op_mem_stream_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span><span class="n">_data</span><span class="p">,</span><span class="n">_size</span><span class="p">),</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span>
<a name="gbab-1674"></a>   <span class="n">_error</span><span class="p">);</span>
<a name="gbab-1675"></a><span class="p">}</span>
<a name="gbab-1676"></a>
<a name="gbab-1677"></a><span class="kt">int</span> <span class="nf">op_test_open</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1678"></a>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1679"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">!=</span><span class="n">OP_PARTOPEN</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-1680"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">op_open2</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1681"></a>  <span class="cm">/*op_open2() will clear this structure on failure.</span>
<a name="gbab-1682"></a><span class="cm">    Reset its contents to prevent double-frees in op_free().*/</span>
<a name="gbab-1683"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="n">memset</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="p">));</span>
<a name="gbab-1684"></a>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1685"></a><span class="p">}</span>
<a name="gbab-1686"></a>
<a name="gbab-1687"></a><span class="kt">void</span> <span class="nf">op_free</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1688"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)){</span>
<a name="gbab-1689"></a>    <span class="n">op_clear</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1690"></a>    <span class="n">_ogg_free</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1691"></a>  <span class="p">}</span>
<a name="gbab-1692"></a><span class="p">}</span>
<a name="gbab-1693"></a>
<a name="gbab-1694"></a><span class="kt">int</span> <span class="nf">op_seekable</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1695"></a>  <span class="k">return</span> <span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">;</span>
<a name="gbab-1696"></a><span class="p">}</span>
<a name="gbab-1697"></a>
<a name="gbab-1698"></a><span class="kt">int</span> <span class="nf">op_link_count</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1699"></a>  <span class="k">return</span> <span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-1700"></a><span class="p">}</span>
<a name="gbab-1701"></a>
<a name="gbab-1702"></a><span class="n">ogg_uint32_t</span> <span class="nf">op_serialno</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">int</span> <span class="n">_li</span><span class="p">){</span>
<a name="gbab-1703"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_li</span><span class="o">&gt;=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">))</span><span class="n">_li</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1704"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">)</span><span class="n">_li</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1705"></a>  <span class="k">return</span> <span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">?</span><span class="n">_of</span><span class="o">-&gt;</span><span class="nl">cur_link</span><span class="p">:</span><span class="n">_li</span><span class="p">].</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1706"></a><span class="p">}</span>
<a name="gbab-1707"></a>
<a name="gbab-1708"></a><span class="kt">int</span> <span class="nf">op_channel_count</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">int</span> <span class="n">_li</span><span class="p">){</span>
<a name="gbab-1709"></a>  <span class="k">return</span> <span class="n">op_head</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_li</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_count</span><span class="p">;</span>
<a name="gbab-1710"></a><span class="p">}</span>
<a name="gbab-1711"></a>
<a name="gbab-1712"></a><span class="n">opus_int64</span> <span class="nf">op_raw_total</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">int</span> <span class="n">_li</span><span class="p">){</span>
<a name="gbab-1713"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_OPENED</span><span class="p">)</span>
<a name="gbab-1714"></a>   <span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">)</span>
<a name="gbab-1715"></a>   <span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_li</span><span class="o">&gt;=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">)){</span>
<a name="gbab-1716"></a>    <span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-1717"></a>  <span class="p">}</span>
<a name="gbab-1718"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_li</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="k">return</span> <span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">-</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1719"></a>  <span class="k">return</span> <span class="p">(</span><span class="n">_li</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="o">?</span><span class="n">_of</span><span class="o">-&gt;</span><span class="nl">end</span><span class="p">:</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">offset</span><span class="p">)</span>
<a name="gbab-1720"></a>   <span class="o">-</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-1721"></a><span class="p">}</span>
<a name="gbab-1722"></a>
<a name="gbab-1723"></a><span class="n">ogg_int64_t</span> <span class="nf">op_pcm_total</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">int</span> <span class="n">_li</span><span class="p">){</span>
<a name="gbab-1724"></a>  <span class="n">OggOpusLink</span> <span class="o">*</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-1725"></a>  <span class="n">ogg_int64_t</span>  <span class="n">diff</span><span class="p">;</span>
<a name="gbab-1726"></a>  <span class="kt">int</span>          <span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-1727"></a>  <span class="n">nlinks</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-1728"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_OPENED</span><span class="p">)</span>
<a name="gbab-1729"></a>   <span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">)</span>
<a name="gbab-1730"></a>   <span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_li</span><span class="o">&gt;=</span><span class="n">nlinks</span><span class="p">)){</span>
<a name="gbab-1731"></a>    <span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-1732"></a>  <span class="p">}</span>
<a name="gbab-1733"></a>  <span class="n">links</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-1734"></a>  <span class="cm">/*We verify that the granule position differences are larger than the</span>
<a name="gbab-1735"></a><span class="cm">     pre-skip and that the total duration does not overflow during link</span>
<a name="gbab-1736"></a><span class="cm">     enumeration, so we don&#39;t have to check here.*/</span>
<a name="gbab-1737"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_li</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-1738"></a>    <span class="n">ogg_int64_t</span> <span class="n">pcm_total</span><span class="p">;</span>
<a name="gbab-1739"></a>    <span class="kt">int</span>         <span class="n">li</span><span class="p">;</span>
<a name="gbab-1740"></a>    <span class="n">pcm_total</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1741"></a>    <span class="k">for</span><span class="p">(</span><span class="n">li</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">li</span><span class="o">&lt;</span><span class="n">nlinks</span><span class="p">;</span><span class="n">li</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-1742"></a>      <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span>
<a name="gbab-1743"></a>       <span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">pcm_end</span><span class="p">,</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">pcm_start</span><span class="p">));</span>
<a name="gbab-1744"></a>      <span class="n">pcm_total</span><span class="o">+=</span><span class="n">diff</span><span class="o">-</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-1745"></a>    <span class="p">}</span>
<a name="gbab-1746"></a>    <span class="k">return</span> <span class="n">pcm_total</span><span class="p">;</span>
<a name="gbab-1747"></a>  <span class="p">}</span>
<a name="gbab-1748"></a>  <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span>
<a name="gbab-1749"></a>   <span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">pcm_end</span><span class="p">,</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">pcm_start</span><span class="p">));</span>
<a name="gbab-1750"></a>  <span class="k">return</span> <span class="n">diff</span><span class="o">-</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-1751"></a><span class="p">}</span>
<a name="gbab-1752"></a>
<a name="gbab-1753"></a><span class="k">const</span> <span class="n">OpusHead</span> <span class="o">*</span><span class="nf">op_head</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">int</span> <span class="n">_li</span><span class="p">){</span>
<a name="gbab-1754"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_li</span><span class="o">&gt;=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">))</span><span class="n">_li</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1755"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">)</span><span class="n">_li</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1756"></a>  <span class="k">return</span> <span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">?</span><span class="n">_of</span><span class="o">-&gt;</span><span class="nl">cur_link</span><span class="p">:</span><span class="n">_li</span><span class="p">].</span><span class="n">head</span><span class="p">;</span>
<a name="gbab-1757"></a><span class="p">}</span>
<a name="gbab-1758"></a>
<a name="gbab-1759"></a><span class="k">const</span> <span class="n">OpusTags</span> <span class="o">*</span><span class="nf">op_tags</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">int</span> <span class="n">_li</span><span class="p">){</span>
<a name="gbab-1760"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_li</span><span class="o">&gt;=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">))</span><span class="n">_li</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1761"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">){</span>
<a name="gbab-1762"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_STREAMSET</span><span class="o">&amp;&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">!=</span><span class="n">OP_PARTOPEN</span><span class="p">){</span>
<a name="gbab-1763"></a>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-1764"></a>    <span class="p">}</span>
<a name="gbab-1765"></a>    <span class="n">_li</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1766"></a>  <span class="p">}</span>
<a name="gbab-1767"></a>  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">_li</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="n">_li</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;=</span><span class="n">OP_STREAMSET</span><span class="o">?</span><span class="n">_of</span><span class="o">-&gt;</span><span class="nl">cur_link</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1768"></a>  <span class="k">return</span> <span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">tags</span><span class="p">;</span>
<a name="gbab-1769"></a><span class="p">}</span>
<a name="gbab-1770"></a>
<a name="gbab-1771"></a><span class="kt">int</span> <span class="nf">op_current_link</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1772"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_OPENED</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-1773"></a>  <span class="k">return</span> <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="p">;</span>
<a name="gbab-1774"></a><span class="p">}</span>
<a name="gbab-1775"></a>
<a name="gbab-1776"></a><span class="cm">/*Compute an average bitrate given a byte and sample count.</span>
<a name="gbab-1777"></a><span class="cm">  Return: The bitrate in bits per second.*/</span>
<a name="gbab-1778"></a><span class="k">static</span> <span class="n">opus_int32</span> <span class="nf">op_calc_bitrate</span><span class="p">(</span><span class="n">opus_int64</span> <span class="n">_bytes</span><span class="p">,</span><span class="n">ogg_int64_t</span> <span class="n">_samples</span><span class="p">){</span>
<a name="gbab-1779"></a>  <span class="cm">/*These rates are absurd, but let&#39;s handle them anyway.*/</span>
<a name="gbab-1780"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_bytes</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OP_INT64_MAX</span><span class="o">-</span><span class="p">(</span><span class="n">_samples</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">48000</span><span class="o">*</span><span class="mi">8</span><span class="p">))){</span>
<a name="gbab-1781"></a>    <span class="n">ogg_int64_t</span> <span class="n">den</span><span class="p">;</span>
<a name="gbab-1782"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_bytes</span><span class="o">/</span><span class="p">(</span><span class="n">OP_INT32_MAX</span><span class="o">/</span><span class="p">(</span><span class="mi">48000</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span><span class="o">&gt;=</span><span class="n">_samples</span><span class="p">)){</span>
<a name="gbab-1783"></a>      <span class="k">return</span> <span class="n">OP_INT32_MAX</span><span class="p">;</span>
<a name="gbab-1784"></a>    <span class="p">}</span>
<a name="gbab-1785"></a>    <span class="n">den</span><span class="o">=</span><span class="n">_samples</span><span class="o">/</span><span class="p">(</span><span class="mi">48000</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
<a name="gbab-1786"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">opus_int32</span><span class="p">)((</span><span class="n">_bytes</span><span class="o">+</span><span class="p">(</span><span class="n">den</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">den</span><span class="p">);</span>
<a name="gbab-1787"></a>  <span class="p">}</span>
<a name="gbab-1788"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_samples</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_INT32_MAX</span><span class="p">;</span>
<a name="gbab-1789"></a>  <span class="cm">/*This can&#39;t actually overflow in normal operation: even with a pre-skip of</span>
<a name="gbab-1790"></a><span class="cm">     545 2.5 ms frames with 8 streams running at 1282*8+1 bytes per packet</span>
<a name="gbab-1791"></a><span class="cm">     (1275 byte frames + Opus framing overhead + Ogg lacing values), that all</span>
<a name="gbab-1792"></a><span class="cm">     produce a single sample of decoded output, we still don&#39;t top 45 Mbps.</span>
<a name="gbab-1793"></a><span class="cm">    The only way to get bitrates larger than that is with excessive Opus</span>
<a name="gbab-1794"></a><span class="cm">     padding, more encoded streams than output channels, or lots and lots of</span>
<a name="gbab-1795"></a><span class="cm">     Ogg pages with no packets on them.*/</span>
<a name="gbab-1796"></a>  <span class="k">return</span> <span class="p">(</span><span class="n">opus_int32</span><span class="p">)</span><span class="n">OP_MIN</span><span class="p">((</span><span class="n">_bytes</span><span class="o">*</span><span class="mi">48000</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="p">(</span><span class="n">_samples</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">_samples</span><span class="p">,</span>
<a name="gbab-1797"></a>   <span class="n">OP_INT32_MAX</span><span class="p">);</span>
<a name="gbab-1798"></a><span class="p">}</span>
<a name="gbab-1799"></a>
<a name="gbab-1800"></a><span class="n">opus_int32</span> <span class="nf">op_bitrate</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">int</span> <span class="n">_li</span><span class="p">){</span>
<a name="gbab-1801"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_OPENED</span><span class="p">)</span><span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">)</span>
<a name="gbab-1802"></a>   <span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_li</span><span class="o">&gt;=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">)){</span>
<a name="gbab-1803"></a>    <span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-1804"></a>  <span class="p">}</span>
<a name="gbab-1805"></a>  <span class="k">return</span> <span class="n">op_calc_bitrate</span><span class="p">(</span><span class="n">op_raw_total</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_li</span><span class="p">),</span><span class="n">op_pcm_total</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_li</span><span class="p">));</span>
<a name="gbab-1806"></a><span class="p">}</span>
<a name="gbab-1807"></a>
<a name="gbab-1808"></a><span class="n">opus_int32</span> <span class="nf">op_bitrate_instant</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-1809"></a>  <span class="n">ogg_int64_t</span> <span class="n">samples_tracked</span><span class="p">;</span>
<a name="gbab-1810"></a>  <span class="n">opus_int32</span>  <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1811"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_OPENED</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-1812"></a>  <span class="n">samples_tracked</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">samples_tracked</span><span class="p">;</span>
<a name="gbab-1813"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">samples_tracked</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_FALSE</span><span class="p">;</span>
<a name="gbab-1814"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">op_calc_bitrate</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">bytes_tracked</span><span class="p">,</span><span class="n">samples_tracked</span><span class="p">);</span>
<a name="gbab-1815"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">bytes_tracked</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1816"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">samples_tracked</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1817"></a>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1818"></a><span class="p">}</span>
<a name="gbab-1819"></a>
<a name="gbab-1820"></a><span class="cm">/*Fetch and process a page.</span>
<a name="gbab-1821"></a><span class="cm">  This handles the case where we&#39;re at a bitstream boundary and dumps the</span>
<a name="gbab-1822"></a><span class="cm">   decoding machine.</span>
<a name="gbab-1823"></a><span class="cm">  If the decoding machine is unloaded, it loads it.</span>
<a name="gbab-1824"></a><span class="cm">  It also keeps prev_packet_gp up to date (seek and read both use this; seek</span>
<a name="gbab-1825"></a><span class="cm">   uses a special hack with _readp).</span>
<a name="gbab-1826"></a><span class="cm">  Return: &lt;0) Error, OP_HOLE (lost packet), or OP_EOF.</span>
<a name="gbab-1827"></a><span class="cm">           0) Need more data (only if _readp==0).</span>
<a name="gbab-1828"></a><span class="cm">           1) Got at least one audio data packet.*/</span>
<a name="gbab-1829"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_fetch_and_process_page</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-1830"></a> <span class="n">ogg_page</span> <span class="o">*</span><span class="n">_og</span><span class="p">,</span><span class="n">opus_int64</span> <span class="n">_page_offset</span><span class="p">,</span>
<a name="gbab-1831"></a> <span class="kt">int</span> <span class="n">_readp</span><span class="p">,</span><span class="kt">int</span> <span class="n">_spanp</span><span class="p">,</span><span class="kt">int</span> <span class="n">_ignore_holes</span><span class="p">){</span>
<a name="gbab-1832"></a>  <span class="n">OggOpusLink</span>  <span class="o">*</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-1833"></a>  <span class="n">ogg_uint32_t</span>  <span class="n">cur_serialno</span><span class="p">;</span>
<a name="gbab-1834"></a>  <span class="kt">int</span>           <span class="n">seekable</span><span class="p">;</span>
<a name="gbab-1835"></a>  <span class="kt">int</span>           <span class="n">cur_link</span><span class="p">;</span>
<a name="gbab-1836"></a>  <span class="kt">int</span>           <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1837"></a>  <span class="cm">/*We shouldn&#39;t get here if we have unprocessed packets.*/</span>
<a name="gbab-1838"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_INITSET</span><span class="o">||</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_pos</span><span class="o">&gt;=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">);</span>
<a name="gbab-1839"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_readp</span><span class="p">)</span><span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-1840"></a>  <span class="n">seekable</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">;</span>
<a name="gbab-1841"></a>  <span class="n">links</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-1842"></a>  <span class="n">cur_link</span><span class="o">=</span><span class="n">seekable</span><span class="o">?</span><span class="n">_of</span><span class="o">-&gt;</span><span class="nl">cur_link</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1843"></a>  <span class="n">cur_serialno</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="n">cur_link</span><span class="p">].</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1844"></a>  <span class="cm">/*Handle one page.*/</span>
<a name="gbab-1845"></a>  <span class="k">for</span><span class="p">(;;){</span>
<a name="gbab-1846"></a>    <span class="n">ogg_page</span> <span class="n">og</span><span class="p">;</span>
<a name="gbab-1847"></a>    <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;=</span><span class="n">OP_OPENED</span><span class="p">);</span>
<a name="gbab-1848"></a>    <span class="cm">/*This loop is not strictly necessary, but there&#39;s no sense in doing the</span>
<a name="gbab-1849"></a><span class="cm">       extra checks of the larger loop for the common case in a multiplexed</span>
<a name="gbab-1850"></a><span class="cm">       bistream where the page is simply part of a different logical</span>
<a name="gbab-1851"></a><span class="cm">       bitstream.*/</span>
<a name="gbab-1852"></a>    <span class="k">do</span><span class="p">{</span>
<a name="gbab-1853"></a>      <span class="cm">/*If we were given a page to use, use it.*/</span>
<a name="gbab-1854"></a>      <span class="k">if</span><span class="p">(</span><span class="n">_og</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">){</span>
<a name="gbab-1855"></a>        <span class="o">*&amp;</span><span class="n">og</span><span class="o">=*</span><span class="n">_og</span><span class="p">;</span>
<a name="gbab-1856"></a>        <span class="n">_og</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<a name="gbab-1857"></a>      <span class="p">}</span>
<a name="gbab-1858"></a>      <span class="cm">/*Keep reading until we get a page with the correct serialno.*/</span>
<a name="gbab-1859"></a>      <span class="k">else</span> <span class="n">_page_offset</span><span class="o">=</span><span class="n">op_get_next_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
<a name="gbab-1860"></a>      <span class="cm">/*EOF: Leave uninitialized.*/</span>
<a name="gbab-1861"></a>      <span class="k">if</span><span class="p">(</span><span class="n">_page_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="k">return</span> <span class="n">_page_offset</span><span class="o">&lt;</span><span class="n">OP_FALSE</span><span class="o">?</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nl">_page_offset</span><span class="p">:</span><span class="n">OP_EOF</span><span class="p">;</span>
<a name="gbab-1862"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;=</span><span class="n">OP_STREAMSET</span><span class="p">)){</span>
<a name="gbab-1863"></a>        <span class="k">if</span><span class="p">(</span><span class="n">cur_serialno</span><span class="o">!=</span><span class="p">(</span><span class="n">ogg_uint32_t</span><span class="p">)</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">)){</span>
<a name="gbab-1864"></a>          <span class="cm">/*Two possibilities:</span>
<a name="gbab-1865"></a><span class="cm">             1) Another stream is multiplexed into this logical section, or*/</span>
<a name="gbab-1866"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">ogg_page_bos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">)))</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-1867"></a>          <span class="cm">/* 2) Our decoding just traversed a bitstream boundary.*/</span>
<a name="gbab-1868"></a>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_spanp</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_EOF</span><span class="p">;</span>
<a name="gbab-1869"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;=</span><span class="n">OP_INITSET</span><span class="p">))</span><span class="n">op_decode_clear</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1870"></a>          <span class="k">break</span><span class="p">;</span>
<a name="gbab-1871"></a>        <span class="p">}</span>
<a name="gbab-1872"></a>      <span class="p">}</span>
<a name="gbab-1873"></a>      <span class="cm">/*Bitrate tracking: add the header&#39;s bytes here.</span>
<a name="gbab-1874"></a><span class="cm">        The body bytes are counted when we consume the packets.*/</span>
<a name="gbab-1875"></a>      <span class="n">_of</span><span class="o">-&gt;</span><span class="n">bytes_tracked</span><span class="o">+=</span><span class="n">og</span><span class="p">.</span><span class="n">header_len</span><span class="p">;</span>
<a name="gbab-1876"></a>    <span class="p">}</span>
<a name="gbab-1877"></a>    <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-1878"></a>    <span class="cm">/*Do we need to load a new machine before submitting the page?</span>
<a name="gbab-1879"></a><span class="cm">      This is different in the seekable and non-seekable cases.</span>
<a name="gbab-1880"></a><span class="cm">      In the seekable case, we already have all the header information loaded</span>
<a name="gbab-1881"></a><span class="cm">       and cached.</span>
<a name="gbab-1882"></a><span class="cm">      We just initialize the machine with it and continue on our merry way.</span>
<a name="gbab-1883"></a><span class="cm">      In the non-seekable (streaming) case, we&#39;ll only be at a boundary if we</span>
<a name="gbab-1884"></a><span class="cm">       just left the previous logical bitstream, and we&#39;re now nominally at the</span>
<a name="gbab-1885"></a><span class="cm">       header of the next bitstream.*/</span>
<a name="gbab-1886"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_STREAMSET</span><span class="p">)){</span>
<a name="gbab-1887"></a>      <span class="k">if</span><span class="p">(</span><span class="n">seekable</span><span class="p">){</span>
<a name="gbab-1888"></a>        <span class="n">ogg_uint32_t</span> <span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1889"></a>        <span class="kt">int</span>          <span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-1890"></a>        <span class="kt">int</span>          <span class="n">li</span><span class="p">;</span>
<a name="gbab-1891"></a>        <span class="n">serialno</span><span class="o">=</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-1892"></a>        <span class="cm">/*Match the serialno to bitstream section.</span>
<a name="gbab-1893"></a><span class="cm">          We use this rather than offset positions to avoid problems near</span>
<a name="gbab-1894"></a><span class="cm">           logical bitstream boundaries.*/</span>
<a name="gbab-1895"></a>        <span class="n">nlinks</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-1896"></a>        <span class="k">for</span><span class="p">(</span><span class="n">li</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">li</span><span class="o">&lt;</span><span class="n">nlinks</span><span class="o">&amp;&amp;</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">serialno</span><span class="o">!=</span><span class="n">serialno</span><span class="p">;</span><span class="n">li</span><span class="o">++</span><span class="p">);</span>
<a name="gbab-1897"></a>        <span class="cm">/*Not a desired Opus bitstream section.</span>
<a name="gbab-1898"></a><span class="cm">          Keep trying.*/</span>
<a name="gbab-1899"></a>        <span class="k">if</span><span class="p">(</span><span class="n">li</span><span class="o">&gt;=</span><span class="n">nlinks</span><span class="p">)</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-1900"></a>        <span class="n">cur_serialno</span><span class="o">=</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1901"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="o">=</span><span class="n">cur_link</span><span class="o">=</span><span class="n">li</span><span class="p">;</span>
<a name="gbab-1902"></a>        <span class="n">ogg_stream_reset_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="n">serialno</span><span class="p">);</span>
<a name="gbab-1903"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_STREAMSET</span><span class="p">;</span>
<a name="gbab-1904"></a>        <span class="cm">/*If we&#39;re at the start of this link, initialize the granule position</span>
<a name="gbab-1905"></a><span class="cm">           and pre-skip tracking.*/</span>
<a name="gbab-1906"></a>        <span class="k">if</span><span class="p">(</span><span class="n">_page_offset</span><span class="o">&lt;=</span><span class="n">links</span><span class="p">[</span><span class="n">cur_link</span><span class="p">].</span><span class="n">data_offset</span><span class="p">){</span>
<a name="gbab-1907"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="n">cur_link</span><span class="p">].</span><span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-1908"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_page_offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1909"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="n">cur_link</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-1910"></a>          <span class="cm">/*Ignore a hole at the start of a new link (this is common for</span>
<a name="gbab-1911"></a><span class="cm">             streams joined in the middle) or after seeking.*/</span>
<a name="gbab-1912"></a>          <span class="n">_ignore_holes</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-1913"></a>        <span class="p">}</span>
<a name="gbab-1914"></a>      <span class="p">}</span>
<a name="gbab-1915"></a>      <span class="k">else</span><span class="p">{</span>
<a name="gbab-1916"></a>        <span class="k">do</span><span class="p">{</span>
<a name="gbab-1917"></a>          <span class="cm">/*We&#39;re streaming.</span>
<a name="gbab-1918"></a><span class="cm">            Fetch the two header packets, build the info struct.*/</span>
<a name="gbab-1919"></a>          <span class="n">ret</span><span class="o">=</span><span class="n">op_fetch_headers</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">head</span><span class="p">,</span><span class="o">&amp;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tags</span><span class="p">,</span>
<a name="gbab-1920"></a>           <span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-1921"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1922"></a>          <span class="cm">/*op_find_initial_pcm_offset() will suppress any initial hole for us,</span>
<a name="gbab-1923"></a><span class="cm">             so no need to set _ignore_holes.*/</span>
<a name="gbab-1924"></a>          <span class="n">ret</span><span class="o">=</span><span class="n">op_find_initial_pcm_offset</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">links</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-1925"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1926"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">serialno</span><span class="o">=</span><span class="n">cur_serialno</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-1927"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-1928"></a>        <span class="p">}</span>
<a name="gbab-1929"></a>        <span class="cm">/*If the link was empty, keep going, because we already have the</span>
<a name="gbab-1930"></a><span class="cm">           BOS page of the next one in og.*/</span>
<a name="gbab-1931"></a>        <span class="k">while</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">));</span>
<a name="gbab-1932"></a>        <span class="cm">/*If we didn&#39;t get any packets out of op_find_initial_pcm_offset(),</span>
<a name="gbab-1933"></a><span class="cm">           keep going (this is possible if end-trimming trimmed them all).*/</span>
<a name="gbab-1934"></a>        <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-1935"></a>        <span class="cm">/*Otherwise, we&#39;re done.*/</span>
<a name="gbab-1936"></a>        <span class="n">ret</span><span class="o">=</span><span class="n">op_make_decode_ready</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1937"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1938"></a>        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-1939"></a>      <span class="p">}</span>
<a name="gbab-1940"></a>    <span class="p">}</span>
<a name="gbab-1941"></a>    <span class="cm">/*The buffered page is the data we want, and we&#39;re ready for it.</span>
<a name="gbab-1942"></a><span class="cm">      Add it to the stream state.*/</span>
<a name="gbab-1943"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">==</span><span class="n">OP_STREAMSET</span><span class="p">)){</span>
<a name="gbab-1944"></a>      <span class="n">ret</span><span class="o">=</span><span class="n">op_make_decode_ready</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-1945"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-1946"></a>    <span class="p">}</span>
<a name="gbab-1947"></a>    <span class="cm">/*Extract all the packets from the current page.*/</span>
<a name="gbab-1948"></a>    <span class="n">ogg_stream_pagein</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-1949"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;=</span><span class="n">OP_INITSET</span><span class="p">)){</span>
<a name="gbab-1950"></a>      <span class="n">opus_int32</span> <span class="n">total_duration</span><span class="p">;</span>
<a name="gbab-1951"></a>      <span class="kt">int</span>        <span class="n">durations</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
<a name="gbab-1952"></a>      <span class="kt">int</span>        <span class="n">op_count</span><span class="p">;</span>
<a name="gbab-1953"></a>      <span class="n">total_duration</span><span class="o">=</span><span class="n">op_collect_audio_packets</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">durations</span><span class="p">);</span>
<a name="gbab-1954"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">total_duration</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-1955"></a>        <span class="cm">/*Drain the packets from the page anyway.*/</span>
<a name="gbab-1956"></a>        <span class="n">total_duration</span><span class="o">=</span><span class="n">op_collect_audio_packets</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">durations</span><span class="p">);</span>
<a name="gbab-1957"></a>        <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">total_duration</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-1958"></a>        <span class="cm">/*Report holes to the caller.*/</span>
<a name="gbab-1959"></a>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_ignore_holes</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_HOLE</span><span class="p">;</span>
<a name="gbab-1960"></a>      <span class="p">}</span>
<a name="gbab-1961"></a>      <span class="n">op_count</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
<a name="gbab-1962"></a>      <span class="cm">/*If we found at least one audio data packet, compute per-packet granule</span>
<a name="gbab-1963"></a><span class="cm">         positions for them.*/</span>
<a name="gbab-1964"></a>      <span class="k">if</span><span class="p">(</span><span class="n">op_count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-1965"></a>        <span class="n">ogg_int64_t</span> <span class="n">diff</span><span class="p">;</span>
<a name="gbab-1966"></a>        <span class="n">ogg_int64_t</span> <span class="n">prev_packet_gp</span><span class="p">;</span>
<a name="gbab-1967"></a>        <span class="n">ogg_int64_t</span> <span class="n">cur_packet_gp</span><span class="p">;</span>
<a name="gbab-1968"></a>        <span class="n">ogg_int64_t</span> <span class="n">cur_page_gp</span><span class="p">;</span>
<a name="gbab-1969"></a>        <span class="kt">int</span>         <span class="n">cur_page_eos</span><span class="p">;</span>
<a name="gbab-1970"></a>        <span class="kt">int</span>         <span class="n">pi</span><span class="p">;</span>
<a name="gbab-1971"></a>        <span class="n">cur_page_gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">granulepos</span><span class="p">;</span>
<a name="gbab-1972"></a>        <span class="n">cur_page_eos</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">e_o_s</span><span class="p">;</span>
<a name="gbab-1973"></a>        <span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="p">;</span>
<a name="gbab-1974"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">prev_packet_gp</span><span class="o">==-</span><span class="mi">1</span><span class="p">)){</span>
<a name="gbab-1975"></a>          <span class="n">opus_int32</span> <span class="n">cur_discard_count</span><span class="p">;</span>
<a name="gbab-1976"></a>          <span class="cm">/*This is the first call after a raw seek.</span>
<a name="gbab-1977"></a><span class="cm">            Try to reconstruct prev_packet_gp from scratch.*/</span>
<a name="gbab-1978"></a>          <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">seekable</span><span class="p">);</span>
<a name="gbab-1979"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">cur_page_eos</span><span class="p">)){</span>
<a name="gbab-1980"></a>            <span class="cm">/*If the first page we hit after our seek was the EOS page, and</span>
<a name="gbab-1981"></a><span class="cm">               we didn&#39;t start from data_offset or before, we don&#39;t have</span>
<a name="gbab-1982"></a><span class="cm">               enough information to do end-trimming.</span>
<a name="gbab-1983"></a><span class="cm">              Proceed to the next link, rather than risk playing back some</span>
<a name="gbab-1984"></a><span class="cm">               samples that shouldn&#39;t have been played.*/</span>
<a name="gbab-1985"></a>            <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-1986"></a>            <span class="k">continue</span><span class="p">;</span>
<a name="gbab-1987"></a>          <span class="p">}</span>
<a name="gbab-1988"></a>          <span class="cm">/*By default discard 80 ms of data after a seek, unless we seek</span>
<a name="gbab-1989"></a><span class="cm">             into the pre-skip region.*/</span>
<a name="gbab-1990"></a>          <span class="n">cur_discard_count</span><span class="o">=</span><span class="mi">80</span><span class="o">*</span><span class="mi">48</span><span class="p">;</span>
<a name="gbab-1991"></a>          <span class="n">cur_page_gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">granulepos</span><span class="p">;</span>
<a name="gbab-1992"></a>          <span class="cm">/*Try to initialize prev_packet_gp.</span>
<a name="gbab-1993"></a><span class="cm">            If the current page had packets but didn&#39;t have a granule</span>
<a name="gbab-1994"></a><span class="cm">             position, or the granule position it had was too small (both</span>
<a name="gbab-1995"></a><span class="cm">             illegal), just use the starting granule position for the link.*/</span>
<a name="gbab-1996"></a>          <span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="n">cur_link</span><span class="p">].</span><span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-1997"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">cur_page_gp</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)){</span>
<a name="gbab-1998"></a>            <span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev_packet_gp</span><span class="p">,</span><span class="n">cur_page_gp</span><span class="p">,</span><span class="o">-</span><span class="n">total_duration</span><span class="p">);</span>
<a name="gbab-1999"></a>          <span class="p">}</span>
<a name="gbab-2000"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span>
<a name="gbab-2001"></a>           <span class="n">prev_packet_gp</span><span class="p">,</span><span class="n">links</span><span class="p">[</span><span class="n">cur_link</span><span class="p">].</span><span class="n">pcm_start</span><span class="p">))){</span>
<a name="gbab-2002"></a>            <span class="n">opus_int32</span> <span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-2003"></a>            <span class="cm">/*If we start at the beginning of the pre-skip region, or we&#39;re</span>
<a name="gbab-2004"></a><span class="cm">               at least 80 ms from the end of the pre-skip region, we discard</span>
<a name="gbab-2005"></a><span class="cm">               to the end of the pre-skip region.</span>
<a name="gbab-2006"></a><span class="cm">              Otherwise, we still use the 80 ms default, which will discard</span>
<a name="gbab-2007"></a><span class="cm">               past the end of the pre-skip region.*/</span>
<a name="gbab-2008"></a>            <span class="n">pre_skip</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="n">cur_link</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-2009"></a>            <span class="k">if</span><span class="p">(</span><span class="n">diff</span><span class="o">&gt;=</span><span class="mi">0</span><span class="o">&amp;&amp;</span><span class="n">diff</span><span class="o">&lt;=</span><span class="n">OP_MAX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">pre_skip</span><span class="o">-</span><span class="mi">80</span><span class="o">*</span><span class="mi">48</span><span class="p">)){</span>
<a name="gbab-2010"></a>              <span class="n">cur_discard_count</span><span class="o">=</span><span class="n">pre_skip</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">diff</span><span class="p">;</span>
<a name="gbab-2011"></a>            <span class="p">}</span>
<a name="gbab-2012"></a>          <span class="p">}</span>
<a name="gbab-2013"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="o">=</span><span class="n">cur_discard_count</span><span class="p">;</span>
<a name="gbab-2014"></a>        <span class="p">}</span>
<a name="gbab-2015"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">cur_page_gp</span><span class="o">==-</span><span class="mi">1</span><span class="p">)){</span>
<a name="gbab-2016"></a>          <span class="cm">/*This page had completed packets but didn&#39;t have a valid granule</span>
<a name="gbab-2017"></a><span class="cm">             position.</span>
<a name="gbab-2018"></a><span class="cm">            This is illegal, but we&#39;ll try to handle it by continuing to count</span>
<a name="gbab-2019"></a><span class="cm">             forwards from the previous page.*/</span>
<a name="gbab-2020"></a>          <span class="k">if</span><span class="p">(</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur_page_gp</span><span class="p">,</span><span class="n">prev_packet_gp</span><span class="p">,</span><span class="n">total_duration</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-2021"></a>            <span class="cm">/*The timestamp for this page overflowed.*/</span>
<a name="gbab-2022"></a>            <span class="n">cur_page_gp</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="n">cur_link</span><span class="p">].</span><span class="n">pcm_end</span><span class="p">;</span>
<a name="gbab-2023"></a>          <span class="p">}</span>
<a name="gbab-2024"></a>        <span class="p">}</span>
<a name="gbab-2025"></a>        <span class="cm">/*If we hit the last page, handle end-trimming.*/</span>
<a name="gbab-2026"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">cur_page_eos</span><span class="p">)</span>
<a name="gbab-2027"></a>         <span class="o">&amp;&amp;</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span><span class="n">cur_page_gp</span><span class="p">,</span><span class="n">prev_packet_gp</span><span class="p">))</span>
<a name="gbab-2028"></a>         <span class="o">&amp;&amp;</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">diff</span><span class="o">&lt;</span><span class="n">total_duration</span><span class="p">)){</span>
<a name="gbab-2029"></a>          <span class="n">cur_packet_gp</span><span class="o">=</span><span class="n">prev_packet_gp</span><span class="p">;</span>
<a name="gbab-2030"></a>          <span class="k">for</span><span class="p">(</span><span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">pi</span><span class="o">&lt;</span><span class="n">op_count</span><span class="p">;</span><span class="n">pi</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-2031"></a>            <span class="n">diff</span><span class="o">=</span><span class="n">durations</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="o">-</span><span class="n">diff</span><span class="p">;</span>
<a name="gbab-2032"></a>            <span class="cm">/*If we have samples to trim...*/</span>
<a name="gbab-2033"></a>            <span class="k">if</span><span class="p">(</span><span class="n">diff</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-2034"></a>              <span class="cm">/*If we trimmed the entire packet, stop (the spec says encoders</span>
<a name="gbab-2035"></a><span class="cm">                 shouldn&#39;t do this, but we support it anyway).*/</span>
<a name="gbab-2036"></a>              <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">diff</span><span class="o">&gt;</span><span class="n">durations</span><span class="p">[</span><span class="n">pi</span><span class="p">]))</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-2037"></a>              <span class="n">cur_packet_gp</span><span class="o">=</span><span class="n">cur_page_gp</span><span class="p">;</span>
<a name="gbab-2038"></a>              <span class="cm">/*Move the EOS flag to this packet, if necessary, so we&#39;ll trim</span>
<a name="gbab-2039"></a><span class="cm">                 the samples during decode.*/</span>
<a name="gbab-2040"></a>              <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">pi</span><span class="p">].</span><span class="n">e_o_s</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2041"></a>            <span class="p">}</span>
<a name="gbab-2042"></a>            <span class="k">else</span><span class="p">{</span>
<a name="gbab-2043"></a>              <span class="cm">/*Update the granule position as normal.*/</span>
<a name="gbab-2044"></a>              <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur_packet_gp</span><span class="p">,</span>
<a name="gbab-2045"></a>               <span class="n">cur_packet_gp</span><span class="p">,</span><span class="n">durations</span><span class="p">[</span><span class="n">pi</span><span class="p">]));</span>
<a name="gbab-2046"></a>            <span class="p">}</span>
<a name="gbab-2047"></a>            <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">pi</span><span class="p">].</span><span class="n">granulepos</span><span class="o">=</span><span class="n">cur_packet_gp</span><span class="p">;</span>
<a name="gbab-2048"></a>            <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span><span class="n">cur_page_gp</span><span class="p">,</span><span class="n">cur_packet_gp</span><span class="p">));</span>
<a name="gbab-2049"></a>          <span class="p">}</span>
<a name="gbab-2050"></a>        <span class="p">}</span>
<a name="gbab-2051"></a>        <span class="k">else</span><span class="p">{</span>
<a name="gbab-2052"></a>          <span class="cm">/*Propagate timestamps to earlier packets.</span>
<a name="gbab-2053"></a><span class="cm">            op_granpos_add(&amp;prev_packet_gp,prev_packet_gp,total_duration)</span>
<a name="gbab-2054"></a><span class="cm">             should succeed and give prev_packet_gp==cur_page_gp.</span>
<a name="gbab-2055"></a><span class="cm">            But we don&#39;t bother to check that, as there isn&#39;t much we can do</span>
<a name="gbab-2056"></a><span class="cm">             if it&#39;s not true, and it actually will not be true on the first</span>
<a name="gbab-2057"></a><span class="cm">             page after a seek, if there was a continued packet.</span>
<a name="gbab-2058"></a><span class="cm">            The only thing we guarantee is that the start and end granule</span>
<a name="gbab-2059"></a><span class="cm">             positions of the packets are valid, and that they are monotonic</span>
<a name="gbab-2060"></a><span class="cm">             within a page.</span>
<a name="gbab-2061"></a><span class="cm">            They might be completely out of range for this link (we&#39;ll check</span>
<a name="gbab-2062"></a><span class="cm">             that elsewhere), or non-monotonic between pages.*/</span>
<a name="gbab-2063"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev_packet_gp</span><span class="p">,</span>
<a name="gbab-2064"></a>           <span class="n">cur_page_gp</span><span class="p">,</span><span class="o">-</span><span class="n">total_duration</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2065"></a>            <span class="cm">/*The starting timestamp for the first packet on this page</span>
<a name="gbab-2066"></a><span class="cm">               underflowed.</span>
<a name="gbab-2067"></a><span class="cm">              This is illegal, but we ignore it.*/</span>
<a name="gbab-2068"></a>            <span class="n">prev_packet_gp</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2069"></a>          <span class="p">}</span>
<a name="gbab-2070"></a>          <span class="k">for</span><span class="p">(</span><span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">pi</span><span class="o">&lt;</span><span class="n">op_count</span><span class="p">;</span><span class="n">pi</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-2071"></a>            <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur_packet_gp</span><span class="p">,</span>
<a name="gbab-2072"></a>             <span class="n">cur_page_gp</span><span class="p">,</span><span class="o">-</span><span class="n">total_duration</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2073"></a>              <span class="cm">/*The start timestamp for this packet underflowed.</span>
<a name="gbab-2074"></a><span class="cm">                This is illegal, but we ignore it.*/</span>
<a name="gbab-2075"></a>              <span class="n">cur_packet_gp</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2076"></a>            <span class="p">}</span>
<a name="gbab-2077"></a>            <span class="n">total_duration</span><span class="o">-=</span><span class="n">durations</span><span class="p">[</span><span class="n">pi</span><span class="p">];</span>
<a name="gbab-2078"></a>            <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">total_duration</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2079"></a>            <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur_packet_gp</span><span class="p">,</span>
<a name="gbab-2080"></a>             <span class="n">cur_packet_gp</span><span class="p">,</span><span class="n">durations</span><span class="p">[</span><span class="n">pi</span><span class="p">]));</span>
<a name="gbab-2081"></a>            <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">pi</span><span class="p">].</span><span class="n">granulepos</span><span class="o">=</span><span class="n">cur_packet_gp</span><span class="p">;</span>
<a name="gbab-2082"></a>          <span class="p">}</span>
<a name="gbab-2083"></a>          <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">total_duration</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2084"></a>        <span class="p">}</span>
<a name="gbab-2085"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">prev_packet_gp</span><span class="p">;</span>
<a name="gbab-2086"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_page_offset</span><span class="o">=</span><span class="n">_page_offset</span><span class="p">;</span>
<a name="gbab-2087"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="o">=</span><span class="n">pi</span><span class="p">;</span>
<a name="gbab-2088"></a>        <span class="cm">/*If end-trimming didn&#39;t trim all the packets, we&#39;re done.*/</span>
<a name="gbab-2089"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">pi</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-2090"></a>      <span class="p">}</span>
<a name="gbab-2091"></a>    <span class="p">}</span>
<a name="gbab-2092"></a>  <span class="p">}</span>
<a name="gbab-2093"></a><span class="p">}</span>
<a name="gbab-2094"></a>
<a name="gbab-2095"></a><span class="kt">int</span> <span class="nf">op_raw_seek</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">opus_int64</span> <span class="n">_pos</span><span class="p">){</span>
<a name="gbab-2096"></a>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2097"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_OPENED</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-2098"></a>  <span class="cm">/*Don&#39;t dump the decoder state if we can&#39;t seek.*/</span>
<a name="gbab-2099"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_ENOSEEK</span><span class="p">;</span>
<a name="gbab-2100"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_pos</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_pos</span><span class="o">&gt;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-2101"></a>  <span class="cm">/*Clear out any buffered, decoded data.*/</span>
<a name="gbab-2102"></a>  <span class="n">op_decode_clear</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-2103"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">bytes_tracked</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2104"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">samples_tracked</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2105"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">op_seek_helper</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pos</span><span class="p">);</span>
<a name="gbab-2106"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EREAD</span><span class="p">;</span>
<a name="gbab-2107"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">op_fetch_and_process_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-2108"></a>  <span class="cm">/*If we hit EOF, op_fetch_and_process_page() leaves us uninitialized.</span>
<a name="gbab-2109"></a><span class="cm">    Instead, jump to the end.*/</span>
<a name="gbab-2110"></a>  <span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="o">==</span><span class="n">OP_EOF</span><span class="p">){</span>
<a name="gbab-2111"></a>    <span class="kt">int</span> <span class="n">cur_link</span><span class="p">;</span>
<a name="gbab-2112"></a>    <span class="n">op_decode_clear</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-2113"></a>    <span class="n">cur_link</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2114"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="o">=</span><span class="n">cur_link</span><span class="p">;</span>
<a name="gbab-2115"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">cur_link</span><span class="p">].</span><span class="n">pcm_end</span><span class="p">;</span>
<a name="gbab-2116"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2117"></a>    <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2118"></a>  <span class="p">}</span>
<a name="gbab-2119"></a>  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2120"></a>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2121"></a><span class="p">}</span>
<a name="gbab-2122"></a>
<a name="gbab-2123"></a><span class="cm">/*Convert a PCM offset relative to the start of the whole stream to a granule</span>
<a name="gbab-2124"></a><span class="cm">   position in an individual link.*/</span>
<a name="gbab-2125"></a><span class="k">static</span> <span class="n">ogg_int64_t</span> <span class="nf">op_get_granulepos</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-2126"></a> <span class="n">ogg_int64_t</span> <span class="n">_pcm_offset</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_li</span><span class="p">){</span>
<a name="gbab-2127"></a>  <span class="k">const</span> <span class="n">OggOpusLink</span> <span class="o">*</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-2128"></a>  <span class="n">ogg_int64_t</span>        <span class="n">duration</span><span class="p">;</span>
<a name="gbab-2129"></a>  <span class="kt">int</span>                <span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-2130"></a>  <span class="kt">int</span>                <span class="n">li</span><span class="p">;</span>
<a name="gbab-2131"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_pcm_offset</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2132"></a>  <span class="n">nlinks</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-2133"></a>  <span class="n">links</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-2134"></a>  <span class="k">for</span><span class="p">(</span><span class="n">li</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">li</span><span class="o">&lt;</span><span class="n">nlinks</span><span class="p">);</span><span class="n">li</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-2135"></a>    <span class="n">ogg_int64_t</span> <span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-2136"></a>    <span class="n">opus_int32</span>  <span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-2137"></a>    <span class="n">pcm_start</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-2138"></a>    <span class="n">pre_skip</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-2139"></a>    <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">duration</span><span class="p">,</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">pcm_end</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">));</span>
<a name="gbab-2140"></a>    <span class="n">duration</span><span class="o">-=</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-2141"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_pcm_offset</span><span class="o">&lt;</span><span class="n">duration</span><span class="p">){</span>
<a name="gbab-2142"></a>      <span class="n">_pcm_offset</span><span class="o">+=</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-2143"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">pcm_start</span><span class="o">&gt;</span><span class="n">OP_INT64_MAX</span><span class="o">-</span><span class="n">_pcm_offset</span><span class="p">)){</span>
<a name="gbab-2144"></a>        <span class="cm">/*Adding this amount to the granule position would overflow the positive</span>
<a name="gbab-2145"></a><span class="cm">           half of its 64-bit range.</span>
<a name="gbab-2146"></a><span class="cm">          Since signed overflow is undefined in C, do it in a way the compiler</span>
<a name="gbab-2147"></a><span class="cm">           isn&#39;t allowed to screw up.*/</span>
<a name="gbab-2148"></a>        <span class="n">_pcm_offset</span><span class="o">-=</span><span class="n">OP_INT64_MAX</span><span class="o">-</span><span class="n">pcm_start</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2149"></a>        <span class="n">pcm_start</span><span class="o">=</span><span class="n">OP_INT64_MIN</span><span class="p">;</span>
<a name="gbab-2150"></a>      <span class="p">}</span>
<a name="gbab-2151"></a>      <span class="n">pcm_start</span><span class="o">+=</span><span class="n">_pcm_offset</span><span class="p">;</span>
<a name="gbab-2152"></a>      <span class="o">*</span><span class="n">_li</span><span class="o">=</span><span class="n">li</span><span class="p">;</span>
<a name="gbab-2153"></a>      <span class="k">return</span> <span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-2154"></a>    <span class="p">}</span>
<a name="gbab-2155"></a>    <span class="n">_pcm_offset</span><span class="o">-=</span><span class="n">duration</span><span class="p">;</span>
<a name="gbab-2156"></a>  <span class="p">}</span>
<a name="gbab-2157"></a>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2158"></a><span class="p">}</span>
<a name="gbab-2159"></a>
<a name="gbab-2160"></a><span class="cm">/*A small helper to determine if an Ogg page contains data that continues onto</span>
<a name="gbab-2161"></a><span class="cm">   a subsequent page.*/</span>
<a name="gbab-2162"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_page_continues</span><span class="p">(</span><span class="k">const</span> <span class="n">ogg_page</span> <span class="o">*</span><span class="n">_og</span><span class="p">){</span>
<a name="gbab-2163"></a>  <span class="kt">int</span> <span class="n">nlacing</span><span class="p">;</span>
<a name="gbab-2164"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_og</span><span class="o">-&gt;</span><span class="n">header_len</span><span class="o">&gt;=</span><span class="mi">27</span><span class="p">);</span>
<a name="gbab-2165"></a>  <span class="n">nlacing</span><span class="o">=</span><span class="n">_og</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">[</span><span class="mi">26</span><span class="p">];</span>
<a name="gbab-2166"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_og</span><span class="o">-&gt;</span><span class="n">header_len</span><span class="o">&gt;=</span><span class="mi">27</span><span class="o">+</span><span class="n">nlacing</span><span class="p">);</span>
<a name="gbab-2167"></a>  <span class="cm">/*This also correctly handles the (unlikely) case of nlacing==0, because</span>
<a name="gbab-2168"></a><span class="cm">     0!=255.*/</span>
<a name="gbab-2169"></a>  <span class="k">return</span> <span class="n">_og</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">[</span><span class="mi">27</span><span class="o">+</span><span class="n">nlacing</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">255</span><span class="p">;</span>
<a name="gbab-2170"></a><span class="p">}</span>
<a name="gbab-2171"></a>
<a name="gbab-2172"></a><span class="cm">/*A small helper to buffer the continued packet data from a page.*/</span>
<a name="gbab-2173"></a><span class="k">static</span> <span class="kt">void</span> <span class="nf">op_buffer_continued_data</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">ogg_page</span> <span class="o">*</span><span class="n">_og</span><span class="p">){</span>
<a name="gbab-2174"></a>  <span class="n">ogg_packet</span> <span class="n">op</span><span class="p">;</span>
<a name="gbab-2175"></a>  <span class="n">ogg_stream_pagein</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="n">_og</span><span class="p">);</span>
<a name="gbab-2176"></a>  <span class="cm">/*Drain any packets that did end on this page (and ignore holes).</span>
<a name="gbab-2177"></a><span class="cm">    We only care about the continued packet data.*/</span>
<a name="gbab-2178"></a>  <span class="k">while</span><span class="p">(</span><span class="n">ogg_stream_packetout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="o">&amp;</span><span class="n">op</span><span class="p">));</span>
<a name="gbab-2179"></a><span class="p">}</span>
<a name="gbab-2180"></a>
<a name="gbab-2181"></a><span class="cm">/*This controls how close the target has to be to use the current stream</span>
<a name="gbab-2182"></a><span class="cm">   position to subdivide the initial range.</span>
<a name="gbab-2183"></a><span class="cm">  Two minutes seems to be a good default.*/</span>
<a name="gbab-2184"></a><span class="cp">#define OP_CUR_TIME_THRESH (120*48*(opus_int32)1000)</span>
<a name="gbab-2185"></a>
<a name="gbab-2186"></a><span class="cm">/*Note: The OP_SMALL_FOOTPRINT #define doesn&#39;t (currently) save much code size,</span>
<a name="gbab-2187"></a><span class="cm">   but it&#39;s meant to serve as documentation for portions of the seeking</span>
<a name="gbab-2188"></a><span class="cm">   algorithm that are purely optional, to aid others learning from/porting this</span>
<a name="gbab-2189"></a><span class="cm">   code to other contexts.*/</span>
<a name="gbab-2190"></a><span class="cm">/*#define OP_SMALL_FOOTPRINT (1)*/</span>
<a name="gbab-2191"></a>
<a name="gbab-2192"></a><span class="cm">/*Search within link _li for the page with the highest granule position</span>
<a name="gbab-2193"></a><span class="cm">   preceding (or equal to) _target_gp.</span>
<a name="gbab-2194"></a><span class="cm">  There is a danger here: missing pages or incorrect frame number information</span>
<a name="gbab-2195"></a><span class="cm">   in the bitstream could make our task impossible.</span>
<a name="gbab-2196"></a><span class="cm">  Account for that (and report it as an error condition).*/</span>
<a name="gbab-2197"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_pcm_seek_page</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-2198"></a> <span class="n">ogg_int64_t</span> <span class="n">_target_gp</span><span class="p">,</span><span class="kt">int</span> <span class="n">_li</span><span class="p">){</span>
<a name="gbab-2199"></a>  <span class="k">const</span> <span class="n">OggOpusLink</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
<a name="gbab-2200"></a>  <span class="n">ogg_page</span>           <span class="n">og</span><span class="p">;</span>
<a name="gbab-2201"></a>  <span class="n">ogg_int64_t</span>        <span class="n">pcm_pre_skip</span><span class="p">;</span>
<a name="gbab-2202"></a>  <span class="n">ogg_int64_t</span>        <span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-2203"></a>  <span class="n">ogg_int64_t</span>        <span class="n">pcm_end</span><span class="p">;</span>
<a name="gbab-2204"></a>  <span class="n">ogg_int64_t</span>        <span class="n">best_gp</span><span class="p">;</span>
<a name="gbab-2205"></a>  <span class="n">ogg_int64_t</span>        <span class="n">diff</span><span class="p">;</span>
<a name="gbab-2206"></a>  <span class="n">ogg_uint32_t</span>       <span class="n">serialno</span><span class="p">;</span>
<a name="gbab-2207"></a>  <span class="n">opus_int32</span>         <span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-2208"></a>  <span class="n">opus_int64</span>         <span class="n">begin</span><span class="p">;</span>
<a name="gbab-2209"></a>  <span class="n">opus_int64</span>         <span class="n">end</span><span class="p">;</span>
<a name="gbab-2210"></a>  <span class="n">opus_int64</span>         <span class="n">boundary</span><span class="p">;</span>
<a name="gbab-2211"></a>  <span class="n">opus_int64</span>         <span class="n">best</span><span class="p">;</span>
<a name="gbab-2212"></a>  <span class="n">opus_int64</span>         <span class="n">best_start</span><span class="p">;</span>
<a name="gbab-2213"></a>  <span class="n">opus_int64</span>         <span class="n">page_offset</span><span class="p">;</span>
<a name="gbab-2214"></a>  <span class="n">opus_int64</span>         <span class="n">d0</span><span class="p">;</span>
<a name="gbab-2215"></a>  <span class="n">opus_int64</span>         <span class="n">d1</span><span class="p">;</span>
<a name="gbab-2216"></a>  <span class="n">opus_int64</span>         <span class="n">d2</span><span class="p">;</span>
<a name="gbab-2217"></a>  <span class="kt">int</span>                <span class="n">force_bisect</span><span class="p">;</span>
<a name="gbab-2218"></a>  <span class="kt">int</span>                <span class="n">buffering</span><span class="p">;</span>
<a name="gbab-2219"></a>  <span class="kt">int</span>                <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2220"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">bytes_tracked</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2221"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">samples_tracked</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2222"></a>  <span class="n">link</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="o">+</span><span class="n">_li</span><span class="p">;</span>
<a name="gbab-2223"></a>  <span class="n">best_gp</span><span class="o">=</span><span class="n">pcm_start</span><span class="o">=</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-2224"></a>  <span class="n">pcm_end</span><span class="o">=</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pcm_end</span><span class="p">;</span>
<a name="gbab-2225"></a>  <span class="n">serialno</span><span class="o">=</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">serialno</span><span class="p">;</span>
<a name="gbab-2226"></a>  <span class="n">best</span><span class="o">=</span><span class="n">best_start</span><span class="o">=</span><span class="n">begin</span><span class="o">=</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>
<a name="gbab-2227"></a>  <span class="n">page_offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2228"></a>  <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2229"></a>  <span class="cm">/*We discard the first 80 ms of data after a seek, so seek back that much</span>
<a name="gbab-2230"></a><span class="cm">     farther.</span>
<a name="gbab-2231"></a><span class="cm">    If we can&#39;t, simply seek to the beginning of the link.*/</span>
<a name="gbab-2232"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_target_gp</span><span class="p">,</span><span class="n">_target_gp</span><span class="p">,</span><span class="o">-</span><span class="mi">80</span><span class="o">*</span><span class="mi">48</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
<a name="gbab-2233"></a>   <span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">_target_gp</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2234"></a>    <span class="n">_target_gp</span><span class="o">=</span><span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-2235"></a>  <span class="p">}</span>
<a name="gbab-2236"></a>  <span class="cm">/*Special case seeking to the start of the link.*/</span>
<a name="gbab-2237"></a>  <span class="n">pre_skip</span><span class="o">=</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-2238"></a>  <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm_pre_skip</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">,</span><span class="n">pre_skip</span><span class="p">));</span>
<a name="gbab-2239"></a>  <span class="k">if</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">_target_gp</span><span class="p">,</span><span class="n">pcm_pre_skip</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="n">end</span><span class="o">=</span><span class="n">boundary</span><span class="o">=</span><span class="n">begin</span><span class="p">;</span>
<a name="gbab-2240"></a>  <span class="k">else</span><span class="p">{</span>
<a name="gbab-2241"></a>    <span class="n">end</span><span class="o">=</span><span class="n">boundary</span><span class="o">=</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">end_offset</span><span class="p">;</span>
<a name="gbab-2242"></a><span class="cp">#if !defined(OP_SMALL_FOOTPRINT)</span>
<a name="gbab-2243"></a>    <span class="cm">/*If we were decoding from this link, we can narrow the range a bit.*/</span>
<a name="gbab-2244"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_li</span><span class="o">==</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="o">&amp;&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;=</span><span class="n">OP_INITSET</span><span class="p">){</span>
<a name="gbab-2245"></a>      <span class="n">opus_int64</span> <span class="n">offset</span><span class="p">;</span>
<a name="gbab-2246"></a>      <span class="kt">int</span>        <span class="n">op_count</span><span class="p">;</span>
<a name="gbab-2247"></a>      <span class="n">op_count</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
<a name="gbab-2248"></a>      <span class="cm">/*The only way the offset can be invalid _and_ we can fail the granule</span>
<a name="gbab-2249"></a><span class="cm">         position checks below is if someone changed the contents of the last</span>
<a name="gbab-2250"></a><span class="cm">         page since we read it.</span>
<a name="gbab-2251"></a><span class="cm">        We&#39;d be within our rights to just return OP_EBADLINK in that case, but</span>
<a name="gbab-2252"></a><span class="cm">         we&#39;ll simply ignore the current position instead.*/</span>
<a name="gbab-2253"></a>      <span class="n">offset</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-2254"></a>      <span class="k">if</span><span class="p">(</span><span class="n">op_count</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">&amp;&amp;</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">offset</span><span class="o">&lt;=</span><span class="n">end</span><span class="p">)){</span>
<a name="gbab-2255"></a>        <span class="n">ogg_int64_t</span> <span class="n">gp</span><span class="p">;</span>
<a name="gbab-2256"></a>        <span class="cm">/*Make sure the timestamp is valid.</span>
<a name="gbab-2257"></a><span class="cm">          The granule position might be -1 if we collected the packets from a</span>
<a name="gbab-2258"></a><span class="cm">           page without a granule position after reporting a hole.*/</span>
<a name="gbab-2259"></a>        <span class="n">gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_count</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">granulepos</span><span class="p">;</span>
<a name="gbab-2260"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">gp</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">pcm_start</span><span class="p">,</span><span class="n">gp</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
<a name="gbab-2261"></a>         <span class="o">&amp;&amp;</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">pcm_end</span><span class="p">,</span><span class="n">gp</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2262"></a>          <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span><span class="n">gp</span><span class="p">,</span><span class="n">_target_gp</span><span class="p">));</span>
<a name="gbab-2263"></a>          <span class="cm">/*We only actually use the current time if either</span>
<a name="gbab-2264"></a><span class="cm">            a) We can cut off at least half the range, or</span>
<a name="gbab-2265"></a><span class="cm">            b) We&#39;re seeking sufficiently close to the current position that</span>
<a name="gbab-2266"></a><span class="cm">                it&#39;s likely to be informative.</span>
<a name="gbab-2267"></a><span class="cm">            Otherwise it appears using the whole link range to estimate the</span>
<a name="gbab-2268"></a><span class="cm">             first seek location gives better results, on average.*/</span>
<a name="gbab-2269"></a>          <span class="k">if</span><span class="p">(</span><span class="n">diff</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-2270"></a>            <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">offset</span><span class="o">&gt;=</span><span class="n">begin</span><span class="p">);</span>
<a name="gbab-2271"></a>            <span class="k">if</span><span class="p">(</span><span class="n">offset</span><span class="o">-</span><span class="n">begin</span><span class="o">&gt;=</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="o">||</span><span class="n">diff</span><span class="o">&gt;-</span><span class="n">OP_CUR_TIME_THRESH</span><span class="p">){</span>
<a name="gbab-2272"></a>              <span class="n">best</span><span class="o">=</span><span class="n">begin</span><span class="o">=</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-2273"></a>              <span class="n">best_gp</span><span class="o">=</span><span class="n">pcm_start</span><span class="o">=</span><span class="n">gp</span><span class="p">;</span>
<a name="gbab-2274"></a>              <span class="cm">/*If we have buffered data from a continued packet, remember the</span>
<a name="gbab-2275"></a><span class="cm">                 offset of the previous page&#39;s start, so that if we do wind up</span>
<a name="gbab-2276"></a><span class="cm">                 having to seek back here later, we can prime the stream with</span>
<a name="gbab-2277"></a><span class="cm">                 the continued packet data.</span>
<a name="gbab-2278"></a><span class="cm">                With no continued packet, we remember the end of the page.*/</span>
<a name="gbab-2279"></a>              <span class="n">best_start</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">body_returned</span><span class="o">&lt;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">body_fill</span><span class="o">?</span>
<a name="gbab-2280"></a>               <span class="n">_of</span><span class="o">-&gt;</span><span class="nl">prev_page_offset</span><span class="p">:</span><span class="n">best</span><span class="p">;</span>
<a name="gbab-2281"></a>              <span class="cm">/*If there&#39;s completed packets and data in the stream state,</span>
<a name="gbab-2282"></a><span class="cm">                 prev_page_offset should always be set.*/</span>
<a name="gbab-2283"></a>              <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">best_start</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2284"></a>              <span class="cm">/*Buffer any continued packet data starting from here.*/</span>
<a name="gbab-2285"></a>              <span class="n">buffering</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2286"></a>            <span class="p">}</span>
<a name="gbab-2287"></a>          <span class="p">}</span>
<a name="gbab-2288"></a>          <span class="k">else</span><span class="p">{</span>
<a name="gbab-2289"></a>            <span class="n">ogg_int64_t</span> <span class="n">prev_page_gp</span><span class="p">;</span>
<a name="gbab-2290"></a>            <span class="cm">/*We might get lucky and already have the packet with the target</span>
<a name="gbab-2291"></a><span class="cm">               buffered.</span>
<a name="gbab-2292"></a><span class="cm">              Worth checking.</span>
<a name="gbab-2293"></a><span class="cm">              For very small files (with all of the data in a single page,</span>
<a name="gbab-2294"></a><span class="cm">               generally 1 second or less), we can loop them continuously</span>
<a name="gbab-2295"></a><span class="cm">               without seeking at all.*/</span>
<a name="gbab-2296"></a>            <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev_page_gp</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">granulepos</span><span class="p">,</span>
<a name="gbab-2297"></a>             <span class="o">-</span><span class="n">op_get_packet_duration</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">packet</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bytes</span><span class="p">)));</span>
<a name="gbab-2298"></a>            <span class="k">if</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">prev_page_gp</span><span class="p">,</span><span class="n">_target_gp</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-2299"></a>              <span class="cm">/*Don&#39;t call op_decode_clear(), because it will dump our</span>
<a name="gbab-2300"></a><span class="cm">                 packets.*/</span>
<a name="gbab-2301"></a>              <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2302"></a>              <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_size</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2303"></a>              <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">prev_page_gp</span><span class="p">;</span>
<a name="gbab-2304"></a>              <span class="cm">/*_of-&gt;prev_page_offset already points to the right place.*/</span>
<a name="gbab-2305"></a>              <span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_STREAMSET</span><span class="p">;</span>
<a name="gbab-2306"></a>              <span class="k">return</span> <span class="n">op_make_decode_ready</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-2307"></a>            <span class="p">}</span>
<a name="gbab-2308"></a>            <span class="cm">/*No such luck.</span>
<a name="gbab-2309"></a><span class="cm">              Check if we can cut off at least half the range, though.*/</span>
<a name="gbab-2310"></a>            <span class="k">if</span><span class="p">(</span><span class="n">offset</span><span class="o">-</span><span class="n">begin</span><span class="o">&lt;=</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="o">||</span><span class="n">diff</span><span class="o">&lt;</span><span class="n">OP_CUR_TIME_THRESH</span><span class="p">){</span>
<a name="gbab-2311"></a>              <span class="cm">/*We really want the page start here, but this will do.*/</span>
<a name="gbab-2312"></a>              <span class="n">end</span><span class="o">=</span><span class="n">boundary</span><span class="o">=</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-2313"></a>              <span class="n">pcm_end</span><span class="o">=</span><span class="n">gp</span><span class="p">;</span>
<a name="gbab-2314"></a>            <span class="p">}</span>
<a name="gbab-2315"></a>          <span class="p">}</span>
<a name="gbab-2316"></a>        <span class="p">}</span>
<a name="gbab-2317"></a>      <span class="p">}</span>
<a name="gbab-2318"></a>    <span class="p">}</span>
<a name="gbab-2319"></a><span class="cp">#endif</span>
<a name="gbab-2320"></a>  <span class="p">}</span>
<a name="gbab-2321"></a>  <span class="cm">/*This code was originally based on the &quot;new search algorithm by HB (Nicholas</span>
<a name="gbab-2322"></a><span class="cm">     Vinen)&quot; from libvorbisfile.</span>
<a name="gbab-2323"></a><span class="cm">    It has been modified substantially since.*/</span>
<a name="gbab-2324"></a>  <span class="n">op_decode_clear</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-2325"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">buffering</span><span class="p">)</span><span class="n">ogg_stream_reset_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="n">serialno</span><span class="p">);</span>
<a name="gbab-2326"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="o">=</span><span class="n">_li</span><span class="p">;</span>
<a name="gbab-2327"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">=</span><span class="n">OP_STREAMSET</span><span class="p">;</span>
<a name="gbab-2328"></a>  <span class="cm">/*Initialize the interval size history.*/</span>
<a name="gbab-2329"></a>  <span class="n">d2</span><span class="o">=</span><span class="n">d1</span><span class="o">=</span><span class="n">d0</span><span class="o">=</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="p">;</span>
<a name="gbab-2330"></a>  <span class="n">force_bisect</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2331"></a>  <span class="k">while</span><span class="p">(</span><span class="n">begin</span><span class="o">&lt;</span><span class="n">end</span><span class="p">){</span>
<a name="gbab-2332"></a>    <span class="n">opus_int64</span> <span class="n">bisect</span><span class="p">;</span>
<a name="gbab-2333"></a>    <span class="n">opus_int64</span> <span class="n">next_boundary</span><span class="p">;</span>
<a name="gbab-2334"></a>    <span class="n">opus_int32</span> <span class="n">chunk_size</span><span class="p">;</span>
<a name="gbab-2335"></a>    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="o">&lt;</span><span class="n">OP_CHUNK_SIZE</span><span class="p">)</span><span class="n">bisect</span><span class="o">=</span><span class="n">begin</span><span class="p">;</span>
<a name="gbab-2336"></a>    <span class="k">else</span><span class="p">{</span>
<a name="gbab-2337"></a>      <span class="cm">/*Update the interval size history.*/</span>
<a name="gbab-2338"></a>      <span class="n">d0</span><span class="o">=</span><span class="n">d1</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2339"></a>      <span class="n">d1</span><span class="o">=</span><span class="n">d2</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2340"></a>      <span class="n">d2</span><span class="o">=</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2341"></a>      <span class="k">if</span><span class="p">(</span><span class="n">force_bisect</span><span class="p">)</span><span class="n">bisect</span><span class="o">=</span><span class="n">begin</span><span class="o">+</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-2342"></a>      <span class="k">else</span><span class="p">{</span>
<a name="gbab-2343"></a>        <span class="n">ogg_int64_t</span> <span class="n">diff2</span><span class="p">;</span>
<a name="gbab-2344"></a>        <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span><span class="n">_target_gp</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">));</span>
<a name="gbab-2345"></a>        <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff2</span><span class="p">,</span><span class="n">pcm_end</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">));</span>
<a name="gbab-2346"></a>        <span class="cm">/*Take a (pretty decent) guess.*/</span>
<a name="gbab-2347"></a>        <span class="n">bisect</span><span class="o">=</span><span class="n">begin</span><span class="o">+</span><span class="n">op_rescale64</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span><span class="n">diff2</span><span class="p">,</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="p">)</span><span class="o">-</span><span class="n">OP_CHUNK_SIZE</span><span class="p">;</span>
<a name="gbab-2348"></a>      <span class="p">}</span>
<a name="gbab-2349"></a>      <span class="k">if</span><span class="p">(</span><span class="n">bisect</span><span class="o">-</span><span class="n">OP_CHUNK_SIZE</span><span class="o">&lt;</span><span class="n">begin</span><span class="p">)</span><span class="n">bisect</span><span class="o">=</span><span class="n">begin</span><span class="p">;</span>
<a name="gbab-2350"></a>      <span class="n">force_bisect</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2351"></a>    <span class="p">}</span>
<a name="gbab-2352"></a>    <span class="k">if</span><span class="p">(</span><span class="n">bisect</span><span class="o">!=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">){</span>
<a name="gbab-2353"></a>      <span class="cm">/*Discard any buffered continued packet data.*/</span>
<a name="gbab-2354"></a>      <span class="k">if</span><span class="p">(</span><span class="n">buffering</span><span class="p">)</span><span class="n">ogg_stream_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">);</span>
<a name="gbab-2355"></a>      <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2356"></a>      <span class="n">page_offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2357"></a>      <span class="n">ret</span><span class="o">=</span><span class="n">op_seek_helper</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">bisect</span><span class="p">);</span>
<a name="gbab-2358"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2359"></a>    <span class="p">}</span>
<a name="gbab-2360"></a>    <span class="n">chunk_size</span><span class="o">=</span><span class="n">OP_CHUNK_SIZE</span><span class="p">;</span>
<a name="gbab-2361"></a>    <span class="n">next_boundary</span><span class="o">=</span><span class="n">boundary</span><span class="p">;</span>
<a name="gbab-2362"></a>    <span class="cm">/*Now scan forward and figure out where we landed.</span>
<a name="gbab-2363"></a><span class="cm">      In the ideal case, we will see a page with a granule position at or</span>
<a name="gbab-2364"></a><span class="cm">       before our target, followed by a page with a granule position after our</span>
<a name="gbab-2365"></a><span class="cm">       target (or the end of the search interval).</span>
<a name="gbab-2366"></a><span class="cm">      Then we can just drop out and will have all of the data we need with no</span>
<a name="gbab-2367"></a><span class="cm">       additional seeking.</span>
<a name="gbab-2368"></a><span class="cm">      If we landed too far before, or after, we&#39;ll break out and do another</span>
<a name="gbab-2369"></a><span class="cm">       bisection.*/</span>
<a name="gbab-2370"></a>    <span class="k">while</span><span class="p">(</span><span class="n">begin</span><span class="o">&lt;</span><span class="n">end</span><span class="p">){</span>
<a name="gbab-2371"></a>      <span class="n">page_offset</span><span class="o">=</span><span class="n">op_get_next_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">,</span><span class="n">boundary</span><span class="p">);</span>
<a name="gbab-2372"></a>      <span class="k">if</span><span class="p">(</span><span class="n">page_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-2373"></a>        <span class="k">if</span><span class="p">(</span><span class="n">page_offset</span><span class="o">&lt;</span><span class="n">OP_FALSE</span><span class="p">)</span><span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">page_offset</span><span class="p">;</span>
<a name="gbab-2374"></a>        <span class="cm">/*There are no more pages in our interval from our stream with a valid</span>
<a name="gbab-2375"></a><span class="cm">           timestamp that start at position bisect or later.*/</span>
<a name="gbab-2376"></a>        <span class="cm">/*If we scanned the whole interval, we&#39;re done.*/</span>
<a name="gbab-2377"></a>        <span class="k">if</span><span class="p">(</span><span class="n">bisect</span><span class="o">&lt;=</span><span class="n">begin</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="n">end</span><span class="o">=</span><span class="n">begin</span><span class="p">;</span>
<a name="gbab-2378"></a>        <span class="k">else</span><span class="p">{</span>
<a name="gbab-2379"></a>          <span class="cm">/*Otherwise, back up one chunk.</span>
<a name="gbab-2380"></a><span class="cm">            First, discard any data from a continued packet.*/</span>
<a name="gbab-2381"></a>          <span class="k">if</span><span class="p">(</span><span class="n">buffering</span><span class="p">)</span><span class="n">ogg_stream_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">);</span>
<a name="gbab-2382"></a>          <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2383"></a>          <span class="n">bisect</span><span class="o">=</span><span class="n">OP_MAX</span><span class="p">(</span><span class="n">bisect</span><span class="o">-</span><span class="n">chunk_size</span><span class="p">,</span><span class="n">begin</span><span class="p">);</span>
<a name="gbab-2384"></a>          <span class="n">ret</span><span class="o">=</span><span class="n">op_seek_helper</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">bisect</span><span class="p">);</span>
<a name="gbab-2385"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2386"></a>          <span class="cm">/*Bump up the chunk size.*/</span>
<a name="gbab-2387"></a>          <span class="n">chunk_size</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">,</span><span class="n">OP_CHUNK_SIZE_MAX</span><span class="p">);</span>
<a name="gbab-2388"></a>          <span class="cm">/*If we did find a page from another stream or without a timestamp,</span>
<a name="gbab-2389"></a><span class="cm">             don&#39;t read past it.*/</span>
<a name="gbab-2390"></a>          <span class="n">boundary</span><span class="o">=</span><span class="n">next_boundary</span><span class="p">;</span>
<a name="gbab-2391"></a>        <span class="p">}</span>
<a name="gbab-2392"></a>      <span class="p">}</span>
<a name="gbab-2393"></a>      <span class="k">else</span><span class="p">{</span>
<a name="gbab-2394"></a>        <span class="n">ogg_int64_t</span> <span class="n">gp</span><span class="p">;</span>
<a name="gbab-2395"></a>        <span class="kt">int</span>         <span class="n">has_packets</span><span class="p">;</span>
<a name="gbab-2396"></a>        <span class="cm">/*Save the offset of the first page we found after the seek, regardless</span>
<a name="gbab-2397"></a><span class="cm">           of the stream it came from or whether or not it has a timestamp.*/</span>
<a name="gbab-2398"></a>        <span class="n">next_boundary</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">page_offset</span><span class="p">,</span><span class="n">next_boundary</span><span class="p">);</span>
<a name="gbab-2399"></a>        <span class="k">if</span><span class="p">(</span><span class="n">serialno</span><span class="o">!=</span><span class="p">(</span><span class="n">ogg_uint32_t</span><span class="p">)</span><span class="n">ogg_page_serialno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">))</span><span class="k">continue</span><span class="p">;</span>
<a name="gbab-2400"></a>        <span class="n">has_packets</span><span class="o">=</span><span class="n">ogg_page_packets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2401"></a>        <span class="cm">/*Force the gp to -1 (as it should be per spec) if no packets end on</span>
<a name="gbab-2402"></a><span class="cm">           this page.</span>
<a name="gbab-2403"></a><span class="cm">          Otherwise we might get confused when we try to pull out a packet</span>
<a name="gbab-2404"></a><span class="cm">           with that timestamp and can&#39;t find it.*/</span>
<a name="gbab-2405"></a>        <span class="n">gp</span><span class="o">=</span><span class="n">has_packets</span><span class="o">?</span><span class="n">ogg_page_granulepos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">)</span><span class="o">:-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2406"></a>        <span class="k">if</span><span class="p">(</span><span class="n">gp</span><span class="o">==-</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-2407"></a>          <span class="k">if</span><span class="p">(</span><span class="n">buffering</span><span class="p">){</span>
<a name="gbab-2408"></a>            <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">has_packets</span><span class="p">))</span><span class="n">ogg_stream_pagein</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-2409"></a>            <span class="k">else</span><span class="p">{</span>
<a name="gbab-2410"></a>              <span class="cm">/*If packets did end on this page, but we still didn&#39;t have a</span>
<a name="gbab-2411"></a><span class="cm">                 valid granule position (in violation of the spec!), stop</span>
<a name="gbab-2412"></a><span class="cm">                 buffering continued packet data.</span>
<a name="gbab-2413"></a><span class="cm">                Otherwise we might continue past the packet we actually</span>
<a name="gbab-2414"></a><span class="cm">                 wanted.*/</span>
<a name="gbab-2415"></a>              <span class="n">ogg_stream_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">);</span>
<a name="gbab-2416"></a>              <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2417"></a>            <span class="p">}</span>
<a name="gbab-2418"></a>          <span class="p">}</span>
<a name="gbab-2419"></a>          <span class="k">continue</span><span class="p">;</span>
<a name="gbab-2420"></a>        <span class="p">}</span>
<a name="gbab-2421"></a>        <span class="k">if</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span><span class="n">_target_gp</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-2422"></a>          <span class="cm">/*We found a page that ends before our target.</span>
<a name="gbab-2423"></a><span class="cm">            Advance to the raw offset of the next page.*/</span>
<a name="gbab-2424"></a>          <span class="n">begin</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-2425"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">pcm_start</span><span class="p">,</span><span class="n">gp</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
<a name="gbab-2426"></a>           <span class="o">||</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">pcm_end</span><span class="p">,</span><span class="n">gp</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2427"></a>            <span class="cm">/*Don&#39;t let pcm_start get out of range!</span>
<a name="gbab-2428"></a><span class="cm">              That could happen with an invalid timestamp.*/</span>
<a name="gbab-2429"></a>            <span class="k">break</span><span class="p">;</span>
<a name="gbab-2430"></a>          <span class="p">}</span>
<a name="gbab-2431"></a>          <span class="cm">/*Save the byte offset of the end of the page with this granule</span>
<a name="gbab-2432"></a><span class="cm">             position.*/</span>
<a name="gbab-2433"></a>          <span class="n">best</span><span class="o">=</span><span class="n">best_start</span><span class="o">=</span><span class="n">begin</span><span class="p">;</span>
<a name="gbab-2434"></a>          <span class="cm">/*Buffer any data from a continued packet, if necessary.</span>
<a name="gbab-2435"></a><span class="cm">            This avoids the need to seek back here if the next timestamp we</span>
<a name="gbab-2436"></a><span class="cm">             encounter while scanning forward lies after our target.*/</span>
<a name="gbab-2437"></a>          <span class="k">if</span><span class="p">(</span><span class="n">buffering</span><span class="p">)</span><span class="n">ogg_stream_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">);</span>
<a name="gbab-2438"></a>          <span class="k">if</span><span class="p">(</span><span class="n">op_page_continues</span><span class="p">(</span><span class="o">&amp;</span><span class="n">og</span><span class="p">)){</span>
<a name="gbab-2439"></a>            <span class="n">op_buffer_continued_data</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-2440"></a>            <span class="cm">/*If we have a continued packet, remember the offset of this</span>
<a name="gbab-2441"></a><span class="cm">               page&#39;s start, so that if we do wind up having to seek back here</span>
<a name="gbab-2442"></a><span class="cm">               later, we can prime the stream with the continued packet data.</span>
<a name="gbab-2443"></a><span class="cm">              With no continued packet, we remember the end of the page.*/</span>
<a name="gbab-2444"></a>            <span class="n">best_start</span><span class="o">=</span><span class="n">page_offset</span><span class="p">;</span>
<a name="gbab-2445"></a>          <span class="p">}</span>
<a name="gbab-2446"></a>          <span class="cm">/*Then force buffering on, so that if a packet starts (but does not</span>
<a name="gbab-2447"></a><span class="cm">             end) on the next page, we still avoid the extra seek back.*/</span>
<a name="gbab-2448"></a>          <span class="n">buffering</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2449"></a>          <span class="n">best_gp</span><span class="o">=</span><span class="n">pcm_start</span><span class="o">=</span><span class="n">gp</span><span class="p">;</span>
<a name="gbab-2450"></a>          <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span><span class="n">_target_gp</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">));</span>
<a name="gbab-2451"></a>          <span class="cm">/*If we&#39;re more than a second away from our target, break out and</span>
<a name="gbab-2452"></a><span class="cm">             do another bisection.*/</span>
<a name="gbab-2453"></a>          <span class="k">if</span><span class="p">(</span><span class="n">diff</span><span class="o">&gt;</span><span class="mi">48000</span><span class="p">)</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-2454"></a>          <span class="cm">/*Otherwise, keep scanning forward (do NOT use begin+1).*/</span>
<a name="gbab-2455"></a>          <span class="n">bisect</span><span class="o">=</span><span class="n">begin</span><span class="p">;</span>
<a name="gbab-2456"></a>        <span class="p">}</span>
<a name="gbab-2457"></a>        <span class="k">else</span><span class="p">{</span>
<a name="gbab-2458"></a>          <span class="cm">/*We found a page that ends after our target.*/</span>
<a name="gbab-2459"></a>          <span class="cm">/*If we scanned the whole interval before we found it, we&#39;re done.*/</span>
<a name="gbab-2460"></a>          <span class="k">if</span><span class="p">(</span><span class="n">bisect</span><span class="o">&lt;=</span><span class="n">begin</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="n">end</span><span class="o">=</span><span class="n">begin</span><span class="p">;</span>
<a name="gbab-2461"></a>          <span class="k">else</span><span class="p">{</span>
<a name="gbab-2462"></a>            <span class="n">end</span><span class="o">=</span><span class="n">bisect</span><span class="p">;</span>
<a name="gbab-2463"></a>            <span class="cm">/*In later iterations, don&#39;t read past the first page we found.*/</span>
<a name="gbab-2464"></a>            <span class="n">boundary</span><span class="o">=</span><span class="n">next_boundary</span><span class="p">;</span>
<a name="gbab-2465"></a>            <span class="cm">/*If we&#39;re not making much progress shrinking the interval size,</span>
<a name="gbab-2466"></a><span class="cm">               start forcing straight bisection to limit the worst case.*/</span>
<a name="gbab-2467"></a>            <span class="n">force_bisect</span><span class="o">=</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="o">&gt;</span><span class="n">d0</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
<a name="gbab-2468"></a>            <span class="cm">/*Don&#39;t let pcm_end get out of range!</span>
<a name="gbab-2469"></a><span class="cm">              That could happen with an invalid timestamp.*/</span>
<a name="gbab-2470"></a>            <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">pcm_end</span><span class="p">,</span><span class="n">gp</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
<a name="gbab-2471"></a>             <span class="o">&amp;&amp;</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">pcm_start</span><span class="p">,</span><span class="n">gp</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2472"></a>              <span class="n">pcm_end</span><span class="o">=</span><span class="n">gp</span><span class="p">;</span>
<a name="gbab-2473"></a>            <span class="p">}</span>
<a name="gbab-2474"></a>            <span class="k">break</span><span class="p">;</span>
<a name="gbab-2475"></a>          <span class="p">}</span>
<a name="gbab-2476"></a>        <span class="p">}</span>
<a name="gbab-2477"></a>      <span class="p">}</span>
<a name="gbab-2478"></a>    <span class="p">}</span>
<a name="gbab-2479"></a>  <span class="p">}</span>
<a name="gbab-2480"></a>  <span class="cm">/*Found our page.*/</span>
<a name="gbab-2481"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">best_gp</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2482"></a>  <span class="cm">/*Seek, if necessary.</span>
<a name="gbab-2483"></a><span class="cm">    If we were buffering data from a continued packet, we should be able to</span>
<a name="gbab-2484"></a><span class="cm">     continue to scan forward to get the rest of the data (even if</span>
<a name="gbab-2485"></a><span class="cm">     page_offset==-1).</span>
<a name="gbab-2486"></a><span class="cm">    Otherwise, we need to seek back to best_start.*/</span>
<a name="gbab-2487"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">buffering</span><span class="p">){</span>
<a name="gbab-2488"></a>    <span class="k">if</span><span class="p">(</span><span class="n">best_start</span><span class="o">!=</span><span class="n">page_offset</span><span class="p">){</span>
<a name="gbab-2489"></a>      <span class="n">page_offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2490"></a>      <span class="n">ret</span><span class="o">=</span><span class="n">op_seek_helper</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">best_start</span><span class="p">);</span>
<a name="gbab-2491"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2492"></a>    <span class="p">}</span>
<a name="gbab-2493"></a>    <span class="k">if</span><span class="p">(</span><span class="n">best_start</span><span class="o">&lt;</span><span class="n">best</span><span class="p">){</span>
<a name="gbab-2494"></a>      <span class="cm">/*Retrieve the page at best_start, if we do not already have it.*/</span>
<a name="gbab-2495"></a>      <span class="k">if</span><span class="p">(</span><span class="n">page_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-2496"></a>        <span class="n">page_offset</span><span class="o">=</span><span class="n">op_get_next_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">,</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">end_offset</span><span class="p">);</span>
<a name="gbab-2497"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">page_offset</span><span class="o">&lt;</span><span class="n">OP_FALSE</span><span class="p">))</span><span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">page_offset</span><span class="p">;</span>
<a name="gbab-2498"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">page_offset</span><span class="o">!=</span><span class="n">best_start</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-2499"></a>      <span class="p">}</span>
<a name="gbab-2500"></a>      <span class="n">op_buffer_continued_data</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="o">&amp;</span><span class="n">og</span><span class="p">);</span>
<a name="gbab-2501"></a>      <span class="n">page_offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2502"></a>    <span class="p">}</span>
<a name="gbab-2503"></a>  <span class="p">}</span>
<a name="gbab-2504"></a>  <span class="cm">/*Update prev_packet_gp to allow per-packet granule position assignment.*/</span>
<a name="gbab-2505"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">best_gp</span><span class="p">;</span>
<a name="gbab-2506"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_page_offset</span><span class="o">=</span><span class="n">best_start</span><span class="p">;</span>
<a name="gbab-2507"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">op_fetch_and_process_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">page_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">?</span><span class="nb">NULL</span><span class="o">:&amp;</span><span class="n">og</span><span class="p">,</span><span class="n">page_offset</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-2508"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-2509"></a>  <span class="cm">/*Verify result.*/</span>
<a name="gbab-2510"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="p">,</span><span class="n">_target_gp</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2511"></a>    <span class="k">return</span> <span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-2512"></a>  <span class="p">}</span>
<a name="gbab-2513"></a>  <span class="cm">/*Our caller will set cur_discard_count to handle pre-roll.*/</span>
<a name="gbab-2514"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-2515"></a><span class="p">}</span>
<a name="gbab-2516"></a>
<a name="gbab-2517"></a><span class="kt">int</span> <span class="nf">op_pcm_seek</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">ogg_int64_t</span> <span class="n">_pcm_offset</span><span class="p">){</span>
<a name="gbab-2518"></a>  <span class="k">const</span> <span class="n">OggOpusLink</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
<a name="gbab-2519"></a>  <span class="n">ogg_int64_t</span>        <span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-2520"></a>  <span class="n">ogg_int64_t</span>        <span class="n">target_gp</span><span class="p">;</span>
<a name="gbab-2521"></a>  <span class="n">ogg_int64_t</span>        <span class="n">prev_packet_gp</span><span class="p">;</span>
<a name="gbab-2522"></a>  <span class="n">ogg_int64_t</span>        <span class="n">skip</span><span class="p">;</span>
<a name="gbab-2523"></a>  <span class="n">ogg_int64_t</span>        <span class="n">diff</span><span class="p">;</span>
<a name="gbab-2524"></a>  <span class="kt">int</span>                <span class="n">op_count</span><span class="p">;</span>
<a name="gbab-2525"></a>  <span class="kt">int</span>                <span class="n">op_pos</span><span class="p">;</span>
<a name="gbab-2526"></a>  <span class="kt">int</span>                <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2527"></a>  <span class="kt">int</span>                <span class="n">li</span><span class="p">;</span>
<a name="gbab-2528"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_OPENED</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-2529"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_ENOSEEK</span><span class="p">;</span>
<a name="gbab-2530"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_pcm_offset</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-2531"></a>  <span class="n">target_gp</span><span class="o">=</span><span class="n">op_get_granulepos</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pcm_offset</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
<a name="gbab-2532"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">target_gp</span><span class="o">==-</span><span class="mi">1</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-2533"></a>  <span class="n">link</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="o">+</span><span class="n">li</span><span class="p">;</span>
<a name="gbab-2534"></a>  <span class="n">pcm_start</span><span class="o">=</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pcm_start</span><span class="p">;</span>
<a name="gbab-2535"></a>  <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_pcm_offset</span><span class="p">,</span><span class="n">target_gp</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">));</span>
<a name="gbab-2536"></a><span class="cp">#if !defined(OP_SMALL_FOOTPRINT)</span>
<a name="gbab-2537"></a>  <span class="cm">/*For small (90 ms or less) forward seeks within the same link, just decode</span>
<a name="gbab-2538"></a><span class="cm">     forward.</span>
<a name="gbab-2539"></a><span class="cm">    This also optimizes the case of seeking to the current position.*/</span>
<a name="gbab-2540"></a>  <span class="k">if</span><span class="p">(</span><span class="n">li</span><span class="o">==</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="o">&amp;&amp;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;=</span><span class="n">OP_INITSET</span><span class="p">){</span>
<a name="gbab-2541"></a>    <span class="n">ogg_int64_t</span> <span class="n">gp</span><span class="p">;</span>
<a name="gbab-2542"></a>    <span class="n">gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="p">;</span>
<a name="gbab-2543"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">gp</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)){</span>
<a name="gbab-2544"></a>      <span class="kt">int</span> <span class="n">nbuffered</span><span class="p">;</span>
<a name="gbab-2545"></a>      <span class="n">nbuffered</span><span class="o">=</span><span class="n">OP_MAX</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_size</span><span class="o">-</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_pos</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2546"></a>      <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="p">,</span><span class="n">gp</span><span class="p">,</span><span class="o">-</span><span class="n">nbuffered</span><span class="p">));</span>
<a name="gbab-2547"></a>      <span class="cm">/*We do _not_ add cur_discard_count to gp.</span>
<a name="gbab-2548"></a><span class="cm">        Otherwise the total amount to discard could grow without bound, and it</span>
<a name="gbab-2549"></a><span class="cm">         would be better just to do a full seek.*/</span>
<a name="gbab-2550"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span><span class="n">gp</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">))){</span>
<a name="gbab-2551"></a>        <span class="n">ogg_int64_t</span> <span class="n">discard_count</span><span class="p">;</span>
<a name="gbab-2552"></a>        <span class="n">discard_count</span><span class="o">=</span><span class="n">_pcm_offset</span><span class="o">-</span><span class="n">diff</span><span class="p">;</span>
<a name="gbab-2553"></a>        <span class="cm">/*We use a threshold of 90 ms instead of 80, since 80 ms is the</span>
<a name="gbab-2554"></a><span class="cm">           _minimum_ we would have discarded after a full seek.</span>
<a name="gbab-2555"></a><span class="cm">          Assuming 20 ms frames (the default), we&#39;d discard 90 ms on average.*/</span>
<a name="gbab-2556"></a>        <span class="k">if</span><span class="p">(</span><span class="n">discard_count</span><span class="o">&gt;=</span><span class="mi">0</span><span class="o">&amp;&amp;</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">discard_count</span><span class="o">&lt;</span><span class="mi">90</span><span class="o">*</span><span class="mi">48</span><span class="p">)){</span>
<a name="gbab-2557"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="o">=</span><span class="p">(</span><span class="n">opus_int32</span><span class="p">)</span><span class="n">discard_count</span><span class="p">;</span>
<a name="gbab-2558"></a>          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-2559"></a>        <span class="p">}</span>
<a name="gbab-2560"></a>      <span class="p">}</span>
<a name="gbab-2561"></a>    <span class="p">}</span>
<a name="gbab-2562"></a>  <span class="p">}</span>
<a name="gbab-2563"></a><span class="cp">#endif</span>
<a name="gbab-2564"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">op_pcm_seek_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">target_gp</span><span class="p">,</span><span class="n">li</span><span class="p">);</span>
<a name="gbab-2565"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2566"></a>  <span class="cm">/*Now skip samples until we actually get to our target.*/</span>
<a name="gbab-2567"></a>  <span class="cm">/*Figure out where we should skip to.*/</span>
<a name="gbab-2568"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_pcm_offset</span><span class="o">&lt;=</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">)</span><span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2569"></a>  <span class="k">else</span> <span class="n">skip</span><span class="o">=</span><span class="n">OP_MAX</span><span class="p">(</span><span class="n">_pcm_offset</span><span class="o">-</span><span class="mi">80</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2570"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_pcm_offset</span><span class="o">-</span><span class="n">skip</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2571"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_pcm_offset</span><span class="o">-</span><span class="n">skip</span><span class="o">&lt;</span><span class="n">OP_INT32_MAX</span><span class="o">-</span><span class="mi">120</span><span class="o">*</span><span class="mi">48</span><span class="p">);</span>
<a name="gbab-2572"></a>  <span class="cm">/*Skip packets until we find one with samples past our skip target.*/</span>
<a name="gbab-2573"></a>  <span class="k">for</span><span class="p">(;;){</span>
<a name="gbab-2574"></a>    <span class="n">op_count</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
<a name="gbab-2575"></a>    <span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="p">;</span>
<a name="gbab-2576"></a>    <span class="k">for</span><span class="p">(</span><span class="n">op_pos</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_pos</span><span class="p">;</span><span class="n">op_pos</span><span class="o">&lt;</span><span class="n">op_count</span><span class="p">;</span><span class="n">op_pos</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-2577"></a>      <span class="n">ogg_int64_t</span> <span class="n">cur_packet_gp</span><span class="p">;</span>
<a name="gbab-2578"></a>      <span class="n">cur_packet_gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">[</span><span class="n">op_pos</span><span class="p">].</span><span class="n">granulepos</span><span class="p">;</span>
<a name="gbab-2579"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span><span class="n">cur_packet_gp</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">))</span>
<a name="gbab-2580"></a>       <span class="o">&amp;&amp;</span><span class="n">diff</span><span class="o">&gt;</span><span class="n">skip</span><span class="p">){</span>
<a name="gbab-2581"></a>        <span class="k">break</span><span class="p">;</span>
<a name="gbab-2582"></a>      <span class="p">}</span>
<a name="gbab-2583"></a>      <span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">cur_packet_gp</span><span class="p">;</span>
<a name="gbab-2584"></a>    <span class="p">}</span>
<a name="gbab-2585"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">prev_packet_gp</span><span class="p">;</span>
<a name="gbab-2586"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_pos</span><span class="o">=</span><span class="n">op_pos</span><span class="p">;</span>
<a name="gbab-2587"></a>    <span class="k">if</span><span class="p">(</span><span class="n">op_pos</span><span class="o">&lt;</span><span class="n">op_count</span><span class="p">)</span><span class="k">break</span><span class="p">;</span>
<a name="gbab-2588"></a>    <span class="cm">/*We skipped all the packets on this page.</span>
<a name="gbab-2589"></a><span class="cm">      Fetch another.*/</span>
<a name="gbab-2590"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_fetch_and_process_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-2591"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-2592"></a>  <span class="p">}</span>
<a name="gbab-2593"></a>  <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span><span class="n">prev_packet_gp</span><span class="p">,</span><span class="n">pcm_start</span><span class="p">));</span>
<a name="gbab-2594"></a>  <span class="cm">/*We skipped too far.</span>
<a name="gbab-2595"></a><span class="cm">    Either the timestamps were illegal or there was a hole in the data.*/</span>
<a name="gbab-2596"></a>  <span class="k">if</span><span class="p">(</span><span class="n">diff</span><span class="o">&gt;</span><span class="n">skip</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_EBADLINK</span><span class="p">;</span>
<a name="gbab-2597"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_pcm_offset</span><span class="o">-</span><span class="n">diff</span><span class="o">&lt;</span><span class="n">OP_INT32_MAX</span><span class="p">);</span>
<a name="gbab-2598"></a>  <span class="cm">/*TODO: If there are further holes/illegal timestamps, we still won&#39;t decode</span>
<a name="gbab-2599"></a><span class="cm">     to the correct sample.</span>
<a name="gbab-2600"></a><span class="cm">    However, at least op_pcm_tell() will report the correct value immediately</span>
<a name="gbab-2601"></a><span class="cm">     after returning.*/</span>
<a name="gbab-2602"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="o">=</span><span class="p">(</span><span class="n">opus_int32</span><span class="p">)(</span><span class="n">_pcm_offset</span><span class="o">-</span><span class="n">diff</span><span class="p">);</span>
<a name="gbab-2603"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-2604"></a><span class="p">}</span>
<a name="gbab-2605"></a>
<a name="gbab-2606"></a><span class="n">opus_int64</span> <span class="nf">op_raw_tell</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-2607"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_OPENED</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-2608"></a>  <span class="k">return</span> <span class="n">_of</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="gbab-2609"></a><span class="p">}</span>
<a name="gbab-2610"></a>
<a name="gbab-2611"></a><span class="cm">/*Convert a granule position from a given link to a PCM offset relative to the</span>
<a name="gbab-2612"></a><span class="cm">   start of the whole stream.</span>
<a name="gbab-2613"></a><span class="cm">  For unseekable sources, this gets reset to 0 at the beginning of each link.*/</span>
<a name="gbab-2614"></a><span class="k">static</span> <span class="n">ogg_int64_t</span> <span class="nf">op_get_pcm_offset</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-2615"></a> <span class="n">ogg_int64_t</span> <span class="n">_gp</span><span class="p">,</span><span class="kt">int</span> <span class="n">_li</span><span class="p">){</span>
<a name="gbab-2616"></a>  <span class="k">const</span> <span class="n">OggOpusLink</span> <span class="o">*</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-2617"></a>  <span class="n">ogg_int64_t</span>        <span class="n">pcm_offset</span><span class="p">;</span>
<a name="gbab-2618"></a>  <span class="n">ogg_int64_t</span>        <span class="n">delta</span><span class="p">;</span>
<a name="gbab-2619"></a>  <span class="kt">int</span>                <span class="n">li</span><span class="p">;</span>
<a name="gbab-2620"></a>  <span class="n">links</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-2621"></a>  <span class="n">pcm_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2622"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_li</span><span class="o">&lt;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">);</span>
<a name="gbab-2623"></a>  <span class="k">for</span><span class="p">(</span><span class="n">li</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">li</span><span class="o">&lt;</span><span class="n">_li</span><span class="p">;</span><span class="n">li</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-2624"></a>    <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delta</span><span class="p">,</span>
<a name="gbab-2625"></a>     <span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">pcm_end</span><span class="p">,</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">pcm_start</span><span class="p">));</span>
<a name="gbab-2626"></a>    <span class="n">delta</span><span class="o">-=</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-2627"></a>    <span class="n">pcm_offset</span><span class="o">+=</span><span class="n">delta</span><span class="p">;</span>
<a name="gbab-2628"></a>  <span class="p">}</span>
<a name="gbab-2629"></a>  <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">_li</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2630"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="o">&amp;&amp;</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">_gp</span><span class="p">,</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">pcm_end</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2631"></a>    <span class="n">_gp</span><span class="o">=</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">pcm_end</span><span class="p">;</span>
<a name="gbab-2632"></a>  <span class="p">}</span>
<a name="gbab-2633"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">_gp</span><span class="p">,</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">pcm_start</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2634"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delta</span><span class="p">,</span><span class="n">_gp</span><span class="p">,</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">pcm_start</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2635"></a>      <span class="cm">/*This means an unseekable stream claimed to have a page from more than</span>
<a name="gbab-2636"></a><span class="cm">         2 billion days after we joined.*/</span>
<a name="gbab-2637"></a>      <span class="n">OP_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">);</span>
<a name="gbab-2638"></a>      <span class="k">return</span> <span class="n">OP_INT64_MAX</span><span class="p">;</span>
<a name="gbab-2639"></a>    <span class="p">}</span>
<a name="gbab-2640"></a>    <span class="k">if</span><span class="p">(</span><span class="n">delta</span><span class="o">&lt;</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">)</span><span class="n">delta</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2641"></a>    <span class="k">else</span> <span class="n">delta</span><span class="o">-=</span><span class="n">links</span><span class="p">[</span><span class="n">_li</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">pre_skip</span><span class="p">;</span>
<a name="gbab-2642"></a>    <span class="cm">/*In the seekable case, _gp was limited by pcm_end.</span>
<a name="gbab-2643"></a><span class="cm">      In the unseekable case, pcm_offset should be 0.*/</span>
<a name="gbab-2644"></a>    <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">pcm_offset</span><span class="o">&lt;=</span><span class="n">OP_INT64_MAX</span><span class="o">-</span><span class="n">delta</span><span class="p">);</span>
<a name="gbab-2645"></a>    <span class="n">pcm_offset</span><span class="o">+=</span><span class="n">delta</span><span class="p">;</span>
<a name="gbab-2646"></a>  <span class="p">}</span>
<a name="gbab-2647"></a>  <span class="k">return</span> <span class="n">pcm_offset</span><span class="p">;</span>
<a name="gbab-2648"></a><span class="p">}</span>
<a name="gbab-2649"></a>
<a name="gbab-2650"></a><span class="n">ogg_int64_t</span> <span class="nf">op_pcm_tell</span><span class="p">(</span><span class="k">const</span> <span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-2651"></a>  <span class="n">ogg_int64_t</span> <span class="n">gp</span><span class="p">;</span>
<a name="gbab-2652"></a>  <span class="kt">int</span>         <span class="n">nbuffered</span><span class="p">;</span>
<a name="gbab-2653"></a>  <span class="kt">int</span>         <span class="n">li</span><span class="p">;</span>
<a name="gbab-2654"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_OPENED</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-2655"></a>  <span class="n">gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="p">;</span>
<a name="gbab-2656"></a>  <span class="k">if</span><span class="p">(</span><span class="n">gp</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span><span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-2657"></a>  <span class="n">nbuffered</span><span class="o">=</span><span class="n">OP_MAX</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_size</span><span class="o">-</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_pos</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2658"></a>  <span class="n">OP_ALWAYS_TRUE</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="p">,</span><span class="n">gp</span><span class="p">,</span><span class="o">-</span><span class="n">nbuffered</span><span class="p">));</span>
<a name="gbab-2659"></a>  <span class="n">li</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="o">?</span><span class="n">_of</span><span class="o">-&gt;</span><span class="nl">cur_link</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2660"></a>  <span class="k">if</span><span class="p">(</span><span class="n">op_granpos_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gp</span><span class="p">,</span><span class="n">gp</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-2661"></a>    <span class="n">gp</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">pcm_end</span><span class="p">;</span>
<a name="gbab-2662"></a>  <span class="p">}</span>
<a name="gbab-2663"></a>  <span class="k">return</span> <span class="n">op_get_pcm_offset</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">gp</span><span class="p">,</span><span class="n">li</span><span class="p">);</span>
<a name="gbab-2664"></a><span class="p">}</span>
<a name="gbab-2665"></a>
<a name="gbab-2666"></a><span class="kt">void</span> <span class="nf">op_set_decode_callback</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-2667"></a> <span class="n">op_decode_cb_func</span> <span class="n">_decode_cb</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">_ctx</span><span class="p">){</span>
<a name="gbab-2668"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">decode_cb</span><span class="o">=</span><span class="n">_decode_cb</span><span class="p">;</span>
<a name="gbab-2669"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">decode_cb_ctx</span><span class="o">=</span><span class="n">_ctx</span><span class="p">;</span>
<a name="gbab-2670"></a><span class="p">}</span>
<a name="gbab-2671"></a>
<a name="gbab-2672"></a><span class="kt">int</span> <span class="nf">op_set_gain_offset</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-2673"></a> <span class="kt">int</span> <span class="n">_gain_type</span><span class="p">,</span><span class="n">opus_int32</span> <span class="n">_gain_offset_q8</span><span class="p">){</span>
<a name="gbab-2674"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_gain_type</span><span class="o">!=</span><span class="n">OP_HEADER_GAIN</span><span class="o">&amp;&amp;</span><span class="n">_gain_type</span><span class="o">!=</span><span class="n">OP_ALBUM_GAIN</span>
<a name="gbab-2675"></a>   <span class="o">&amp;&amp;</span><span class="n">_gain_type</span><span class="o">!=</span><span class="n">OP_TRACK_GAIN</span><span class="o">&amp;&amp;</span><span class="n">_gain_type</span><span class="o">!=</span><span class="n">OP_ABSOLUTE_GAIN</span><span class="p">){</span>
<a name="gbab-2676"></a>    <span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-2677"></a>  <span class="p">}</span>
<a name="gbab-2678"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">gain_type</span><span class="o">=</span><span class="n">_gain_type</span><span class="p">;</span>
<a name="gbab-2679"></a>  <span class="cm">/*The sum of header gain and track gain lies in the range [-65536,65534].</span>
<a name="gbab-2680"></a><span class="cm">    These bounds allow the offset to set the final value to anywhere in the</span>
<a name="gbab-2681"></a><span class="cm">     range [-32768,32767], which is what we&#39;ll clamp it to before applying.*/</span>
<a name="gbab-2682"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">gain_offset_q8</span><span class="o">=</span><span class="n">OP_CLAMP</span><span class="p">(</span><span class="o">-</span><span class="mi">98302</span><span class="p">,</span><span class="n">_gain_offset_q8</span><span class="p">,</span><span class="mi">98303</span><span class="p">);</span>
<a name="gbab-2683"></a>  <span class="n">op_update_gain</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-2684"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-2685"></a><span class="p">}</span>
<a name="gbab-2686"></a>
<a name="gbab-2687"></a><span class="kt">void</span> <span class="nf">op_set_dither_enabled</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">int</span> <span class="n">_enabled</span><span class="p">){</span>
<a name="gbab-2688"></a><span class="cp">#if !defined(OP_FIXED_POINT)</span>
<a name="gbab-2689"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_disabled</span><span class="o">=!</span><span class="n">_enabled</span><span class="p">;</span>
<a name="gbab-2690"></a>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_enabled</span><span class="p">)</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_mute</span><span class="o">=</span><span class="mi">65</span><span class="p">;</span>
<a name="gbab-2691"></a><span class="cp">#endif</span>
<a name="gbab-2692"></a><span class="p">}</span>
<a name="gbab-2693"></a>
<a name="gbab-2694"></a><span class="cm">/*Allocate the decoder scratch buffer.</span>
<a name="gbab-2695"></a><span class="cm">  This is done lazily, since if the user provides large enough buffers, we&#39;ll</span>
<a name="gbab-2696"></a><span class="cm">   never need it.*/</span>
<a name="gbab-2697"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_init_buffer</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">){</span>
<a name="gbab-2698"></a>  <span class="kt">int</span> <span class="n">nchannels_max</span><span class="p">;</span>
<a name="gbab-2699"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="p">){</span>
<a name="gbab-2700"></a>    <span class="k">const</span> <span class="n">OggOpusLink</span> <span class="o">*</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-2701"></a>    <span class="kt">int</span>                <span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-2702"></a>    <span class="kt">int</span>                <span class="n">li</span><span class="p">;</span>
<a name="gbab-2703"></a>    <span class="n">links</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">;</span>
<a name="gbab-2704"></a>    <span class="n">nlinks</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">nlinks</span><span class="p">;</span>
<a name="gbab-2705"></a>    <span class="n">nchannels_max</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-2706"></a>    <span class="k">for</span><span class="p">(</span><span class="n">li</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">li</span><span class="o">&lt;</span><span class="n">nlinks</span><span class="p">;</span><span class="n">li</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-2707"></a>      <span class="n">nchannels_max</span><span class="o">=</span><span class="n">OP_MAX</span><span class="p">(</span><span class="n">nchannels_max</span><span class="p">,</span><span class="n">links</span><span class="p">[</span><span class="n">li</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">channel_count</span><span class="p">);</span>
<a name="gbab-2708"></a>    <span class="p">}</span>
<a name="gbab-2709"></a>  <span class="p">}</span>
<a name="gbab-2710"></a>  <span class="k">else</span> <span class="n">nchannels_max</span><span class="o">=</span><span class="n">OP_NCHANNELS_MAX</span><span class="p">;</span>
<a name="gbab-2711"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer</span><span class="o">=</span><span class="p">(</span><span class="n">op_sample</span> <span class="o">*</span><span class="p">)</span><span class="n">_ogg_malloc</span><span class="p">(</span>
<a name="gbab-2712"></a>   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer</span><span class="p">)</span><span class="o">*</span><span class="n">nchannels_max</span><span class="o">*</span><span class="mi">120</span><span class="o">*</span><span class="mi">48</span><span class="p">);</span>
<a name="gbab-2713"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span><span class="k">return</span> <span class="n">OP_EFAULT</span><span class="p">;</span>
<a name="gbab-2714"></a>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-2715"></a><span class="p">}</span>
<a name="gbab-2716"></a>
<a name="gbab-2717"></a><span class="cm">/*Decode a single packet into the target buffer.*/</span>
<a name="gbab-2718"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_decode</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">op_sample</span> <span class="o">*</span><span class="n">_pcm</span><span class="p">,</span>
<a name="gbab-2719"></a> <span class="k">const</span> <span class="n">ogg_packet</span> <span class="o">*</span><span class="n">_op</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nsamples</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nchannels</span><span class="p">){</span>
<a name="gbab-2720"></a>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2721"></a>  <span class="cm">/*First we try using the application-provided decode callback.*/</span>
<a name="gbab-2722"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">decode_cb</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">){</span>
<a name="gbab-2723"></a><span class="cp">#if defined(OP_FIXED_POINT)</span>
<a name="gbab-2724"></a>    <span class="n">ret</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">decode_cb</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">decode_cb_ctx</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_op</span><span class="p">,</span>
<a name="gbab-2725"></a>     <span class="n">_nsamples</span><span class="p">,</span><span class="n">_nchannels</span><span class="p">,</span><span class="n">OP_DEC_FORMAT_SHORT</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="p">);</span>
<a name="gbab-2726"></a><span class="cp">#else</span>
<a name="gbab-2727"></a>    <span class="n">ret</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">decode_cb</span><span class="p">)(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">decode_cb_ctx</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_op</span><span class="p">,</span>
<a name="gbab-2728"></a>     <span class="n">_nsamples</span><span class="p">,</span><span class="n">_nchannels</span><span class="p">,</span><span class="n">OP_DEC_FORMAT_FLOAT</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="p">);</span>
<a name="gbab-2729"></a><span class="cp">#endif</span>
<a name="gbab-2730"></a>  <span class="p">}</span>
<a name="gbab-2731"></a>  <span class="k">else</span> <span class="n">ret</span><span class="o">=</span><span class="n">OP_DEC_USE_DEFAULT</span><span class="p">;</span>
<a name="gbab-2732"></a>  <span class="cm">/*If the application didn&#39;t want to handle decoding, do it ourselves.*/</span>
<a name="gbab-2733"></a>  <span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="o">==</span><span class="n">OP_DEC_USE_DEFAULT</span><span class="p">){</span>
<a name="gbab-2734"></a><span class="cp">#if defined(OP_FIXED_POINT)</span>
<a name="gbab-2735"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">opus_multistream_decode</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">,</span>
<a name="gbab-2736"></a>     <span class="n">_op</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span><span class="n">_op</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_nsamples</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2737"></a><span class="cp">#else</span>
<a name="gbab-2738"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">opus_multistream_decode_float</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">,</span>
<a name="gbab-2739"></a>     <span class="n">_op</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span><span class="n">_op</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_nsamples</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2740"></a><span class="cp">#endif</span>
<a name="gbab-2741"></a>    <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">||</span><span class="n">ret</span><span class="o">==</span><span class="n">_nsamples</span><span class="p">);</span>
<a name="gbab-2742"></a>  <span class="p">}</span>
<a name="gbab-2743"></a>  <span class="cm">/*If the application returned a positive value other than 0 or</span>
<a name="gbab-2744"></a><span class="cm">     OP_DEC_USE_DEFAULT, fail.*/</span>
<a name="gbab-2745"></a>  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADPACKET</span><span class="p">;</span>
<a name="gbab-2746"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EBADPACKET</span><span class="p">;</span>
<a name="gbab-2747"></a>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2748"></a><span class="p">}</span>
<a name="gbab-2749"></a>
<a name="gbab-2750"></a><span class="cm">/*Read more samples from the stream, using the same API as op_read() or</span>
<a name="gbab-2751"></a><span class="cm">   op_read_float().*/</span>
<a name="gbab-2752"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_read_native</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-2753"></a> <span class="n">op_sample</span> <span class="o">*</span><span class="n">_pcm</span><span class="p">,</span><span class="kt">int</span> <span class="n">_buf_size</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_li</span><span class="p">){</span>
<a name="gbab-2754"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&lt;</span><span class="n">OP_OPENED</span><span class="p">))</span><span class="k">return</span> <span class="n">OP_EINVAL</span><span class="p">;</span>
<a name="gbab-2755"></a>  <span class="k">for</span><span class="p">(;;){</span>
<a name="gbab-2756"></a>    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2757"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;=</span><span class="n">OP_INITSET</span><span class="p">)){</span>
<a name="gbab-2758"></a>      <span class="kt">int</span> <span class="n">nchannels</span><span class="p">;</span>
<a name="gbab-2759"></a>      <span class="kt">int</span> <span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2760"></a>      <span class="kt">int</span> <span class="n">nsamples</span><span class="p">;</span>
<a name="gbab-2761"></a>      <span class="kt">int</span> <span class="n">op_pos</span><span class="p">;</span>
<a name="gbab-2762"></a>      <span class="n">nchannels</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="o">?</span><span class="n">_of</span><span class="o">-&gt;</span><span class="nl">cur_link</span><span class="p">:</span><span class="mi">0</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">channel_count</span><span class="p">;</span>
<a name="gbab-2763"></a>      <span class="n">od_buffer_pos</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2764"></a>      <span class="n">nsamples</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_size</span><span class="o">-</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2765"></a>      <span class="cm">/*If we have buffered samples, return them.*/</span>
<a name="gbab-2766"></a>      <span class="k">if</span><span class="p">(</span><span class="n">nsamples</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
<a name="gbab-2767"></a>        <span class="k">if</span><span class="p">(</span><span class="n">nsamples</span><span class="o">*</span><span class="n">nchannels</span><span class="o">&gt;</span><span class="n">_buf_size</span><span class="p">)</span><span class="n">nsamples</span><span class="o">=</span><span class="n">_buf_size</span><span class="o">/</span><span class="n">nchannels</span><span class="p">;</span>
<a name="gbab-2768"></a>        <span class="n">memcpy</span><span class="p">(</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer</span><span class="o">+</span><span class="n">nchannels</span><span class="o">*</span><span class="n">od_buffer_pos</span><span class="p">,</span>
<a name="gbab-2769"></a>         <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_pcm</span><span class="p">)</span><span class="o">*</span><span class="n">nchannels</span><span class="o">*</span><span class="n">nsamples</span><span class="p">);</span>
<a name="gbab-2770"></a>        <span class="n">od_buffer_pos</span><span class="o">+=</span><span class="n">nsamples</span><span class="p">;</span>
<a name="gbab-2771"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_pos</span><span class="o">=</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2772"></a>        <span class="k">if</span><span class="p">(</span><span class="n">_li</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span><span class="o">*</span><span class="n">_li</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="p">;</span>
<a name="gbab-2773"></a>        <span class="k">return</span> <span class="n">nsamples</span><span class="p">;</span>
<a name="gbab-2774"></a>      <span class="p">}</span>
<a name="gbab-2775"></a>      <span class="cm">/*If we have buffered packets, decode one.*/</span>
<a name="gbab-2776"></a>      <span class="n">op_pos</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_pos</span><span class="p">;</span>
<a name="gbab-2777"></a>      <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">op_pos</span><span class="o">&lt;</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">)){</span>
<a name="gbab-2778"></a>        <span class="k">const</span> <span class="n">ogg_packet</span> <span class="o">*</span><span class="n">pop</span><span class="p">;</span>
<a name="gbab-2779"></a>        <span class="n">ogg_int64_t</span>       <span class="n">diff</span><span class="p">;</span>
<a name="gbab-2780"></a>        <span class="n">opus_int32</span>        <span class="n">cur_discard_count</span><span class="p">;</span>
<a name="gbab-2781"></a>        <span class="kt">int</span>               <span class="n">duration</span><span class="p">;</span>
<a name="gbab-2782"></a>        <span class="kt">int</span>               <span class="n">trimmed_duration</span><span class="p">;</span>
<a name="gbab-2783"></a>        <span class="n">pop</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">+</span><span class="n">op_pos</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-2784"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">op_pos</span><span class="o">=</span><span class="n">op_pos</span><span class="p">;</span>
<a name="gbab-2785"></a>        <span class="n">cur_discard_count</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="p">;</span>
<a name="gbab-2786"></a>        <span class="n">duration</span><span class="o">=</span><span class="n">op_get_packet_duration</span><span class="p">(</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>
<a name="gbab-2787"></a>        <span class="cm">/*We don&#39;t buffer packets with an invalid TOC sequence.*/</span>
<a name="gbab-2788"></a>        <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">duration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2789"></a>        <span class="n">trimmed_duration</span><span class="o">=</span><span class="n">duration</span><span class="p">;</span>
<a name="gbab-2790"></a>        <span class="cm">/*Perform end-trimming.*/</span>
<a name="gbab-2791"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">e_o_s</span><span class="p">)){</span>
<a name="gbab-2792"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">op_granpos_cmp</span><span class="p">(</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">granulepos</span><span class="p">,</span>
<a name="gbab-2793"></a>           <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2794"></a>            <span class="n">trimmed_duration</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2795"></a>          <span class="p">}</span>
<a name="gbab-2796"></a>          <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">op_granpos_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff</span><span class="p">,</span>
<a name="gbab-2797"></a>           <span class="n">pop</span><span class="o">-&gt;</span><span class="n">granulepos</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="p">))){</span>
<a name="gbab-2798"></a>            <span class="n">trimmed_duration</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span><span class="n">trimmed_duration</span><span class="p">);</span>
<a name="gbab-2799"></a>          <span class="p">}</span>
<a name="gbab-2800"></a>        <span class="p">}</span>
<a name="gbab-2801"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">prev_packet_gp</span><span class="o">=</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">granulepos</span><span class="p">;</span>
<a name="gbab-2802"></a>        <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">duration</span><span class="o">*</span><span class="n">nchannels</span><span class="o">&gt;</span><span class="n">_buf_size</span><span class="p">)){</span>
<a name="gbab-2803"></a>          <span class="n">op_sample</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<a name="gbab-2804"></a>          <span class="cm">/*If the user&#39;s buffer is too small, decode into a scratch buffer.*/</span>
<a name="gbab-2805"></a>          <span class="n">buf</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer</span><span class="p">;</span>
<a name="gbab-2806"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">buf</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)){</span>
<a name="gbab-2807"></a>            <span class="n">ret</span><span class="o">=</span><span class="n">op_init_buffer</span><span class="p">(</span><span class="n">_of</span><span class="p">);</span>
<a name="gbab-2808"></a>            <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2809"></a>            <span class="n">buf</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer</span><span class="p">;</span>
<a name="gbab-2810"></a>          <span class="p">}</span>
<a name="gbab-2811"></a>          <span class="n">ret</span><span class="o">=</span><span class="n">op_decode</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">pop</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">nchannels</span><span class="p">);</span>
<a name="gbab-2812"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2813"></a>          <span class="cm">/*Perform pre-skip/pre-roll.*/</span>
<a name="gbab-2814"></a>          <span class="n">od_buffer_pos</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">trimmed_duration</span><span class="p">,</span><span class="n">cur_discard_count</span><span class="p">);</span>
<a name="gbab-2815"></a>          <span class="n">cur_discard_count</span><span class="o">-=</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2816"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="o">=</span><span class="n">cur_discard_count</span><span class="p">;</span>
<a name="gbab-2817"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_pos</span><span class="o">=</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2818"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_size</span><span class="o">=</span><span class="n">trimmed_duration</span><span class="p">;</span>
<a name="gbab-2819"></a>          <span class="cm">/*Update bitrate tracking based on the actual samples we used from</span>
<a name="gbab-2820"></a><span class="cm">             what was decoded.*/</span>
<a name="gbab-2821"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">bytes_tracked</span><span class="o">+=</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">;</span>
<a name="gbab-2822"></a>          <span class="n">_of</span><span class="o">-&gt;</span><span class="n">samples_tracked</span><span class="o">+=</span><span class="n">trimmed_duration</span><span class="o">-</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2823"></a>        <span class="p">}</span>
<a name="gbab-2824"></a>        <span class="k">else</span><span class="p">{</span>
<a name="gbab-2825"></a>          <span class="cm">/*Otherwise decode directly into the user&#39;s buffer.*/</span>
<a name="gbab-2826"></a>          <span class="n">ret</span><span class="o">=</span><span class="n">op_decode</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">pop</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">nchannels</span><span class="p">);</span>
<a name="gbab-2827"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2828"></a>          <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">trimmed_duration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2829"></a>            <span class="cm">/*Perform pre-skip/pre-roll.*/</span>
<a name="gbab-2830"></a>            <span class="n">od_buffer_pos</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">trimmed_duration</span><span class="p">,</span><span class="n">cur_discard_count</span><span class="p">);</span>
<a name="gbab-2831"></a>            <span class="n">cur_discard_count</span><span class="o">-=</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2832"></a>            <span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_discard_count</span><span class="o">=</span><span class="n">cur_discard_count</span><span class="p">;</span>
<a name="gbab-2833"></a>            <span class="n">trimmed_duration</span><span class="o">-=</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2834"></a>            <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">trimmed_duration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
<a name="gbab-2835"></a>             <span class="o">&amp;&amp;</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">od_buffer_pos</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2836"></a>              <span class="n">memmove</span><span class="p">(</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_pcm</span><span class="o">+</span><span class="n">od_buffer_pos</span><span class="o">*</span><span class="n">nchannels</span><span class="p">,</span>
<a name="gbab-2837"></a>               <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_pcm</span><span class="p">)</span><span class="o">*</span><span class="n">trimmed_duration</span><span class="o">*</span><span class="n">nchannels</span><span class="p">);</span>
<a name="gbab-2838"></a>            <span class="p">}</span>
<a name="gbab-2839"></a>            <span class="cm">/*Update bitrate tracking based on the actual samples we used from</span>
<a name="gbab-2840"></a><span class="cm">               what was decoded.*/</span>
<a name="gbab-2841"></a>            <span class="n">_of</span><span class="o">-&gt;</span><span class="n">bytes_tracked</span><span class="o">+=</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">;</span>
<a name="gbab-2842"></a>            <span class="n">_of</span><span class="o">-&gt;</span><span class="n">samples_tracked</span><span class="o">+=</span><span class="n">trimmed_duration</span><span class="p">;</span>
<a name="gbab-2843"></a>            <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">trimmed_duration</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2844"></a>              <span class="k">if</span><span class="p">(</span><span class="n">_li</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span><span class="o">*</span><span class="n">_li</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="p">;</span>
<a name="gbab-2845"></a>              <span class="k">return</span> <span class="n">trimmed_duration</span><span class="p">;</span>
<a name="gbab-2846"></a>            <span class="p">}</span>
<a name="gbab-2847"></a>          <span class="p">}</span>
<a name="gbab-2848"></a>        <span class="p">}</span>
<a name="gbab-2849"></a>        <span class="cm">/*Don&#39;t grab another page yet.</span>
<a name="gbab-2850"></a><span class="cm">          This one might have more packets, or might have buffered data now.*/</span>
<a name="gbab-2851"></a>        <span class="k">continue</span><span class="p">;</span>
<a name="gbab-2852"></a>      <span class="p">}</span>
<a name="gbab-2853"></a>    <span class="p">}</span>
<a name="gbab-2854"></a>    <span class="cm">/*Suck in another page.*/</span>
<a name="gbab-2855"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">op_fetch_and_process_page</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2856"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">==</span><span class="n">OP_EOF</span><span class="p">)){</span>
<a name="gbab-2857"></a>      <span class="k">if</span><span class="p">(</span><span class="n">_li</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span><span class="o">*</span><span class="n">_li</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">cur_link</span><span class="p">;</span>
<a name="gbab-2858"></a>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-2859"></a>    <span class="p">}</span>
<a name="gbab-2860"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">))</span><span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2861"></a>  <span class="p">}</span>
<a name="gbab-2862"></a><span class="p">}</span>
<a name="gbab-2863"></a>
<a name="gbab-2864"></a><span class="cm">/*A generic filter to apply to the decoded audio data.</span>
<a name="gbab-2865"></a><span class="cm">  _src is non-const because we will destructively modify the contents of the</span>
<a name="gbab-2866"></a><span class="cm">   source buffer that we consume in some cases.*/</span>
<a name="gbab-2867"></a><span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">op_read_filter_func</span><span class="p">)(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dst_sz</span><span class="p">,</span>
<a name="gbab-2868"></a> <span class="n">op_sample</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nsamples</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nchannels</span><span class="p">);</span>
<a name="gbab-2869"></a>
<a name="gbab-2870"></a><span class="cm">/*Decode some samples and then apply a custom filter to them.</span>
<a name="gbab-2871"></a><span class="cm">  This is used to convert to different output formats.*/</span>
<a name="gbab-2872"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_filter_read_native</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dst_sz</span><span class="p">,</span>
<a name="gbab-2873"></a> <span class="n">op_read_filter_func</span> <span class="n">_filter</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_li</span><span class="p">){</span>
<a name="gbab-2874"></a>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2875"></a>  <span class="cm">/*Ensure we have some decoded samples in our buffer.*/</span>
<a name="gbab-2876"></a>  <span class="n">ret</span><span class="o">=</span><span class="n">op_read_native</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">_li</span><span class="p">);</span>
<a name="gbab-2877"></a>  <span class="cm">/*Now apply the filter to them.*/</span>
<a name="gbab-2878"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">ready_state</span><span class="o">&gt;=</span><span class="n">OP_INITSET</span><span class="p">)){</span>
<a name="gbab-2879"></a>    <span class="kt">int</span> <span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2880"></a>    <span class="n">od_buffer_pos</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2881"></a>    <span class="n">ret</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_size</span><span class="o">-</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2882"></a>    <span class="k">if</span><span class="p">(</span><span class="n">OP_LIKELY</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)){</span>
<a name="gbab-2883"></a>      <span class="kt">int</span> <span class="n">nchannels</span><span class="p">;</span>
<a name="gbab-2884"></a>      <span class="n">nchannels</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">seekable</span><span class="o">?</span><span class="n">_of</span><span class="o">-&gt;</span><span class="nl">cur_link</span><span class="p">:</span><span class="mi">0</span><span class="p">].</span><span class="n">head</span><span class="p">.</span><span class="n">channel_count</span><span class="p">;</span>
<a name="gbab-2885"></a>      <span class="n">ret</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">_filter</span><span class="p">)(</span><span class="n">_of</span><span class="p">,</span><span class="n">_dst</span><span class="p">,</span><span class="n">_dst_sz</span><span class="p">,</span>
<a name="gbab-2886"></a>       <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer</span><span class="o">+</span><span class="n">nchannels</span><span class="o">*</span><span class="n">od_buffer_pos</span><span class="p">,</span><span class="n">ret</span><span class="p">,</span><span class="n">nchannels</span><span class="p">);</span>
<a name="gbab-2887"></a>      <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">ret</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
<a name="gbab-2888"></a>      <span class="n">OP_ASSERT</span><span class="p">(</span><span class="n">ret</span><span class="o">&lt;=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_size</span><span class="o">-</span><span class="n">od_buffer_pos</span><span class="p">);</span>
<a name="gbab-2889"></a>      <span class="n">od_buffer_pos</span><span class="o">+=</span><span class="n">ret</span><span class="p">;</span>
<a name="gbab-2890"></a>      <span class="n">_of</span><span class="o">-&gt;</span><span class="n">od_buffer_pos</span><span class="o">=</span><span class="n">od_buffer_pos</span><span class="p">;</span>
<a name="gbab-2891"></a>    <span class="p">}</span>
<a name="gbab-2892"></a>  <span class="p">}</span>
<a name="gbab-2893"></a>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="gbab-2894"></a><span class="p">}</span>
<a name="gbab-2895"></a>
<a name="gbab-2896"></a><span class="cp">#if !defined(OP_FIXED_POINT)||!defined(OP_DISABLE_FLOAT_API)</span>
<a name="gbab-2897"></a>
<a name="gbab-2898"></a><span class="cm">/*Matrices for downmixing from the supported channel counts to stereo.</span>
<a name="gbab-2899"></a><span class="cm">  The matrices with 5 or more channels are normalized to a total volume of 2.0,</span>
<a name="gbab-2900"></a><span class="cm">   since most mixes sound too quiet if normalized to 1.0 (as there is generally</span>
<a name="gbab-2901"></a><span class="cm">   little volume in the side/rear channels).*/</span>
<a name="gbab-2902"></a><span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">OP_STEREO_DOWNMIX</span><span class="p">[</span><span class="n">OP_NCHANNELS_MAX</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="n">OP_NCHANNELS_MAX</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">{</span>
<a name="gbab-2903"></a>  <span class="cm">/*3.0*/</span>
<a name="gbab-2904"></a>  <span class="p">{</span>
<a name="gbab-2905"></a>    <span class="p">{</span><span class="mf">0.5858F</span><span class="p">,</span><span class="mf">0.0F</span><span class="p">},{</span><span class="mf">0.4142F</span><span class="p">,</span><span class="mf">0.4142F</span><span class="p">},{</span><span class="mf">0.0F</span><span class="p">,</span><span class="mf">0.5858F</span><span class="p">}</span>
<a name="gbab-2906"></a>  <span class="p">},</span>
<a name="gbab-2907"></a>  <span class="cm">/*quadrophonic*/</span>
<a name="gbab-2908"></a>  <span class="p">{</span>
<a name="gbab-2909"></a>    <span class="p">{</span><span class="mf">0.4226F</span><span class="p">,</span><span class="mf">0.0F</span><span class="p">},{</span><span class="mf">0.0F</span><span class="p">,</span><span class="mf">0.4226F</span><span class="p">},{</span><span class="mf">0.366F</span><span class="p">,</span><span class="mf">0.2114F</span><span class="p">},{</span><span class="mf">0.2114F</span><span class="p">,</span><span class="mf">0.336F</span><span class="p">}</span>
<a name="gbab-2910"></a>  <span class="p">},</span>
<a name="gbab-2911"></a>  <span class="cm">/*5.0*/</span>
<a name="gbab-2912"></a>  <span class="p">{</span>
<a name="gbab-2913"></a>    <span class="p">{</span><span class="mf">0.651F</span><span class="p">,</span><span class="mf">0.0F</span><span class="p">},{</span><span class="mf">0.46F</span><span class="p">,</span><span class="mf">0.46F</span><span class="p">},{</span><span class="mf">0.0F</span><span class="p">,</span><span class="mf">0.651F</span><span class="p">},{</span><span class="mf">0.5636F</span><span class="p">,</span><span class="mf">0.3254F</span><span class="p">},</span>
<a name="gbab-2914"></a>    <span class="p">{</span><span class="mf">0.3254F</span><span class="p">,</span><span class="mf">0.5636F</span><span class="p">}</span>
<a name="gbab-2915"></a>  <span class="p">},</span>
<a name="gbab-2916"></a>  <span class="cm">/*5.1*/</span>
<a name="gbab-2917"></a>  <span class="p">{</span>
<a name="gbab-2918"></a>    <span class="p">{</span><span class="mf">0.529F</span><span class="p">,</span><span class="mf">0.0F</span><span class="p">},{</span><span class="mf">0.3741F</span><span class="p">,</span><span class="mf">0.3741F</span><span class="p">},{</span><span class="mf">0.0F</span><span class="p">,</span><span class="mf">0.529F</span><span class="p">},{</span><span class="mf">0.4582F</span><span class="p">,</span><span class="mf">0.2645F</span><span class="p">},</span>
<a name="gbab-2919"></a>    <span class="p">{</span><span class="mf">0.2645F</span><span class="p">,</span><span class="mf">0.4582F</span><span class="p">},{</span><span class="mf">0.3741F</span><span class="p">,</span><span class="mf">0.3741F</span><span class="p">}</span>
<a name="gbab-2920"></a>  <span class="p">},</span>
<a name="gbab-2921"></a>  <span class="cm">/*6.1*/</span>
<a name="gbab-2922"></a>  <span class="p">{</span>
<a name="gbab-2923"></a>    <span class="p">{</span><span class="mf">0.4553F</span><span class="p">,</span><span class="mf">0.0F</span><span class="p">},{</span><span class="mf">0.322F</span><span class="p">,</span><span class="mf">0.322F</span><span class="p">},{</span><span class="mf">0.0F</span><span class="p">,</span><span class="mf">0.4553F</span><span class="p">},{</span><span class="mf">0.3943F</span><span class="p">,</span><span class="mf">0.2277F</span><span class="p">},</span>
<a name="gbab-2924"></a>    <span class="p">{</span><span class="mf">0.2277F</span><span class="p">,</span><span class="mf">0.3943F</span><span class="p">},{</span><span class="mf">0.2788F</span><span class="p">,</span><span class="mf">0.2788F</span><span class="p">},{</span><span class="mf">0.322F</span><span class="p">,</span><span class="mf">0.322F</span><span class="p">}</span>
<a name="gbab-2925"></a>  <span class="p">},</span>
<a name="gbab-2926"></a>  <span class="cm">/*7.1*/</span>
<a name="gbab-2927"></a>  <span class="p">{</span>
<a name="gbab-2928"></a>    <span class="p">{</span><span class="mf">0.3886F</span><span class="p">,</span><span class="mf">0.0F</span><span class="p">},{</span><span class="mf">0.2748F</span><span class="p">,</span><span class="mf">0.2748F</span><span class="p">},{</span><span class="mf">0.0F</span><span class="p">,</span><span class="mf">0.3886F</span><span class="p">},{</span><span class="mf">0.3366F</span><span class="p">,</span><span class="mf">0.1943F</span><span class="p">},</span>
<a name="gbab-2929"></a>    <span class="p">{</span><span class="mf">0.1943F</span><span class="p">,</span><span class="mf">0.3366F</span><span class="p">},{</span><span class="mf">0.3366F</span><span class="p">,</span><span class="mf">0.1943F</span><span class="p">},{</span><span class="mf">0.1943F</span><span class="p">,</span><span class="mf">0.3366F</span><span class="p">},{</span><span class="mf">0.2748F</span><span class="p">,</span><span class="mf">0.2748F</span><span class="p">}</span>
<a name="gbab-2930"></a>  <span class="p">}</span>
<a name="gbab-2931"></a><span class="p">};</span>
<a name="gbab-2932"></a>
<a name="gbab-2933"></a><span class="cp">#endif</span>
<a name="gbab-2934"></a>
<a name="gbab-2935"></a><span class="cp">#if defined(OP_FIXED_POINT)</span>
<a name="gbab-2936"></a>
<a name="gbab-2937"></a><span class="cm">/*Matrices for downmixing from the supported channel counts to stereo.</span>
<a name="gbab-2938"></a><span class="cm">  The matrices with 5 or more channels are normalized to a total volume of 2.0,</span>
<a name="gbab-2939"></a><span class="cm">   since most mixes sound too quiet if normalized to 1.0 (as there is generally</span>
<a name="gbab-2940"></a><span class="cm">   little volume in the side/rear channels).</span>
<a name="gbab-2941"></a><span class="cm">  Hence we keep the coefficients in Q14, so the downmix values won&#39;t overflow a</span>
<a name="gbab-2942"></a><span class="cm">   32-bit number.*/</span>
<a name="gbab-2943"></a><span class="k">static</span> <span class="k">const</span> <span class="n">opus_int16</span> <span class="n">OP_STEREO_DOWNMIX_Q14</span>
<a name="gbab-2944"></a> <span class="p">[</span><span class="n">OP_NCHANNELS_MAX</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="n">OP_NCHANNELS_MAX</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">{</span>
<a name="gbab-2945"></a>  <span class="cm">/*3.0*/</span>
<a name="gbab-2946"></a>  <span class="p">{</span>
<a name="gbab-2947"></a>    <span class="p">{</span><span class="mi">9598</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">6786</span><span class="p">,</span><span class="mi">6786</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">9598</span><span class="p">}</span>
<a name="gbab-2948"></a>  <span class="p">},</span>
<a name="gbab-2949"></a>  <span class="cm">/*quadrophonic*/</span>
<a name="gbab-2950"></a>  <span class="p">{</span>
<a name="gbab-2951"></a>    <span class="p">{</span><span class="mi">6924</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">6924</span><span class="p">},{</span><span class="mi">5996</span><span class="p">,</span><span class="mi">3464</span><span class="p">},{</span><span class="mi">3464</span><span class="p">,</span><span class="mi">5996</span><span class="p">}</span>
<a name="gbab-2952"></a>  <span class="p">},</span>
<a name="gbab-2953"></a>  <span class="cm">/*5.0*/</span>
<a name="gbab-2954"></a>  <span class="p">{</span>
<a name="gbab-2955"></a>    <span class="p">{</span><span class="mi">10666</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">7537</span><span class="p">,</span><span class="mi">7537</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">10666</span><span class="p">},{</span><span class="mi">9234</span><span class="p">,</span><span class="mi">5331</span><span class="p">},{</span><span class="mi">5331</span><span class="p">,</span><span class="mi">9234</span><span class="p">}</span>
<a name="gbab-2956"></a>  <span class="p">},</span>
<a name="gbab-2957"></a>  <span class="cm">/*5.1*/</span>
<a name="gbab-2958"></a>  <span class="p">{</span>
<a name="gbab-2959"></a>    <span class="p">{</span><span class="mi">8668</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">6129</span><span class="p">,</span><span class="mi">6129</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">8668</span><span class="p">},{</span><span class="mi">7507</span><span class="p">,</span><span class="mi">4335</span><span class="p">},{</span><span class="mi">4335</span><span class="p">,</span><span class="mi">7507</span><span class="p">},{</span><span class="mi">6129</span><span class="p">,</span><span class="mi">6129</span><span class="p">}</span>
<a name="gbab-2960"></a>  <span class="p">},</span>
<a name="gbab-2961"></a>  <span class="cm">/*6.1*/</span>
<a name="gbab-2962"></a>  <span class="p">{</span>
<a name="gbab-2963"></a>    <span class="p">{</span><span class="mi">7459</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">5275</span><span class="p">,</span><span class="mi">5275</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">7459</span><span class="p">},{</span><span class="mi">6460</span><span class="p">,</span><span class="mi">3731</span><span class="p">},{</span><span class="mi">3731</span><span class="p">,</span><span class="mi">6460</span><span class="p">},{</span><span class="mi">4568</span><span class="p">,</span><span class="mi">4568</span><span class="p">},</span>
<a name="gbab-2964"></a>    <span class="p">{</span><span class="mi">5275</span><span class="p">,</span><span class="mi">5275</span><span class="p">}</span>
<a name="gbab-2965"></a>  <span class="p">},</span>
<a name="gbab-2966"></a>  <span class="cm">/*7.1*/</span>
<a name="gbab-2967"></a>  <span class="p">{</span>
<a name="gbab-2968"></a>    <span class="p">{</span><span class="mi">6368</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">4502</span><span class="p">,</span><span class="mi">4502</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">6368</span><span class="p">},{</span><span class="mi">5515</span><span class="p">,</span><span class="mi">3183</span><span class="p">},{</span><span class="mi">3183</span><span class="p">,</span><span class="mi">5515</span><span class="p">},{</span><span class="mi">5515</span><span class="p">,</span><span class="mi">3183</span><span class="p">},</span>
<a name="gbab-2969"></a>    <span class="p">{</span><span class="mi">3183</span><span class="p">,</span><span class="mi">5515</span><span class="p">},{</span><span class="mi">4502</span><span class="p">,</span><span class="mi">4502</span><span class="p">}</span>
<a name="gbab-2970"></a>  <span class="p">}</span>
<a name="gbab-2971"></a><span class="p">};</span>
<a name="gbab-2972"></a>
<a name="gbab-2973"></a><span class="kt">int</span> <span class="nf">op_read</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">opus_int16</span> <span class="o">*</span><span class="n">_pcm</span><span class="p">,</span><span class="kt">int</span> <span class="n">_buf_size</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_li</span><span class="p">){</span>
<a name="gbab-2974"></a>  <span class="k">return</span> <span class="n">op_read_native</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_buf_size</span><span class="p">,</span><span class="n">_li</span><span class="p">);</span>
<a name="gbab-2975"></a><span class="p">}</span>
<a name="gbab-2976"></a>
<a name="gbab-2977"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_stereo_filter</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dst_sz</span><span class="p">,</span>
<a name="gbab-2978"></a> <span class="n">op_sample</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nsamples</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nchannels</span><span class="p">){</span>
<a name="gbab-2979"></a>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">_of</span><span class="p">;</span>
<a name="gbab-2980"></a>  <span class="n">_nsamples</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">_nsamples</span><span class="p">,</span><span class="n">_dst_sz</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-2981"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_nchannels</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="n">memcpy</span><span class="p">(</span><span class="n">_dst</span><span class="p">,</span><span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_src</span><span class="p">));</span>
<a name="gbab-2982"></a>  <span class="k">else</span><span class="p">{</span>
<a name="gbab-2983"></a>    <span class="n">opus_int16</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
<a name="gbab-2984"></a>    <span class="kt">int</span>         <span class="n">i</span><span class="p">;</span>
<a name="gbab-2985"></a>    <span class="n">dst</span><span class="o">=</span><span class="p">(</span><span class="n">opus_int16</span> <span class="o">*</span><span class="p">)</span><span class="n">_dst</span><span class="p">;</span>
<a name="gbab-2986"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_nchannels</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-2987"></a>      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_nsamples</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">_src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="gbab-2988"></a>    <span class="p">}</span>
<a name="gbab-2989"></a>    <span class="k">else</span><span class="p">{</span>
<a name="gbab-2990"></a>      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_nsamples</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-2991"></a>        <span class="n">opus_int32</span> <span class="n">l</span><span class="p">;</span>
<a name="gbab-2992"></a>        <span class="n">opus_int32</span> <span class="n">r</span><span class="p">;</span>
<a name="gbab-2993"></a>        <span class="kt">int</span>        <span class="n">ci</span><span class="p">;</span>
<a name="gbab-2994"></a>        <span class="n">l</span><span class="o">=</span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-2995"></a>        <span class="k">for</span><span class="p">(</span><span class="n">ci</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ci</span><span class="o">&lt;</span><span class="n">_nchannels</span><span class="p">;</span><span class="n">ci</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-2996"></a>          <span class="n">opus_int32</span> <span class="n">s</span><span class="p">;</span>
<a name="gbab-2997"></a>          <span class="n">s</span><span class="o">=</span><span class="n">_src</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">ci</span><span class="p">];</span>
<a name="gbab-2998"></a>          <span class="n">l</span><span class="o">+=</span><span class="n">OP_STEREO_DOWNMIX_Q14</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">-</span><span class="mi">3</span><span class="p">][</span><span class="n">ci</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
<a name="gbab-2999"></a>          <span class="n">r</span><span class="o">+=</span><span class="n">OP_STEREO_DOWNMIX_Q14</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">-</span><span class="mi">3</span><span class="p">][</span><span class="n">ci</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
<a name="gbab-3000"></a>        <span class="p">}</span>
<a name="gbab-3001"></a>        <span class="cm">/*TODO: For 5 or more channels, we should do soft clipping here.*/</span>
<a name="gbab-3002"></a>        <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">opus_int16</span><span class="p">)</span><span class="n">OP_CLAMP</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="n">l</span><span class="o">+</span><span class="mi">8192</span><span class="o">&gt;&gt;</span><span class="mi">14</span><span class="p">,</span><span class="mi">32767</span><span class="p">);</span>
<a name="gbab-3003"></a>        <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">opus_int16</span><span class="p">)</span><span class="n">OP_CLAMP</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="n">r</span><span class="o">+</span><span class="mi">8192</span><span class="o">&gt;&gt;</span><span class="mi">14</span><span class="p">,</span><span class="mi">32767</span><span class="p">);</span>
<a name="gbab-3004"></a>      <span class="p">}</span>
<a name="gbab-3005"></a>    <span class="p">}</span>
<a name="gbab-3006"></a>  <span class="p">}</span>
<a name="gbab-3007"></a>  <span class="k">return</span> <span class="n">_nsamples</span><span class="p">;</span>
<a name="gbab-3008"></a><span class="p">}</span>
<a name="gbab-3009"></a>
<a name="gbab-3010"></a><span class="kt">int</span> <span class="nf">op_read_stereo</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">opus_int16</span> <span class="o">*</span><span class="n">_pcm</span><span class="p">,</span><span class="kt">int</span> <span class="n">_buf_size</span><span class="p">){</span>
<a name="gbab-3011"></a>  <span class="k">return</span> <span class="n">op_filter_read_native</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_buf_size</span><span class="p">,</span><span class="n">op_stereo_filter</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<a name="gbab-3012"></a><span class="p">}</span>
<a name="gbab-3013"></a>
<a name="gbab-3014"></a><span class="cp"># if !defined(OP_DISABLE_FLOAT_API)</span>
<a name="gbab-3015"></a>
<a name="gbab-3016"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_short2float_filter</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dst_sz</span><span class="p">,</span>
<a name="gbab-3017"></a> <span class="n">op_sample</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nsamples</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nchannels</span><span class="p">){</span>
<a name="gbab-3018"></a>  <span class="kt">float</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
<a name="gbab-3019"></a>  <span class="kt">int</span>    <span class="n">i</span><span class="p">;</span>
<a name="gbab-3020"></a>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">_of</span><span class="p">;</span>
<a name="gbab-3021"></a>  <span class="n">dst</span><span class="o">=</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="n">_dst</span><span class="p">;</span>
<a name="gbab-3022"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_nsamples</span><span class="o">*</span><span class="n">_nchannels</span><span class="o">&gt;</span><span class="n">_dst_sz</span><span class="p">))</span><span class="n">_nsamples</span><span class="o">=</span><span class="n">_dst_sz</span><span class="o">/</span><span class="n">_nchannels</span><span class="p">;</span>
<a name="gbab-3023"></a>  <span class="n">_dst_sz</span><span class="o">=</span><span class="n">_nsamples</span><span class="o">*</span><span class="n">_nchannels</span><span class="p">;</span>
<a name="gbab-3024"></a>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_dst_sz</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0F</span><span class="o">/</span><span class="mi">32768</span><span class="p">)</span><span class="o">*</span><span class="n">_src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="gbab-3025"></a>  <span class="k">return</span> <span class="n">_nsamples</span><span class="p">;</span>
<a name="gbab-3026"></a><span class="p">}</span>
<a name="gbab-3027"></a>
<a name="gbab-3028"></a><span class="kt">int</span> <span class="nf">op_read_float</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">float</span> <span class="o">*</span><span class="n">_pcm</span><span class="p">,</span><span class="kt">int</span> <span class="n">_buf_size</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_li</span><span class="p">){</span>
<a name="gbab-3029"></a>  <span class="k">return</span> <span class="n">op_filter_read_native</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_buf_size</span><span class="p">,</span><span class="n">op_short2float_filter</span><span class="p">,</span><span class="n">_li</span><span class="p">);</span>
<a name="gbab-3030"></a><span class="p">}</span>
<a name="gbab-3031"></a>
<a name="gbab-3032"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_short2float_stereo_filter</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-3033"></a> <span class="kt">void</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dst_sz</span><span class="p">,</span><span class="n">op_sample</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nsamples</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nchannels</span><span class="p">){</span>
<a name="gbab-3034"></a>  <span class="kt">float</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
<a name="gbab-3035"></a>  <span class="kt">int</span>    <span class="n">i</span><span class="p">;</span>
<a name="gbab-3036"></a>  <span class="n">dst</span><span class="o">=</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="n">_dst</span><span class="p">;</span>
<a name="gbab-3037"></a>  <span class="n">_nsamples</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">_nsamples</span><span class="p">,</span><span class="n">_dst_sz</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-3038"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_nchannels</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-3039"></a>    <span class="n">_nsamples</span><span class="o">=</span><span class="n">op_short2float_filter</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">dst</span><span class="p">,</span><span class="n">_nsamples</span><span class="p">,</span><span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-3040"></a>    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">_nsamples</span><span class="p">;</span><span class="n">i</span><span class="o">--&gt;</span><span class="mi">0</span><span class="p">;)</span><span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="gbab-3041"></a>  <span class="p">}</span>
<a name="gbab-3042"></a>  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">_nchannels</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">){</span>
<a name="gbab-3043"></a>    <span class="cm">/*For 3 or 4 channels, we can downmix in fixed point without risk of</span>
<a name="gbab-3044"></a><span class="cm">       clipping.*/</span>
<a name="gbab-3045"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_nchannels</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">){</span>
<a name="gbab-3046"></a>      <span class="n">_nsamples</span><span class="o">=</span><span class="n">op_stereo_filter</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
<a name="gbab-3047"></a>       <span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="p">,</span><span class="n">_nchannels</span><span class="p">);</span>
<a name="gbab-3048"></a>    <span class="p">}</span>
<a name="gbab-3049"></a>    <span class="k">return</span> <span class="n">op_short2float_filter</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">dst</span><span class="p">,</span><span class="n">_dst_sz</span><span class="p">,</span><span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a name="gbab-3050"></a>  <span class="p">}</span>
<a name="gbab-3051"></a>  <span class="k">else</span><span class="p">{</span>
<a name="gbab-3052"></a>    <span class="cm">/*For 5 or more channels, we convert to floats and then downmix (so that we</span>
<a name="gbab-3053"></a><span class="cm">       don&#39;t risk clipping).*/</span>
<a name="gbab-3054"></a>    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_nsamples</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-3055"></a>      <span class="kt">float</span> <span class="n">l</span><span class="p">;</span>
<a name="gbab-3056"></a>      <span class="kt">float</span> <span class="n">r</span><span class="p">;</span>
<a name="gbab-3057"></a>      <span class="kt">int</span>   <span class="n">ci</span><span class="p">;</span>
<a name="gbab-3058"></a>      <span class="n">l</span><span class="o">=</span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-3059"></a>      <span class="k">for</span><span class="p">(</span><span class="n">ci</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ci</span><span class="o">&lt;</span><span class="n">_nchannels</span><span class="p">;</span><span class="n">ci</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-3060"></a>        <span class="kt">float</span> <span class="n">s</span><span class="p">;</span>
<a name="gbab-3061"></a>        <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0F</span><span class="o">/</span><span class="mi">32768</span><span class="p">)</span><span class="o">*</span><span class="n">_src</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">ci</span><span class="p">];</span>
<a name="gbab-3062"></a>        <span class="n">l</span><span class="o">+=</span><span class="n">OP_STEREO_DOWNMIX</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">-</span><span class="mi">3</span><span class="p">][</span><span class="n">ci</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
<a name="gbab-3063"></a>        <span class="n">r</span><span class="o">+=</span><span class="n">OP_STEREO_DOWNMIX</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">-</span><span class="mi">3</span><span class="p">][</span><span class="n">ci</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
<a name="gbab-3064"></a>      <span class="p">}</span>
<a name="gbab-3065"></a>      <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">l</span><span class="p">;</span>
<a name="gbab-3066"></a>      <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="p">;</span>
<a name="gbab-3067"></a>    <span class="p">}</span>
<a name="gbab-3068"></a>  <span class="p">}</span>
<a name="gbab-3069"></a>  <span class="k">return</span> <span class="n">_nsamples</span><span class="p">;</span>
<a name="gbab-3070"></a><span class="p">}</span>
<a name="gbab-3071"></a>
<a name="gbab-3072"></a><span class="kt">int</span> <span class="nf">op_read_float_stereo</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">float</span> <span class="o">*</span><span class="n">_pcm</span><span class="p">,</span><span class="kt">int</span> <span class="n">_buf_size</span><span class="p">){</span>
<a name="gbab-3073"></a>  <span class="k">return</span> <span class="n">op_filter_read_native</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_buf_size</span><span class="p">,</span>
<a name="gbab-3074"></a>   <span class="n">op_short2float_stereo_filter</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<a name="gbab-3075"></a><span class="p">}</span>
<a name="gbab-3076"></a>
<a name="gbab-3077"></a><span class="cp"># endif</span>
<a name="gbab-3078"></a>
<a name="gbab-3079"></a><span class="cp">#else</span>
<a name="gbab-3080"></a>
<a name="gbab-3081"></a><span class="cp"># if defined(OP_HAVE_LRINTF)</span>
<a name="gbab-3082"></a><span class="cp">#  include &lt;math.h&gt;</span>
<a name="gbab-3083"></a><span class="cp">#  define op_float2int(_x) (lrintf(_x))</span>
<a name="gbab-3084"></a><span class="cp"># else</span>
<a name="gbab-3085"></a><span class="cp">#  define op_float2int(_x) ((int)((_x)+((_x)&lt;0?-0.5F:0.5F)))</span>
<a name="gbab-3086"></a><span class="cp"># endif</span>
<a name="gbab-3087"></a>
<a name="gbab-3088"></a><span class="cm">/*The dithering code here is adapted from opusdec, part of opus-tools.</span>
<a name="gbab-3089"></a><span class="cm">  It was originally written by Greg Maxwell.*/</span>
<a name="gbab-3090"></a>
<a name="gbab-3091"></a><span class="k">static</span> <span class="n">opus_uint32</span> <span class="nf">op_rand</span><span class="p">(</span><span class="n">opus_uint32</span> <span class="n">_seed</span><span class="p">){</span>
<a name="gbab-3092"></a>  <span class="k">return</span> <span class="n">_seed</span><span class="o">*</span><span class="mi">96314165</span><span class="o">+</span><span class="mi">907633515</span><span class="o">&amp;</span><span class="mh">0xFFFFFFFFU</span><span class="p">;</span>
<a name="gbab-3093"></a><span class="p">}</span>
<a name="gbab-3094"></a>
<a name="gbab-3095"></a><span class="cm">/*This implements 16-bit quantization with full triangular dither and IIR noise</span>
<a name="gbab-3096"></a><span class="cm">   shaping.</span>
<a name="gbab-3097"></a><span class="cm">  The noise shaping filters were designed by Sebastian Gesemann, and are based</span>
<a name="gbab-3098"></a><span class="cm">   on the LAME ATH curves with flattening to limit their peak gain to 20 dB.</span>
<a name="gbab-3099"></a><span class="cm">  Everyone else&#39;s noise shaping filters are mildly crazy.</span>
<a name="gbab-3100"></a><span class="cm">  The 48 kHz version of this filter is just a warped version of the 44.1 kHz</span>
<a name="gbab-3101"></a><span class="cm">   filter and probably could be improved by shifting the HF shelf up in</span>
<a name="gbab-3102"></a><span class="cm">   frequency a little bit, since 48 kHz has a bit more room and being more</span>
<a name="gbab-3103"></a><span class="cm">   conservative against bat-ears is probably more important than more noise</span>
<a name="gbab-3104"></a><span class="cm">   suppression.</span>
<a name="gbab-3105"></a><span class="cm">  This process can increase the peak level of the signal (in theory by the peak</span>
<a name="gbab-3106"></a><span class="cm">   error of 1.5 +20 dB, though that is unobservably rare).</span>
<a name="gbab-3107"></a><span class="cm">  To avoid clipping, the signal is attenuated by a couple thousandths of a dB.</span>
<a name="gbab-3108"></a><span class="cm">  Initially, the approach taken here was to only attenuate by the 99.9th</span>
<a name="gbab-3109"></a><span class="cm">   percentile, making clipping rare but not impossible (like SoX), but the</span>
<a name="gbab-3110"></a><span class="cm">   limited gain of the filter means that the worst case was only two</span>
<a name="gbab-3111"></a><span class="cm">   thousandths of a dB more, so this just uses the worst case.</span>
<a name="gbab-3112"></a><span class="cm">  The attenuation is probably also helpful to prevent clipping in the DAC</span>
<a name="gbab-3113"></a><span class="cm">   reconstruction filters or downstream resampling, in any case.*/</span>
<a name="gbab-3114"></a>
<a name="gbab-3115"></a><span class="cp"># define OP_GAIN (32753.0F)</span>
<a name="gbab-3116"></a>
<a name="gbab-3117"></a><span class="cp"># define OP_PRNG_GAIN (1.0F/0xFFFFFFFF)</span>
<a name="gbab-3118"></a>
<a name="gbab-3119"></a><span class="cm">/*48 kHz noise shaping filter, sd=2.34.*/</span>
<a name="gbab-3120"></a>
<a name="gbab-3121"></a><span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">OP_FCOEF_B</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">{</span>
<a name="gbab-3122"></a>  <span class="mf">2.2374F</span><span class="p">,</span><span class="o">-</span><span class="mf">0.7339F</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1251F</span><span class="p">,</span><span class="o">-</span><span class="mf">0.6033F</span>
<a name="gbab-3123"></a><span class="p">};</span>
<a name="gbab-3124"></a>
<a name="gbab-3125"></a><span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">OP_FCOEF_A</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">{</span>
<a name="gbab-3126"></a>  <span class="mf">0.9030F</span><span class="p">,</span><span class="mf">0.0116F</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5853F</span><span class="p">,</span><span class="o">-</span><span class="mf">0.2571F</span>
<a name="gbab-3127"></a><span class="p">};</span>
<a name="gbab-3128"></a>
<a name="gbab-3129"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_float2short_filter</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dst_sz</span><span class="p">,</span>
<a name="gbab-3130"></a> <span class="kt">float</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nsamples</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nchannels</span><span class="p">){</span>
<a name="gbab-3131"></a>  <span class="n">opus_int16</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
<a name="gbab-3132"></a>  <span class="kt">int</span>         <span class="n">ci</span><span class="p">;</span>
<a name="gbab-3133"></a>  <span class="kt">int</span>         <span class="n">i</span><span class="p">;</span>
<a name="gbab-3134"></a>  <span class="n">dst</span><span class="o">=</span><span class="p">(</span><span class="n">opus_int16</span> <span class="o">*</span><span class="p">)</span><span class="n">_dst</span><span class="p">;</span>
<a name="gbab-3135"></a>  <span class="k">if</span><span class="p">(</span><span class="n">OP_UNLIKELY</span><span class="p">(</span><span class="n">_nsamples</span><span class="o">*</span><span class="n">_nchannels</span><span class="o">&gt;</span><span class="n">_dst_sz</span><span class="p">))</span><span class="n">_nsamples</span><span class="o">=</span><span class="n">_dst_sz</span><span class="o">/</span><span class="n">_nchannels</span><span class="p">;</span>
<a name="gbab-3136"></a><span class="cp"># if defined(OP_SOFT_CLIP)</span>
<a name="gbab-3137"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">state_channel_count</span><span class="o">!=</span><span class="n">_nchannels</span><span class="p">){</span>
<a name="gbab-3138"></a>    <span class="k">for</span><span class="p">(</span><span class="n">ci</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ci</span><span class="o">&lt;</span><span class="n">_nchannels</span><span class="p">;</span><span class="n">ci</span><span class="o">++</span><span class="p">)</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">clip_state</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-3139"></a>  <span class="p">}</span>
<a name="gbab-3140"></a>  <span class="n">opus_pcm_soft_clip</span><span class="p">(</span><span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="p">,</span><span class="n">_nchannels</span><span class="p">,</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">clip_state</span><span class="p">);</span>
<a name="gbab-3141"></a><span class="cp"># endif</span>
<a name="gbab-3142"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_disabled</span><span class="p">){</span>
<a name="gbab-3143"></a>    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_nchannels</span><span class="o">*</span><span class="n">_nsamples</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-3144"></a>      <span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">op_float2int</span><span class="p">(</span><span class="n">OP_CLAMP</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mf">32768.0F</span><span class="o">*</span><span class="n">_src</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">32767</span><span class="p">));</span>
<a name="gbab-3145"></a>    <span class="p">}</span>
<a name="gbab-3146"></a>  <span class="p">}</span>
<a name="gbab-3147"></a>  <span class="k">else</span><span class="p">{</span>
<a name="gbab-3148"></a>    <span class="n">opus_uint32</span> <span class="n">seed</span><span class="p">;</span>
<a name="gbab-3149"></a>    <span class="kt">int</span>         <span class="n">mute</span><span class="p">;</span>
<a name="gbab-3150"></a>    <span class="n">seed</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_seed</span><span class="p">;</span>
<a name="gbab-3151"></a>    <span class="n">mute</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_mute</span><span class="p">;</span>
<a name="gbab-3152"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">state_channel_count</span><span class="o">!=</span><span class="n">_nchannels</span><span class="p">)</span><span class="n">mute</span><span class="o">=</span><span class="mi">65</span><span class="p">;</span>
<a name="gbab-3153"></a>    <span class="cm">/*In order to avoid replacing digital silence with quiet dither noise, we</span>
<a name="gbab-3154"></a><span class="cm">       mute if the output has been silent for a while.*/</span>
<a name="gbab-3155"></a>    <span class="k">if</span><span class="p">(</span><span class="n">mute</span><span class="o">&gt;</span><span class="mi">64</span><span class="p">)</span><span class="n">memset</span><span class="p">(</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_a</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_a</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">_nchannels</span><span class="p">);</span>
<a name="gbab-3156"></a>    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_nsamples</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-3157"></a>      <span class="kt">int</span> <span class="n">silent</span><span class="p">;</span>
<a name="gbab-3158"></a>      <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<a name="gbab-3159"></a>      <span class="k">for</span><span class="p">(</span><span class="n">ci</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ci</span><span class="o">&lt;</span><span class="n">_nchannels</span><span class="p">;</span><span class="n">ci</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-3160"></a>        <span class="kt">float</span> <span class="n">r</span><span class="p">;</span>
<a name="gbab-3161"></a>        <span class="kt">float</span> <span class="n">s</span><span class="p">;</span>
<a name="gbab-3162"></a>        <span class="kt">float</span> <span class="n">err</span><span class="p">;</span>
<a name="gbab-3163"></a>        <span class="kt">int</span>   <span class="n">si</span><span class="p">;</span>
<a name="gbab-3164"></a>        <span class="kt">int</span>   <span class="n">j</span><span class="p">;</span>
<a name="gbab-3165"></a>        <span class="n">s</span><span class="o">=</span><span class="n">_src</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">ci</span><span class="p">];</span>
<a name="gbab-3166"></a>        <span class="n">silent</span><span class="o">&amp;=</span><span class="n">s</span><span class="o">==</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-3167"></a>        <span class="n">s</span><span class="o">*=</span><span class="n">OP_GAIN</span><span class="p">;</span>
<a name="gbab-3168"></a>        <span class="n">err</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-3169"></a>        <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-3170"></a>          <span class="n">err</span><span class="o">+=</span><span class="n">OP_FCOEF_B</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_b</span><span class="p">[</span><span class="n">ci</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
<a name="gbab-3171"></a>           <span class="o">-</span><span class="n">OP_FCOEF_A</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_a</span><span class="p">[</span><span class="n">ci</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
<a name="gbab-3172"></a>        <span class="p">}</span>
<a name="gbab-3173"></a>        <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span><span class="n">j</span><span class="o">--&gt;</span><span class="mi">0</span><span class="p">;)</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_a</span><span class="p">[</span><span class="n">ci</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_a</span><span class="p">[</span><span class="n">ci</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
<a name="gbab-3174"></a>        <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span><span class="n">j</span><span class="o">--&gt;</span><span class="mi">0</span><span class="p">;)</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_b</span><span class="p">[</span><span class="n">ci</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_b</span><span class="p">[</span><span class="n">ci</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
<a name="gbab-3175"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_a</span><span class="p">[</span><span class="n">ci</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">err</span><span class="p">;</span>
<a name="gbab-3176"></a>        <span class="n">s</span><span class="o">-=</span><span class="n">err</span><span class="p">;</span>
<a name="gbab-3177"></a>        <span class="k">if</span><span class="p">(</span><span class="n">mute</span><span class="o">&gt;</span><span class="mi">16</span><span class="p">)</span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-3178"></a>        <span class="k">else</span><span class="p">{</span>
<a name="gbab-3179"></a>          <span class="n">seed</span><span class="o">=</span><span class="n">op_rand</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>
<a name="gbab-3180"></a>          <span class="n">r</span><span class="o">=</span><span class="n">seed</span><span class="o">*</span><span class="n">OP_PRNG_GAIN</span><span class="p">;</span>
<a name="gbab-3181"></a>          <span class="n">seed</span><span class="o">=</span><span class="n">op_rand</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>
<a name="gbab-3182"></a>          <span class="n">r</span><span class="o">-=</span><span class="n">seed</span><span class="o">*</span><span class="n">OP_PRNG_GAIN</span><span class="p">;</span>
<a name="gbab-3183"></a>        <span class="p">}</span>
<a name="gbab-3184"></a>        <span class="cm">/*Clamp in float out of paranoia that the input will be &gt; 96 dBFS and</span>
<a name="gbab-3185"></a><span class="cm">           wrap if the integer is clamped.*/</span>
<a name="gbab-3186"></a>        <span class="n">si</span><span class="o">=</span><span class="n">op_float2int</span><span class="p">(</span><span class="n">OP_CLAMP</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="n">s</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="mi">32767</span><span class="p">));</span>
<a name="gbab-3187"></a>        <span class="n">dst</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">ci</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">opus_int16</span><span class="p">)</span><span class="n">si</span><span class="p">;</span>
<a name="gbab-3188"></a>        <span class="cm">/*Including clipping in the noise shaping is generally disastrous: the</span>
<a name="gbab-3189"></a><span class="cm">           futile effort to restore the clipped energy results in more clipping.</span>
<a name="gbab-3190"></a><span class="cm">          However, small amounts---at the level which could normally be created</span>
<a name="gbab-3191"></a><span class="cm">           by dither and rounding---are harmless and can even reduce clipping</span>
<a name="gbab-3192"></a><span class="cm">           somewhat due to the clipping sometimes reducing the dither + rounding</span>
<a name="gbab-3193"></a><span class="cm">           error.*/</span>
<a name="gbab-3194"></a>        <span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_b</span><span class="p">[</span><span class="n">ci</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">mute</span><span class="o">&gt;</span><span class="mi">16</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="n">OP_CLAMP</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5F</span><span class="p">,</span><span class="n">si</span><span class="o">-</span><span class="n">s</span><span class="p">,</span><span class="mf">1.5F</span><span class="p">);</span>
<a name="gbab-3195"></a>      <span class="p">}</span>
<a name="gbab-3196"></a>      <span class="n">mute</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-3197"></a>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span><span class="n">mute</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-3198"></a>    <span class="p">}</span>
<a name="gbab-3199"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_mute</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">mute</span><span class="p">,</span><span class="mi">65</span><span class="p">);</span>
<a name="gbab-3200"></a>    <span class="n">_of</span><span class="o">-&gt;</span><span class="n">dither_seed</span><span class="o">=</span><span class="n">seed</span><span class="p">;</span>
<a name="gbab-3201"></a>  <span class="p">}</span>
<a name="gbab-3202"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">state_channel_count</span><span class="o">=</span><span class="n">_nchannels</span><span class="p">;</span>
<a name="gbab-3203"></a>  <span class="k">return</span> <span class="n">_nsamples</span><span class="p">;</span>
<a name="gbab-3204"></a><span class="p">}</span>
<a name="gbab-3205"></a>
<a name="gbab-3206"></a><span class="kt">int</span> <span class="nf">op_read</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">opus_int16</span> <span class="o">*</span><span class="n">_pcm</span><span class="p">,</span><span class="kt">int</span> <span class="n">_buf_size</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_li</span><span class="p">){</span>
<a name="gbab-3207"></a>  <span class="k">return</span> <span class="n">op_filter_read_native</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_buf_size</span><span class="p">,</span><span class="n">op_float2short_filter</span><span class="p">,</span><span class="n">_li</span><span class="p">);</span>
<a name="gbab-3208"></a><span class="p">}</span>
<a name="gbab-3209"></a>
<a name="gbab-3210"></a><span class="kt">int</span> <span class="nf">op_read_float</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">float</span> <span class="o">*</span><span class="n">_pcm</span><span class="p">,</span><span class="kt">int</span> <span class="n">_buf_size</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">_li</span><span class="p">){</span>
<a name="gbab-3211"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">state_channel_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-3212"></a>  <span class="k">return</span> <span class="n">op_read_native</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_buf_size</span><span class="p">,</span><span class="n">_li</span><span class="p">);</span>
<a name="gbab-3213"></a><span class="p">}</span>
<a name="gbab-3214"></a>
<a name="gbab-3215"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_stereo_filter</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dst_sz</span><span class="p">,</span>
<a name="gbab-3216"></a> <span class="n">op_sample</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nsamples</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nchannels</span><span class="p">){</span>
<a name="gbab-3217"></a>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">_of</span><span class="p">;</span>
<a name="gbab-3218"></a>  <span class="n">_nsamples</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">_nsamples</span><span class="p">,</span><span class="n">_dst_sz</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-3219"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_nchannels</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="n">memcpy</span><span class="p">(</span><span class="n">_dst</span><span class="p">,</span><span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">_src</span><span class="p">));</span>
<a name="gbab-3220"></a>  <span class="k">else</span><span class="p">{</span>
<a name="gbab-3221"></a>    <span class="kt">float</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
<a name="gbab-3222"></a>    <span class="kt">int</span>    <span class="n">i</span><span class="p">;</span>
<a name="gbab-3223"></a>    <span class="n">dst</span><span class="o">=</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="n">_dst</span><span class="p">;</span>
<a name="gbab-3224"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_nchannels</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-3225"></a>      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_nsamples</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">_src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="gbab-3226"></a>    <span class="p">}</span>
<a name="gbab-3227"></a>    <span class="k">else</span><span class="p">{</span>
<a name="gbab-3228"></a>      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_nsamples</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-3229"></a>        <span class="kt">float</span> <span class="n">l</span><span class="p">;</span>
<a name="gbab-3230"></a>        <span class="kt">float</span> <span class="n">r</span><span class="p">;</span>
<a name="gbab-3231"></a>        <span class="kt">int</span>   <span class="n">ci</span><span class="p">;</span>
<a name="gbab-3232"></a>        <span class="n">l</span><span class="o">=</span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-3233"></a>        <span class="k">for</span><span class="p">(</span><span class="n">ci</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ci</span><span class="o">&lt;</span><span class="n">_nchannels</span><span class="p">;</span><span class="n">ci</span><span class="o">++</span><span class="p">){</span>
<a name="gbab-3234"></a>          <span class="n">l</span><span class="o">+=</span><span class="n">OP_STEREO_DOWNMIX</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">-</span><span class="mi">3</span><span class="p">][</span><span class="n">ci</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_src</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">ci</span><span class="p">];</span>
<a name="gbab-3235"></a>          <span class="n">r</span><span class="o">+=</span><span class="n">OP_STEREO_DOWNMIX</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">-</span><span class="mi">3</span><span class="p">][</span><span class="n">ci</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">_src</span><span class="p">[</span><span class="n">_nchannels</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">ci</span><span class="p">];</span>
<a name="gbab-3236"></a>        <span class="p">}</span>
<a name="gbab-3237"></a>        <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">l</span><span class="p">;</span>
<a name="gbab-3238"></a>        <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="p">;</span>
<a name="gbab-3239"></a>      <span class="p">}</span>
<a name="gbab-3240"></a>    <span class="p">}</span>
<a name="gbab-3241"></a>  <span class="p">}</span>
<a name="gbab-3242"></a>  <span class="k">return</span> <span class="n">_nsamples</span><span class="p">;</span>
<a name="gbab-3243"></a><span class="p">}</span>
<a name="gbab-3244"></a>
<a name="gbab-3245"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">op_float2short_stereo_filter</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span>
<a name="gbab-3246"></a> <span class="kt">void</span> <span class="o">*</span><span class="n">_dst</span><span class="p">,</span><span class="kt">int</span> <span class="n">_dst_sz</span><span class="p">,</span><span class="n">op_sample</span> <span class="o">*</span><span class="n">_src</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nsamples</span><span class="p">,</span><span class="kt">int</span> <span class="n">_nchannels</span><span class="p">){</span>
<a name="gbab-3247"></a>  <span class="n">opus_int16</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
<a name="gbab-3248"></a>  <span class="n">dst</span><span class="o">=</span><span class="p">(</span><span class="n">opus_int16</span> <span class="o">*</span><span class="p">)</span><span class="n">_dst</span><span class="p">;</span>
<a name="gbab-3249"></a>  <span class="k">if</span><span class="p">(</span><span class="n">_nchannels</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
<a name="gbab-3250"></a>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="gbab-3251"></a>    <span class="n">_nsamples</span><span class="o">=</span><span class="n">op_float2short_filter</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">dst</span><span class="p">,</span><span class="n">_dst_sz</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">,</span><span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-3252"></a>    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">_nsamples</span><span class="p">;</span><span class="n">i</span><span class="o">--&gt;</span><span class="mi">0</span><span class="p">;)</span><span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="gbab-3253"></a>  <span class="p">}</span>
<a name="gbab-3254"></a>  <span class="k">else</span><span class="p">{</span>
<a name="gbab-3255"></a>    <span class="k">if</span><span class="p">(</span><span class="n">_nchannels</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">){</span>
<a name="gbab-3256"></a>      <span class="n">_nsamples</span><span class="o">=</span><span class="n">OP_MIN</span><span class="p">(</span><span class="n">_nsamples</span><span class="p">,</span><span class="n">_dst_sz</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
<a name="gbab-3257"></a>      <span class="n">_nsamples</span><span class="o">=</span><span class="n">op_stereo_filter</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
<a name="gbab-3258"></a>       <span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="p">,</span><span class="n">_nchannels</span><span class="p">);</span>
<a name="gbab-3259"></a>    <span class="p">}</span>
<a name="gbab-3260"></a>    <span class="n">_nsamples</span><span class="o">=</span><span class="n">op_float2short_filter</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">dst</span><span class="p">,</span><span class="n">_dst_sz</span><span class="p">,</span><span class="n">_src</span><span class="p">,</span><span class="n">_nsamples</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a name="gbab-3261"></a>  <span class="p">}</span>
<a name="gbab-3262"></a>  <span class="k">return</span> <span class="n">_nsamples</span><span class="p">;</span>
<a name="gbab-3263"></a><span class="p">}</span>
<a name="gbab-3264"></a>
<a name="gbab-3265"></a><span class="kt">int</span> <span class="nf">op_read_stereo</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="n">opus_int16</span> <span class="o">*</span><span class="n">_pcm</span><span class="p">,</span><span class="kt">int</span> <span class="n">_buf_size</span><span class="p">){</span>
<a name="gbab-3266"></a>  <span class="k">return</span> <span class="n">op_filter_read_native</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_buf_size</span><span class="p">,</span>
<a name="gbab-3267"></a>   <span class="n">op_float2short_stereo_filter</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<a name="gbab-3268"></a><span class="p">}</span>
<a name="gbab-3269"></a>
<a name="gbab-3270"></a><span class="kt">int</span> <span class="nf">op_read_float_stereo</span><span class="p">(</span><span class="n">OggOpusFile</span> <span class="o">*</span><span class="n">_of</span><span class="p">,</span><span class="kt">float</span> <span class="o">*</span><span class="n">_pcm</span><span class="p">,</span><span class="kt">int</span> <span class="n">_buf_size</span><span class="p">){</span>
<a name="gbab-3271"></a>  <span class="n">_of</span><span class="o">-&gt;</span><span class="n">state_channel_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="gbab-3272"></a>  <span class="k">return</span> <span class="n">op_filter_read_native</span><span class="p">(</span><span class="n">_of</span><span class="p">,</span><span class="n">_pcm</span><span class="p">,</span><span class="n">_buf_size</span><span class="p">,</span><span class="n">op_stereo_filter</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<a name="gbab-3273"></a><span class="p">}</span>
<a name="gbab-3274"></a>
<a name="gbab-3275"></a><span class="cp">#endif</span>
</pre></div>
</td></tr></table>