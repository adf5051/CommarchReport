<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="gbab-1"></a><span class="cm">/***************************************************************************/</span>
<a name="gbab-2"></a><span class="cm">/*                                                                         */</span>
<a name="gbab-3"></a><span class="cm">/*  cf2font.c                                                              */</span>
<a name="gbab-4"></a><span class="cm">/*                                                                         */</span>
<a name="gbab-5"></a><span class="cm">/*    Adobe&#39;s code for font instances (body).                              */</span>
<a name="gbab-6"></a><span class="cm">/*                                                                         */</span>
<a name="gbab-7"></a><span class="cm">/*  Copyright 2007-2014 Adobe Systems Incorporated.                        */</span>
<a name="gbab-8"></a><span class="cm">/*                                                                         */</span>
<a name="gbab-9"></a><span class="cm">/*  This software, and all works of authorship, whether in source or       */</span>
<a name="gbab-10"></a><span class="cm">/*  object code form as indicated by the copyright notice(s) included      */</span>
<a name="gbab-11"></a><span class="cm">/*  herein (collectively, the &quot;Work&quot;) is made available, and may only be   */</span>
<a name="gbab-12"></a><span class="cm">/*  used, modified, and distributed under the FreeType Project License,    */</span>
<a name="gbab-13"></a><span class="cm">/*  LICENSE.TXT.  Additionally, subject to the terms and conditions of the */</span>
<a name="gbab-14"></a><span class="cm">/*  FreeType Project License, each contributor to the Work hereby grants   */</span>
<a name="gbab-15"></a><span class="cm">/*  to any individual or legal entity exercising permissions granted by    */</span>
<a name="gbab-16"></a><span class="cm">/*  the FreeType Project License and this section (hereafter, &quot;You&quot; or     */</span>
<a name="gbab-17"></a><span class="cm">/*  &quot;Your&quot;) a perpetual, worldwide, non-exclusive, no-charge,              */</span>
<a name="gbab-18"></a><span class="cm">/*  royalty-free, irrevocable (except as stated in this section) patent    */</span>
<a name="gbab-19"></a><span class="cm">/*  license to make, have made, use, offer to sell, sell, import, and      */</span>
<a name="gbab-20"></a><span class="cm">/*  otherwise transfer the Work, where such license applies only to those  */</span>
<a name="gbab-21"></a><span class="cm">/*  patent claims licensable by such contributor that are necessarily      */</span>
<a name="gbab-22"></a><span class="cm">/*  infringed by their contribution(s) alone or by combination of their    */</span>
<a name="gbab-23"></a><span class="cm">/*  contribution(s) with the Work to which such contribution(s) was        */</span>
<a name="gbab-24"></a><span class="cm">/*  submitted.  If You institute patent litigation against any entity      */</span>
<a name="gbab-25"></a><span class="cm">/*  (including a cross-claim or counterclaim in a lawsuit) alleging that   */</span>
<a name="gbab-26"></a><span class="cm">/*  the Work or a contribution incorporated within the Work constitutes    */</span>
<a name="gbab-27"></a><span class="cm">/*  direct or contributory patent infringement, then any patent licenses   */</span>
<a name="gbab-28"></a><span class="cm">/*  granted to You under this License for that Work shall terminate as of  */</span>
<a name="gbab-29"></a><span class="cm">/*  the date such litigation is filed.                                     */</span>
<a name="gbab-30"></a><span class="cm">/*                                                                         */</span>
<a name="gbab-31"></a><span class="cm">/*  By using, modifying, or distributing the Work you indicate that you    */</span>
<a name="gbab-32"></a><span class="cm">/*  have read and understood the terms and conditions of the               */</span>
<a name="gbab-33"></a><span class="cm">/*  FreeType Project License as well as those provided in this section,    */</span>
<a name="gbab-34"></a><span class="cm">/*  and you accept them fully.                                             */</span>
<a name="gbab-35"></a><span class="cm">/*                                                                         */</span>
<a name="gbab-36"></a><span class="cm">/***************************************************************************/</span>
<a name="gbab-37"></a>
<a name="gbab-38"></a>
<a name="gbab-39"></a><span class="cp">#include</span> <span class="cpf">&lt;ft2build.h&gt;</span><span class="cp"></span>
<a name="gbab-40"></a><span class="cp">#include</span> <span class="cpf">FT_INTERNAL_CALC_H</span><span class="cp"></span>
<a name="gbab-41"></a>
<a name="gbab-42"></a><span class="cp">#include</span> <span class="cpf">&quot;cf2ft.h&quot;</span><span class="cp"></span>
<a name="gbab-43"></a>
<a name="gbab-44"></a><span class="cp">#include</span> <span class="cpf">&quot;cf2glue.h&quot;</span><span class="cp"></span>
<a name="gbab-45"></a><span class="cp">#include</span> <span class="cpf">&quot;cf2font.h&quot;</span><span class="cp"></span>
<a name="gbab-46"></a><span class="cp">#include</span> <span class="cpf">&quot;cf2error.h&quot;</span><span class="cp"></span>
<a name="gbab-47"></a><span class="cp">#include</span> <span class="cpf">&quot;cf2intrp.h&quot;</span><span class="cp"></span>
<a name="gbab-48"></a>
<a name="gbab-49"></a>
<a name="gbab-50"></a>  <span class="cm">/* Compute a stem darkening amount in character space. */</span>
<a name="gbab-51"></a>  <span class="k">static</span> <span class="kt">void</span>
<a name="gbab-52"></a>  <span class="nf">cf2_computeDarkening</span><span class="p">(</span> <span class="n">CF2_Fixed</span>   <span class="n">emRatio</span><span class="p">,</span>
<a name="gbab-53"></a>                        <span class="n">CF2_Fixed</span>   <span class="n">ppem</span><span class="p">,</span>
<a name="gbab-54"></a>                        <span class="n">CF2_Fixed</span>   <span class="n">stemWidth</span><span class="p">,</span>
<a name="gbab-55"></a>                        <span class="n">CF2_Fixed</span><span class="o">*</span>  <span class="n">darkenAmount</span><span class="p">,</span>
<a name="gbab-56"></a>                        <span class="n">CF2_Fixed</span>   <span class="n">boldenAmount</span><span class="p">,</span>
<a name="gbab-57"></a>                        <span class="n">FT_Bool</span>     <span class="n">stemDarkened</span><span class="p">,</span>
<a name="gbab-58"></a>                        <span class="n">FT_Int</span><span class="o">*</span>     <span class="n">darkenParams</span> <span class="p">)</span>
<a name="gbab-59"></a>  <span class="p">{</span>
<a name="gbab-60"></a>    <span class="cm">/*</span>
<a name="gbab-61"></a><span class="cm">     * Total darkening amount is computed in 1000 unit character space</span>
<a name="gbab-62"></a><span class="cm">     * using the modified 5 part curve as Adobe&#39;s Avalon rasterizer.</span>
<a name="gbab-63"></a><span class="cm">     * The darkening amount is smaller for thicker stems.</span>
<a name="gbab-64"></a><span class="cm">     * It becomes zero when the stem is thicker than 2.333 pixels.</span>
<a name="gbab-65"></a><span class="cm">     *</span>
<a name="gbab-66"></a><span class="cm">     * By default, we use</span>
<a name="gbab-67"></a><span class="cm">     *</span>
<a name="gbab-68"></a><span class="cm">     *   darkenAmount = 0.4 pixels   if scaledStem &lt;= 0.5 pixels,</span>
<a name="gbab-69"></a><span class="cm">     *   darkenAmount = 0.275 pixels if 1 &lt;= scaledStem &lt;= 1.667 pixels,</span>
<a name="gbab-70"></a><span class="cm">     *   darkenAmount = 0 pixel      if scaledStem &gt;= 2.333 pixels,</span>
<a name="gbab-71"></a><span class="cm">     *</span>
<a name="gbab-72"></a><span class="cm">     * and piecewise linear in-between:</span>
<a name="gbab-73"></a><span class="cm">     *</span>
<a name="gbab-74"></a><span class="cm">     *</span>
<a name="gbab-75"></a><span class="cm">     *   darkening</span>
<a name="gbab-76"></a><span class="cm">     *       ^</span>
<a name="gbab-77"></a><span class="cm">     *       |</span>
<a name="gbab-78"></a><span class="cm">     *       |      (x1,y1)</span>
<a name="gbab-79"></a><span class="cm">     *       |--------+</span>
<a name="gbab-80"></a><span class="cm">     *       |         \</span>
<a name="gbab-81"></a><span class="cm">     *       |          \</span>
<a name="gbab-82"></a><span class="cm">     *       |           \          (x3,y3)</span>
<a name="gbab-83"></a><span class="cm">     *       |            +----------+</span>
<a name="gbab-84"></a><span class="cm">     *       |        (x2,y2)         \</span>
<a name="gbab-85"></a><span class="cm">     *       |                         \</span>
<a name="gbab-86"></a><span class="cm">     *       |                          \</span>
<a name="gbab-87"></a><span class="cm">     *       |                           +-----------------</span>
<a name="gbab-88"></a><span class="cm">     *       |                         (x4,y4)</span>
<a name="gbab-89"></a><span class="cm">     *       +---------------------------------------------&gt;   stem</span>
<a name="gbab-90"></a><span class="cm">     *                                                       thickness</span>
<a name="gbab-91"></a><span class="cm">     *</span>
<a name="gbab-92"></a><span class="cm">     *</span>
<a name="gbab-93"></a><span class="cm">     * This corresponds to the following values for the</span>
<a name="gbab-94"></a><span class="cm">     * `darkening-parameters&#39; property:</span>
<a name="gbab-95"></a><span class="cm">     *</span>
<a name="gbab-96"></a><span class="cm">     *   (x1, y1) = (500, 400)</span>
<a name="gbab-97"></a><span class="cm">     *   (x2, y2) = (1000, 275)</span>
<a name="gbab-98"></a><span class="cm">     *   (x3, y3) = (1667, 275)</span>
<a name="gbab-99"></a><span class="cm">     *   (x4, y4) = (2333, 0)</span>
<a name="gbab-100"></a><span class="cm">     *</span>
<a name="gbab-101"></a><span class="cm">     */</span>
<a name="gbab-102"></a>
<a name="gbab-103"></a>    <span class="cm">/* Internal calculations are done in units per thousand for */</span>
<a name="gbab-104"></a>    <span class="cm">/* convenience. The x axis is scaled stem width in          */</span>
<a name="gbab-105"></a>    <span class="cm">/* thousandths of a pixel. That is, 1000 is 1 pixel.        */</span>
<a name="gbab-106"></a>    <span class="cm">/* The y axis is darkening amount in thousandths of a pixel.*/</span>
<a name="gbab-107"></a>    <span class="cm">/* In the code, below, dividing by ppem and                 */</span>
<a name="gbab-108"></a>    <span class="cm">/* adjusting for emRatio converts darkenAmount to character */</span>
<a name="gbab-109"></a>    <span class="cm">/* space (font units).                                      */</span>
<a name="gbab-110"></a>    <span class="n">CF2_Fixed</span>  <span class="n">stemWidthPer1000</span><span class="p">,</span> <span class="n">scaledStem</span><span class="p">;</span>
<a name="gbab-111"></a>    <span class="n">FT_Int</span>     <span class="n">logBase2</span><span class="p">;</span>
<a name="gbab-112"></a>
<a name="gbab-113"></a>
<a name="gbab-114"></a>    <span class="o">*</span><span class="n">darkenAmount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-115"></a>
<a name="gbab-116"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">boldenAmount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">stemDarkened</span> <span class="p">)</span>
<a name="gbab-117"></a>      <span class="k">return</span><span class="p">;</span>
<a name="gbab-118"></a>
<a name="gbab-119"></a>    <span class="cm">/* protect against range problems and divide by zero */</span>
<a name="gbab-120"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">emRatio</span> <span class="o">&lt;</span> <span class="n">cf2_floatToFixed</span><span class="p">(</span> <span class="mf">.01</span> <span class="p">)</span> <span class="p">)</span>
<a name="gbab-121"></a>      <span class="k">return</span><span class="p">;</span>
<a name="gbab-122"></a>
<a name="gbab-123"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">stemDarkened</span> <span class="p">)</span>
<a name="gbab-124"></a>    <span class="p">{</span>
<a name="gbab-125"></a>      <span class="n">FT_Int</span>  <span class="n">x1</span> <span class="o">=</span> <span class="n">darkenParams</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="gbab-126"></a>      <span class="n">FT_Int</span>  <span class="n">y1</span> <span class="o">=</span> <span class="n">darkenParams</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="gbab-127"></a>      <span class="n">FT_Int</span>  <span class="n">x2</span> <span class="o">=</span> <span class="n">darkenParams</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a name="gbab-128"></a>      <span class="n">FT_Int</span>  <span class="n">y2</span> <span class="o">=</span> <span class="n">darkenParams</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<a name="gbab-129"></a>      <span class="n">FT_Int</span>  <span class="n">x3</span> <span class="o">=</span> <span class="n">darkenParams</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<a name="gbab-130"></a>      <span class="n">FT_Int</span>  <span class="n">y3</span> <span class="o">=</span> <span class="n">darkenParams</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<a name="gbab-131"></a>      <span class="n">FT_Int</span>  <span class="n">x4</span> <span class="o">=</span> <span class="n">darkenParams</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<a name="gbab-132"></a>      <span class="n">FT_Int</span>  <span class="n">y4</span> <span class="o">=</span> <span class="n">darkenParams</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
<a name="gbab-133"></a>
<a name="gbab-134"></a>
<a name="gbab-135"></a>      <span class="cm">/* convert from true character space to 1000 unit character space; */</span>
<a name="gbab-136"></a>      <span class="cm">/* add synthetic emboldening effect                                */</span>
<a name="gbab-137"></a>
<a name="gbab-138"></a>      <span class="cm">/* `stemWidthPer1000&#39; will not overflow for a legitimate font      */</span>
<a name="gbab-139"></a>
<a name="gbab-140"></a>      <span class="n">stemWidthPer1000</span> <span class="o">=</span> <span class="n">FT_MulFix</span><span class="p">(</span> <span class="n">stemWidth</span> <span class="o">+</span> <span class="n">boldenAmount</span><span class="p">,</span> <span class="n">emRatio</span> <span class="p">);</span>
<a name="gbab-141"></a>
<a name="gbab-142"></a>      <span class="cm">/* `scaledStem&#39; can easily overflow, so we must clamp its maximum  */</span>
<a name="gbab-143"></a>      <span class="cm">/* value; the test doesn&#39;t need to be precise, but must be         */</span>
<a name="gbab-144"></a>      <span class="cm">/* conservative.  The clamp value (default 2333) where             */</span>
<a name="gbab-145"></a>      <span class="cm">/* `darkenAmount&#39; is zero is well below the overflow value of      */</span>
<a name="gbab-146"></a>      <span class="cm">/* 32767.                                                          */</span>
<a name="gbab-147"></a>      <span class="cm">/*                                                                 */</span>
<a name="gbab-148"></a>      <span class="cm">/* FT_MSB computes the integer part of the base 2 logarithm.  The  */</span>
<a name="gbab-149"></a>      <span class="cm">/* number of bits for the product is 1 or 2 more than the sum of   */</span>
<a name="gbab-150"></a>      <span class="cm">/* logarithms; remembering that the 16 lowest bits of the fraction */</span>
<a name="gbab-151"></a>      <span class="cm">/* are dropped this is correct to within a factor of almost 4.     */</span>
<a name="gbab-152"></a>      <span class="cm">/* For example, 0x80.0000 * 0x80.0000 = 0x4000.0000 is 23+23 and   */</span>
<a name="gbab-153"></a>      <span class="cm">/* is flagged as possible overflow because 0xFF.FFFF * 0xFF.FFFF = */</span>
<a name="gbab-154"></a>      <span class="cm">/* 0xFFFF.FE00 is also 23+23.                                      */</span>
<a name="gbab-155"></a>
<a name="gbab-156"></a>      <span class="n">logBase2</span> <span class="o">=</span> <span class="n">FT_MSB</span><span class="p">(</span> <span class="p">(</span><span class="n">FT_UInt32</span><span class="p">)</span><span class="n">stemWidthPer1000</span> <span class="p">)</span> <span class="o">+</span>
<a name="gbab-157"></a>                   <span class="n">FT_MSB</span><span class="p">(</span> <span class="p">(</span><span class="n">FT_UInt32</span><span class="p">)</span><span class="n">ppem</span> <span class="p">);</span>
<a name="gbab-158"></a>
<a name="gbab-159"></a>      <span class="k">if</span> <span class="p">(</span> <span class="n">logBase2</span> <span class="o">&gt;=</span> <span class="mi">46</span> <span class="p">)</span>
<a name="gbab-160"></a>        <span class="cm">/* possible overflow */</span>
<a name="gbab-161"></a>        <span class="n">scaledStem</span> <span class="o">=</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">x4</span> <span class="p">);</span>
<a name="gbab-162"></a>      <span class="k">else</span>
<a name="gbab-163"></a>        <span class="n">scaledStem</span> <span class="o">=</span> <span class="n">FT_MulFix</span><span class="p">(</span> <span class="n">stemWidthPer1000</span><span class="p">,</span> <span class="n">ppem</span> <span class="p">);</span>
<a name="gbab-164"></a>
<a name="gbab-165"></a>      <span class="cm">/* now apply the darkening parameters */</span>
<a name="gbab-166"></a>
<a name="gbab-167"></a>      <span class="k">if</span> <span class="p">(</span> <span class="n">scaledStem</span> <span class="o">&lt;</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">x1</span> <span class="p">)</span> <span class="p">)</span>
<a name="gbab-168"></a>        <span class="o">*</span><span class="n">darkenAmount</span> <span class="o">=</span> <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">y1</span> <span class="p">),</span> <span class="n">ppem</span> <span class="p">);</span>
<a name="gbab-169"></a>
<a name="gbab-170"></a>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">scaledStem</span> <span class="o">&lt;</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">x2</span> <span class="p">)</span> <span class="p">)</span>
<a name="gbab-171"></a>      <span class="p">{</span>
<a name="gbab-172"></a>        <span class="n">FT_Int</span>  <span class="n">xdelta</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">;</span>
<a name="gbab-173"></a>        <span class="n">FT_Int</span>  <span class="n">ydelta</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">;</span>
<a name="gbab-174"></a>        <span class="n">FT_Int</span>  <span class="n">x</span>      <span class="o">=</span> <span class="n">stemWidthPer1000</span> <span class="o">-</span>
<a name="gbab-175"></a>                           <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">x1</span> <span class="p">),</span> <span class="n">ppem</span> <span class="p">);</span>
<a name="gbab-176"></a>
<a name="gbab-177"></a>
<a name="gbab-178"></a>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">xdelta</span> <span class="p">)</span>
<a name="gbab-179"></a>          <span class="k">goto</span> <span class="n">Try_x3</span><span class="p">;</span>
<a name="gbab-180"></a>
<a name="gbab-181"></a>        <span class="o">*</span><span class="n">darkenAmount</span> <span class="o">=</span> <span class="n">FT_MulDiv</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">ydelta</span><span class="p">,</span> <span class="n">xdelta</span> <span class="p">)</span> <span class="o">+</span>
<a name="gbab-182"></a>                          <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">y1</span> <span class="p">),</span> <span class="n">ppem</span> <span class="p">);</span>
<a name="gbab-183"></a>      <span class="p">}</span>
<a name="gbab-184"></a>
<a name="gbab-185"></a>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">scaledStem</span> <span class="o">&lt;</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">x3</span> <span class="p">)</span> <span class="p">)</span>
<a name="gbab-186"></a>      <span class="p">{</span>
<a name="gbab-187"></a>      <span class="nl">Try_x3</span><span class="p">:</span>
<a name="gbab-188"></a>        <span class="p">{</span>
<a name="gbab-189"></a>          <span class="n">FT_Int</span>  <span class="n">xdelta</span> <span class="o">=</span> <span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span><span class="p">;</span>
<a name="gbab-190"></a>          <span class="n">FT_Int</span>  <span class="n">ydelta</span> <span class="o">=</span> <span class="n">y3</span> <span class="o">-</span> <span class="n">y2</span><span class="p">;</span>
<a name="gbab-191"></a>          <span class="n">FT_Int</span>  <span class="n">x</span>      <span class="o">=</span> <span class="n">stemWidthPer1000</span> <span class="o">-</span>
<a name="gbab-192"></a>                             <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">x2</span> <span class="p">),</span> <span class="n">ppem</span> <span class="p">);</span>
<a name="gbab-193"></a>
<a name="gbab-194"></a>
<a name="gbab-195"></a>          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">xdelta</span> <span class="p">)</span>
<a name="gbab-196"></a>            <span class="k">goto</span> <span class="n">Try_x4</span><span class="p">;</span>
<a name="gbab-197"></a>
<a name="gbab-198"></a>          <span class="o">*</span><span class="n">darkenAmount</span> <span class="o">=</span> <span class="n">FT_MulDiv</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">ydelta</span><span class="p">,</span> <span class="n">xdelta</span> <span class="p">)</span> <span class="o">+</span>
<a name="gbab-199"></a>                            <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">y2</span> <span class="p">),</span> <span class="n">ppem</span> <span class="p">);</span>
<a name="gbab-200"></a>        <span class="p">}</span>
<a name="gbab-201"></a>      <span class="p">}</span>
<a name="gbab-202"></a>
<a name="gbab-203"></a>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">scaledStem</span> <span class="o">&lt;</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">x4</span> <span class="p">)</span> <span class="p">)</span>
<a name="gbab-204"></a>      <span class="p">{</span>
<a name="gbab-205"></a>      <span class="nl">Try_x4</span><span class="p">:</span>
<a name="gbab-206"></a>        <span class="p">{</span>
<a name="gbab-207"></a>          <span class="n">FT_Int</span>  <span class="n">xdelta</span> <span class="o">=</span> <span class="n">x4</span> <span class="o">-</span> <span class="n">x3</span><span class="p">;</span>
<a name="gbab-208"></a>          <span class="n">FT_Int</span>  <span class="n">ydelta</span> <span class="o">=</span> <span class="n">y4</span> <span class="o">-</span> <span class="n">y3</span><span class="p">;</span>
<a name="gbab-209"></a>          <span class="n">FT_Int</span>  <span class="n">x</span>      <span class="o">=</span> <span class="n">stemWidthPer1000</span> <span class="o">-</span>
<a name="gbab-210"></a>                             <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">x3</span> <span class="p">),</span> <span class="n">ppem</span> <span class="p">);</span>
<a name="gbab-211"></a>
<a name="gbab-212"></a>
<a name="gbab-213"></a>          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">xdelta</span> <span class="p">)</span>
<a name="gbab-214"></a>            <span class="k">goto</span> <span class="n">Use_y4</span><span class="p">;</span>
<a name="gbab-215"></a>
<a name="gbab-216"></a>          <span class="o">*</span><span class="n">darkenAmount</span> <span class="o">=</span> <span class="n">FT_MulDiv</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">ydelta</span><span class="p">,</span> <span class="n">xdelta</span> <span class="p">)</span> <span class="o">+</span>
<a name="gbab-217"></a>                            <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">y3</span> <span class="p">),</span> <span class="n">ppem</span> <span class="p">);</span>
<a name="gbab-218"></a>        <span class="p">}</span>
<a name="gbab-219"></a>      <span class="p">}</span>
<a name="gbab-220"></a>
<a name="gbab-221"></a>      <span class="k">else</span>
<a name="gbab-222"></a>      <span class="p">{</span>
<a name="gbab-223"></a>      <span class="nl">Use_y4</span><span class="p">:</span>
<a name="gbab-224"></a>        <span class="o">*</span><span class="n">darkenAmount</span> <span class="o">=</span> <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">y4</span> <span class="p">),</span> <span class="n">ppem</span> <span class="p">);</span>
<a name="gbab-225"></a>      <span class="p">}</span>
<a name="gbab-226"></a>
<a name="gbab-227"></a>      <span class="cm">/* use half the amount on each side and convert back to true */</span>
<a name="gbab-228"></a>      <span class="cm">/* character space                                           */</span>
<a name="gbab-229"></a>      <span class="o">*</span><span class="n">darkenAmount</span> <span class="o">=</span> <span class="n">FT_DivFix</span><span class="p">(</span> <span class="o">*</span><span class="n">darkenAmount</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">emRatio</span> <span class="p">);</span>
<a name="gbab-230"></a>    <span class="p">}</span>
<a name="gbab-231"></a>
<a name="gbab-232"></a>    <span class="cm">/* add synthetic emboldening effect in character space */</span>
<a name="gbab-233"></a>    <span class="o">*</span><span class="n">darkenAmount</span> <span class="o">+=</span> <span class="n">boldenAmount</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<a name="gbab-234"></a>  <span class="p">}</span>
<a name="gbab-235"></a>
<a name="gbab-236"></a>
<a name="gbab-237"></a>  <span class="cm">/* set up values for the current FontDict and matrix */</span>
<a name="gbab-238"></a>
<a name="gbab-239"></a>  <span class="cm">/* caller&#39;s transform is adjusted for subpixel positioning */</span>
<a name="gbab-240"></a>  <span class="k">static</span> <span class="kt">void</span>
<a name="gbab-241"></a>  <span class="nf">cf2_font_setup</span><span class="p">(</span> <span class="n">CF2_Font</span>           <span class="n">font</span><span class="p">,</span>
<a name="gbab-242"></a>                  <span class="k">const</span> <span class="n">CF2_Matrix</span><span class="o">*</span>  <span class="n">transform</span> <span class="p">)</span>
<a name="gbab-243"></a>  <span class="p">{</span>
<a name="gbab-244"></a>    <span class="cm">/* pointer to parsed font object */</span>
<a name="gbab-245"></a>    <span class="n">CFF_Decoder</span><span class="o">*</span>  <span class="n">decoder</span> <span class="o">=</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">;</span>
<a name="gbab-246"></a>
<a name="gbab-247"></a>    <span class="n">FT_Bool</span>  <span class="n">needExtraSetup</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<a name="gbab-248"></a>
<a name="gbab-249"></a>    <span class="cm">/* character space units */</span>
<a name="gbab-250"></a>    <span class="n">CF2_Fixed</span>  <span class="n">boldenX</span> <span class="o">=</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">syntheticEmboldeningAmountX</span><span class="p">;</span>
<a name="gbab-251"></a>    <span class="n">CF2_Fixed</span>  <span class="n">boldenY</span> <span class="o">=</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">syntheticEmboldeningAmountY</span><span class="p">;</span>
<a name="gbab-252"></a>
<a name="gbab-253"></a>    <span class="n">CFF_SubFont</span>  <span class="n">subFont</span><span class="p">;</span>
<a name="gbab-254"></a>    <span class="n">CF2_Fixed</span>  <span class="n">ppem</span><span class="p">;</span>
<a name="gbab-255"></a>
<a name="gbab-256"></a>
<a name="gbab-257"></a>    <span class="cm">/* clear previous error */</span>
<a name="gbab-258"></a>    <span class="n">font</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">FT_Err_Ok</span><span class="p">;</span>
<a name="gbab-259"></a>
<a name="gbab-260"></a>    <span class="cm">/* if a CID fontDict has changed, we need to recompute some cached */</span>
<a name="gbab-261"></a>    <span class="cm">/* data                                                            */</span>
<a name="gbab-262"></a>    <span class="n">subFont</span> <span class="o">=</span> <span class="n">cf2_getSubfont</span><span class="p">(</span> <span class="n">decoder</span> <span class="p">);</span>
<a name="gbab-263"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">lastSubfont</span> <span class="o">!=</span> <span class="n">subFont</span> <span class="p">)</span>
<a name="gbab-264"></a>    <span class="p">{</span>
<a name="gbab-265"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">lastSubfont</span> <span class="o">=</span> <span class="n">subFont</span><span class="p">;</span>
<a name="gbab-266"></a>      <span class="n">needExtraSetup</span>    <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="gbab-267"></a>    <span class="p">}</span>
<a name="gbab-268"></a>
<a name="gbab-269"></a>    <span class="cm">/* if ppem has changed, we need to recompute some cached data         */</span>
<a name="gbab-270"></a>    <span class="cm">/* note: because of CID font matrix concatenation, ppem and transform */</span>
<a name="gbab-271"></a>    <span class="cm">/*       do not necessarily track.                                    */</span>
<a name="gbab-272"></a>    <span class="n">ppem</span> <span class="o">=</span> <span class="n">cf2_getPpemY</span><span class="p">(</span> <span class="n">decoder</span> <span class="p">);</span>
<a name="gbab-273"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">ppem</span> <span class="o">!=</span> <span class="n">ppem</span> <span class="p">)</span>
<a name="gbab-274"></a>    <span class="p">{</span>
<a name="gbab-275"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">ppem</span>     <span class="o">=</span> <span class="n">ppem</span><span class="p">;</span>
<a name="gbab-276"></a>      <span class="n">needExtraSetup</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="gbab-277"></a>    <span class="p">}</span>
<a name="gbab-278"></a>
<a name="gbab-279"></a>    <span class="cm">/* copy hinted flag on each call */</span>
<a name="gbab-280"></a>    <span class="n">font</span><span class="o">-&gt;</span><span class="n">hinted</span> <span class="o">=</span> <span class="p">(</span><span class="n">FT_Bool</span><span class="p">)(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">renderingFlags</span> <span class="o">&amp;</span> <span class="n">CF2_FlagsHinted</span> <span class="p">);</span>
<a name="gbab-281"></a>
<a name="gbab-282"></a>    <span class="cm">/* determine if transform has changed;       */</span>
<a name="gbab-283"></a>    <span class="cm">/* include Fontmatrix but ignore translation */</span>
<a name="gbab-284"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">ft_memcmp</span><span class="p">(</span> <span class="n">transform</span><span class="p">,</span>
<a name="gbab-285"></a>                    <span class="o">&amp;</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">currentTransform</span><span class="p">,</span>
<a name="gbab-286"></a>                    <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span> <span class="n">CF2_Fixed</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
<a name="gbab-287"></a>    <span class="p">{</span>
<a name="gbab-288"></a>      <span class="cm">/* save `key&#39; information for `cache of one&#39; matrix data; */</span>
<a name="gbab-289"></a>      <span class="cm">/* save client transform, without the translation         */</span>
<a name="gbab-290"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">currentTransform</span>    <span class="o">=</span> <span class="o">*</span><span class="n">transform</span><span class="p">;</span>
<a name="gbab-291"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">currentTransform</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span>
<a name="gbab-292"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">currentTransform</span><span class="p">.</span><span class="n">ty</span> <span class="o">=</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
<a name="gbab-293"></a>
<a name="gbab-294"></a>      <span class="cm">/* TODO: FreeType transform is simple scalar; for now, use identity */</span>
<a name="gbab-295"></a>      <span class="cm">/*       for outer                                                  */</span>
<a name="gbab-296"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">innerTransform</span>   <span class="o">=</span> <span class="o">*</span><span class="n">transform</span><span class="p">;</span>
<a name="gbab-297"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">outerTransform</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span>
<a name="gbab-298"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">outerTransform</span><span class="p">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
<a name="gbab-299"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">outerTransform</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span>
<a name="gbab-300"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">outerTransform</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
<a name="gbab-301"></a>
<a name="gbab-302"></a>      <span class="n">needExtraSetup</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="gbab-303"></a>    <span class="p">}</span>
<a name="gbab-304"></a>
<a name="gbab-305"></a>    <span class="cm">/*</span>
<a name="gbab-306"></a><span class="cm">     * font-&gt;darkened is set to true if there is a stem darkening request or</span>
<a name="gbab-307"></a><span class="cm">     * the font is synthetic emboldened.</span>
<a name="gbab-308"></a><span class="cm">     * font-&gt;darkened controls whether to adjust blue zones, winding order,</span>
<a name="gbab-309"></a><span class="cm">     * and hinting.</span>
<a name="gbab-310"></a><span class="cm">     *</span>
<a name="gbab-311"></a><span class="cm">     */</span>
<a name="gbab-312"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">stemDarkened</span> <span class="o">!=</span> <span class="p">(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">renderingFlags</span> <span class="o">&amp;</span> <span class="n">CF2_FlagsDarkened</span> <span class="p">)</span> <span class="p">)</span>
<a name="gbab-313"></a>    <span class="p">{</span>
<a name="gbab-314"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">stemDarkened</span> <span class="o">=</span>
<a name="gbab-315"></a>        <span class="p">(</span><span class="n">FT_Bool</span><span class="p">)(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">renderingFlags</span> <span class="o">&amp;</span> <span class="n">CF2_FlagsDarkened</span> <span class="p">);</span>
<a name="gbab-316"></a>
<a name="gbab-317"></a>      <span class="cm">/* blue zones depend on darkened flag */</span>
<a name="gbab-318"></a>      <span class="n">needExtraSetup</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="gbab-319"></a>    <span class="p">}</span>
<a name="gbab-320"></a>
<a name="gbab-321"></a>    <span class="cm">/* recompute variables that are dependent on transform or FontDict or */</span>
<a name="gbab-322"></a>    <span class="cm">/* darken flag                                                        */</span>
<a name="gbab-323"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">needExtraSetup</span> <span class="p">)</span>
<a name="gbab-324"></a>    <span class="p">{</span>
<a name="gbab-325"></a>      <span class="cm">/* StdVW is found in the private dictionary;                       */</span>
<a name="gbab-326"></a>      <span class="cm">/* recompute darkening amounts whenever private dictionary or      */</span>
<a name="gbab-327"></a>      <span class="cm">/* transform change                                                */</span>
<a name="gbab-328"></a>      <span class="cm">/* Note: a rendering flag turns darkening on or off, so we want to */</span>
<a name="gbab-329"></a>      <span class="cm">/*       store the `on&#39; amounts;                                   */</span>
<a name="gbab-330"></a>      <span class="cm">/*       darkening amount is computed in character space           */</span>
<a name="gbab-331"></a>      <span class="cm">/* TODO: testing size-dependent darkening here;                    */</span>
<a name="gbab-332"></a>      <span class="cm">/*       what to do for rotations?                                 */</span>
<a name="gbab-333"></a>
<a name="gbab-334"></a>      <span class="n">CF2_Fixed</span>  <span class="n">emRatio</span><span class="p">;</span>
<a name="gbab-335"></a>      <span class="n">CF2_Fixed</span>  <span class="n">stdHW</span><span class="p">;</span>
<a name="gbab-336"></a>      <span class="n">CF2_Int</span>    <span class="n">unitsPerEm</span> <span class="o">=</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">unitsPerEm</span><span class="p">;</span>
<a name="gbab-337"></a>
<a name="gbab-338"></a>
<a name="gbab-339"></a>      <span class="k">if</span> <span class="p">(</span> <span class="n">unitsPerEm</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
<a name="gbab-340"></a>        <span class="n">unitsPerEm</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<a name="gbab-341"></a>
<a name="gbab-342"></a>      <span class="n">ppem</span> <span class="o">=</span> <span class="n">FT_MAX</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="mi">4</span> <span class="p">),</span>
<a name="gbab-343"></a>                     <span class="n">font</span><span class="o">-&gt;</span><span class="n">ppem</span> <span class="p">);</span> <span class="cm">/* use minimum ppem of 4 */</span>
<a name="gbab-344"></a>
<a name="gbab-345"></a><span class="cp">#if 0</span><span class="c"></span>
<a name="gbab-346"></a><span class="c">      /* since vstem is measured in the x-direction, we use the `a&#39; member */</span>
<a name="gbab-347"></a><span class="c">      /* of the fontMatrix                                                 */</span>
<a name="gbab-348"></a><span class="c">      emRatio = cf2_fixedFracMul( cf2_intToFixed( 1000 ), fontMatrix-&gt;a );</span>
<a name="gbab-349"></a><span class="cp">#endif</span>
<a name="gbab-350"></a>
<a name="gbab-351"></a>      <span class="cm">/* Freetype does not preserve the fontMatrix when parsing; use */</span>
<a name="gbab-352"></a>      <span class="cm">/* unitsPerEm instead.                                         */</span>
<a name="gbab-353"></a>      <span class="cm">/* TODO: check precision of this                               */</span>
<a name="gbab-354"></a>      <span class="n">emRatio</span>     <span class="o">=</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="mi">1000</span> <span class="p">)</span> <span class="o">/</span> <span class="n">unitsPerEm</span><span class="p">;</span>
<a name="gbab-355"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">stdVW</span> <span class="o">=</span> <span class="n">cf2_getStdVW</span><span class="p">(</span> <span class="n">decoder</span> <span class="p">);</span>
<a name="gbab-356"></a>
<a name="gbab-357"></a>      <span class="k">if</span> <span class="p">(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">stdVW</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
<a name="gbab-358"></a>        <span class="n">font</span><span class="o">-&gt;</span><span class="n">stdVW</span> <span class="o">=</span> <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="mi">75</span> <span class="p">),</span> <span class="n">emRatio</span> <span class="p">);</span>
<a name="gbab-359"></a>
<a name="gbab-360"></a>      <span class="k">if</span> <span class="p">(</span> <span class="n">boldenX</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
<a name="gbab-361"></a>      <span class="p">{</span>
<a name="gbab-362"></a>        <span class="cm">/* Ensure that boldenX is at least 1 pixel for synthetic bold font */</span>
<a name="gbab-363"></a>        <span class="cm">/* (similar to what Avalon does)                                   */</span>
<a name="gbab-364"></a>        <span class="n">boldenX</span> <span class="o">=</span> <span class="n">FT_MAX</span><span class="p">(</span> <span class="n">boldenX</span><span class="p">,</span>
<a name="gbab-365"></a>                          <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="n">unitsPerEm</span> <span class="p">),</span> <span class="n">ppem</span> <span class="p">)</span> <span class="p">);</span>
<a name="gbab-366"></a>
<a name="gbab-367"></a>        <span class="cm">/* Synthetic emboldening adds at least 1 pixel to darkenX, while */</span>
<a name="gbab-368"></a>        <span class="cm">/* stem darkening adds at most half pixel.  Since the purpose of */</span>
<a name="gbab-369"></a>        <span class="cm">/* stem darkening (readability at small sizes) is met with       */</span>
<a name="gbab-370"></a>        <span class="cm">/* synthetic emboldening, no need to add stem darkening for a    */</span>
<a name="gbab-371"></a>        <span class="cm">/* synthetic bold font.                                          */</span>
<a name="gbab-372"></a>        <span class="n">cf2_computeDarkening</span><span class="p">(</span> <span class="n">emRatio</span><span class="p">,</span>
<a name="gbab-373"></a>                              <span class="n">ppem</span><span class="p">,</span>
<a name="gbab-374"></a>                              <span class="n">font</span><span class="o">-&gt;</span><span class="n">stdVW</span><span class="p">,</span>
<a name="gbab-375"></a>                              <span class="o">&amp;</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">darkenX</span><span class="p">,</span>
<a name="gbab-376"></a>                              <span class="n">boldenX</span><span class="p">,</span>
<a name="gbab-377"></a>                              <span class="n">FALSE</span><span class="p">,</span>
<a name="gbab-378"></a>                              <span class="n">font</span><span class="o">-&gt;</span><span class="n">darkenParams</span> <span class="p">);</span>
<a name="gbab-379"></a>      <span class="p">}</span>
<a name="gbab-380"></a>      <span class="k">else</span>
<a name="gbab-381"></a>        <span class="n">cf2_computeDarkening</span><span class="p">(</span> <span class="n">emRatio</span><span class="p">,</span>
<a name="gbab-382"></a>                              <span class="n">ppem</span><span class="p">,</span>
<a name="gbab-383"></a>                              <span class="n">font</span><span class="o">-&gt;</span><span class="n">stdVW</span><span class="p">,</span>
<a name="gbab-384"></a>                              <span class="o">&amp;</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">darkenX</span><span class="p">,</span>
<a name="gbab-385"></a>                              <span class="mi">0</span><span class="p">,</span>
<a name="gbab-386"></a>                              <span class="n">font</span><span class="o">-&gt;</span><span class="n">stemDarkened</span><span class="p">,</span>
<a name="gbab-387"></a>                              <span class="n">font</span><span class="o">-&gt;</span><span class="n">darkenParams</span> <span class="p">);</span>
<a name="gbab-388"></a>
<a name="gbab-389"></a><span class="cp">#if 0</span><span class="c"></span>
<a name="gbab-390"></a><span class="c">      /* since hstem is measured in the y-direction, we use the `d&#39; member */</span>
<a name="gbab-391"></a><span class="c">      /* of the fontMatrix                                                 */</span>
<a name="gbab-392"></a><span class="c">      /* TODO: use the same units per em as above; check this              */</span>
<a name="gbab-393"></a><span class="c">      emRatio = cf2_fixedFracMul( cf2_intToFixed( 1000 ), fontMatrix-&gt;d );</span>
<a name="gbab-394"></a><span class="cp">#endif</span>
<a name="gbab-395"></a>
<a name="gbab-396"></a>      <span class="cm">/* set the default stem width, because it must be the same for all */</span>
<a name="gbab-397"></a>      <span class="cm">/* family members;                                                 */</span>
<a name="gbab-398"></a>      <span class="cm">/* choose a constant for StdHW that depends on font contrast       */</span>
<a name="gbab-399"></a>      <span class="n">stdHW</span> <span class="o">=</span> <span class="n">cf2_getStdHW</span><span class="p">(</span> <span class="n">decoder</span> <span class="p">);</span>
<a name="gbab-400"></a>
<a name="gbab-401"></a>      <span class="k">if</span> <span class="p">(</span> <span class="n">stdHW</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">stdVW</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">stdHW</span> <span class="p">)</span>
<a name="gbab-402"></a>        <span class="n">font</span><span class="o">-&gt;</span><span class="n">stdHW</span> <span class="o">=</span> <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="mi">75</span> <span class="p">),</span> <span class="n">emRatio</span> <span class="p">);</span>
<a name="gbab-403"></a>      <span class="k">else</span>
<a name="gbab-404"></a>      <span class="p">{</span>
<a name="gbab-405"></a>        <span class="cm">/* low contrast font gets less hstem darkening */</span>
<a name="gbab-406"></a>        <span class="n">font</span><span class="o">-&gt;</span><span class="n">stdHW</span> <span class="o">=</span> <span class="n">FT_DivFix</span><span class="p">(</span> <span class="n">cf2_intToFixed</span><span class="p">(</span> <span class="mi">110</span> <span class="p">),</span> <span class="n">emRatio</span> <span class="p">);</span>
<a name="gbab-407"></a>      <span class="p">}</span>
<a name="gbab-408"></a>
<a name="gbab-409"></a>      <span class="n">cf2_computeDarkening</span><span class="p">(</span> <span class="n">emRatio</span><span class="p">,</span>
<a name="gbab-410"></a>                            <span class="n">ppem</span><span class="p">,</span>
<a name="gbab-411"></a>                            <span class="n">font</span><span class="o">-&gt;</span><span class="n">stdHW</span><span class="p">,</span>
<a name="gbab-412"></a>                            <span class="o">&amp;</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">darkenY</span><span class="p">,</span>
<a name="gbab-413"></a>                            <span class="n">boldenY</span><span class="p">,</span>
<a name="gbab-414"></a>                            <span class="n">font</span><span class="o">-&gt;</span><span class="n">stemDarkened</span><span class="p">,</span>
<a name="gbab-415"></a>                            <span class="n">font</span><span class="o">-&gt;</span><span class="n">darkenParams</span> <span class="p">);</span>
<a name="gbab-416"></a>
<a name="gbab-417"></a>      <span class="k">if</span> <span class="p">(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">darkenX</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">darkenY</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
<a name="gbab-418"></a>        <span class="n">font</span><span class="o">-&gt;</span><span class="n">darkened</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="gbab-419"></a>      <span class="k">else</span>
<a name="gbab-420"></a>        <span class="n">font</span><span class="o">-&gt;</span><span class="n">darkened</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<a name="gbab-421"></a>
<a name="gbab-422"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">reverseWinding</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="cm">/* initial expectation is CCW */</span>
<a name="gbab-423"></a>
<a name="gbab-424"></a>      <span class="cm">/* compute blue zones for this instance */</span>
<a name="gbab-425"></a>      <span class="n">cf2_blues_init</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">blues</span><span class="p">,</span> <span class="n">font</span> <span class="p">);</span>
<a name="gbab-426"></a>    <span class="p">}</span>
<a name="gbab-427"></a>  <span class="p">}</span>
<a name="gbab-428"></a>
<a name="gbab-429"></a>
<a name="gbab-430"></a>  <span class="cm">/* equivalent to AdobeGetOutline */</span>
<a name="gbab-431"></a>  <span class="n">FT_LOCAL_DEF</span><span class="p">(</span> <span class="n">FT_Error</span> <span class="p">)</span>
<a name="gbab-432"></a>  <span class="n">cf2_getGlyphOutline</span><span class="p">(</span> <span class="n">CF2_Font</span>           <span class="n">font</span><span class="p">,</span>
<a name="gbab-433"></a>                       <span class="n">CF2_Buffer</span>         <span class="n">charstring</span><span class="p">,</span>
<a name="gbab-434"></a>                       <span class="k">const</span> <span class="n">CF2_Matrix</span><span class="o">*</span>  <span class="n">transform</span><span class="p">,</span>
<a name="gbab-435"></a>                       <span class="n">CF2_F16Dot16</span><span class="o">*</span>      <span class="n">glyphWidth</span> <span class="p">)</span>
<a name="gbab-436"></a>  <span class="p">{</span>
<a name="gbab-437"></a>    <span class="n">FT_Error</span>  <span class="n">lastError</span> <span class="o">=</span> <span class="n">FT_Err_Ok</span><span class="p">;</span>
<a name="gbab-438"></a>
<a name="gbab-439"></a>    <span class="n">FT_Vector</span>  <span class="n">translation</span><span class="p">;</span>
<a name="gbab-440"></a>
<a name="gbab-441"></a><span class="cp">#if 0</span><span class="c"></span>
<a name="gbab-442"></a><span class="c">    FT_Vector  advancePoint;</span>
<a name="gbab-443"></a><span class="cp">#endif</span>
<a name="gbab-444"></a>
<a name="gbab-445"></a>    <span class="n">CF2_Fixed</span>  <span class="n">advWidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-446"></a>    <span class="n">FT_Bool</span>    <span class="n">needWinding</span><span class="p">;</span>
<a name="gbab-447"></a>
<a name="gbab-448"></a>
<a name="gbab-449"></a>    <span class="cm">/* Note: use both integer and fraction for outlines.  This allows bbox */</span>
<a name="gbab-450"></a>    <span class="cm">/*       to come out directly.                                         */</span>
<a name="gbab-451"></a>
<a name="gbab-452"></a>    <span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">transform</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>
<a name="gbab-453"></a>    <span class="n">translation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">transform</span><span class="o">-&gt;</span><span class="n">ty</span><span class="p">;</span>
<a name="gbab-454"></a>
<a name="gbab-455"></a>    <span class="cm">/* set up values based on transform */</span>
<a name="gbab-456"></a>    <span class="n">cf2_font_setup</span><span class="p">(</span> <span class="n">font</span><span class="p">,</span> <span class="n">transform</span> <span class="p">);</span>
<a name="gbab-457"></a>    <span class="k">if</span> <span class="p">(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">error</span> <span class="p">)</span>
<a name="gbab-458"></a>      <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>                      <span class="cm">/* setup encountered an error */</span>
<a name="gbab-459"></a>
<a name="gbab-460"></a>    <span class="cm">/* reset darken direction */</span>
<a name="gbab-461"></a>    <span class="n">font</span><span class="o">-&gt;</span><span class="n">reverseWinding</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<a name="gbab-462"></a>
<a name="gbab-463"></a>    <span class="cm">/* winding order only affects darkening */</span>
<a name="gbab-464"></a>    <span class="n">needWinding</span> <span class="o">=</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">darkened</span><span class="p">;</span>
<a name="gbab-465"></a>
<a name="gbab-466"></a>    <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
<a name="gbab-467"></a>    <span class="p">{</span>
<a name="gbab-468"></a>      <span class="cm">/* reset output buffer */</span>
<a name="gbab-469"></a>      <span class="n">cf2_outline_reset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">outline</span> <span class="p">);</span>
<a name="gbab-470"></a>
<a name="gbab-471"></a>      <span class="cm">/* build the outline, passing the full translation */</span>
<a name="gbab-472"></a>      <span class="n">cf2_interpT2CharString</span><span class="p">(</span> <span class="n">font</span><span class="p">,</span>
<a name="gbab-473"></a>                              <span class="n">charstring</span><span class="p">,</span>
<a name="gbab-474"></a>                              <span class="p">(</span><span class="n">CF2_OutlineCallbacks</span><span class="p">)</span><span class="o">&amp;</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">outline</span><span class="p">,</span>
<a name="gbab-475"></a>                              <span class="o">&amp;</span><span class="n">translation</span><span class="p">,</span>
<a name="gbab-476"></a>                              <span class="n">FALSE</span><span class="p">,</span>
<a name="gbab-477"></a>                              <span class="mi">0</span><span class="p">,</span>
<a name="gbab-478"></a>                              <span class="mi">0</span><span class="p">,</span>
<a name="gbab-479"></a>                              <span class="o">&amp;</span><span class="n">advWidth</span> <span class="p">);</span>
<a name="gbab-480"></a>
<a name="gbab-481"></a>      <span class="k">if</span> <span class="p">(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">error</span> <span class="p">)</span>
<a name="gbab-482"></a>        <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
<a name="gbab-483"></a>
<a name="gbab-484"></a>      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">needWinding</span> <span class="p">)</span>
<a name="gbab-485"></a>        <span class="k">break</span><span class="p">;</span>
<a name="gbab-486"></a>
<a name="gbab-487"></a>      <span class="cm">/* check winding order */</span>
<a name="gbab-488"></a>      <span class="k">if</span> <span class="p">(</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">outline</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">windingMomentum</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="cm">/* CFF is CCW */</span>
<a name="gbab-489"></a>        <span class="k">break</span><span class="p">;</span>
<a name="gbab-490"></a>
<a name="gbab-491"></a>      <span class="cm">/* invert darkening and render again                            */</span>
<a name="gbab-492"></a>      <span class="cm">/* TODO: this should be a parameter to getOutline-computeOffset */</span>
<a name="gbab-493"></a>      <span class="n">font</span><span class="o">-&gt;</span><span class="n">reverseWinding</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<a name="gbab-494"></a>
<a name="gbab-495"></a>      <span class="n">needWinding</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>    <span class="cm">/* exit after next iteration */</span>
<a name="gbab-496"></a>    <span class="p">}</span>
<a name="gbab-497"></a>
<a name="gbab-498"></a>    <span class="cm">/* finish storing client outline */</span>
<a name="gbab-499"></a>    <span class="n">cf2_outline_close</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">outline</span> <span class="p">);</span>
<a name="gbab-500"></a>
<a name="gbab-501"></a>  <span class="nl">exit</span><span class="p">:</span>
<a name="gbab-502"></a>    <span class="cm">/* FreeType just wants the advance width; there is no translation */</span>
<a name="gbab-503"></a>    <span class="o">*</span><span class="n">glyphWidth</span> <span class="o">=</span> <span class="n">advWidth</span><span class="p">;</span>
<a name="gbab-504"></a>
<a name="gbab-505"></a>    <span class="cm">/* free resources and collect errors from objects we&#39;ve used */</span>
<a name="gbab-506"></a>    <span class="n">cf2_setError</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">font</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">,</span> <span class="n">lastError</span> <span class="p">);</span>
<a name="gbab-507"></a>
<a name="gbab-508"></a>    <span class="k">return</span> <span class="n">font</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
<a name="gbab-509"></a>  <span class="p">}</span>
<a name="gbab-510"></a>
<a name="gbab-511"></a>
<a name="gbab-512"></a><span class="cm">/* END */</span>
</pre></div>
</td></tr></table>