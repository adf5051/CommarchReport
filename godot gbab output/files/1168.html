<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="gbab-1"></a><span class="cm">/* crc32.c -- compute the CRC-32 of a data stream</span>
<a name="gbab-2"></a><span class="cm"> * Copyright (C) 1995-2006, 2010, 2011, 2012 Mark Adler</span>
<a name="gbab-3"></a><span class="cm"> * For conditions of distribution and use, see copyright notice in zlib.h</span>
<a name="gbab-4"></a><span class="cm"> *</span>
<a name="gbab-5"></a><span class="cm"> * Thanks to Rodney Brown &lt;rbrown64@csc.com.au&gt; for his contribution of faster</span>
<a name="gbab-6"></a><span class="cm"> * CRC methods: exclusive-oring 32 bits of data at a time, and pre-computing</span>
<a name="gbab-7"></a><span class="cm"> * tables for updating the shift register in one step with three exclusive-ors</span>
<a name="gbab-8"></a><span class="cm"> * instead of four steps with four exclusive-ors.  This results in about a</span>
<a name="gbab-9"></a><span class="cm"> * factor of two increase in speed on a Power PC G4 (PPC7455) using gcc -O3.</span>
<a name="gbab-10"></a><span class="cm"> */</span>
<a name="gbab-11"></a>
<a name="gbab-12"></a><span class="cm">/* @(#) $Id$ */</span>
<a name="gbab-13"></a>
<a name="gbab-14"></a><span class="cm">/*</span>
<a name="gbab-15"></a><span class="cm">  Note on the use of DYNAMIC_CRC_TABLE: there is no mutex or semaphore</span>
<a name="gbab-16"></a><span class="cm">  protection on the static variables used to control the first-use generation</span>
<a name="gbab-17"></a><span class="cm">  of the crc tables.  Therefore, if you #define DYNAMIC_CRC_TABLE, you should</span>
<a name="gbab-18"></a><span class="cm">  first call get_crc_table() to initialize the tables before allowing more than</span>
<a name="gbab-19"></a><span class="cm">  one thread to use crc32().</span>
<a name="gbab-20"></a>
<a name="gbab-21"></a><span class="cm">  DYNAMIC_CRC_TABLE and MAKECRCH can be #defined to write out crc32.h.</span>
<a name="gbab-22"></a><span class="cm"> */</span>
<a name="gbab-23"></a>
<a name="gbab-24"></a><span class="cp">#ifdef MAKECRCH</span>
<a name="gbab-25"></a><span class="cp">#  include &lt;stdio.h&gt;</span>
<a name="gbab-26"></a><span class="cp">#  ifndef DYNAMIC_CRC_TABLE</span>
<a name="gbab-27"></a><span class="cp">#    define DYNAMIC_CRC_TABLE</span>
<a name="gbab-28"></a><span class="cp">#  endif </span><span class="cm">/* !DYNAMIC_CRC_TABLE */</span><span class="cp"></span>
<a name="gbab-29"></a><span class="cp">#endif </span><span class="cm">/* MAKECRCH */</span><span class="cp"></span>
<a name="gbab-30"></a>
<a name="gbab-31"></a><span class="cp">#include</span> <span class="cpf">&quot;zutil.h&quot;      /* for STDC and FAR definitions */</span><span class="cp"></span>
<a name="gbab-32"></a>
<a name="gbab-33"></a><span class="cp">#define local static</span>
<a name="gbab-34"></a>
<a name="gbab-35"></a><span class="cm">/* Definitions for doing the crc four data bytes at a time. */</span>
<a name="gbab-36"></a><span class="cp">#if !defined(NOBYFOUR) &amp;&amp; defined(Z_U4)</span>
<a name="gbab-37"></a><span class="cp">#  define BYFOUR</span>
<a name="gbab-38"></a><span class="cp">#endif</span>
<a name="gbab-39"></a><span class="cp">#ifdef BYFOUR</span>
<a name="gbab-40"></a>   <span class="n">local</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crc32_little</span> <span class="nf">OF</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span>
<a name="gbab-41"></a>                        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">));</span>
<a name="gbab-42"></a>   <span class="n">local</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crc32_big</span> <span class="nf">OF</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span>
<a name="gbab-43"></a>                        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">));</span>
<a name="gbab-44"></a><span class="cp">#  define TBLS 8</span>
<a name="gbab-45"></a><span class="cp">#else</span>
<a name="gbab-46"></a><span class="cp">#  define TBLS 1</span>
<a name="gbab-47"></a><span class="cp">#endif </span><span class="cm">/* BYFOUR */</span><span class="cp"></span>
<a name="gbab-48"></a>
<a name="gbab-49"></a><span class="cm">/* Local functions for crc concatenation */</span>
<a name="gbab-50"></a><span class="n">local</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gf2_matrix_times</span> <span class="nf">OF</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mat</span><span class="p">,</span>
<a name="gbab-51"></a>                                         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vec</span><span class="p">));</span>
<a name="gbab-52"></a><span class="n">local</span> <span class="kt">void</span> <span class="n">gf2_matrix_square</span> <span class="nf">OF</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">square</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mat</span><span class="p">));</span>
<a name="gbab-53"></a><span class="n">local</span> <span class="n">uLong</span> <span class="n">crc32_combine_</span> <span class="nf">OF</span><span class="p">((</span><span class="n">uLong</span> <span class="n">crc1</span><span class="p">,</span> <span class="n">uLong</span> <span class="n">crc2</span><span class="p">,</span> <span class="n">z_off64_t</span> <span class="n">len2</span><span class="p">));</span>
<a name="gbab-54"></a>
<a name="gbab-55"></a>
<a name="gbab-56"></a><span class="cp">#ifdef DYNAMIC_CRC_TABLE</span>
<a name="gbab-57"></a>
<a name="gbab-58"></a><span class="n">local</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">crc_table_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-59"></a><span class="n">local</span> <span class="n">z_crc_t</span> <span class="n">FAR</span> <span class="n">crc_table</span><span class="p">[</span><span class="n">TBLS</span><span class="p">][</span><span class="mi">256</span><span class="p">];</span>
<a name="gbab-60"></a><span class="n">local</span> <span class="kt">void</span> <span class="n">make_crc_table</span> <span class="nf">OF</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="gbab-61"></a><span class="cp">#ifdef MAKECRCH</span>
<a name="gbab-62"></a>   <span class="n">local</span> <span class="kt">void</span> <span class="n">write_table</span> <span class="nf">OF</span><span class="p">((</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">z_crc_t</span> <span class="n">FAR</span> <span class="o">*</span><span class="p">));</span>
<a name="gbab-63"></a><span class="cp">#endif </span><span class="cm">/* MAKECRCH */</span><span class="cp"></span>
<a name="gbab-64"></a><span class="cm">/*</span>
<a name="gbab-65"></a><span class="cm">  Generate tables for a byte-wise 32-bit CRC calculation on the polynomial:</span>
<a name="gbab-66"></a><span class="cm">  x^32+x^26+x^23+x^22+x^16+x^12+x^11+x^10+x^8+x^7+x^5+x^4+x^2+x+1.</span>
<a name="gbab-67"></a>
<a name="gbab-68"></a><span class="cm">  Polynomials over GF(2) are represented in binary, one bit per coefficient,</span>
<a name="gbab-69"></a><span class="cm">  with the lowest powers in the most significant bit.  Then adding polynomials</span>
<a name="gbab-70"></a><span class="cm">  is just exclusive-or, and multiplying a polynomial by x is a right shift by</span>
<a name="gbab-71"></a><span class="cm">  one.  If we call the above polynomial p, and represent a byte as the</span>
<a name="gbab-72"></a><span class="cm">  polynomial q, also with the lowest power in the most significant bit (so the</span>
<a name="gbab-73"></a><span class="cm">  byte 0xb1 is the polynomial x^7+x^3+x+1), then the CRC is (q*x^32) mod p,</span>
<a name="gbab-74"></a><span class="cm">  where a mod b means the remainder after dividing a by b.</span>
<a name="gbab-75"></a>
<a name="gbab-76"></a><span class="cm">  This calculation is done using the shift-register method of multiplying and</span>
<a name="gbab-77"></a><span class="cm">  taking the remainder.  The register is initialized to zero, and for each</span>
<a name="gbab-78"></a><span class="cm">  incoming bit, x^32 is added mod p to the register if the bit is a one (where</span>
<a name="gbab-79"></a><span class="cm">  x^32 mod p is p+x^32 = x^26+...+1), and the register is multiplied mod p by</span>
<a name="gbab-80"></a><span class="cm">  x (which is shifting right by one and adding x^32 mod p if the bit shifted</span>
<a name="gbab-81"></a><span class="cm">  out is a one).  We start with the highest power (least significant bit) of</span>
<a name="gbab-82"></a><span class="cm">  q and repeat for all eight bits of q.</span>
<a name="gbab-83"></a>
<a name="gbab-84"></a><span class="cm">  The first table is simply the CRC of all possible eight bit values.  This is</span>
<a name="gbab-85"></a><span class="cm">  all the information needed to generate CRCs on data a byte at a time for all</span>
<a name="gbab-86"></a><span class="cm">  combinations of CRC register values and incoming bytes.  The remaining tables</span>
<a name="gbab-87"></a><span class="cm">  allow for word-at-a-time CRC calculation for both big-endian and little-</span>
<a name="gbab-88"></a><span class="cm">  endian machines, where a word is four bytes.</span>
<a name="gbab-89"></a><span class="cm">*/</span>
<a name="gbab-90"></a><span class="n">local</span> <span class="kt">void</span> <span class="nf">make_crc_table</span><span class="p">()</span>
<a name="gbab-91"></a><span class="p">{</span>
<a name="gbab-92"></a>    <span class="n">z_crc_t</span> <span class="n">c</span><span class="p">;</span>
<a name="gbab-93"></a>    <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
<a name="gbab-94"></a>    <span class="n">z_crc_t</span> <span class="n">poly</span><span class="p">;</span>                       <span class="cm">/* polynomial exclusive-or pattern */</span>
<a name="gbab-95"></a>    <span class="cm">/* terms of polynomial defining this crc (except x^32): */</span>
<a name="gbab-96"></a>    <span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>      <span class="cm">/* flag to limit concurrent making */</span>
<a name="gbab-97"></a>    <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">26</span><span class="p">};</span>
<a name="gbab-98"></a>
<a name="gbab-99"></a>    <span class="cm">/* See if another task is already doing this (not thread-safe, but better</span>
<a name="gbab-100"></a><span class="cm">       than nothing -- significantly reduces duration of vulnerability in</span>
<a name="gbab-101"></a><span class="cm">       case the advice about DYNAMIC_CRC_TABLE is ignored) */</span>
<a name="gbab-102"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-103"></a>        <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-104"></a>
<a name="gbab-105"></a>        <span class="cm">/* make exclusive-or pattern from polynomial (0xedb88320UL) */</span>
<a name="gbab-106"></a>        <span class="n">poly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-107"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">));</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
<a name="gbab-108"></a>            <span class="n">poly</span> <span class="o">|=</span> <span class="p">(</span><span class="n">z_crc_t</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
<a name="gbab-109"></a>
<a name="gbab-110"></a>        <span class="cm">/* generate a crc for every 8-bit value */</span>
<a name="gbab-111"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-112"></a>            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_crc_t</span><span class="p">)</span><span class="n">n</span><span class="p">;</span>
<a name="gbab-113"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a name="gbab-114"></a>                <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">poly</span> <span class="o">^</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-115"></a>            <span class="n">crc_table</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<a name="gbab-116"></a>        <span class="p">}</span>
<a name="gbab-117"></a>
<a name="gbab-118"></a><span class="cp">#ifdef BYFOUR</span>
<a name="gbab-119"></a>        <span class="cm">/* generate crc for each value followed by one, two, and three zeros,</span>
<a name="gbab-120"></a><span class="cm">           and then the byte reversal of those as well as the first table */</span>
<a name="gbab-121"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-122"></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">crc_table</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">];</span>
<a name="gbab-123"></a>            <span class="n">crc_table</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZSWAP32</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<a name="gbab-124"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-125"></a>                <span class="n">c</span> <span class="o">=</span> <span class="n">crc_table</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
<a name="gbab-126"></a>                <span class="n">crc_table</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<a name="gbab-127"></a>                <span class="n">crc_table</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">4</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZSWAP32</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<a name="gbab-128"></a>            <span class="p">}</span>
<a name="gbab-129"></a>        <span class="p">}</span>
<a name="gbab-130"></a><span class="cp">#endif </span><span class="cm">/* BYFOUR */</span><span class="cp"></span>
<a name="gbab-131"></a>
<a name="gbab-132"></a>        <span class="n">crc_table_empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-133"></a>    <span class="p">}</span>
<a name="gbab-134"></a>    <span class="k">else</span> <span class="p">{</span>      <span class="cm">/* not first */</span>
<a name="gbab-135"></a>        <span class="cm">/* wait for the other guy to finish (not efficient, but rare) */</span>
<a name="gbab-136"></a>        <span class="k">while</span> <span class="p">(</span><span class="n">crc_table_empty</span><span class="p">)</span>
<a name="gbab-137"></a>            <span class="p">;</span>
<a name="gbab-138"></a>    <span class="p">}</span>
<a name="gbab-139"></a>
<a name="gbab-140"></a><span class="cp">#ifdef MAKECRCH</span>
<a name="gbab-141"></a>    <span class="cm">/* write out CRC tables to crc32.h */</span>
<a name="gbab-142"></a>    <span class="p">{</span>
<a name="gbab-143"></a>        <span class="kt">FILE</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>
<a name="gbab-144"></a>
<a name="gbab-145"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;crc32.h&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
<a name="gbab-146"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<a name="gbab-147"></a>        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;/* crc32.h -- tables for rapid CRC calculation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a name="gbab-148"></a>        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot; * Generated automatically by crc32.c</span><span class="se">\n</span><span class="s"> */</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<a name="gbab-149"></a>        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;local const z_crc_t FAR &quot;</span><span class="p">);</span>
<a name="gbab-150"></a>        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;crc_table[TBLS][256] =</span><span class="se">\n</span><span class="s">{</span><span class="se">\n</span><span class="s">  {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a name="gbab-151"></a>        <span class="n">write_table</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">crc_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="gbab-152"></a><span class="cp">#  ifdef BYFOUR</span>
<a name="gbab-153"></a>        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;#ifdef BYFOUR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a name="gbab-154"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-155"></a>            <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;  },</span><span class="se">\n</span><span class="s">  {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a name="gbab-156"></a>            <span class="n">write_table</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">crc_table</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
<a name="gbab-157"></a>        <span class="p">}</span>
<a name="gbab-158"></a>        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;#endif</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a name="gbab-159"></a><span class="cp">#  endif </span><span class="cm">/* BYFOUR */</span><span class="cp"></span>
<a name="gbab-160"></a>        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;  }</span><span class="se">\n</span><span class="s">};</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a name="gbab-161"></a>        <span class="n">fclose</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<a name="gbab-162"></a>    <span class="p">}</span>
<a name="gbab-163"></a><span class="cp">#endif </span><span class="cm">/* MAKECRCH */</span><span class="cp"></span>
<a name="gbab-164"></a><span class="p">}</span>
<a name="gbab-165"></a>
<a name="gbab-166"></a><span class="cp">#ifdef MAKECRCH</span>
<a name="gbab-167"></a><span class="n">local</span> <span class="kt">void</span> <span class="nf">write_table</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
<a name="gbab-168"></a>    <span class="kt">FILE</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>
<a name="gbab-169"></a>    <span class="k">const</span> <span class="n">z_crc_t</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
<a name="gbab-170"></a><span class="p">{</span>
<a name="gbab-171"></a>    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
<a name="gbab-172"></a>
<a name="gbab-173"></a>    <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
<a name="gbab-174"></a>        <span class="n">fprintf</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">&quot;%s0x%08lxUL%s&quot;</span><span class="p">,</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;    &quot;</span><span class="p">,</span>
<a name="gbab-175"></a>                <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">table</span><span class="p">[</span><span class="n">n</span><span class="p">]),</span>
<a name="gbab-176"></a>                <span class="n">n</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="s">&quot;,</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;, &quot;</span><span class="p">));</span>
<a name="gbab-177"></a><span class="p">}</span>
<a name="gbab-178"></a><span class="cp">#endif </span><span class="cm">/* MAKECRCH */</span><span class="cp"></span>
<a name="gbab-179"></a>
<a name="gbab-180"></a><span class="cp">#else </span><span class="cm">/* !DYNAMIC_CRC_TABLE */</span><span class="cp"></span>
<a name="gbab-181"></a><span class="cm">/* ========================================================================</span>
<a name="gbab-182"></a><span class="cm"> * Tables of CRC-32s of all single-byte values, made by make_crc_table().</span>
<a name="gbab-183"></a><span class="cm"> */</span>
<a name="gbab-184"></a><span class="cp">#include</span> <span class="cpf">&quot;crc32.h&quot;</span><span class="cp"></span>
<a name="gbab-185"></a><span class="cp">#endif </span><span class="cm">/* DYNAMIC_CRC_TABLE */</span><span class="cp"></span>
<a name="gbab-186"></a>
<a name="gbab-187"></a><span class="cm">/* =========================================================================</span>
<a name="gbab-188"></a><span class="cm"> * This function can be used by asm versions of crc32()</span>
<a name="gbab-189"></a><span class="cm"> */</span>
<a name="gbab-190"></a><span class="k">const</span> <span class="n">z_crc_t</span> <span class="n">FAR</span> <span class="o">*</span> <span class="n">ZEXPORT</span> <span class="n">get_crc_table</span><span class="p">()</span>
<a name="gbab-191"></a><span class="p">{</span>
<a name="gbab-192"></a><span class="cp">#ifdef DYNAMIC_CRC_TABLE</span>
<a name="gbab-193"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">crc_table_empty</span><span class="p">)</span>
<a name="gbab-194"></a>        <span class="n">make_crc_table</span><span class="p">();</span>
<a name="gbab-195"></a><span class="cp">#endif </span><span class="cm">/* DYNAMIC_CRC_TABLE */</span><span class="cp"></span>
<a name="gbab-196"></a>    <span class="k">return</span> <span class="p">(</span><span class="k">const</span> <span class="n">z_crc_t</span> <span class="n">FAR</span> <span class="o">*</span><span class="p">)</span><span class="n">crc_table</span><span class="p">;</span>
<a name="gbab-197"></a><span class="p">}</span>
<a name="gbab-198"></a>
<a name="gbab-199"></a><span class="cm">/* ========================================================================= */</span>
<a name="gbab-200"></a><span class="cp">#define DO1 crc = crc_table[0][((int)crc ^ (*buf++)) &amp; 0xff] ^ (crc &gt;&gt; 8)</span>
<a name="gbab-201"></a><span class="cp">#define DO8 DO1; DO1; DO1; DO1; DO1; DO1; DO1; DO1</span>
<a name="gbab-202"></a>
<a name="gbab-203"></a><span class="cm">/* ========================================================================= */</span>
<a name="gbab-204"></a><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ZEXPORT</span> <span class="n">crc32</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span>
<a name="gbab-205"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crc</span><span class="p">;</span>
<a name="gbab-206"></a>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<a name="gbab-207"></a>    <span class="n">uInt</span> <span class="n">len</span><span class="p">;</span>
<a name="gbab-208"></a><span class="p">{</span>
<a name="gbab-209"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="n">Z_NULL</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0UL</span><span class="p">;</span>
<a name="gbab-210"></a>
<a name="gbab-211"></a><span class="cp">#ifdef DYNAMIC_CRC_TABLE</span>
<a name="gbab-212"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">crc_table_empty</span><span class="p">)</span>
<a name="gbab-213"></a>        <span class="n">make_crc_table</span><span class="p">();</span>
<a name="gbab-214"></a><span class="cp">#endif </span><span class="cm">/* DYNAMIC_CRC_TABLE */</span><span class="cp"></span>
<a name="gbab-215"></a>
<a name="gbab-216"></a><span class="cp">#ifdef BYFOUR</span>
<a name="gbab-217"></a>    <span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">ptrdiff_t</span><span class="p">))</span> <span class="p">{</span>
<a name="gbab-218"></a>        <span class="n">z_crc_t</span> <span class="n">endian</span><span class="p">;</span>
<a name="gbab-219"></a>
<a name="gbab-220"></a>        <span class="n">endian</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-221"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">endian</span><span class="p">)))</span>
<a name="gbab-222"></a>            <span class="k">return</span> <span class="n">crc32_little</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="gbab-223"></a>        <span class="k">else</span>
<a name="gbab-224"></a>            <span class="k">return</span> <span class="nf">crc32_big</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="gbab-225"></a>    <span class="p">}</span>
<a name="gbab-226"></a><span class="cp">#endif </span><span class="cm">/* BYFOUR */</span><span class="cp"></span>
<a name="gbab-227"></a>    <span class="n">crc</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">^</span> <span class="mh">0xffffffffUL</span><span class="p">;</span>
<a name="gbab-228"></a>    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-229"></a>        <span class="n">DO8</span><span class="p">;</span>
<a name="gbab-230"></a>        <span class="n">len</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
<a name="gbab-231"></a>    <span class="p">}</span>
<a name="gbab-232"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="k">do</span> <span class="p">{</span>
<a name="gbab-233"></a>        <span class="n">DO1</span><span class="p">;</span>
<a name="gbab-234"></a>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">len</span><span class="p">);</span>
<a name="gbab-235"></a>    <span class="k">return</span> <span class="n">crc</span> <span class="o">^</span> <span class="mh">0xffffffffUL</span><span class="p">;</span>
<a name="gbab-236"></a><span class="p">}</span>
<a name="gbab-237"></a>
<a name="gbab-238"></a><span class="cp">#ifdef BYFOUR</span>
<a name="gbab-239"></a>
<a name="gbab-240"></a><span class="cm">/* ========================================================================= */</span>
<a name="gbab-241"></a><span class="cp">#define DOLIT4 c ^= *buf4++; \</span>
<a name="gbab-242"></a><span class="cp">        c = crc_table[3][c &amp; 0xff] ^ crc_table[2][(c &gt;&gt; 8) &amp; 0xff] ^ \</span>
<a name="gbab-243"></a><span class="cp">            crc_table[1][(c &gt;&gt; 16) &amp; 0xff] ^ crc_table[0][c &gt;&gt; 24]</span>
<a name="gbab-244"></a><span class="cp">#define DOLIT32 DOLIT4; DOLIT4; DOLIT4; DOLIT4; DOLIT4; DOLIT4; DOLIT4; DOLIT4</span>
<a name="gbab-245"></a>
<a name="gbab-246"></a><span class="cm">/* ========================================================================= */</span>
<a name="gbab-247"></a><span class="n">local</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crc32_little</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span>
<a name="gbab-248"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crc</span><span class="p">;</span>
<a name="gbab-249"></a>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<a name="gbab-250"></a>    <span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
<a name="gbab-251"></a><span class="p">{</span>
<a name="gbab-252"></a>    <span class="k">register</span> <span class="n">z_crc_t</span> <span class="n">c</span><span class="p">;</span>
<a name="gbab-253"></a>    <span class="k">register</span> <span class="k">const</span> <span class="n">z_crc_t</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">buf4</span><span class="p">;</span>
<a name="gbab-254"></a>
<a name="gbab-255"></a>    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_crc_t</span><span class="p">)</span><span class="n">crc</span><span class="p">;</span>
<a name="gbab-256"></a>    <span class="n">c</span> <span class="o">=</span> <span class="o">~</span><span class="n">c</span><span class="p">;</span>
<a name="gbab-257"></a>    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">ptrdiff_t</span><span class="p">)</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
<a name="gbab-258"></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">crc_table</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">c</span> <span class="o">^</span> <span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
<a name="gbab-259"></a>        <span class="n">len</span><span class="o">--</span><span class="p">;</span>
<a name="gbab-260"></a>    <span class="p">}</span>
<a name="gbab-261"></a>
<a name="gbab-262"></a>    <span class="n">buf4</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">z_crc_t</span> <span class="n">FAR</span> <span class="o">*</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="n">FAR</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
<a name="gbab-263"></a>    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-264"></a>        <span class="n">DOLIT32</span><span class="p">;</span>
<a name="gbab-265"></a>        <span class="n">len</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">;</span>
<a name="gbab-266"></a>    <span class="p">}</span>
<a name="gbab-267"></a>    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-268"></a>        <span class="n">DOLIT4</span><span class="p">;</span>
<a name="gbab-269"></a>        <span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
<a name="gbab-270"></a>    <span class="p">}</span>
<a name="gbab-271"></a>    <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="p">)</span><span class="n">buf4</span><span class="p">;</span>
<a name="gbab-272"></a>
<a name="gbab-273"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="k">do</span> <span class="p">{</span>
<a name="gbab-274"></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">crc_table</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">c</span> <span class="o">^</span> <span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
<a name="gbab-275"></a>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">len</span><span class="p">);</span>
<a name="gbab-276"></a>    <span class="n">c</span> <span class="o">=</span> <span class="o">~</span><span class="n">c</span><span class="p">;</span>
<a name="gbab-277"></a>    <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
<a name="gbab-278"></a><span class="p">}</span>
<a name="gbab-279"></a>
<a name="gbab-280"></a><span class="cm">/* ========================================================================= */</span>
<a name="gbab-281"></a><span class="cp">#define DOBIG4 c ^= *++buf4; \</span>
<a name="gbab-282"></a><span class="cp">        c = crc_table[4][c &amp; 0xff] ^ crc_table[5][(c &gt;&gt; 8) &amp; 0xff] ^ \</span>
<a name="gbab-283"></a><span class="cp">            crc_table[6][(c &gt;&gt; 16) &amp; 0xff] ^ crc_table[7][c &gt;&gt; 24]</span>
<a name="gbab-284"></a><span class="cp">#define DOBIG32 DOBIG4; DOBIG4; DOBIG4; DOBIG4; DOBIG4; DOBIG4; DOBIG4; DOBIG4</span>
<a name="gbab-285"></a>
<a name="gbab-286"></a><span class="cm">/* ========================================================================= */</span>
<a name="gbab-287"></a><span class="n">local</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crc32_big</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span>
<a name="gbab-288"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crc</span><span class="p">;</span>
<a name="gbab-289"></a>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<a name="gbab-290"></a>    <span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
<a name="gbab-291"></a><span class="p">{</span>
<a name="gbab-292"></a>    <span class="k">register</span> <span class="n">z_crc_t</span> <span class="n">c</span><span class="p">;</span>
<a name="gbab-293"></a>    <span class="k">register</span> <span class="k">const</span> <span class="n">z_crc_t</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">buf4</span><span class="p">;</span>
<a name="gbab-294"></a>
<a name="gbab-295"></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">ZSWAP32</span><span class="p">((</span><span class="n">z_crc_t</span><span class="p">)</span><span class="n">crc</span><span class="p">);</span>
<a name="gbab-296"></a>    <span class="n">c</span> <span class="o">=</span> <span class="o">~</span><span class="n">c</span><span class="p">;</span>
<a name="gbab-297"></a>    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">ptrdiff_t</span><span class="p">)</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
<a name="gbab-298"></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">crc_table</span><span class="p">[</span><span class="mi">4</span><span class="p">][(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">^</span> <span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<a name="gbab-299"></a>        <span class="n">len</span><span class="o">--</span><span class="p">;</span>
<a name="gbab-300"></a>    <span class="p">}</span>
<a name="gbab-301"></a>
<a name="gbab-302"></a>    <span class="n">buf4</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">z_crc_t</span> <span class="n">FAR</span> <span class="o">*</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="n">FAR</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
<a name="gbab-303"></a>    <span class="n">buf4</span><span class="o">--</span><span class="p">;</span>
<a name="gbab-304"></a>    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-305"></a>        <span class="n">DOBIG32</span><span class="p">;</span>
<a name="gbab-306"></a>        <span class="n">len</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">;</span>
<a name="gbab-307"></a>    <span class="p">}</span>
<a name="gbab-308"></a>    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-309"></a>        <span class="n">DOBIG4</span><span class="p">;</span>
<a name="gbab-310"></a>        <span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
<a name="gbab-311"></a>    <span class="p">}</span>
<a name="gbab-312"></a>    <span class="n">buf4</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-313"></a>    <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="p">)</span><span class="n">buf4</span><span class="p">;</span>
<a name="gbab-314"></a>
<a name="gbab-315"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="k">do</span> <span class="p">{</span>
<a name="gbab-316"></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">crc_table</span><span class="p">[</span><span class="mi">4</span><span class="p">][(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">^</span> <span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<a name="gbab-317"></a>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">len</span><span class="p">);</span>
<a name="gbab-318"></a>    <span class="n">c</span> <span class="o">=</span> <span class="o">~</span><span class="n">c</span><span class="p">;</span>
<a name="gbab-319"></a>    <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">ZSWAP32</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
<a name="gbab-320"></a><span class="p">}</span>
<a name="gbab-321"></a>
<a name="gbab-322"></a><span class="cp">#endif </span><span class="cm">/* BYFOUR */</span><span class="cp"></span>
<a name="gbab-323"></a>
<a name="gbab-324"></a><span class="cp">#define GF2_DIM 32      </span><span class="cm">/* dimension of GF(2) vectors (length of CRC) */</span><span class="cp"></span>
<a name="gbab-325"></a>
<a name="gbab-326"></a><span class="cm">/* ========================================================================= */</span>
<a name="gbab-327"></a><span class="n">local</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gf2_matrix_times</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
<a name="gbab-328"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mat</span><span class="p">;</span>
<a name="gbab-329"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vec</span><span class="p">;</span>
<a name="gbab-330"></a><span class="p">{</span>
<a name="gbab-331"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sum</span><span class="p">;</span>
<a name="gbab-332"></a>
<a name="gbab-333"></a>    <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="gbab-334"></a>    <span class="k">while</span> <span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-335"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">vec</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
<a name="gbab-336"></a>            <span class="n">sum</span> <span class="o">^=</span> <span class="o">*</span><span class="n">mat</span><span class="p">;</span>
<a name="gbab-337"></a>        <span class="n">vec</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-338"></a>        <span class="n">mat</span><span class="o">++</span><span class="p">;</span>
<a name="gbab-339"></a>    <span class="p">}</span>
<a name="gbab-340"></a>    <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
<a name="gbab-341"></a><span class="p">}</span>
<a name="gbab-342"></a>
<a name="gbab-343"></a><span class="cm">/* ========================================================================= */</span>
<a name="gbab-344"></a><span class="n">local</span> <span class="kt">void</span> <span class="n">gf2_matrix_square</span><span class="p">(</span><span class="n">square</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
<a name="gbab-345"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">square</span><span class="p">;</span>
<a name="gbab-346"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mat</span><span class="p">;</span>
<a name="gbab-347"></a><span class="p">{</span>
<a name="gbab-348"></a>    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
<a name="gbab-349"></a>
<a name="gbab-350"></a>    <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">GF2_DIM</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
<a name="gbab-351"></a>        <span class="n">square</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">gf2_matrix_times</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
<a name="gbab-352"></a><span class="p">}</span>
<a name="gbab-353"></a>
<a name="gbab-354"></a><span class="cm">/* ========================================================================= */</span>
<a name="gbab-355"></a><span class="n">local</span> <span class="n">uLong</span> <span class="n">crc32_combine_</span><span class="p">(</span><span class="n">crc1</span><span class="p">,</span> <span class="n">crc2</span><span class="p">,</span> <span class="n">len2</span><span class="p">)</span>
<a name="gbab-356"></a>    <span class="n">uLong</span> <span class="n">crc1</span><span class="p">;</span>
<a name="gbab-357"></a>    <span class="n">uLong</span> <span class="n">crc2</span><span class="p">;</span>
<a name="gbab-358"></a>    <span class="n">z_off64_t</span> <span class="n">len2</span><span class="p">;</span>
<a name="gbab-359"></a><span class="p">{</span>
<a name="gbab-360"></a>    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
<a name="gbab-361"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">row</span><span class="p">;</span>
<a name="gbab-362"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">even</span><span class="p">[</span><span class="n">GF2_DIM</span><span class="p">];</span>    <span class="cm">/* even-power-of-two zeros operator */</span>
<a name="gbab-363"></a>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">odd</span><span class="p">[</span><span class="n">GF2_DIM</span><span class="p">];</span>     <span class="cm">/* odd-power-of-two zeros operator */</span>
<a name="gbab-364"></a>
<a name="gbab-365"></a>    <span class="cm">/* degenerate case (also disallow negative lengths) */</span>
<a name="gbab-366"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">len2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-367"></a>        <span class="k">return</span> <span class="n">crc1</span><span class="p">;</span>
<a name="gbab-368"></a>
<a name="gbab-369"></a>    <span class="cm">/* put operator for one zero bit in odd */</span>
<a name="gbab-370"></a>    <span class="n">odd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xedb88320UL</span><span class="p">;</span>          <span class="cm">/* CRC-32 polynomial */</span>
<a name="gbab-371"></a>    <span class="n">row</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-372"></a>    <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">GF2_DIM</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="gbab-373"></a>        <span class="n">odd</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">;</span>
<a name="gbab-374"></a>        <span class="n">row</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-375"></a>    <span class="p">}</span>
<a name="gbab-376"></a>
<a name="gbab-377"></a>    <span class="cm">/* put operator for two zero bits in even */</span>
<a name="gbab-378"></a>    <span class="n">gf2_matrix_square</span><span class="p">(</span><span class="n">even</span><span class="p">,</span> <span class="n">odd</span><span class="p">);</span>
<a name="gbab-379"></a>
<a name="gbab-380"></a>    <span class="cm">/* put operator for four zero bits in odd */</span>
<a name="gbab-381"></a>    <span class="n">gf2_matrix_square</span><span class="p">(</span><span class="n">odd</span><span class="p">,</span> <span class="n">even</span><span class="p">);</span>
<a name="gbab-382"></a>
<a name="gbab-383"></a>    <span class="cm">/* apply len2 zeros to crc1 (first square will put the operator for one</span>
<a name="gbab-384"></a><span class="cm">       zero byte, eight zero bits, in even) */</span>
<a name="gbab-385"></a>    <span class="k">do</span> <span class="p">{</span>
<a name="gbab-386"></a>        <span class="cm">/* apply zeros operator for this bit of len2 */</span>
<a name="gbab-387"></a>        <span class="n">gf2_matrix_square</span><span class="p">(</span><span class="n">even</span><span class="p">,</span> <span class="n">odd</span><span class="p">);</span>
<a name="gbab-388"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">len2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
<a name="gbab-389"></a>            <span class="n">crc1</span> <span class="o">=</span> <span class="n">gf2_matrix_times</span><span class="p">(</span><span class="n">even</span><span class="p">,</span> <span class="n">crc1</span><span class="p">);</span>
<a name="gbab-390"></a>        <span class="n">len2</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-391"></a>
<a name="gbab-392"></a>        <span class="cm">/* if no more bits set, then done */</span>
<a name="gbab-393"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">len2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="gbab-394"></a>            <span class="k">break</span><span class="p">;</span>
<a name="gbab-395"></a>
<a name="gbab-396"></a>        <span class="cm">/* another iteration of the loop with odd and even swapped */</span>
<a name="gbab-397"></a>        <span class="n">gf2_matrix_square</span><span class="p">(</span><span class="n">odd</span><span class="p">,</span> <span class="n">even</span><span class="p">);</span>
<a name="gbab-398"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">len2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
<a name="gbab-399"></a>            <span class="n">crc1</span> <span class="o">=</span> <span class="n">gf2_matrix_times</span><span class="p">(</span><span class="n">odd</span><span class="p">,</span> <span class="n">crc1</span><span class="p">);</span>
<a name="gbab-400"></a>        <span class="n">len2</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
<a name="gbab-401"></a>
<a name="gbab-402"></a>        <span class="cm">/* if no more bits set, then done */</span>
<a name="gbab-403"></a>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<a name="gbab-404"></a>
<a name="gbab-405"></a>    <span class="cm">/* return combined crc */</span>
<a name="gbab-406"></a>    <span class="n">crc1</span> <span class="o">^=</span> <span class="n">crc2</span><span class="p">;</span>
<a name="gbab-407"></a>    <span class="k">return</span> <span class="n">crc1</span><span class="p">;</span>
<a name="gbab-408"></a><span class="p">}</span>
<a name="gbab-409"></a>
<a name="gbab-410"></a><span class="cm">/* ========================================================================= */</span>
<a name="gbab-411"></a><span class="n">uLong</span> <span class="n">ZEXPORT</span> <span class="n">crc32_combine</span><span class="p">(</span><span class="n">crc1</span><span class="p">,</span> <span class="n">crc2</span><span class="p">,</span> <span class="n">len2</span><span class="p">)</span>
<a name="gbab-412"></a>    <span class="n">uLong</span> <span class="n">crc1</span><span class="p">;</span>
<a name="gbab-413"></a>    <span class="n">uLong</span> <span class="n">crc2</span><span class="p">;</span>
<a name="gbab-414"></a>    <span class="n">z_off_t</span> <span class="n">len2</span><span class="p">;</span>
<a name="gbab-415"></a><span class="p">{</span>
<a name="gbab-416"></a>    <span class="k">return</span> <span class="n">crc32_combine_</span><span class="p">(</span><span class="n">crc1</span><span class="p">,</span> <span class="n">crc2</span><span class="p">,</span> <span class="n">len2</span><span class="p">);</span>
<a name="gbab-417"></a><span class="p">}</span>
<a name="gbab-418"></a>
<a name="gbab-419"></a><span class="n">uLong</span> <span class="n">ZEXPORT</span> <span class="n">crc32_combine64</span><span class="p">(</span><span class="n">crc1</span><span class="p">,</span> <span class="n">crc2</span><span class="p">,</span> <span class="n">len2</span><span class="p">)</span>
<a name="gbab-420"></a>    <span class="n">uLong</span> <span class="n">crc1</span><span class="p">;</span>
<a name="gbab-421"></a>    <span class="n">uLong</span> <span class="n">crc2</span><span class="p">;</span>
<a name="gbab-422"></a>    <span class="n">z_off64_t</span> <span class="n">len2</span><span class="p">;</span>
<a name="gbab-423"></a><span class="p">{</span>
<a name="gbab-424"></a>    <span class="k">return</span> <span class="n">crc32_combine_</span><span class="p">(</span><span class="n">crc1</span><span class="p">,</span> <span class="n">crc2</span><span class="p">,</span> <span class="n">len2</span><span class="p">);</span>
<a name="gbab-425"></a><span class="p">}</span>
</pre></div>
</td></tr></table>